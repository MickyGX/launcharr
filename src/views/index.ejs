<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= title %></title>
  <script>
    (function() {
      try {
        var stored = localStorage.getItem("launcharr-theme");
        var prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
        var mode = stored || (prefersLight ? "day" : "night");
        var brandTheme = localStorage.getItem("launcharr-brand-theme") || "pulsarr";
        document.documentElement.dataset.theme = mode;
        document.documentElement.dataset.brandTheme = brandTheme;
        if (brandTheme === "custom") {
          var customHex = localStorage.getItem("launcharr-custom-color") || "#1cc6c2";
          var normalizedHex = /^#?[0-9a-fA-F]{6}$/.test(customHex) ? (customHex.charAt(0) === "#" ? customHex : "#" + customHex) : "#1cc6c2";
          var r = parseInt(normalizedHex.slice(1, 3), 16);
          var g = parseInt(normalizedHex.slice(3, 5), 16);
          var b = parseInt(normalizedHex.slice(5, 7), 16);
          var mix = function(base, target, amount) {
            return Math.round(base + (target - base) * amount);
          };
          var toHex = function(value) {
            var clamped = Math.max(0, Math.min(255, value));
            return clamped.toString(16).padStart(2, "0");
          };
          var dark = "#" + toHex(mix(r, 0, 0.4)) + toHex(mix(g, 0, 0.4)) + toHex(mix(b, 0, 0.4));
          var start = "#" + toHex(mix(r, 255, 0.35)) + toHex(mix(g, 255, 0.35)) + toHex(mix(b, 255, 0.35));
          var end = "#" + toHex(mix(r, 0, 0.2)) + toHex(mix(g, 0, 0.2)) + toHex(mix(b, 0, 0.2));
          var shadowR = mix(r, 0, 0.28);
          var shadowG = mix(g, 0, 0.28);
          var shadowB = mix(b, 0, 0.28);
          var linear = function(channel) {
            var value = channel / 255;
            return value <= 0.03928 ? value / 12.92 : Math.pow((value + 0.055) / 1.055, 2.4);
          };
          var luminance = 0.2126 * linear(r) + 0.7152 * linear(g) + 0.0722 * linear(b);
          var contrastWhite = 1.05 / (luminance + 0.05);
          var contrastBlack = (luminance + 0.05) / 0.05;
          var onBrand = contrastWhite >= contrastBlack ? "#ffffff" : "#081013";
          var onBrandMuted = contrastWhite >= contrastBlack ? "rgba(255,255,255,.78)" : "rgba(8,16,19,.72)";
          var onBrandIconFilter = contrastWhite >= contrastBlack ? "brightness(0) saturate(100%) invert(1)" : "brightness(0) saturate(100%)";
          document.documentElement.style.setProperty("--teal", normalizedHex.toLowerCase());
          document.documentElement.style.setProperty("--teal-dark", dark);
          document.documentElement.style.setProperty("--brand-rgb", r + "," + g + "," + b);
          document.documentElement.style.setProperty("--brand-btn-start", start);
          document.documentElement.style.setProperty("--brand-btn-mid", normalizedHex.toLowerCase());
          document.documentElement.style.setProperty("--brand-btn-end", end);
          document.documentElement.style.setProperty("--brand-btn-shadow", shadowR + "," + shadowG + "," + shadowB);
          document.documentElement.style.setProperty("--on-brand", onBrand);
          document.documentElement.style.setProperty("--on-brand-muted", onBrandMuted);
          document.documentElement.style.setProperty("--on-brand-icon-filter", onBrandIconFilter);
        }
      } catch (e) {}
    })();
  </script>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" type="image/png" href="/icons/launcharr-icon.png" />
  <meta name="theme-color" content="#1cc6c2" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/icons/launcharr-icon.png" />
</head>
<body>
  <div class="bg-grid"></div>
  <header class="topbar">
    <div class="brand">
      <div class="logo">
        <img src="/icons/launcharr-icon.png" alt="Launcharr" />
      </div>
      <div>
        <div class="title">Launcharr</div>
        <div class="subtitle">Arr suite control deck</div>
      </div>
    </div>
    <div class="auth">
      <% if (user) { %>
        <div class="user-pill user-pill--menu user-pill--menu-down" data-user-menu role="button" tabindex="0" aria-haspopup="true" aria-expanded="false">
          <% if (user.avatar) { %>
            <img class="user-avatar" src="<%= user.avatar %>" alt="" />
          <% } %>
          <div class="user-meta">
            <span class="role"><%= role %></span>
            <div class="username"><%= user.username %></div>
            <% if (user.email) { %>
              <div class="email"><%= user.email %></div>
            <% } %>
          </div>
          <span class="user-pill-caret" aria-hidden="true"></span>
          <div class="user-menu" role="menu">
            <% if (actualRole === 'admin') { %>
              <a class="user-menu-item" href="/settings">
                <img class="user-menu-icon" src="/icons/settings.svg" alt="" />
                <span class="user-menu-text">Settings</span>
              </a>
            <% } %>
            <% if (role === 'admin') { %>
              <a class="user-menu-item" href="/switch-view?role=<%= role === 'admin' ? 'user' : 'admin' %>">
                <img class="user-menu-icon" src="/icons/window.svg" alt="" />
                <span class="user-menu-text"><%= role === 'admin' ? 'Switch to user view' : 'Switch to admin view' %></span>
              </a>
            <% } %>
            <a class="user-menu-item" href="/user-settings">
              <img class="user-menu-icon" src="/icons/user-profile.svg" alt="" />
              <span class="user-menu-text">User profile</span>
            </a>
            <div class="user-menu-divider"></div>
            <a class="user-menu-item" href="/logout">
              <img class="user-menu-icon" src="/icons/logout.svg" alt="" />
              <span class="user-menu-text">Sign out</span>
            </a>
          </div>
        </div>
      <% } else { %>
        <a class="primary-button" href="/login">Sign in with Plex</a>
      <% } %>
    </div>
  </header>

  <main class="container">
    <% if (!user) { %>
      <section class="hero">
        <div class="hero-card">
          <h1>Welcome to Launcharr</h1>
          <p>Centralize Radarr, Sonarr, Lidarr, Pulsarr, Cleanuparr, Huntarr, Transmission, and NZBGet in one place.</p>
          <div class="hero-actions">
            <a class="primary-button" href="/login">Authenticate with Plex</a>
            <span class="hint">Admins unlock system controls. Users see request tools.</span>
          </div>
        </div>
        <div class="hero-ambient"></div>
      </section>
    <% } else { %>
      <% grouped.forEach(section => { %>
        <section class="section">
          <div class="section-header">
            <h2><%= section.category %></h2>
            <div class="divider"></div>
          </div>
          <div class="grid">
            <% section.items.forEach(app => { %>
              <a class="card" href="<%= app.url %>" target="_blank" rel="noreferrer">
                <div class="card-top">
                  <div class="card-title"><%= app.name %></div>
                  <span class="chip"><%= app.category %></span>
                </div>
                <p><%= app.description || 'Open app' %></p>
                <div class="card-footer">
                  <span class="link">Launch</span>
                </div>
              </a>
            <% }) %>
          </div>
        </section>
      <% }) %>
    <% } %>
  </main>

  <footer class="footer">
    <div>Launcharr Â· <span class="muted">Plex-backed access control</span></div>
  </footer>
  <script>
    const userMenus = document.querySelectorAll('[data-user-menu]');

    function closeUserMenus(except) {
      userMenus.forEach((menu) => {
        if (menu === except) return;
        menu.classList.remove('user-pill--open');
        menu.setAttribute('aria-expanded', 'false');
      });
    }

    userMenus.forEach((menu) => {
      menu.setAttribute('aria-expanded', 'false');
      menu.addEventListener('click', (event) => {
        if (event.target.closest('.user-menu')) return;
        event.preventDefault();
        const isOpen = menu.classList.contains('user-pill--open');
        closeUserMenus(menu);
        menu.classList.toggle('user-pill--open', !isOpen);
        menu.setAttribute('aria-expanded', !isOpen ? 'true' : 'false');
      });
      menu.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        event.preventDefault();
        menu.click();
      });
    });

    document.addEventListener('click', (event) => {
      if (event.target.closest('[data-user-menu]')) return;
      closeUserMenus();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      closeUserMenus();
    });
  </script>
  <script src="/pwa.js"></script>
</body>
</html>
