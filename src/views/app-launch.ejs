<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Launcharr Â· <%= app.name %> Launch</title>
  <script>
    (function() {
      try {
        var stored = localStorage.getItem("launcharr-theme");
        var prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
        var themeDefaults = <%- JSON.stringify(themeDefaults || {}) %>;
        var modeFromDefaults = (themeDefaults && (themeDefaults.mode === "day" || themeDefaults.mode === "night")) ? themeDefaults.mode : "";
        var mode = stored || modeFromDefaults || (prefersLight ? "day" : "night");
        var defaultBrandTheme = String(themeDefaults && themeDefaults.brandTheme || "").trim().toLowerCase();
        var isAllowedBrandTheme = /^(custom|launcharr|rocketship|pulsarr|plex|radarr|sonarr|lidarr|readarr)$/.test(defaultBrandTheme);
        var brandTheme = localStorage.getItem("launcharr-brand-theme") || (isAllowedBrandTheme ? defaultBrandTheme : "pulsarr");
        document.documentElement.dataset.theme = mode;
        document.documentElement.dataset.brandTheme = brandTheme;
        var parseStoredBool = function(key, fallback) {
          var raw = localStorage.getItem(key);
          if (raw === null || raw === undefined) return Boolean(fallback);
          return raw === "1" || raw === "true";
        };
        var sidebarInvert = parseStoredBool("launcharr-sidebar-invert", themeDefaults && themeDefaults.sidebarInvert === true);
        var squareCorners = parseStoredBool("launcharr-square-corners", themeDefaults && themeDefaults.squareCorners === true);
        var bgMotionStored = localStorage.getItem("launcharr-bg-motion");
        var bgMotionDefault = themeDefaults && themeDefaults.bgMotion === undefined ? true : (themeDefaults && themeDefaults.bgMotion === true);
        var bgMotion = bgMotionStored === null ? bgMotionDefault : (bgMotionStored === "1" || bgMotionStored === "true");
        var carouselFreeScroll = parseStoredBool("launcharr-carousel-free-scroll", themeDefaults && themeDefaults.carouselFreeScroll === true);
        var hideScrollbars = parseStoredBool("launcharr-hide-scrollbars", themeDefaults && themeDefaults.hideScrollbars === true);
        var maximizedWindow = localStorage.getItem("launcharr-maximized-window") === "1";
        document.documentElement.dataset.sidebarInvert = sidebarInvert ? "1" : "0";
        document.documentElement.dataset.squareCorners = squareCorners ? "1" : "0";
        document.documentElement.dataset.bgMotion = bgMotion ? "1" : "0";
        document.documentElement.dataset.carouselFreeScroll = carouselFreeScroll ? "1" : "0";
        document.documentElement.dataset.hideScrollbars = hideScrollbars ? "1" : "0";
        document.documentElement.dataset.maximized = maximizedWindow ? "1" : "0";
        var starDensity = 165;
        var starSpeed = 45;
        var starSize = 1.2;
        document.documentElement.style.setProperty("--star-density", String(starDensity));
        document.documentElement.style.setProperty("--star-speed", String(starSpeed) + "s");
        document.documentElement.style.setProperty("--star-size", String(starSize));
        var embedded = false;
        try {
          embedded = window.self !== window.top;
        } catch (err) {
          embedded = true;
        }
        document.documentElement.dataset.embedded = embedded ? "1" : "0";
        if (brandTheme === "custom") {
          var customHex = localStorage.getItem("launcharr-custom-color") || String(themeDefaults && themeDefaults.customColor || "#1cc6c2");
          var normalizedHex = /^#?[0-9a-fA-F]{6}$/.test(customHex) ? (customHex.charAt(0) === "#" ? customHex : "#" + customHex) : "#1cc6c2";
          var r = parseInt(normalizedHex.slice(1, 3), 16);
          var g = parseInt(normalizedHex.slice(3, 5), 16);
          var b = parseInt(normalizedHex.slice(5, 7), 16);
          var mix = function(base, target, amount) {
            return Math.round(base + (target - base) * amount);
          };
          var toHex = function(value) {
            var clamped = Math.max(0, Math.min(255, value));
            return clamped.toString(16).padStart(2, "0");
          };
          var dark = "#" + toHex(mix(r, 0, 0.4)) + toHex(mix(g, 0, 0.4)) + toHex(mix(b, 0, 0.4));
          var start = "#" + toHex(mix(r, 255, 0.35)) + toHex(mix(g, 255, 0.35)) + toHex(mix(b, 255, 0.35));
          var end = "#" + toHex(mix(r, 0, 0.2)) + toHex(mix(g, 0, 0.2)) + toHex(mix(b, 0, 0.2));
          var shadowR = mix(r, 0, 0.28);
          var shadowG = mix(g, 0, 0.28);
          var shadowB = mix(b, 0, 0.28);
          var linear = function(channel) {
            var value = channel / 255;
            return value <= 0.03928 ? value / 12.92 : Math.pow((value + 0.055) / 1.055, 2.4);
          };
          var luminance = 0.2126 * linear(r) + 0.7152 * linear(g) + 0.0722 * linear(b);
          var contrastWhite = 1.05 / (luminance + 0.05);
          var contrastBlack = (luminance + 0.05) / 0.05;
          var onBrand = contrastWhite >= contrastBlack ? "#ffffff" : "#081013";
          var onBrandMuted = contrastWhite >= contrastBlack ? "rgba(255,255,255,.78)" : "rgba(8,16,19,.72)";
          var onBrandIconFilter = contrastWhite >= contrastBlack ? "brightness(0) saturate(100%) invert(1)" : "brightness(0) saturate(100%)";
          document.documentElement.style.setProperty("--teal", normalizedHex.toLowerCase());
          document.documentElement.style.setProperty("--teal-dark", dark);
          document.documentElement.style.setProperty("--brand-rgb", r + "," + g + "," + b);
          document.documentElement.style.setProperty("--brand-btn-start", start);
          document.documentElement.style.setProperty("--brand-btn-mid", normalizedHex.toLowerCase());
          document.documentElement.style.setProperty("--brand-btn-end", end);
          document.documentElement.style.setProperty("--brand-btn-shadow", shadowR + "," + shadowG + "," + shadowB);
          document.documentElement.style.setProperty("--on-brand", onBrand);
          document.documentElement.style.setProperty("--on-brand-muted", onBrandMuted);
          document.documentElement.style.setProperty("--on-brand-icon-filter", onBrandIconFilter);
        }
      } catch (e) {}
    })();
  </script>
  <link rel="stylesheet" href="/styles.css?v=<%= assetVersion %>" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" type="image/png" href="/icons/launcharr-icon.png" />
  <meta name="theme-color" content="#1cc6c2" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/icons/launcharr-icon.png" />
</head>
<body class="dash-body launch-page">
  <div class="dash-frame">
    <aside class="dash-sidebar">
      <div class="dash-brand">
        <span class="dash-logo">
          <img class="nav-icon app-icon" src="/icons/launcharr-icon.png" alt="Launcharr" />
        </span>
        <div>
          <div class="dash-title">Launcharr</div>
        </div>
      </div>

      <div class="dash-nav">
        <a class="nav-item" href="/dashboard">
          <img class="nav-icon" src="/icons/dashboard.svg" alt="" />
          <span class="nav-label">Dashboard</span>
        </a>
        <% if (navCategories && navCategories.length) { %>
          <div class="nav-divider"></div>
          <div class="nav-accordion">
            <% navCategories.forEach((category) => { %>
              <% if (category.sidebarMenu) { %>
                <% const categoryOpen = category.apps.some((item) => item.id === app.id && !item.navFavourite && !((item.favourite || item.favorite))); %>
                <div class="nav-accordion-item nav-accordion-item--category<%= categoryOpen ? ' open' : '' %>">
                  <button class="nav-accordion-trigger nav-accordion-trigger--category" type="button">
                    <img class="nav-icon" src="<%= category.icon || '/icons/category.svg' %>" alt="" onerror="this.src='/icons/category.svg'" />
                    <span class="nav-label"><%= category.name %></span>
                  </button>
                  <div class="nav-accordion-panel nav-accordion-panel--category">
                    <div class="nav-accordion nav-accordion--nested">
                      <% category.apps.forEach((appItem) => { %>
                        <div class="nav-accordion-item<%= appItem.id === app.id && (!((appItem.favourite || appItem.favorite)) || appItem.navFavourite) ? ' open' : '' %>">
                          <button class="nav-accordion-trigger" type="button">
                            <img class="nav-icon app-icon" src="<%= appItem.icon || (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'seerr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission', 'jellyfin', 'emby'].includes(appItem.id) ? '/icons/' + appItem.id + '.png' : '/icons/' + appItem.id + '.svg') %>" alt="" onerror="this.src='/icons/app.svg'" />
                            <span class="nav-label"><%= appItem.name %></span>
                          </button>
                          <div class="nav-accordion-panel">
                            <% if (appItem.menuAccess.overview) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>">
                                <img class="nav-subicon" src="/icons/overview.svg" alt="" />
                                <span>Overview</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.launch) { %>
                              <a class="nav-subitem<%= appItem.id === app.id ? ' active' : '' %>" href="/apps/<%= appItem.id %>/launch" data-launch-mode="<%= appItem.effectiveLaunchMode %>" <%= appItem.effectiveLaunchMode === 'new-tab' ? 'target="_blank" rel="noreferrer"' : '' %>>
                                <img class="nav-subicon" src="/icons/launch.svg" alt="" />
                                <span>Launch</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.settings) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>/settings">
                                <img class="nav-subicon" src="/icons/settings.svg" alt="" />
                                <span>App settings</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.activity) { %>
                              <a class="nav-subitem<%= appItem.id === app.id && page === 'activity' ? ' active' : '' %>" href="/apps/<%= appItem.id %>/activity">
                                <img class="nav-subicon" src="/icons/activity-queue.svg" alt="" />
                                <span>Activity</span>
                              </a>
                            <% } %>
                          </div>
                        </div>
                      <% }) %>
                    </div>
                  </div>
                </div>
              <% } else { %>
                <% category.apps.forEach((appItem) => { %>
                  <div class="nav-accordion-item<%= appItem.id === app.id && (!((appItem.favourite || appItem.favorite)) || appItem.navFavourite) ? ' open' : '' %>">
                    <button class="nav-accordion-trigger" type="button">
                      <img class="nav-icon app-icon" src="<%= appItem.icon || (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'seerr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission', 'jellyfin', 'emby'].includes(appItem.id) ? '/icons/' + appItem.id + '.png' : '/icons/' + appItem.id + '.svg') %>" alt="" onerror="this.src='/icons/app.svg'" />
                      <span class="nav-label"><%= appItem.name %></span>
                    </button>
                    <div class="nav-accordion-panel">
                      <% if (appItem.menuAccess.overview) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>">
                          <img class="nav-subicon" src="/icons/overview.svg" alt="" />
                          <span>Overview</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.launch) { %>
                        <a class="nav-subitem<%= appItem.id === app.id ? ' active' : '' %>" href="/apps/<%= appItem.id %>/launch" data-launch-mode="<%= appItem.effectiveLaunchMode %>" <%= appItem.effectiveLaunchMode === 'new-tab' ? 'target="_blank" rel="noreferrer"' : '' %>>
                          <img class="nav-subicon" src="/icons/launch.svg" alt="" />
                          <span>Launch</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.settings) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>/settings">
                          <img class="nav-subicon" src="/icons/settings.svg" alt="" />
                          <span>App settings</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.activity) { %>
                        <a class="nav-subitem<%= appItem.id === app.id && page === 'activity' ? ' active' : '' %>" href="/apps/<%= appItem.id %>/activity">
                          <img class="nav-subicon" src="/icons/activity-queue.svg" alt="" />
                          <span>Activity</span>
                        </a>
                      <% } %>
                    </div>
                  </div>
                <% }) %>
              <% } %>
            <% }) %>
          </div>
        <% } %>
      </div>

      <div class="dash-user">
        <div class="user-pill user-pill--menu" data-user-menu role="button" tabindex="0" aria-haspopup="true" aria-expanded="false">
          <img class="user-avatar" src="<%= user.avatar || user.avatarFallback || '/icons/user-profile.svg' %>" alt="" onerror="this.onerror=null;this.src='<%= user.avatarFallback || '/icons/user-profile.svg' %>';" />
          <div class="user-meta">
            <span class="role"><%= role %></span>
            <div class="username"><%= user.username %></div>
            <% if (user.email) { %>
              <div class="email"><%= user.email %></div>
            <% } %>
          </div>
          <span class="user-pill-caret" aria-hidden="true"></span>
          <div class="user-menu" role="menu">
            <% if (actualRole === 'admin') { %>
              <a class="user-menu-item" href="/settings">
                <img class="user-menu-icon" src="/icons/settings.svg" alt="" />
                <span class="user-menu-text">Settings</span>
              </a>
            <% } %>
            <% if (actualRole === 'admin') { %>
              <a class="user-menu-item" href="/switch-view?role=<%= role === 'admin' ? 'user' : 'admin' %>">
                <img class="user-menu-icon" src="/icons/window.svg" alt="" />
                <span class="user-menu-text"><%= role === 'admin' ? 'User view' : 'Admin view' %></span>
              </a>
            <% } %>
            <a class="user-menu-item" href="/user-settings">
              <img class="user-menu-icon" src="/icons/user-profile.svg" alt="" />
              <span class="user-menu-text">User profile</span>
            </a>
            <div class="user-menu-divider"></div>
            <a class="user-menu-item" href="/logout">
              <img class="user-menu-icon" src="/icons/logout.svg" alt="" />
              <span class="user-menu-text">Sign out</span>
            </a>
          </div>
        </div>
      </div>
    </aside>

    <section class="dash-main">
      <div class="main-window-bar">
        <button class="sidebar-toggle main-toggle left-toggle" type="button" aria-label="Toggle sidebar">
          <img class="toggle-icon" src="/icons/sidebar-toggle.svg" alt="" />
        </button>
        <div class="main-window-title">
          <img class="main-window-icon" src="<%= app.icon || (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'seerr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission', 'jellyfin', 'emby'].includes(app.id) ? '/icons/' + app.id + '.png' : '/icons/' + app.id + '.svg') %>" alt="" onerror="this.src='/icons/app.svg'" />
          <span class="main-window-app"><%= app.name %></span>
          <span class="main-window-rest">| Launch</span>
        </div>
        <div class="main-window-spacer"></div>
        <div class="main-window-status">
          <span class="status-dot status-dot--ok"></span>
        </div>
      </div>

      <div class="dash-panel launch-frame-panel">
        <iframe class="launch-frame" src="<%= launchUrl %>" title="Launch <%= app.name %>" loading="eager"></iframe>
        <div class="launch-frame-overlay" aria-hidden="true"></div>
      </div>
    </section>
  </div>
  <script>
    const dashFrame = document.querySelector('.dash-frame');
    const toggle = document.querySelector('.sidebar-toggle');
    const toggleIcon = toggle?.querySelector('img');
    const mobileQuery = window.matchMedia('(max-width: 980px)');
    const isMobile = () => mobileQuery.matches;
    const mainContent = document.querySelector('.dash-main');
    const sidebar = document.querySelector('.dash-sidebar');
    const dashNav = document.querySelector('.dash-nav');
    const safeStorage = {
      get(key) {
        try {
          return localStorage.getItem(key);
        } catch (err) {
          return null;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (err) {
          return;
        }
      },
    };

    function setToggleIcon() {
      if (!toggleIcon) return;
      toggleIcon.src = '/icons/sidebar-toggle.svg';
    }

    function applySidebarState() {
      if (!dashFrame) return;
      if (isMobile()) {
        dashFrame.classList.remove('sidebar-collapsed');
        dashFrame.classList.remove('mobile-nav-open');
        document.body.classList.remove('mobile-nav-open');
        if (dashNav) dashNav.scrollTop = 0;
        setToggleIcon(false);
      } else {
        const collapsed = safeStorage.get('sidebarCollapsed') === 'true';
        dashFrame.classList.toggle('sidebar-collapsed', collapsed);
        dashFrame.classList.remove('mobile-nav-open');
        document.body.classList.remove('mobile-nav-open');
        if (dashNav) dashNav.scrollTop = 0;
        setToggleIcon(!collapsed);
      }
    }

    function closeMobileNav() {
      if (!dashFrame || !isMobile()) return;
      if (!dashFrame.classList.contains('mobile-nav-open')) return;
      dashFrame.classList.remove('mobile-nav-open');
      document.body.classList.remove('mobile-nav-open');
      setToggleIcon(false);
    }

    applySidebarState();
    mobileQuery.addEventListener('change', applySidebarState);
    const autoOpenSingleAppMenuItem = <%= autoOpenSingleAppMenuItem ? 'true' : 'false' %>;
    const sidebarButtonPressActions = <%- JSON.stringify(sidebarButtonPressActions || {}) %>;
    const currentSidebarRole = String('<%= role || 'user' %>').trim().toLowerCase();
    const normalizeSidebarRole = (value) => {
      const raw = String(value || '').trim().toLowerCase();
      if (raw === 'guest' || raw === 'user' || raw === 'co-admin' || raw === 'admin') return raw;
      return 'user';
    };
    const normalizePressAction = (value, fallback = 'default') => {
      const raw = String(value || '').trim().toLowerCase();
      if (raw === 'default' || raw === 'launch' || raw === 'settings' || raw === 'activity') return raw;
      return fallback;
    };
    const rolePressConfig = (sidebarButtonPressActions && typeof sidebarButtonPressActions === 'object')
      ? (sidebarButtonPressActions[normalizeSidebarRole(currentSidebarRole)] || sidebarButtonPressActions.user || {})
      : {};
    const shortPressAction = normalizePressAction(rolePressConfig.short, 'default');
    const longPressAction = normalizePressAction(rolePressConfig.long, 'default');
    const LONG_PRESS_DELAY_MS = 450;
    const openSubmenuLink = (link) => {
      if (!link) return false;
      const rawHref = typeof link.getAttribute === 'function'
        ? (link.getAttribute('href') || link.href || '')
        : (link.href || '');
      const href = String(rawHref || '').trim();
      if (!href) return false;
      const rawTargetAttr = typeof link.getAttribute === 'function'
        ? (link.getAttribute('target') || '')
        : (link.target || '');
      const targetAttr = String(rawTargetAttr || '').trim().toLowerCase();
      const targetProp = String(link.target || '').trim().toLowerCase();
      const launchMode = String((link.dataset && link.dataset.launchMode) || link.launchMode || '').trim().toLowerCase();
      const isLaunchRoute = /\/apps\/[^/?#]+\/launch(?:$|[/?#])/i.test(href);
      const shouldOpenBlank = targetAttr === '_blank'
        || targetProp === '_blank'
        || (isLaunchRoute && launchMode === 'new-tab');
      if (shouldOpenBlank) {
        window.open(href, '_blank', 'noopener,noreferrer');
      } else {
        window.location.href = href;
      }
      return true;
    };
    const getDirectLinks = (item) => {
      const panel = Array.from(item.children).find((child) => child.classList && child.classList.contains('nav-accordion-panel'));
      return panel
        ? Array.from(panel.children).filter((child) => typeof child.matches === 'function' && child.matches('a.nav-subitem[href]'))
        : [];
    };
    const resolveAppIdFromItem = (item, links = []) => {
      const pool = Array.isArray(links) && links.length ? links : getDirectLinks(item);
      for (let index = 0; index < pool.length; index += 1) {
        const href = String((pool[index] && pool[index].getAttribute && pool[index].getAttribute('href')) || '').trim();
        const match = href.match(/\/apps\/([^/?#]+)/i);
        if (match && match[1]) return decodeURIComponent(String(match[1]));
      }
      return '';
    };
    const buildVirtualActionLink = (appId, action, links = []) => {
      const normalizedId = String(appId || '').trim();
      if (!normalizedId) return null;
      const encodedId = encodeURIComponent(normalizedId);
      if (action === 'launch') {
        const launchLink = links.find((link) => /\/launch(?:$|[/?#])/.test(String(link.getAttribute('href') || '')));
        const launchMode = String((launchLink?.dataset && launchLink.dataset.launchMode) || '').trim().toLowerCase();
        return {
          href: '/apps/' + encodedId + '/launch',
          target: launchMode === 'new-tab' ? '_blank' : '',
          launchMode,
        };
      }
      if (action === 'settings') return { href: '/apps/' + encodedId + '/settings', target: '', launchMode: '' };
      if (action === 'activity') return { href: '/apps/' + encodedId + '/activity', target: '', launchMode: '' };
      return null;
    };
    const getActionLink = (item, action) => {
      const links = getDirectLinks(item);
      if (action === 'launch') {
        const direct = links.find((link) => /\/launch(?:$|[/?#])/.test(String(link.getAttribute('href') || '')));
        return direct || buildVirtualActionLink(resolveAppIdFromItem(item, links), action, links);
      }
      if (action === 'settings') {
        const direct = links.find((link) => /\/settings(?:$|[/?#])/.test(String(link.getAttribute('href') || '')));
        return direct || buildVirtualActionLink(resolveAppIdFromItem(item, links), action, links);
      }
      if (action === 'activity') {
        const direct = links.find((link) => /\/activity(?:$|[/?#])/.test(String(link.getAttribute('href') || '')));
        return direct || buildVirtualActionLink(resolveAppIdFromItem(item, links), action, links);
      }
      return null;
    };
    const toggleAccordionItem = (item) => {
      const parentAccordion = item.closest('.nav-accordion');
      const siblings = parentAccordion
        ? Array.from(parentAccordion.children).filter((child) => child.classList.contains('nav-accordion-item'))
        : [];
      siblings.forEach((other) => {
        if (other !== item) other.classList.remove('open');
      });
      item.classList.toggle('open');
    };
    const handleDefaultPress = (item, isCategoryTrigger) => {
      if (autoOpenSingleAppMenuItem && !isCategoryTrigger) {
        const links = getDirectLinks(item);
        if (links.length === 1 && openSubmenuLink(links[0])) return;
      }
      toggleAccordionItem(item);
    };
    const handlePressAction = (item, action, isCategoryTrigger) => {
      if (isCategoryTrigger) {
        toggleAccordionItem(item);
        return;
      }
      const resolvedAction = normalizePressAction(action, 'default');
      if (resolvedAction === 'default') {
        handleDefaultPress(item, false);
        return;
      }
      const link = getActionLink(item, resolvedAction);
      if (openSubmenuLink(link)) return;
      handleDefaultPress(item, false);
    };
    const accordion = document.querySelectorAll('.nav-accordion-item');
    accordion.forEach((item) => {
      const trigger = item.querySelector('.nav-accordion-trigger');
      if (!trigger) return;
      const isCategoryTrigger = trigger.classList.contains('nav-accordion-trigger--category');
      let longPressTimer = null;
      let longPressTriggered = false;
      const supportsPointerEvents = typeof window !== 'undefined' && 'PointerEvent' in window;
      const clearLongPressTimer = () => {
        if (longPressTimer) {
          window.clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      };
      const startLongPressTimer = () => {
        longPressTriggered = false;
        clearLongPressTimer();
        longPressTimer = window.setTimeout(() => {
          longPressTriggered = true;
          handlePressAction(item, longPressAction, false);
        }, LONG_PRESS_DELAY_MS);
      };
      if (supportsPointerEvents) {
        trigger.addEventListener('pointerdown', (event) => {
          if (isCategoryTrigger) return;
          if (event.button !== undefined && event.button !== 0) return;
          startLongPressTimer();
        });
        ['pointerup', 'pointerleave', 'pointercancel'].forEach((eventName) => {
          trigger.addEventListener(eventName, clearLongPressTimer);
        });
      } else {
        trigger.addEventListener('touchstart', () => {
          if (isCategoryTrigger) return;
          startLongPressTimer();
        }, { passive: true });
        ['touchend', 'touchcancel', 'touchmove'].forEach((eventName) => {
          trigger.addEventListener(eventName, clearLongPressTimer, { passive: true });
        });
      }
      trigger.addEventListener('contextmenu', (event) => {
        if (longPressTriggered) event.preventDefault();
      });
      trigger.addEventListener('click', (event) => {
        event.stopPropagation();
        clearLongPressTimer();
        if (longPressTriggered) {
          event.preventDefault();
          longPressTriggered = false;
          return;
        }
        handlePressAction(item, shortPressAction, isCategoryTrigger);
      });
    });

    toggle?.addEventListener('click', () => {
      if (!dashFrame) return;
      if (isMobile()) {
        dashFrame.classList.remove('sidebar-collapsed');
        const isOpen = dashFrame.classList.toggle('mobile-nav-open');
        document.body.classList.toggle('mobile-nav-open', isOpen);
        if (dashNav) dashNav.scrollTop = 0;
        setToggleIcon(isOpen);
        return;
      }
      const isCollapsed = dashFrame.classList.toggle('sidebar-collapsed');
      safeStorage.set('sidebarCollapsed', isCollapsed ? 'true' : 'false');
      if (dashNav) dashNav.scrollTop = 0;
      setToggleIcon(!isCollapsed);
    });

    mainContent?.addEventListener('click', (event) => {
      if (event.target.closest('.sidebar-toggle')) return;
      if (event.target.closest('.main-window-bar')) return;
      closeMobileNav();
    });

    sidebar?.addEventListener('click', (event) => {
      if (!isMobile() || !dashFrame?.classList.contains('mobile-nav-open')) return;
      const link = event.target.closest('a');
      if (!link || !link.classList.contains('active')) return;
      event.preventDefault();
      closeMobileNav();
    });

    const userMenus = document.querySelectorAll('[data-user-menu]');

    function closeUserMenus(except) {
      userMenus.forEach((menu) => {
        if (menu === except) return;
        menu.classList.remove('user-pill--open');
        menu.setAttribute('aria-expanded', 'false');
      });
    }

    userMenus.forEach((menu) => {
      menu.setAttribute('aria-expanded', 'false');
      menu.addEventListener('click', (event) => {
        if (event.target.closest('.user-menu')) return;
        event.preventDefault();
        const isOpen = menu.classList.contains('user-pill--open');
        closeUserMenus(menu);
        menu.classList.toggle('user-pill--open', !isOpen);
        menu.setAttribute('aria-expanded', !isOpen ? 'true' : 'false');
      });
      menu.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        event.preventDefault();
        menu.click();
      });
    });

    document.addEventListener('click', (event) => {
      if (event.target.closest('[data-user-menu]')) return;
      closeUserMenus();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      closeUserMenus();
    });
  </script>
  <script src="/version-badge.js?v=<%= assetVersion %>"></script>
  <script src="/brand-menu.js?v=<%= assetVersion %>"></script>
  <script src="/starfield-3d.js"></script>
  <script src="/pwa.js?v=<%= assetVersion %>"></script>
</body>
</html>
