<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Launcharr · Dashboard</title>
  <script>
    (function() {
      try {
        var stored = localStorage.getItem("launcharr-theme");
        var prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
        var mode = stored || (prefersLight ? "day" : "night");
        var brandTheme = localStorage.getItem("launcharr-brand-theme") || "pulsarr";
        document.documentElement.dataset.theme = mode;
        document.documentElement.dataset.brandTheme = brandTheme;
        var sidebarInvert = localStorage.getItem("launcharr-sidebar-invert") === "1";
        var squareCorners = localStorage.getItem("launcharr-square-corners") === "1";
        var bgMotionStored = localStorage.getItem("launcharr-bg-motion");
        var bgMotion = bgMotionStored === null ? true : bgMotionStored === "1";
        var maximizedWindow = localStorage.getItem("launcharr-maximized-window") === "1";
        document.documentElement.dataset.sidebarInvert = sidebarInvert ? "1" : "0";
        document.documentElement.dataset.squareCorners = squareCorners ? "1" : "0";
        document.documentElement.dataset.bgMotion = bgMotion ? "1" : "0";
        document.documentElement.dataset.maximized = maximizedWindow ? "1" : "0";
        var starDensity = 165;
        var starSpeed = 45;
        var starSize = 1.2;
        document.documentElement.style.setProperty("--star-density", String(starDensity));
        document.documentElement.style.setProperty("--star-speed", String(starSpeed) + "s");
        document.documentElement.style.setProperty("--star-size", String(starSize));
        var embedded = false;
        try {
          embedded = window.self !== window.top;
        } catch (err) {
          embedded = true;
        }
        document.documentElement.dataset.embedded = embedded ? "1" : "0";
        if (brandTheme === "custom") {
          var customHex = localStorage.getItem("launcharr-custom-color") || "#1cc6c2";
          var normalizedHex = /^#?[0-9a-fA-F]{6}$/.test(customHex) ? (customHex.charAt(0) === "#" ? customHex : "#" + customHex) : "#1cc6c2";
          var r = parseInt(normalizedHex.slice(1, 3), 16);
          var g = parseInt(normalizedHex.slice(3, 5), 16);
          var b = parseInt(normalizedHex.slice(5, 7), 16);
          var mix = function(base, target, amount) {
            return Math.round(base + (target - base) * amount);
          };
          var toHex = function(value) {
            var clamped = Math.max(0, Math.min(255, value));
            return clamped.toString(16).padStart(2, "0");
          };
          var dark = "#" + toHex(mix(r, 0, 0.4)) + toHex(mix(g, 0, 0.4)) + toHex(mix(b, 0, 0.4));
          var start = "#" + toHex(mix(r, 255, 0.35)) + toHex(mix(g, 255, 0.35)) + toHex(mix(b, 255, 0.35));
          var end = "#" + toHex(mix(r, 0, 0.2)) + toHex(mix(g, 0, 0.2)) + toHex(mix(b, 0, 0.2));
          var shadowR = mix(r, 0, 0.28);
          var shadowG = mix(g, 0, 0.28);
          var shadowB = mix(b, 0, 0.28);
          var linear = function(channel) {
            var value = channel / 255;
            return value <= 0.03928 ? value / 12.92 : Math.pow((value + 0.055) / 1.055, 2.4);
          };
          var luminance = 0.2126 * linear(r) + 0.7152 * linear(g) + 0.0722 * linear(b);
          var contrastWhite = 1.05 / (luminance + 0.05);
          var contrastBlack = (luminance + 0.05) / 0.05;
          var onBrand = contrastWhite >= contrastBlack ? "#ffffff" : "#081013";
          var onBrandMuted = contrastWhite >= contrastBlack ? "rgba(255,255,255,.78)" : "rgba(8,16,19,.72)";
          var onBrandIconFilter = contrastWhite >= contrastBlack ? "brightness(0) saturate(100%) invert(1)" : "brightness(0) saturate(100%)";
          document.documentElement.style.setProperty("--teal", normalizedHex.toLowerCase());
          document.documentElement.style.setProperty("--teal-dark", dark);
          document.documentElement.style.setProperty("--brand-rgb", r + "," + g + "," + b);
          document.documentElement.style.setProperty("--brand-btn-start", start);
          document.documentElement.style.setProperty("--brand-btn-mid", normalizedHex.toLowerCase());
          document.documentElement.style.setProperty("--brand-btn-end", end);
          document.documentElement.style.setProperty("--brand-btn-shadow", shadowR + "," + shadowG + "," + shadowB);
          document.documentElement.style.setProperty("--on-brand", onBrand);
          document.documentElement.style.setProperty("--on-brand-muted", onBrandMuted);
          document.documentElement.style.setProperty("--on-brand-icon-filter", onBrandIconFilter);
        }
      } catch (e) {}
    })();
  </script>
  <link rel="stylesheet" href="/styles.css?v=<%= assetVersion %>" />
  <link rel="stylesheet" href="/table-cards-overrides.css?v=<%= assetVersion %>" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" type="image/png" href="/icons/launcharr-icon.png" />
  <meta name="theme-color" content="#1cc6c2" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/icons/launcharr-icon.png" />
</head>
<body class="dash-body">
  <%
    const multiInstanceBaseIdsList = (Array.isArray(multiInstanceBaseIds) ? multiInstanceBaseIds : [])
      .map((item) => String(item || '').trim().toLowerCase())
      .filter(Boolean);
    const resolveAppBaseId = (value) => {
      const id = String(value || '').trim().toLowerCase();
      if (!id) return '';
      const matched = multiInstanceBaseIdsList
        .slice()
        .sort((a, b) => b.length - a.length)
        .find((baseId) => {
          if (id === baseId) return true;
          if (!id.startsWith(baseId + '-')) return false;
          return /^\d+$/.test(id.slice(baseId.length + 1));
        });
      return matched || id;
    };
    const isArrAppId = (value) => ['sonarr', 'radarr', 'lidarr', 'readarr'].includes(resolveAppBaseId(value));
    const hasBaseId = (ids, baseId) => Array.isArray(ids) && ids.some((id) => resolveAppBaseId(id) === baseId);
    const resolveAppIconPath = (appItem) => {
      const customIcon = String(appItem?.icon || '').trim();
      if (customIcon) return customIcon;
      const baseId = resolveAppBaseId(appItem?.id);
      if (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'seerr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission', 'qbittorrent', 'sabnzbd', 'jellyfin', 'emby', 'bazarr'].includes(baseId)) {
        return `/icons/${baseId}.png`;
      }
      return `/icons/${baseId || 'app'}.svg`;
    };
  %>
  <div class="dash-frame">
    <aside class="dash-sidebar">
      <div class="dash-brand">
        <span class="dash-logo">
          <img class="nav-icon app-icon" src="/icons/launcharr-icon.png" alt="Launcharr" />
        </span>
        <div>
          <div class="dash-title">Launcharr</div>
        </div>
      </div>

      <div class="dash-nav">
        <a class="nav-item active" href="/dashboard">
          <img class="nav-icon" src="/icons/dashboard.svg" alt="" />
          <span class="nav-label">Dashboard</span>
        </a>
        <% if (navCategories && navCategories.length) { %>
          <div class="nav-divider"></div>
          <div class="nav-accordion">
            <% navCategories.forEach((category) => { %>
              <% if (category.sidebarMenu) { %>
                <div class="nav-accordion-item nav-accordion-item--category">
                  <button class="nav-accordion-trigger nav-accordion-trigger--category" type="button">
                    <img class="nav-icon" src="<%= category.icon || '/icons/category.svg' %>" alt="" onerror="this.src='/icons/category.svg'" />
                    <span class="nav-label"><%= category.name %></span>
                  </button>
                  <div class="nav-accordion-panel nav-accordion-panel--category">
                    <div class="nav-accordion nav-accordion--nested">
                      <% category.apps.forEach((appItem) => { %>
                        <div class="nav-accordion-item">
                          <button class="nav-accordion-trigger" type="button">
                            <img class="nav-icon app-icon" src="<%= resolveAppIconPath(appItem) %>" alt="" onerror="this.src='/icons/app.svg'" />
                            <span class="nav-label"><%= appItem.name %></span>
                          </button>
                          <div class="nav-accordion-panel">
                            <% if (appItem.menuAccess.overview) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>">
                                <img class="nav-subicon" src="/icons/overview.svg" alt="" />
                                <span>Overview</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.launch) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>/launch" <%= appItem.effectiveLaunchMode === 'new-tab' ? 'target="_blank" rel="noreferrer"' : '' %>>
                                <img class="nav-subicon" src="/icons/launch.svg" alt="" />
                                <span>Launch</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.settings) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>/settings">
                                <img class="nav-subicon" src="/icons/settings.svg" alt="" />
                                <span>App settings</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.activity) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>/activity">
                                <img class="nav-subicon" src="/icons/activity-queue.svg" alt="" />
                                <span>Activity</span>
                              </a>
                            <% } %>
                          </div>
                        </div>
                      <% }) %>
                    </div>
                  </div>
                </div>
              <% } else { %>
                <% category.apps.forEach((appItem) => { %>
                  <div class="nav-accordion-item">
                    <button class="nav-accordion-trigger" type="button">
                      <img class="nav-icon app-icon" src="<%= resolveAppIconPath(appItem) %>" alt="" onerror="this.src='/icons/app.svg'" />
                      <span class="nav-label"><%= appItem.name %></span>
                    </button>
                    <div class="nav-accordion-panel">
                      <% if (appItem.menuAccess.overview) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>">
                          <img class="nav-subicon" src="/icons/overview.svg" alt="" />
                          <span>Overview</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.launch) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>/launch" <%= appItem.effectiveLaunchMode === 'new-tab' ? 'target="_blank" rel="noreferrer"' : '' %>>
                          <img class="nav-subicon" src="/icons/launch.svg" alt="" />
                          <span>Launch</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.settings) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>/settings">
                          <img class="nav-subicon" src="/icons/settings.svg" alt="" />
                          <span>App settings</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.activity) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>/activity">
                          <img class="nav-subicon" src="/icons/activity-queue.svg" alt="" />
                          <span>Activity</span>
                        </a>
                      <% } %>
                    </div>
                  </div>
                <% }) %>
              <% } %>
            <% }) %>
          </div>
        <% } %>
      </div>

      <div class="dash-user">
        <div class="user-pill user-pill--menu" data-user-menu role="button" tabindex="0" aria-haspopup="true" aria-expanded="false">
          <img class="user-avatar" src="<%= user.avatar || user.avatarFallback || '/icons/user-profile.svg' %>" alt="" onerror="this.onerror=null;this.src='<%= user.avatarFallback || '/icons/user-profile.svg' %>';" />
          <div class="user-meta">
            <span class="role"><%= role %></span>
            <div class="username"><%= user.username %></div>
            <% if (user.email) { %>
              <div class="email"><%= user.email %></div>
            <% } %>
          </div>
          <span class="user-pill-caret" aria-hidden="true"></span>
          <div class="user-menu" role="menu">
            <% if (actualRole === 'admin') { %>
              <a class="user-menu-item" href="/settings">
                <img class="user-menu-icon" src="/icons/settings.svg" alt="" />
                <span class="user-menu-text">Settings</span>
              </a>
            <% } %>
            <% if (actualRole === 'admin') { %>
              <a class="user-menu-item" href="/switch-view?role=<%= role === 'admin' ? 'user' : 'admin' %>">
                <img class="user-menu-icon" src="/icons/window.svg" alt="" />
                <span class="user-menu-text"><%= role === 'admin' ? 'User view' : 'Admin view' %></span>
              </a>
            <% } %>
            <a class="user-menu-item" href="/user-settings">
              <img class="user-menu-icon" src="/icons/user-profile.svg" alt="" />
              <span class="user-menu-text">User profile</span>
            </a>
            <div class="user-menu-divider"></div>
            <a class="user-menu-item" href="/logout">
              <img class="user-menu-icon" src="/icons/logout.svg" alt="" />
              <span class="user-menu-text">Sign out</span>
            </a>
          </div>
        </div>
      </div>
    </aside>

    <section class="dash-main">
      <div class="main-window-bar">
        <button class="sidebar-toggle main-toggle left-toggle" type="button" aria-label="Toggle sidebar">
          <img class="toggle-icon" src="/icons/sidebar-toggle.svg" alt="" />
        </button>
        <div class="main-window-title">
          <img class="main-window-icon" src="/icons/launcharr-icon.png" alt="" />
          <span class="main-window-app">Launcharr</span>
          <span class="main-window-rest">| Dashboard</span>
        </div>
        <div class="main-window-spacer"></div>
        <div class="main-window-status">
          <span class="status-dot"></span>
        </div>
      </div>

      <% if (dashboardModules.length) { %>
        <%
          const hasPlexActive = dashboardModules.some((item) => item.app.id === 'plex' && item.element.id === 'active' && !item.mediaCombined);
          const hasPlexRecent = dashboardModules.some((item) => item.app.id === 'plex' && item.element.id === 'recent' && !item.mediaCombined);
          const hasPlexWatchlisted = dashboardModules.some((item) => item.app.id === 'plex' && item.element.id === 'watchlisted');
          const hasTautulliStats = dashboardModules.some((item) => item.app.id === 'tautulli' && item.element.id === 'watch-stats');
          const hasTautulliStatsWheel = dashboardModules.some((item) => item.app.id === 'tautulli' && item.element.id === 'watch-stats-wheel');
          const hasMediaCombinedModules = dashboardModules.some((item) => item.mediaCombined && ['active', 'recent'].includes(item.element.id));
          const hasRequestModules = dashboardModules.some((item) => ['pulsarr', 'seerr'].includes(item.app.id) && (item.element.id === 'recent-requests' || item.element.id === 'most-watchlisted'));
        %>
        <div class="plex-overview">
          <% dashboardModules.forEach((item) => { %>
            <% if (item.mediaCombined && item.element.id === 'active') { %>
              <%
                const moduleId = 'mediacombined-active';
                const controlPrefix = 'mediacombinedActive';
                const combinedSourceApps = Array.isArray(item.mediaCombined?.appIds)
                  ? item.mediaCombined.appIds
                    .map((appId) => apps.find((entry) => entry.id === appId))
                    .filter(Boolean)
                  : [];
                const defaultLogo = '/icons/media-play.svg';
              %>
              <section class="plex-module plex-module--no-subtitle" id="<%= moduleId %>">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img
                        class="plex-logo"
                        id="<%= controlPrefix %>Logo"
                        src="<%= defaultLogo %>"
                        data-default-icon="<%= defaultLogo %>"
                        alt="Combined media"
                        loading="eager"
                      />
                      <span>Active Streams</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>
                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <% if (combinedSourceApps.length > 1) { %>
                      <div class="plex-select plex-icon plex-filter-media" title="Source">
                        <select id="<%= controlPrefix %>SourceFilter" aria-label="Source">
                          <option value="all" selected>All</option>
                          <% combinedSourceApps.forEach((sourceApp) => { %>
                            <option value="<%= sourceApp.id %>" data-icon="<%= sourceApp.id === 'jellyfin' ? '/icons/jellyfin.png' : (sourceApp.id === 'emby' ? '/icons/emby.png' : '/icons/plex.png') %>"><%= sourceApp.name %></option>
                          <% }) %>
                        </select>
                      </div>
                    <% } %>
                    <button class="plex-iconbtn" id="<%= controlPrefix %>PrevBtn" type="button" aria-label="Previous"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="<%= controlPrefix %>NextBtn" type="button" aria-label="Next"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= moduleId %>" data-collapse-global="true">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel">
                  <div id="<%= controlPrefix %>Viewport" class="plex-carousel-viewport">
                    <div id="<%= controlPrefix %>Track" class="plex-carousel-track">
                      <div class="plex-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (item.mediaCombined && item.element.id === 'recent') { %>
              <%
                const moduleId = 'mediacombined-recent';
                const controlPrefix = 'mediacombinedRecent';
                const combinedSourceApps = Array.isArray(item.mediaCombined?.appIds)
                  ? item.mediaCombined.appIds
                    .map((appId) => apps.find((entry) => entry.id === appId))
                    .filter(Boolean)
                  : [];
                const defaultLogo = '/icons/media-play.svg';
              %>
              <section class="plex-module plex-module--no-subtitle" id="<%= moduleId %>">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img
                        class="plex-logo"
                        id="<%= controlPrefix %>Logo"
                        src="<%= defaultLogo %>"
                        data-default-icon="<%= defaultLogo %>"
                        alt="Combined media"
                        loading="eager"
                      />
                      <span>Recently Added</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>
                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <% if (combinedSourceApps.length > 1) { %>
                      <div class="plex-select plex-icon plex-filter-media" title="Source">
                        <select id="<%= controlPrefix %>SourceFilter" aria-label="Source">
                          <option value="all" selected>All</option>
                          <% combinedSourceApps.forEach((sourceApp) => { %>
                            <option value="<%= sourceApp.id %>" data-icon="<%= sourceApp.id === 'jellyfin' ? '/icons/jellyfin.png' : (sourceApp.id === 'emby' ? '/icons/emby.png' : '/icons/plex.png') %>"><%= sourceApp.name %></option>
                          <% }) %>
                        </select>
                      </div>
                    <% } %>
                    <div class="plex-select plex-icon plex-filter-media" title="Media type">
                      <select id="<%= controlPrefix %>TypeFilter" aria-label="Media type">
                        <option value="movie" selected>Movies</option>
                        <option value="show">TV</option>
                        <option value="all">All</option>
                      </select>
                    </div>
                    <div class="plex-select plex-xsmall" title="Limit">
                      <select id="<%= controlPrefix %>LimitSelect" aria-label="Limit">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                      </select>
                    </div>
                    <button class="plex-iconbtn" id="<%= controlPrefix %>PrevBtn" type="button" aria-label="Previous"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="<%= controlPrefix %>NextBtn" type="button" aria-label="Next"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= moduleId %>" data-collapse-global="true">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel">
                  <div id="<%= controlPrefix %>Viewport" class="plex-carousel-viewport">
                    <div id="<%= controlPrefix %>Track" class="plex-carousel-track">
                      <div class="plex-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (item.app.id === 'plex' && item.element.id === 'active' && !item.mediaCombined) { %>
              <section class="plex-module plex-module--no-subtitle" id="plex-active">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="/icons/plex.png" alt="Plex" loading="eager" />
                      <span>Active Streams</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>
                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <button class="plex-iconbtn" id="plexActivePrevBtn" type="button" aria-label="Previous"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="plexActiveNextBtn" type="button" aria-label="Next"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="plex-active">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel">
                  <div id="plexActiveViewport" class="plex-carousel-viewport">
                    <div id="plexActiveTrack" class="plex-carousel-track">
                      <div class="plex-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (item.app.id === 'plex' && item.element.id === 'recent' && !item.mediaCombined) { %>
              <section class="plex-module plex-module--no-subtitle" id="plex-recent">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="/icons/plex.png" alt="Plex" loading="eager" />
                      <span>Recently Added</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>

                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <div class="plex-select plex-icon plex-filter-media" id="plexRecentTypeWrap" title="Media type">
                      <select id="plexRecentTypeFilter" aria-label="Media type">
                        <option value="movie" selected>Movies</option>
                        <option value="show">TV</option>
                      </select>
                    </div>

                    <div class="plex-select plex-icon plex-filter-window" title="Window">
                      <select id="plexRecentWindowFilter" aria-label="Window">
                        <option value="today">Today</option>
                        <option value="week">Week</option>
                        <option value="month" selected>Month</option>
                      </select>
                    </div>

                    <button class="plex-iconbtn" id="plexRecentPrevBtn" type="button" aria-label="Previous"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="plexRecentNextBtn" type="button" aria-label="Next"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="plex-recent">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel">
                  <div id="plexRecentViewport" class="plex-carousel-viewport">
                    <div id="plexRecentTrack" class="plex-carousel-track">
                      <div class="plex-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (item.app.id === 'plex' && item.element.id === 'watchlisted') { %>
              <section class="plex-module plex-module--no-subtitle" id="plex-watchlisted">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="/icons/plex.png" alt="Plex" loading="eager" />
                      <span>Most Watchlisted This Week</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>

                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <div class="plex-select plex-icon plex-filter-media" id="plexWatchlistedTypeWrap" title="Media type">
                      <select id="plexWatchlistedTypeFilter" aria-label="Media type">
                        <option value="all" selected>All</option>
                        <option value="movie">Movies</option>
                        <option value="show">TV</option>
                      </select>
                    </div>

                    <button class="plex-iconbtn" id="plexWatchlistedPrevBtn" type="button" aria-label="Previous"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="plexWatchlistedNextBtn" type="button" aria-label="Next"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="plex-watchlisted">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel">
                  <div id="plexWatchlistedViewport" class="plex-carousel-viewport">
                    <div id="plexWatchlistedTrack" class="plex-carousel-track">
                      <div class="plex-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (['jellyfin', 'emby'].includes(item.app.id) && item.element.id === 'active' && !item.mediaCombined) { %>
              <% const mediaPrefix = item.app.id; %>
              <section class="plex-module plex-module--no-subtitle" id="<%= mediaPrefix %>-active">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="<%= item.app.icon || '/icons/' + item.app.id + '.png' %>" alt="<%= item.app.name %>" loading="eager" onerror="this.src='/icons/app.svg'" />
                      <span>Active Streams</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>
                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <button class="plex-iconbtn" id="<%= mediaPrefix %>ActivePrevBtn" type="button" aria-label="Previous"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="<%= mediaPrefix %>ActiveNextBtn" type="button" aria-label="Next"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= mediaPrefix %>-active">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel">
                  <div id="<%= mediaPrefix %>ActiveViewport" class="plex-carousel-viewport">
                    <div id="<%= mediaPrefix %>ActiveTrack" class="plex-carousel-track">
                      <div class="plex-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (['jellyfin', 'emby'].includes(item.app.id) && item.element.id === 'recent' && !item.mediaCombined) { %>
              <% const mediaPrefix = item.app.id; %>
              <section class="plex-module plex-module--no-subtitle" id="<%= mediaPrefix %>-recent">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="<%= item.app.icon || '/icons/' + item.app.id + '.png' %>" alt="<%= item.app.name %>" loading="eager" onerror="this.src='/icons/app.svg'" />
                      <span>Recently Added</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>
                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <div class="plex-select plex-icon plex-filter-media" id="<%= mediaPrefix %>RecentTypeWrap" title="Media type">
                      <select id="<%= mediaPrefix %>RecentTypeFilter" aria-label="Media type">
                        <option value="movie" selected>Movies</option>
                        <option value="show">TV</option>
                        <option value="all">All</option>
                      </select>
                    </div>
                    <div class="plex-select plex-xsmall" title="Limit">
                      <select id="<%= mediaPrefix %>RecentLimitSelect" aria-label="Limit">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                      </select>
                    </div>
                    <button class="plex-iconbtn" id="<%= mediaPrefix %>RecentPrevBtn" type="button" aria-label="Previous"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="<%= mediaPrefix %>RecentNextBtn" type="button" aria-label="Next"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= mediaPrefix %>-recent">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel">
                  <div id="<%= mediaPrefix %>RecentViewport" class="plex-carousel-viewport">
                    <div id="<%= mediaPrefix %>RecentTrack" class="plex-carousel-track">
                      <div class="plex-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (item.app.id === 'tautulli' && item.element.id === 'watch-stats') { %>
              <section class="plex-module plex-module--no-subtitle" id="tautulli-stats">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="/icons/tautulli.png" alt="Tautulli" loading="eager" />
                      <span>Watch Statistics</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>
                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <button class="plex-iconbtn" id="tautulliStatsPrevBtn" type="button" aria-label="Previous"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="tautulliStatsNextBtn" type="button" aria-label="Next"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="tautulli-stats">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel">
                  <div id="tautulliStatsViewport" class="plex-carousel-viewport">
                    <div id="tautulliStatsTrack" class="plex-carousel-track">
                      <div class="plex-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (item.app.id === 'tautulli' && item.element.id === 'watch-stats-wheel') { %>
              <section class="plex-module plex-module--no-subtitle" id="tautulli-stats-wheel">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="/icons/tautulli.png" alt="Tautulli" loading="eager" />
                      <span>Watch Statistics Wheel</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>
                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <button class="plex-iconbtn" id="tautulliWheelPrevBtn" type="button" aria-label="Previous"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="tautulliWheelNextBtn" type="button" aria-label="Next"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="tautulli-stats-wheel">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel">
                  <div id="tautulliWheelViewport" class="plex-carousel-viewport">
                    <div id="tautulliWheelTrack" class="plex-carousel-track">
                      <div class="plex-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (['prowlarr', 'jackett'].includes(item.app.id) && item.element.id === 'search') { %>
              <% const searchPrefix = item.app.id; %>
              <% const searchActionLabel = item.app.id === 'prowlarr' ? 'Action' : 'Open'; %>
              <% const rawSearchVisibleRows = Number(item.element?.queueVisibleRows); %>
              <% const searchVisibleRows = Number.isFinite(rawSearchVisibleRows) ? Math.max(5, Math.min(100, rawSearchVisibleRows)) : 25; %>
              <% const searchPageSizeOptions = [5, 10, 25, 50]; %>
              <% const searchPageSize = 25; %>
              <section class="plex-module plex-module--no-subtitle" id="<%= searchPrefix %>-search">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="<%= resolveAppIconPath(item.app) %>" alt="<%= item.app.name %>" loading="eager" />
                      <span>Indexer Search</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>

                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <div class="plex-search" title="Search">
                      <input id="<%= searchPrefix %>SearchInput" type="text" placeholder="Search indexers" aria-label="Search indexers" />
                      <button class="plex-search-btn" id="<%= searchPrefix %>SearchButton" type="button">Search</button>
                    </div>

                    <div class="plex-select plex-icon plex-filter-source" title="Indexer type">
                      <select id="<%= searchPrefix %>SearchTypeFilter" aria-label="Indexer type">
                        <option value="all" data-icon="/icons/all-type.svg" selected>All indexers</option>
                        <option value="usenet" data-icon="/icons/download.svg">Usenet</option>
                        <option value="torrent" data-icon="/icons/download.svg">Torrent</option>
                      </select>
                    </div>

                    <div class="plex-select plex-icon plex-filter-source" title="Available indexers">
                      <select id="<%= searchPrefix %>SearchIndexerFilter" aria-label="Available indexers">
                        <option value="all" data-icon="/icons/all-type.svg" selected>All available indexers</option>
                      </select>
                    </div>

                    <div class="plex-select plex-icon plex-filter-status" title="Top level categories">
                      <select id="<%= searchPrefix %>SearchCategoryFilter" aria-label="Top level categories">
                        <option value="all" data-icon="/icons/all-type.svg" selected>All top level categories</option>
                      </select>
                    </div>

                    <div class="plex-select plex-xsmall" title="Limit">
                      <select id="<%= searchPrefix %>SearchLimitSelect" aria-label="Limit">
                        <% searchPageSizeOptions.forEach((limitValue) => { %>
                          <option value="<%= limitValue %>" <%= limitValue === searchPageSize ? 'selected' : '' %>><%= limitValue %></option>
                        <% }) %>
                      </select>
                    </div>

                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= searchPrefix %>-search" data-collapse-global="true">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel queue-panel">
                  <div class="queue-table queue-table--manual queue-hide-timeleft queue-hide-progress indexer-table" style="--queue-visible-rows:<%= searchVisibleRows %>">
                    <div class="queue-row header indexer-head">
                      <div class="queue-col-title">Name</div>
                      <div class="queue-col-detail">Peers</div>
                      <div class="queue-col-subdetail">Quality</div>
                      <div class="queue-col-size">Protocol</div>
                      <div class="queue-col-protocol"><%= searchActionLabel %></div>
                    </div>
                    <div id="<%= searchPrefix %>SearchResults" class="queue-body indexer-results">
                      <div class="queue-row indexer-row indexer-row--empty">
                        <div class="queue-col-title">Enter a search term to get results.</div>
                      </div>
                    </div>
                  </div>
                  <div class="queue-pagination indexer-pagination">
                    <button class="plex-iconbtn queue-page-prev" id="<%= searchPrefix %>SearchPrevBtn" type="button" aria-label="Previous page"><div class="plex-chev plex-left"></div></button>
                    <span id="<%= searchPrefix %>SearchPageLabel" class="queue-page-label">Page 1</span>
                    <button class="plex-iconbtn queue-page-next" id="<%= searchPrefix %>SearchNextBtn" type="button" aria-label="Next page"><div class="plex-chev plex-right"></div></button>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (isArrAppId(item.app.id) && item.element.id === 'downloading-soon') { %>
              <%
                const isCombined = Boolean(item.arrCombined);
                const combinedApps = isCombined ? item.arrCombined.appIds : [];
                const combinedSourceEntries = isCombined
                  ? combinedApps
                    .map((appId) => {
                      const normalizedId = String(appId || '').trim().toLowerCase();
                      const sourceApp = (Array.isArray(apps) ? apps : []).find((candidate) => String(candidate?.id || '').trim().toLowerCase() === normalizedId);
                      return {
                        id: normalizedId,
                        name: String(sourceApp?.name || appId || normalizedId || 'Instance').trim(),
                        baseId: resolveAppBaseId(normalizedId),
                        optionLabel: String(sourceApp?.name || appId || normalizedId || 'Instance').trim(),
                      };
                    })
                    .filter((entry) => entry.id)
                  : [];
                const combinedBaseCounts = combinedSourceEntries.reduce((acc, entry) => {
                  if (!entry.baseId) return acc;
                  acc[entry.baseId] = (acc[entry.baseId] || 0) + 1;
                  return acc;
                }, {});
                const showCombinedMediaFilter = isCombined && Object.keys(combinedBaseCounts).length > 1;
                const showCombinedInstanceFilter = isCombined && Object.values(combinedBaseCounts).some((count) => count > 1);
                const combinedModuleKey = isCombined ? String(item.arrCombined?.moduleKey || 'arrcombinedsoon').trim() : String(item.app.id || '').trim();
                const moduleId = combinedModuleKey + '-downloading-soon';
                const controlPrefix = combinedModuleKey + 'Soon';
                const logo = isCombined ? (item.arrCombined?.iconPath || '/icons/app-arr.svg') : resolveAppIconPath(item.app);
                const title = isCombined ? (item.arrCombined?.displayName || 'Combined Downloading Soon') : 'Downloading Soon';
              %>
              <section class="plex-module plex-module--no-subtitle" id="<%= moduleId %>">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="<%= logo %>" alt="<%= isCombined ? 'Combined ARR' : item.app.name %>" loading="eager" />
                      <span><%= title %></span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>

                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <% if (showCombinedMediaFilter || showCombinedInstanceFilter) { %>
                      <div
                        class="arr-filter-popover"
                        data-media-select-id="<%= showCombinedMediaFilter ? (controlPrefix + 'TypeFilter') : '' %>"
                        data-source-select-id="<%= showCombinedInstanceFilter ? (controlPrefix + 'SourceFilter') : '' %>"
                      >
                        <button class="arr-filter-trigger" type="button" aria-label="Open filters" title="Filters" aria-haspopup="true" aria-expanded="false"></button>
                        <div class="arr-filter-menu plex-hidden">
                          <% if (showCombinedMediaFilter) { %>
                            <div class="arr-filter-section">
                              <div class="arr-filter-label">Media</div>
                              <div class="arr-filter-options" data-options-target="media"></div>
                            </div>
                            <select id="<%= controlPrefix %>TypeFilter" class="arr-filter-native-select" aria-label="Media type">
                              <option value="all" data-icon="/icons/all-type.svg" selected>All</option>
                              <% if (hasBaseId(combinedApps, 'radarr')) { %><option value="movie" data-icon="/icons/movie.svg">Movies</option><% } %>
                              <% if (hasBaseId(combinedApps, 'sonarr')) { %><option value="tv" data-icon="/icons/tv.svg">TV</option><% } %>
                              <% if (hasBaseId(combinedApps, 'lidarr')) { %><option value="music" data-icon="/icons/music.svg">Music</option><% } %>
                              <% if (hasBaseId(combinedApps, 'readarr')) { %><option value="book" data-icon="/icons/book.svg">Books</option><% } %>
                            </select>
                          <% } %>
                          <% if (showCombinedInstanceFilter) { %>
                            <div class="arr-filter-section">
                              <div class="arr-filter-label">Instance</div>
                              <div class="arr-filter-options" data-options-target="source"></div>
                            </div>
                            <select id="<%= controlPrefix %>SourceFilter" class="arr-filter-native-select" aria-label="Instance filter">
                              <option value="all" data-base-id="all" data-icon="/icons/all-type.svg" selected>All instances</option>
                              <% combinedSourceEntries.forEach((entry) => { %>
                                <option value="<%= entry.id %>" data-base-id="<%= entry.baseId %>" data-icon="<%= ['radarr', 'sonarr', 'lidarr', 'readarr'].includes(entry.baseId) ? ('/icons/' + entry.baseId + '.png') : '/icons/app-arr.svg' %>"><%= entry.optionLabel %></option>
                              <% }) %>
                            </select>
                          <% } %>
                        </div>
                      </div>
                    <% } %>
                    <div class="plex-select plex-icon plex-filter-window" title="Window">
                      <select id="<%= controlPrefix %>WindowFilter" aria-label="Window">
                        <option value="today">Today</option>
                        <option value="week">Week</option>
                        <option value="month" selected>Month</option>
                      </select>
                    </div>

                    <button class="plex-iconbtn" id="<%= controlPrefix %>PrevBtn" type="button" aria-label="Previous"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="<%= controlPrefix %>NextBtn" type="button" aria-label="Next"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= moduleId %>" data-collapse-global="true">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel">
                  <div id="<%= controlPrefix %>Viewport" class="plex-carousel-viewport">
                    <div id="<%= controlPrefix %>Track" class="plex-carousel-track">
                      <div class="plex-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (isArrAppId(item.app.id) && item.element.id === 'recently-downloaded') { %>
              <%
                const isCombined = Boolean(item.arrCombined);
                const combinedApps = isCombined ? item.arrCombined.appIds : [];
                const combinedSourceEntries = isCombined
                  ? combinedApps
                    .map((appId) => {
                      const normalizedId = String(appId || '').trim().toLowerCase();
                      const sourceApp = (Array.isArray(apps) ? apps : []).find((candidate) => String(candidate?.id || '').trim().toLowerCase() === normalizedId);
                      return {
                        id: normalizedId,
                        name: String(sourceApp?.name || appId || normalizedId || 'Instance').trim(),
                        baseId: resolveAppBaseId(normalizedId),
                        optionLabel: String(sourceApp?.name || appId || normalizedId || 'Instance').trim(),
                      };
                    })
                    .filter((entry) => entry.id)
                  : [];
                const combinedBaseCounts = combinedSourceEntries.reduce((acc, entry) => {
                  if (!entry.baseId) return acc;
                  acc[entry.baseId] = (acc[entry.baseId] || 0) + 1;
                  return acc;
                }, {});
                const showCombinedMediaFilter = isCombined && Object.keys(combinedBaseCounts).length > 1;
                const showCombinedInstanceFilter = isCombined && Object.values(combinedBaseCounts).some((count) => count > 1);
                const combinedModuleKey = isCombined ? String(item.arrCombined?.moduleKey || 'arrcombinedrecent').trim() : String(item.app.id || '').trim();
                const moduleId = combinedModuleKey + '-recently-downloaded';
                const controlPrefix = combinedModuleKey + 'Recent';
                const logo = isCombined ? (item.arrCombined?.iconPath || '/icons/app-arr.svg') : resolveAppIconPath(item.app);
                const title = isCombined ? (item.arrCombined?.displayName || 'Combined Recently Downloaded') : 'Recently Downloaded';
              %>
              <section class="plex-module plex-module--no-subtitle" id="<%= moduleId %>">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="<%= logo %>" alt="<%= isCombined ? 'Combined ARR' : item.app.name %>" loading="eager" />
                      <span><%= title %></span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>

                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <% if (showCombinedMediaFilter || showCombinedInstanceFilter) { %>
                      <div
                        class="arr-filter-popover"
                        data-media-select-id="<%= showCombinedMediaFilter ? (controlPrefix + 'MediaFilter') : '' %>"
                        data-source-select-id="<%= showCombinedInstanceFilter ? (controlPrefix + 'SourceFilter') : '' %>"
                      >
                        <button class="arr-filter-trigger" type="button" aria-label="Open filters" title="Filters" aria-haspopup="true" aria-expanded="false"></button>
                        <div class="arr-filter-menu plex-hidden">
                          <% if (showCombinedMediaFilter) { %>
                            <div class="arr-filter-section">
                              <div class="arr-filter-label">Media</div>
                              <div class="arr-filter-options" data-options-target="media"></div>
                            </div>
                            <select id="<%= controlPrefix %>MediaFilter" class="arr-filter-native-select" aria-label="Media type">
                              <option value="all" data-icon="/icons/all-type.svg" selected>All</option>
                              <% if (hasBaseId(combinedApps, 'radarr')) { %><option value="movie" data-icon="/icons/movie.svg">Movies</option><% } %>
                              <% if (hasBaseId(combinedApps, 'sonarr')) { %><option value="tv" data-icon="/icons/tv.svg">TV</option><% } %>
                              <% if (hasBaseId(combinedApps, 'lidarr')) { %><option value="music" data-icon="/icons/music.svg">Music</option><% } %>
                              <% if (hasBaseId(combinedApps, 'readarr')) { %><option value="book" data-icon="/icons/book.svg">Books</option><% } %>
                            </select>
                          <% } %>
                          <% if (showCombinedInstanceFilter) { %>
                            <div class="arr-filter-section">
                              <div class="arr-filter-label">Instance</div>
                              <div class="arr-filter-options" data-options-target="source"></div>
                            </div>
                            <select id="<%= controlPrefix %>SourceFilter" class="arr-filter-native-select" aria-label="Instance filter">
                              <option value="all" data-base-id="all" data-icon="/icons/all-type.svg" selected>All instances</option>
                              <% combinedSourceEntries.forEach((entry) => { %>
                                <option value="<%= entry.id %>" data-base-id="<%= entry.baseId %>" data-icon="<%= ['radarr', 'sonarr', 'lidarr', 'readarr'].includes(entry.baseId) ? ('/icons/' + entry.baseId + '.png') : '/icons/app-arr.svg' %>"><%= entry.optionLabel %></option>
                              <% }) %>
                            </select>
                          <% } %>
                        </div>
                      </div>
                    <% } %>
                    <div class="plex-select plex-icon plex-filter-event" title="Event type">
                      <select id="<%= controlPrefix %>TypeFilter" aria-label="Event type">
                        <option value="imported" selected>Imported</option>
                        <option value="grabbed">Grabbed</option>
                        <option value="failed">Failed</option>
                        <option value="all">All</option>
                      </select>
                    </div>

                    <div class="plex-select plex-icon plex-filter-window" title="Window">
                      <select id="<%= controlPrefix %>WindowFilter" aria-label="Window">
                        <option value="today">Today</option>
                        <option value="week">Week</option>
                        <option value="month" selected>Month</option>
                      </select>
                    </div>

                    <button class="plex-iconbtn" id="<%= controlPrefix %>PrevBtn" type="button" aria-label="Previous"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="<%= controlPrefix %>NextBtn" type="button" aria-label="Next"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= moduleId %>" data-collapse-global="true">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel">
                  <div id="<%= controlPrefix %>Viewport" class="plex-carousel-viewport">
                    <div id="<%= controlPrefix %>Track" class="plex-carousel-track">
                      <div class="plex-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (isArrAppId(item.app.id) && item.element.id === 'activity-queue') { %>
              <%
                const isCombined = Boolean(item.arrCombined);
                const combinedApps = isCombined ? item.arrCombined.appIds : [];
                const combinedSourceEntries = isCombined
                  ? combinedApps
                    .map((appId) => {
                      const normalizedId = String(appId || '').trim().toLowerCase();
                      const sourceApp = (Array.isArray(apps) ? apps : []).find((candidate) => String(candidate?.id || '').trim().toLowerCase() === normalizedId);
                      return {
                        id: normalizedId,
                        name: String(sourceApp?.name || appId || normalizedId || 'Instance').trim(),
                        baseId: resolveAppBaseId(normalizedId),
                        optionLabel: String(sourceApp?.name || appId || normalizedId || 'Instance').trim(),
                      };
                    })
                    .filter((entry) => entry.id)
                  : [];
                const combinedBaseCounts = combinedSourceEntries.reduce((acc, entry) => {
                  if (!entry.baseId) return acc;
                  acc[entry.baseId] = (acc[entry.baseId] || 0) + 1;
                  return acc;
                }, {});
                const showCombinedMediaFilter = isCombined ? Object.keys(combinedBaseCounts).length > 1 : true;
                const showCombinedInstanceFilter = isCombined && Object.values(combinedBaseCounts).some((count) => count > 1);
                const combinedModuleKey = isCombined ? String(item.arrCombined?.moduleKey || 'arrcombinedqueue').trim() : String(item.app.id || '').trim();
                const moduleId = combinedModuleKey + '-activity-queue';
                const controlPrefix = combinedModuleKey + 'Queue';
                const logo = isCombined ? (item.arrCombined?.iconPath || '/icons/app-arr.svg') : resolveAppIconPath(item.app);
                const title = isCombined ? (item.arrCombined?.displayName || 'Combined Activity Queue') : 'Activity Queue';
                const combinedQueueDisplay = isCombined ? arrCombinedQueueDisplay : null;
                const queueDisplay = combinedQueueDisplay || item.element || {};
                const queueClasses = [
                  queueDisplay.queueShowDetail === false ? 'queue-hide-detail' : '',
                  queueDisplay.queueShowSubDetail === false ? 'queue-hide-subdetail' : '',
                  queueDisplay.queueShowSize === false ? 'queue-hide-size' : '',
                  queueDisplay.queueShowProtocol === false ? 'queue-hide-protocol' : '',
                  queueDisplay.queueShowTimeLeft === false ? 'queue-hide-timeleft' : '',
                  queueDisplay.queueShowProgress === false ? 'queue-hide-progress' : '',
                ].filter(Boolean).join(' ');
                const queueVisibleRows = queueDisplay.queueVisibleRows || 10;
              %>
              <section class="plex-module plex-module--no-subtitle" id="<%= moduleId %>">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="<%= logo %>" alt="<%= isCombined ? 'Combined ARR' : item.app.name %>" loading="eager" />
                      <span><%= title %></span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>

                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <% if (isCombined) { %>
                      <% if (showCombinedMediaFilter || showCombinedInstanceFilter) { %>
                        <div
                          class="arr-filter-popover"
                          data-media-select-id="<%= showCombinedMediaFilter ? (controlPrefix + 'TypeFilter') : '' %>"
                          data-source-select-id="<%= showCombinedInstanceFilter ? (controlPrefix + 'SourceFilter') : '' %>"
                        >
                          <button class="arr-filter-trigger" type="button" aria-label="Open filters" title="Filters" aria-haspopup="true" aria-expanded="false"></button>
                          <div class="arr-filter-menu plex-hidden">
                            <% if (showCombinedMediaFilter) { %>
                              <div class="arr-filter-section">
                                <div class="arr-filter-label">Media</div>
                                <div class="arr-filter-options" data-options-target="media"></div>
                              </div>
                              <select id="<%= controlPrefix %>TypeFilter" class="arr-filter-native-select" aria-label="Queue type">
                                <option value="all" data-icon="/icons/all-type.svg" selected>All</option>
                                <% if (hasBaseId(combinedApps, 'sonarr')) { %><option value="tv" data-icon="/icons/tv.svg">TV</option><% } %>
                                <% if (hasBaseId(combinedApps, 'radarr')) { %><option value="movie" data-icon="/icons/movie.svg">Movies</option><% } %>
                                <% if (hasBaseId(combinedApps, 'lidarr')) { %><option value="music" data-icon="/icons/music.svg">Music</option><% } %>
                                <% if (hasBaseId(combinedApps, 'readarr')) { %><option value="book" data-icon="/icons/book.svg">Books</option><% } %>
                              </select>
                            <% } %>
                            <% if (showCombinedInstanceFilter) { %>
                              <div class="arr-filter-section">
                                <div class="arr-filter-label">Instance</div>
                                <div class="arr-filter-options" data-options-target="source"></div>
                              </div>
                              <select id="<%= controlPrefix %>SourceFilter" class="arr-filter-native-select" aria-label="Instance filter">
                                <option value="all" data-base-id="all" data-icon="/icons/all-type.svg" selected>All instances</option>
                                <% combinedSourceEntries.forEach((entry) => { %>
                                  <option value="<%= entry.id %>" data-base-id="<%= entry.baseId %>" data-icon="<%= ['radarr', 'sonarr', 'lidarr', 'readarr'].includes(entry.baseId) ? ('/icons/' + entry.baseId + '.png') : '/icons/app-arr.svg' %>"><%= entry.optionLabel %></option>
                                <% }) %>
                              </select>
                            <% } %>
                          </div>
                        </div>
                      <% } %>
                    <% } else { %>
                      <div class="plex-select plex-icon plex-filter-media" title="Type">
                        <select id="<%= controlPrefix %>TypeFilter" aria-label="Queue type">
                          <option value="all" selected>All</option>
                          <% if (resolveAppBaseId(item.app.id) === 'sonarr') { %>
                            <option value="tv">TV</option>
                          <% } %>
                          <% if (resolveAppBaseId(item.app.id) === 'radarr') { %>
                            <option value="movie">Movies</option>
                          <% } %>
                          <% if (resolveAppBaseId(item.app.id) === 'lidarr') { %>
                            <option value="music">Music</option>
                          <% } %>
                          <% if (resolveAppBaseId(item.app.id) === 'readarr') { %>
                            <option value="book">Books</option>
                          <% } %>
                        </select>
                      </div>
                    <% } %>
                    <div class="plex-select plex-xsmall" title="Per page">
                      <select id="<%= controlPrefix %>LimitFilter" aria-label="Items per page">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                      </select>
                    </div>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= moduleId %>" data-collapse-global="true">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel queue-panel">
                  <div class="queue-table <%= queueClasses %>" data-page-size-select-id="<%= controlPrefix %>LimitFilter" style="--queue-visible-rows:<%= queueVisibleRows %>">
                    <div class="queue-row header">
                      <div class="queue-col-title">Title</div>
                      <div class="queue-col-detail"><%= isCombined ? 'Detail' : (resolveAppBaseId(item.app.id) === 'lidarr' ? 'Album' : (resolveAppBaseId(item.app.id) === 'readarr' ? 'Author' : (resolveAppBaseId(item.app.id) === 'radarr' ? 'Year' : 'Episode'))) %></div>
                      <div class="queue-col-subdetail"><%= isCombined ? 'Sub-detail' : (resolveAppBaseId(item.app.id) === 'lidarr' ? 'Track' : (resolveAppBaseId(item.app.id) === 'readarr' ? 'Book' : (resolveAppBaseId(item.app.id) === 'radarr' ? 'Studio' : 'Episode Title'))) %></div>
                      <div class="queue-col-size">Quality</div>
                      <div class="queue-col-protocol">Protocol</div>
                      <div class="queue-col-time">Time Left</div>
                      <div class="queue-col-progress">Progress</div>
                    </div>
                    <div id="<%= controlPrefix %>Body" class="queue-body">
                      <div class="queue-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (isArrAppId(item.app.id) && item.element.id === 'calendar') { %>
              <%
                const isCombined = Boolean(item.arrCombined);
                const combinedApps = isCombined ? item.arrCombined.appIds : [];
                const combinedSourceEntries = isCombined
                  ? combinedApps
                    .map((appId) => {
                      const normalizedId = String(appId || '').trim().toLowerCase();
                      const sourceApp = (Array.isArray(apps) ? apps : []).find((candidate) => String(candidate?.id || '').trim().toLowerCase() === normalizedId);
                      return {
                        id: normalizedId,
                        name: String(sourceApp?.name || appId || normalizedId || 'Instance').trim(),
                        baseId: resolveAppBaseId(normalizedId),
                        optionLabel: String(sourceApp?.name || appId || normalizedId || 'Instance').trim(),
                      };
                    })
                    .filter((entry) => entry.id)
                  : [];
                const combinedBaseCounts = combinedSourceEntries.reduce((acc, entry) => {
                  if (!entry.baseId) return acc;
                  acc[entry.baseId] = (acc[entry.baseId] || 0) + 1;
                  return acc;
                }, {});
                const showCombinedMediaFilter = isCombined && Object.keys(combinedBaseCounts).length > 1;
                const showCombinedInstanceFilter = isCombined && Object.values(combinedBaseCounts).some((count) => count > 1);
                const combinedModuleKey = isCombined ? String(item.arrCombined?.moduleKey || 'arrcombinedcalendar').trim() : String(item.app.id || '').trim();
                const moduleId = combinedModuleKey + '-calendar';
                const controlPrefix = combinedModuleKey + 'Calendar';
                const logo = isCombined ? (item.arrCombined?.iconPath || '/icons/app-arr.svg') : resolveAppIconPath(item.app);
                const title = isCombined ? (item.arrCombined?.displayName || 'Combined Calendar') : 'Calendar';
              %>
              <section class="plex-module plex-module--no-subtitle" id="<%= moduleId %>">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="<%= logo %>" alt="<%= isCombined ? 'Combined ARR' : item.app.name %>" loading="eager" />
                      <span><%= title %></span>
                      <span class="arr-calendar-title-sep" aria-hidden="true">|</span>
                      <span id="<%= controlPrefix %>MonthLabel" class="arr-calendar-month-label arr-calendar-month-label--title">Loading…</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>

                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <% if (showCombinedMediaFilter || showCombinedInstanceFilter) { %>
                      <div
                        class="arr-filter-popover"
                        data-media-select-id="<%= showCombinedMediaFilter ? (controlPrefix + 'TypeFilter') : '' %>"
                        data-source-select-id="<%= showCombinedInstanceFilter ? (controlPrefix + 'SourceFilter') : '' %>"
                      >
                        <button class="arr-filter-trigger" type="button" aria-label="Open filters" title="Filters" aria-haspopup="true" aria-expanded="false"></button>
                        <div class="arr-filter-menu plex-hidden">
                          <% if (showCombinedMediaFilter) { %>
                            <div class="arr-filter-section">
                              <div class="arr-filter-label">Media</div>
                              <div class="arr-filter-options" data-options-target="media"></div>
                            </div>
                            <select id="<%= controlPrefix %>TypeFilter" class="arr-filter-native-select" aria-label="Media type">
                              <option value="all" data-icon="/icons/all-type.svg" selected>All</option>
                              <% if (hasBaseId(combinedApps, 'radarr')) { %><option value="movie" data-icon="/icons/movie.svg">Movies</option><% } %>
                              <% if (hasBaseId(combinedApps, 'sonarr')) { %><option value="tv" data-icon="/icons/tv.svg">TV</option><% } %>
                              <% if (hasBaseId(combinedApps, 'lidarr')) { %><option value="music" data-icon="/icons/music.svg">Music</option><% } %>
                              <% if (hasBaseId(combinedApps, 'readarr')) { %><option value="book" data-icon="/icons/book.svg">Books</option><% } %>
                            </select>
                          <% } %>
                          <% if (showCombinedInstanceFilter) { %>
                            <div class="arr-filter-section">
                              <div class="arr-filter-label">Instance</div>
                              <div class="arr-filter-options" data-options-target="source"></div>
                            </div>
                            <select id="<%= controlPrefix %>SourceFilter" class="arr-filter-native-select" aria-label="Instance filter">
                              <option value="all" data-base-id="all" data-icon="/icons/all-type.svg" selected>All instances</option>
                              <% combinedSourceEntries.forEach((entry) => { %>
                                <option value="<%= entry.id %>" data-base-id="<%= entry.baseId %>" data-icon="<%= ['radarr', 'sonarr', 'lidarr', 'readarr'].includes(entry.baseId) ? ('/icons/' + entry.baseId + '.png') : '/icons/app-arr.svg' %>"><%= entry.optionLabel %></option>
                              <% }) %>
                            </select>
                          <% } %>
                        </div>
                      </div>
                    <% } %>
                    <button class="arr-calendar-today-btn" id="<%= controlPrefix %>MonthTodayBtn" type="button">Today</button>
                    <button class="plex-iconbtn" id="<%= controlPrefix %>MonthPrevBtn" type="button" aria-label="Previous month"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="<%= controlPrefix %>MonthNextBtn" type="button" aria-label="Next month"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= moduleId %>" data-collapse-global="true">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel arr-calendar-panel">
                  <div class="arr-calendar-layout">
                    <div class="arr-calendar-pane arr-calendar-pane--grid">
                      <div class="arr-calendar-weekdays">
                        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                      </div>
                      <div id="<%= controlPrefix %>Grid" class="arr-calendar-grid">
                        <div class="plex-empty">Loading…</div>
                      </div>
                    </div>
                    <div class="arr-calendar-pane arr-calendar-pane--list">
                      <div id="<%= controlPrefix %>ListLabel" class="arr-calendar-list-label">Select a day</div>
                      <div id="<%= controlPrefix %>List" class="arr-calendar-list">
                        <div class="plex-empty">Loading…</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="<%= controlPrefix %>Overlay" class="arr-calendar-overlay plex-hidden">
                  <div class="arr-calendar-overlay-card">
                    <div class="arr-calendar-overlay-head">
                      <span id="<%= controlPrefix %>OverlayLabel" class="arr-calendar-list-label">Select a day</span>
                      <button id="<%= controlPrefix %>OverlayClose" class="arr-calendar-overlay-close" type="button" aria-label="Close day list">✕</button>
                    </div>
                    <div id="<%= controlPrefix %>OverlayList" class="arr-calendar-list"></div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (item.app.id === 'bazarr' && item.element.id === 'subtitle-queue') { %>
              <%
                const moduleId = `${item.app.id}-subtitle-queue`;
                const controlPrefix = `${item.app.id}SubtitleQueue`;
                const queueDisplay = item.element || {};
                const queueClasses = [
                  queueDisplay.queueShowDetail === false ? 'queue-hide-detail' : '',
                  queueDisplay.queueShowSubDetail === false ? 'queue-hide-subdetail' : '',
                  queueDisplay.queueShowSize === false ? 'queue-hide-size' : '',
                  queueDisplay.queueShowProtocol === false ? 'queue-hide-protocol' : '',
                  queueDisplay.queueShowTimeLeft === false ? 'queue-hide-timeleft' : '',
                  queueDisplay.queueShowProgress === false ? 'queue-hide-progress' : '',
                ].filter(Boolean).join(' ');
                const queueVisibleRows = queueDisplay.queueVisibleRows || 10;
              %>
              <section class="plex-module plex-module--no-subtitle" id="<%= moduleId %>">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="<%= resolveAppIconPath(item.app) %>" alt="<%= item.app.name %>" loading="eager" />
                      <span>Subtitle Queue</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>
                  <div class="plex-spacer"></div>
                  <div class="plex-controls-right">
                    <div class="plex-select plex-icon plex-filter-media" title="Type">
                      <select id="<%= controlPrefix %>TypeFilter" aria-label="Media type">
                        <option value="all" selected>All</option>
                        <option value="tv">TV</option>
                        <option value="movie">Movies</option>
                      </select>
                    </div>
                    <div class="plex-select plex-icon plex-filter-status" title="Status">
                      <select id="<%= controlPrefix %>StatusFilter" aria-label="Queue status">
                        <option value="all" selected>All</option>
                        <option value="active">Active</option>
                        <option value="queued">Queued</option>
                        <option value="completed">Completed</option>
                        <option value="error">Error</option>
                      </select>
                    </div>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= moduleId %>" data-collapse-global="true">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel queue-panel">
                  <div class="queue-table <%= queueClasses %>" style="--queue-visible-rows:<%= queueVisibleRows %>">
                    <div class="queue-row header">
                      <div class="queue-col-title">Title</div>
                      <div class="queue-col-detail">Target</div>
                      <div class="queue-col-subdetail">Subtitle</div>
                      <div class="queue-col-size">Languages</div>
                      <div class="queue-col-protocol">Protocol</div>
                      <div class="queue-col-time">Time Left</div>
                      <div class="queue-col-progress">Progress</div>
                    </div>
                    <div id="<%= controlPrefix %>Body" class="queue-body">
                      <div class="queue-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (item.app.id === 'autobrr' && ['recent-matches', 'delivery-queue'].includes(item.element.id)) { %>
              <%
                const isRecentMatches = item.element.id === 'recent-matches';
                const moduleId = `${item.app.id}-${item.element.id}`;
                const controlPrefix = `${item.app.id}${isRecentMatches ? 'RecentMatches' : 'DeliveryQueue'}`;
                const queueDisplay = item.element || {};
                const queueClasses = [
                  queueDisplay.queueShowDetail === false ? 'queue-hide-detail' : '',
                  queueDisplay.queueShowSubDetail === false ? 'queue-hide-subdetail' : '',
                  queueDisplay.queueShowSize === false ? 'queue-hide-size' : '',
                  queueDisplay.queueShowProtocol === false ? 'queue-hide-protocol' : '',
                  queueDisplay.queueShowTimeLeft === false ? 'queue-hide-timeleft' : '',
                  queueDisplay.queueShowProgress === false ? 'queue-hide-progress' : '',
                ].filter(Boolean).join(' ');
                const queueVisibleRows = queueDisplay.queueVisibleRows || 10;
              %>
              <section class="plex-module plex-module--no-subtitle" id="<%= moduleId %>">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="<%= resolveAppIconPath(item.app) %>" alt="<%= item.app.name %>" loading="eager" />
                      <span><%= isRecentMatches ? 'Recent Matches' : 'Delivery Queue' %></span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>
                  <div class="plex-spacer"></div>
                  <div class="plex-controls-right">
                    <div class="plex-select plex-icon plex-filter-media" title="Type">
                      <select id="<%= controlPrefix %>TypeFilter" aria-label="Release type">
                        <option value="all" selected>All</option>
                        <option value="torrent">Torrent</option>
                        <option value="usenet">Usenet</option>
                      </select>
                    </div>
                    <div class="plex-select plex-icon plex-filter-status" title="Status">
                      <select id="<%= controlPrefix %>StatusFilter" aria-label="Status">
                        <option value="all" selected>All</option>
                        <option value="active">Active</option>
                        <option value="queued">Queued</option>
                        <option value="completed">Completed</option>
                        <option value="error">Error</option>
                      </select>
                    </div>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= moduleId %>" data-collapse-global="true">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>
                <div class="plex-panel queue-panel">
                  <div class="queue-table <%= queueClasses %>" style="--queue-visible-rows:<%= queueVisibleRows %>">
                    <div class="queue-row header">
                      <div class="queue-col-title">Title</div>
                      <div class="queue-col-detail"><%= isRecentMatches ? 'Indexer' : 'Destination' %></div>
                      <div class="queue-col-subdetail">Release</div>
                      <div class="queue-col-size">Size</div>
                      <div class="queue-col-protocol">Protocol</div>
                      <div class="queue-col-time">Time Left</div>
                      <div class="queue-col-progress">Progress</div>
                    </div>
                    <div id="<%= controlPrefix %>Body" class="queue-body">
                      <div class="queue-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (['transmission', 'nzbget', 'qbittorrent', 'sabnzbd'].includes(resolveAppBaseId(item.app.id)) && item.element.id === 'activity-queue') { %>
              <%
                const isCombined = Boolean(item.downloaderCombined);
                const itemBaseId = resolveAppBaseId(item.app.id);
                const moduleId = isCombined ? 'downloaderscombined-activity-queue' : (item.app.id + '-activity-queue');
                const controlPrefix = isCombined ? 'downloaderscombinedQueue' : (item.app.id + 'Queue');
                const configPrefix = isCombined ? 'downloaderscombined' : item.app.id;
                const isTorrentApp = ['transmission', 'qbittorrent'].includes(itemBaseId);
                const isUsenetApp = ['nzbget', 'sabnzbd'].includes(itemBaseId);
                const logo = isCombined
                  ? '/icons/download.svg'
                  : resolveAppIconPath(item.app);
                const detailLabel = isCombined ? 'Source' : (isUsenetApp ? 'Category' : 'Status');
                const subDetailLabel = isCombined ? 'Detail' : (isUsenetApp ? 'Status' : 'Rate');
                const combinedQueueDisplay = isCombined ? downloaderCombinedQueueDisplay : null;
                const queueDisplay = combinedQueueDisplay || item.element || {};
                const queueClasses = [
                  queueDisplay.queueShowDetail === false ? 'queue-hide-detail' : '',
                  queueDisplay.queueShowSubDetail === false ? 'queue-hide-subdetail' : '',
                  queueDisplay.queueShowSize === false ? 'queue-hide-size' : '',
                  queueDisplay.queueShowProtocol === false ? 'queue-hide-protocol' : '',
                  queueDisplay.queueShowTimeLeft === false ? 'queue-hide-timeleft' : '',
                  queueDisplay.queueShowProgress === false ? 'queue-hide-progress' : '',
                ].filter(Boolean).join(' ');
                const queueVisibleRows = queueDisplay.queueVisibleRows || 10;
              %>
              <section class="plex-module plex-module--no-subtitle" id="<%= moduleId %>">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img
                        class="plex-logo"
                        id="<%= configPrefix %>Logo"
                        src="<%= logo %>"
                        data-default-icon="<%= logo %>"
                        alt="<%= isCombined ? 'Downloaders' : item.app.name %>"
                        loading="eager"
                      />
                      <span>Download Queue</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>

                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <% if (isCombined) { %>
                      <div class="plex-select plex-icon plex-filter-media" title="Type">
                        <select id="<%= controlPrefix %>TypeFilter" aria-label="Queue type">
                          <option value="all" selected>All</option>
                          <% item.downloaderCombined.appIds.forEach((appId) => { %>
                            <% const appItem = apps.find((entry) => entry.id === appId); %>
                            <% if (!appItem) return; %>
                            <% const optionIcon = resolveAppIconPath(appItem); %>
                            <option value="<%= appId %>" data-icon="<%= optionIcon %>"><%= appItem.name %></option>
                          <% }) %>
                        </select>
                      </div>
                    <% } %>
                    <div class="plex-select plex-icon plex-filter-status" title="Status">
                      <select id="<%= controlPrefix %>StatusFilter" aria-label="Queue status">
                        <option value="all" selected>All</option>
                        <% if (isCombined || isTorrentApp) { %>
                          <option value="active">Active</option>
                          <option value="downloading">Downloading</option>
                          <option value="queued">Queued</option>
                          <option value="seeding">Seeding</option>
                          <option value="paused">Paused</option>
                          <option value="completed">Completed</option>
                          <option value="error">Error</option>
                        <% } else { %>
                          <option value="downloading">Downloading</option>
                          <option value="queued">Queued</option>
                          <option value="paused">Paused</option>
                          <option value="completed">Completed</option>
                          <option value="error">Error</option>
                        <% } %>
                      </select>
                    </div>
                    <div class="plex-select plex-xsmall" title="Per page">
                      <select id="<%= controlPrefix %>LimitFilter" aria-label="Items per page">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                      </select>
                    </div>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= moduleId %>" data-collapse-global="true">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel queue-panel">
                  <div class="queue-table <%= queueClasses %>" data-page-size-select-id="<%= controlPrefix %>LimitFilter" style="--queue-visible-rows:<%= queueVisibleRows %>">
                    <div class="queue-row header">
                      <div class="queue-col-title">Title</div>
                      <div class="queue-col-detail"><%= detailLabel %></div>
                      <div class="queue-col-subdetail"><%= subDetailLabel %></div>
                      <div class="queue-col-size">Size</div>
                      <div class="queue-col-protocol">Protocol</div>
                      <div class="queue-col-time">Time Left</div>
                      <div class="queue-col-progress">Progress</div>
                    </div>
                    <div id="<%= controlPrefix %>Body" class="queue-body">
                      <div class="queue-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (['pulsarr', 'seerr'].includes(item.app.id) && item.element.id === 'recent-requests') { %>
              <% const requestPrefix = item.app.id; %>
              <% const requestAppLogo = resolveAppIconPath(item.app); %>
              <section class="plex-module plex-module--no-subtitle" id="<%= requestPrefix %>-recent-requests">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="<%= requestAppLogo %>" alt="<%= item.app.name %>" loading="eager" onerror="this.src='/icons/app.svg'" />
                      <span>Recent Requests</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>

                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <div class="plex-select plex-icon plex-filter-status" title="Status">
                      <select id="<%= requestPrefix %>RequestsStatusFilter" aria-label="Status">
                        <option value="all" selected>All</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="available">Available</option>
                        <option value="declined">Declined</option>
                      </select>
                    </div>

                    <div class="plex-select plex-icon plex-filter-window" title="Limit">
                      <select id="<%= requestPrefix %>RequestsLimitSelect" aria-label="Limit">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="30">30</option>
                        <option value="50">50</option>
                      </select>
                    </div>

                    <button class="plex-iconbtn" id="<%= requestPrefix %>RequestsPrevBtn" type="button" aria-label="Previous"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="<%= requestPrefix %>RequestsNextBtn" type="button" aria-label="Next"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= requestPrefix %>-recent-requests" data-collapse-global="true">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel">
                  <div id="<%= requestPrefix %>RequestsViewport" class="plex-carousel-viewport">
                    <div id="<%= requestPrefix %>RequestsTrack" class="plex-carousel-track">
                      <div class="plex-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
            <% if (['pulsarr', 'seerr'].includes(item.app.id) && item.element.id === 'most-watchlisted') { %>
              <% const requestPrefix = item.app.id; %>
              <% const requestAppLogo = resolveAppIconPath(item.app); %>
              <section class="plex-module plex-module--no-subtitle" id="<%= requestPrefix %>-most-watchlisted">
                <div class="plex-topbar">
                  <div class="plex-title-wrap">
                    <div class="plex-title">
                      <img class="plex-logo" src="<%= requestAppLogo %>" alt="<%= item.app.name %>" loading="eager" onerror="this.src='/icons/app.svg'" />
                      <span>Most Watchlisted</span>
                    </div>
                    <div class="plex-subtitle"></div>
                  </div>

                  <div class="plex-spacer"></div>

                  <div class="plex-controls-right">
                    <div class="plex-select plex-icon plex-filter-media" title="Media type">
                      <select id="<%= requestPrefix %>WatchlistedTypeFilter" aria-label="Media type">
                        <option value="all" selected>All</option>
                        <option value="movie">Movies</option>
                        <option value="show">TV</option>
                      </select>
                    </div>

                    <div class="plex-select plex-icon plex-filter-window" title="Limit">
                      <select id="<%= requestPrefix %>WatchlistedLimitSelect" aria-label="Limit">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="30">30</option>
                        <option value="50">50</option>
                      </select>
                    </div>

                    <button class="plex-iconbtn" id="<%= requestPrefix %>WatchlistedPrevBtn" type="button" aria-label="Previous"><div class="plex-chev plex-left"></div></button>
                    <button class="plex-iconbtn" id="<%= requestPrefix %>WatchlistedNextBtn" type="button" aria-label="Next"><div class="plex-chev plex-right"></div></button>
                    <button class="plex-iconbtn plex-collapse-btn" type="button" aria-label="Collapse" data-target="<%= requestPrefix %>-most-watchlisted" data-collapse-global="true">
                      <div class="plex-doublechev">
                        <div class="plex-chev plex-up"></div>
                        <div class="plex-chev plex-down"></div>
                      </div>
                    </button>
                  </div>
                </div>

                <div class="plex-panel">
                  <div id="<%= requestPrefix %>WatchlistedViewport" class="plex-carousel-viewport">
                    <div id="<%= requestPrefix %>WatchlistedTrack" class="plex-carousel-track">
                      <div class="plex-empty">Loading…</div>
                    </div>
                  </div>
                </div>
              </section>
            <% } %>
          <% }) %>

          <% if (hasPlexActive) { %>
            <div id="plexActiveModalBackdrop" class="plex-modal-backdrop plex-hidden">
              <div class="plex-modal">
                <button id="plexActiveModalClose" class="plex-modal-close" aria-label="Close">✕</button>
                <div class="plex-modal-header">
                  <div class="plex-modal-title">
                    <span id="plexActiveModalTypeIcon" class="plex-mini-icon"></span>
                    <span id="plexActiveModalTitle">Loading…</span>
                  </div>
                  <div id="plexActiveModalSubtitle" class="plex-modal-subtitle"></div>
                </div>
                <div id="plexActiveModalBody" class="plex-modal-body"></div>
              </div>
            </div>
          <% } %>

          <% if (hasPlexRecent) { %>
            <div id="plexRecentModalBackdrop" class="plex-modal-backdrop plex-hidden">
              <div class="plex-modal">
                <button id="plexRecentModalClose" class="plex-modal-close" aria-label="Close">✕</button>
                <div class="plex-modal-header">
                  <div class="plex-modal-title">
                    <span id="plexRecentModalTypeIcon" class="plex-mini-icon"></span>
                    <span id="plexRecentModalTitle">Loading…</span>
                  </div>
                  <div id="plexRecentModalSubtitle" class="plex-modal-subtitle"></div>
                </div>
                <div id="plexRecentModalBody" class="plex-modal-body"></div>
              </div>
            </div>
          <% } %>
          <% if (hasPlexWatchlisted) { %>
            <div id="plexWatchlistedModalBackdrop" class="plex-modal-backdrop plex-hidden">
              <div class="plex-modal">
                <button id="plexWatchlistedModalClose" class="plex-modal-close" aria-label="Close">✕</button>
                <div class="plex-modal-header">
                  <div class="plex-modal-title">
                    <span id="plexWatchlistedModalTypeIcon" class="plex-mini-icon"></span>
                    <span id="plexWatchlistedModalTitle">Loading…</span>
                  </div>
                  <div id="plexWatchlistedModalSubtitle" class="plex-modal-subtitle"></div>
                </div>
                <div id="plexWatchlistedModalBody" class="plex-modal-body"></div>
              </div>
            </div>
          <% } %>
          <% if (hasTautulliStats || hasTautulliStatsWheel) { %>
            <div id="tautulliModalBackdrop" class="plex-modal-backdrop plex-hidden">
              <div class="plex-modal">
                <button id="tautulliModalClose" class="plex-modal-close" aria-label="Close">✕</button>
                <div class="plex-modal-header">
                  <div class="plex-modal-title">
                    <span id="tautulliModalTypeIcon" class="plex-mini-icon"></span>
                    <span id="tautulliModalTitle">Loading…</span>
                  </div>
                  <div id="tautulliModalSubtitle" class="plex-modal-subtitle"></div>
                </div>
                <div id="tautulliModalBody" class="plex-modal-body"></div>
              </div>
            </div>
          <% } %>
          <% if (hasRequestModules) { %>
            <%
              const requestAppIds = Array.from(new Set(
                dashboardModules
                  .filter((entry) => ['pulsarr', 'seerr'].includes(entry.app.id) && ['recent-requests', 'most-watchlisted'].includes(entry.element.id))
                  .map((entry) => entry.app.id)
              ));
            %>
            <% requestAppIds.forEach((requestAppId) => { %>
              <div id="<%= requestAppId %>ModalBackdrop" class="plex-modal-backdrop plex-hidden">
                <div class="plex-modal">
                  <button id="<%= requestAppId %>ModalClose" class="plex-modal-close" aria-label="Close">✕</button>
                  <div class="plex-modal-header">
                    <div class="plex-modal-title">
                      <span id="<%= requestAppId %>ModalTypeIcon" class="plex-mini-icon"></span>
                      <span id="<%= requestAppId %>ModalTitle">Loading…</span>
                    </div>
                    <div id="<%= requestAppId %>ModalSubtitle" class="plex-modal-subtitle"></div>
                  </div>
                  <div id="<%= requestAppId %>ModalBody" class="plex-modal-body"></div>
                </div>
              </div>
            <% }) %>
          <% } %>
          <% if (hasMediaCombinedModules) { %>
            <div id="mediaCombinedModalBackdrop" class="plex-modal-backdrop plex-hidden">
              <div class="plex-modal">
                <button id="mediaCombinedModalClose" class="plex-modal-close" aria-label="Close">✕</button>
                <div class="plex-modal-header">
                  <div class="plex-modal-title">
                    <span id="mediaCombinedModalTypeIcon" class="plex-mini-icon"></span>
                    <span id="mediaCombinedModalTitle">Loading…</span>
                  </div>
                  <div id="mediaCombinedModalSubtitle" class="plex-modal-subtitle"></div>
                </div>
                <div id="mediaCombinedModalBody" class="plex-modal-body"></div>
              </div>
            </div>
          <% } %>
        </div>
      <% } %>
    </section>
  </div>
  <script>
    const dashFrame = document.querySelector('.dash-frame');
    const toggle = document.querySelector('.sidebar-toggle');
    const toggleIcon = toggle?.querySelector('img');
    const mobileQuery = window.matchMedia('(max-width: 980px)');
    const isMobile = () => mobileQuery.matches;
    const mainContent = document.querySelector('.dash-main');
    const sidebar = document.querySelector('.dash-sidebar');
    const dashNav = document.querySelector('.dash-nav');
    const userMenus = document.querySelectorAll('[data-user-menu]');
    const safeStorage = {
      get(key) {
        try {
          return localStorage.getItem(key);
        } catch (err) {
          return null;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (err) {
          return;
        }
      },
    };

    function setToggleIcon() {
      if (!toggleIcon) return;
      toggleIcon.src = '/icons/sidebar-toggle.svg';
    }

    function applySidebarState() {
      if (!dashFrame) return;
      if (isMobile()) {
        dashFrame.classList.remove('sidebar-collapsed');
        dashFrame.classList.remove('mobile-nav-open');
        document.body.classList.remove('mobile-nav-open');
        if (dashNav) dashNav.scrollTop = 0;
        setToggleIcon(false);
      } else {
        const collapsed = safeStorage.get('sidebarCollapsed') === 'true';
        dashFrame.classList.toggle('sidebar-collapsed', collapsed);
        dashFrame.classList.remove('mobile-nav-open');
        document.body.classList.remove('mobile-nav-open');
        if (dashNav) dashNav.scrollTop = 0;
        setToggleIcon(!collapsed);
      }
    }

    function closeMobileNav() {
      if (!dashFrame || !isMobile()) return;
      if (!dashFrame.classList.contains('mobile-nav-open')) return;
      dashFrame.classList.remove('mobile-nav-open');
      document.body.classList.remove('mobile-nav-open');
      setToggleIcon(false);
    }

    applySidebarState();
    mobileQuery.addEventListener('change', applySidebarState);
    const autoOpenSingleAppMenuItem = <%= autoOpenSingleAppMenuItem ? 'true' : 'false' %>;
    const accordion = document.querySelectorAll('.nav-accordion-item');
    accordion.forEach((item) => {
      const trigger = item.querySelector('.nav-accordion-trigger');
      if (!trigger) return;
      trigger.addEventListener('click', (event) => {
        event.stopPropagation();
        const isCategoryTrigger = trigger.classList.contains('nav-accordion-trigger--category');
        if (autoOpenSingleAppMenuItem && !isCategoryTrigger) {
          const panel = Array.from(item.children).find((child) => child.classList && child.classList.contains('nav-accordion-panel'));
          const directLinks = panel
            ? Array.from(panel.children).filter((child) => typeof child.matches === 'function' && child.matches('a.nav-subitem[href]'))
            : [];
          if (directLinks.length === 1) {
            const [onlyLink] = directLinks;
            if (onlyLink.target === '_blank') {
              window.open(onlyLink.href, '_blank', 'noopener,noreferrer');
            } else {
              window.location.href = onlyLink.href;
            }
            return;
          }
        }
        const parentAccordion = item.closest('.nav-accordion');
        const siblings = parentAccordion
          ? Array.from(parentAccordion.children).filter((child) => child.classList.contains('nav-accordion-item'))
          : [];
        siblings.forEach((other) => {
          if (other !== item) other.classList.remove('open');
        });
        item.classList.toggle('open');
      });
    });
    function handleSidebarToggle() {
      if (!dashFrame) return;
      if (isMobile()) {
        dashFrame.classList.remove('sidebar-collapsed');
        const isOpen = dashFrame.classList.toggle('mobile-nav-open');
        document.body.classList.toggle('mobile-nav-open', isOpen);
        if (dashNav) dashNav.scrollTop = 0;
        setToggleIcon(isOpen);
        return;
      }
      const isCollapsed = dashFrame.classList.toggle('sidebar-collapsed');
      safeStorage.set('sidebarCollapsed', isCollapsed ? 'true' : 'false');
      if (dashNav) dashNav.scrollTop = 0;
      setToggleIcon(!isCollapsed);
    }

    toggle?.addEventListener('click', handleSidebarToggle);

    mainContent?.addEventListener('click', (event) => {
      if (event.target.closest('.sidebar-toggle')) return;
      if (event.target.closest('.main-window-bar')) return;
      closeMobileNav();
    });

    sidebar?.addEventListener('click', (event) => {
      if (!isMobile() || !dashFrame?.classList.contains('mobile-nav-open')) return;
      const link = event.target.closest('a');
      if (!link || !link.classList.contains('active')) return;
      event.preventDefault();
      closeMobileNav();
    });

    function closeUserMenus(except) {
      userMenus.forEach((menu) => {
        if (menu === except) return;
        menu.classList.remove('user-pill--open');
        menu.setAttribute('aria-expanded', 'false');
      });
    }

    userMenus.forEach((menu) => {
      menu.setAttribute('aria-expanded', 'false');
      menu.addEventListener('click', (event) => {
        if (event.target.closest('.user-menu')) return;
        event.preventDefault();
        const isOpen = menu.classList.contains('user-pill--open');
        closeUserMenus(menu);
        menu.classList.toggle('user-pill--open', !isOpen);
        menu.setAttribute('aria-expanded', !isOpen ? 'true' : 'false');
      });
      menu.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        event.preventDefault();
        menu.click();
      });
    });

    document.addEventListener('click', (event) => {
      if (event.target.closest('[data-user-menu]')) return;
      closeUserMenus();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      closeUserMenus();
    });

    document.querySelectorAll('.plex-select.plex-filter-media, .plex-select.plex-filter-source').forEach((wrap) => {
      const select = wrap.querySelector('select');
      if (!select) return;
      const sync = () => {
        if (wrap.classList.contains('plex-filter-source')) {
          const selectedOption = select.options[select.selectedIndex];
          const baseId = String(selectedOption?.dataset?.baseId || '').trim().toLowerCase();
          wrap.dataset.filterValue = baseId || 'all';
          return;
        }
        wrap.dataset.filterValue = String(select.value || 'all').toLowerCase();
      };
      select.addEventListener('change', sync);
      sync();
    });

    function initArrFilterPopovers() {
      const ensureModulePopovers = () => {
        const controlsRows = Array.from(document.querySelectorAll('.plex-module .plex-controls-right'));
        controlsRows.forEach((controls) => {
          const selectWraps = Array.from(controls.children).filter((child) => child.classList?.contains('plex-select'));
          if (!selectWraps.length) return;
          let popover = Array.from(controls.children).find((child) => child.classList?.contains('arr-filter-popover'));
          if (popover) return;
          popover = document.createElement('div');
          popover.className = 'arr-filter-popover';
          popover.innerHTML =
            '<button class="arr-filter-trigger" type="button" aria-label="Open filters" title="Filters" aria-haspopup="true" aria-expanded="false"></button>' +
            '<div class="arr-filter-menu plex-hidden"></div>';
          controls.insertBefore(popover, selectWraps[0]);
        });
      };

      ensureModulePopovers();

      const popovers = Array.from(document.querySelectorAll('.arr-filter-popover'));
      if (!popovers.length) return;

      const closeAll = (except) => {
        popovers.forEach((popover) => {
          if (except && popover === except) return;
          const trigger = popover.querySelector('.arr-filter-trigger');
          const menu = popover.querySelector('.arr-filter-menu');
          if (!trigger || !menu) return;
          trigger.setAttribute('aria-expanded', 'false');
          menu.classList.add('plex-hidden');
        });
      };

      const ensureOptionIcon = (kind, optionDef) => {
        const value = String(optionDef?.value || '').trim().toLowerCase();
        const baseId = String(optionDef?.baseId || '').trim().toLowerCase();
        if (optionDef?.icon) return optionDef.icon;
        if (kind === 'media') {
          if (value === 'movie') return '/icons/movie.svg';
          if (value === 'tv' || value === 'show') return '/icons/tv.svg';
          if (value === 'music') return '/icons/music.svg';
          if (value === 'book') return '/icons/book.svg';
          return '/icons/all-type.svg';
        }
        if (kind === 'window') return '/icons/window.svg';
        if (kind === 'event') return '/icons/activity-queue.svg';
        if (kind === 'status') return '/icons/status.svg';
        if (baseId && ['radarr', 'sonarr', 'lidarr', 'readarr'].includes(baseId)) {
          return '/icons/' + baseId + '.png';
        }
        return '/icons/all-type.svg';
      };

      const inferOptionKind = (wrap) => {
        if (!wrap) return 'generic';
        if (wrap.classList.contains('plex-filter-media')) return 'media';
        if (wrap.classList.contains('plex-filter-source')) return 'source';
        if (wrap.classList.contains('plex-filter-window')) return 'window';
        if (wrap.classList.contains('plex-filter-event')) return 'event';
        if (wrap.classList.contains('plex-filter-status')) return 'status';
        return 'generic';
      };

      const escapeHtml = (value) => String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');

      const readOptions = (select) => {
        if (!select) return [];
        return Array.from(select.options || []).map((option) => ({
          value: String(option?.value || '').trim(),
          label: String(option?.textContent || option?.label || option?.value || '').trim(),
          baseId: String(option?.dataset?.baseId || '').trim(),
          icon: String(option?.dataset?.icon || '').trim(),
        }));
      };

      const renderOptionButtons = (select, container, kind) => {
        if (!select || !container) return;
        const selectedValue = String(select.value || '').trim();
        const options = readOptions(select);
        container.innerHTML = options.map((option, index) => {
          const icon = ensureOptionIcon(kind, option);
          const isSelected = selectedValue === option.value;
          return (
            '<button class="arr-filter-option' + (isSelected ? ' is-selected' : '') + '" type="button" data-index="' + index + '">' +
              '<img class="arr-filter-option-icon" src="' + icon + '" alt="" />' +
              '<span class="arr-filter-option-label">' + escapeHtml(option.label) + '</span>' +
            '</button>'
          );
        }).join('');

        container.querySelectorAll('.arr-filter-option').forEach((button) => {
          button.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            const index = Number(button.dataset.index);
            if (!Number.isFinite(index) || !options[index]) return;
            const value = String(options[index].value || '').trim();
            if (select.value === value) return;
            select.value = value;
            select.dispatchEvent(new Event('change', { bubbles: true }));
          });
        });
      };

      popovers.forEach((popover) => {
        const trigger = popover.querySelector('.arr-filter-trigger');
        const menu = popover.querySelector('.arr-filter-menu');
        if (!trigger || !menu) return;
        const controls = popover.closest('.plex-controls-right');
        const sections = [];
        const addSection = (select, container, kind) => {
          if (!select || !container) return;
          if (sections.some((entry) => entry.select === select)) return;
          sections.push({ select, container, kind: kind || 'generic' });
        };

        const mediaSelectId = String(popover.dataset.mediaSelectId || '').trim();
        const sourceSelectId = String(popover.dataset.sourceSelectId || '').trim();
        const mediaSelect = mediaSelectId ? document.getElementById(mediaSelectId) : null;
        const sourceSelect = sourceSelectId ? document.getElementById(sourceSelectId) : null;
        const mediaContainer = menu.querySelector('[data-options-target="media"]');
        const sourceContainer = menu.querySelector('[data-options-target="source"]');
        addSection(mediaSelect, mediaContainer, 'media');
        addSection(sourceSelect, sourceContainer, 'source');

        const wrappers = controls
          ? Array.from(controls.children).filter((child) => child.classList?.contains('plex-select'))
          : [];
        const isIndexerSearchPopover = wrappers.some((wrap) => {
          const select = wrap.querySelector('select');
          const selectId = String(select?.id || '');
          return selectId.includes('SearchIndexerFilter');
        });
        if (isIndexerSearchPopover) {
          menu.classList.add('arr-filter-menu--full-list');
        }
        wrappers.forEach((wrap, index) => {
          const select = wrap.querySelector('select');
          if (!select) return;
          if (sections.some((entry) => entry.select === select)) {
            wrap.classList.add('arr-filter-select-hidden');
            return;
          }
          const labelRaw = String(wrap.getAttribute('title') || select.getAttribute('aria-label') || `Filter ${index + 1}`).trim();
          const section = document.createElement('div');
          section.className = 'arr-filter-section';
          section.innerHTML =
            '<div class="arr-filter-label">' + escapeHtml(labelRaw) + '</div>' +
            '<div class="arr-filter-options"></div>';
          menu.appendChild(section);
          const container = section.querySelector('.arr-filter-options');
          addSection(select, container, inferOptionKind(wrap));
          wrap.classList.add('arr-filter-select-hidden');
        });

        if (!sections.length) return;

        let needsSync = true;
        const positionMenu = () => {
          menu.style.top = 'calc(100% + 8px)';
          menu.style.bottom = 'auto';
          menu.style.maxHeight = '';
        };
        const sync = ({ force = false } = {}) => {
          if (!force && menu.classList.contains('plex-hidden')) {
            needsSync = true;
            return;
          }
          sections.forEach((entry) => {
            renderOptionButtons(entry.select, entry.container, entry.kind);
          });
          if (!menu.classList.contains('plex-hidden')) positionMenu();
          needsSync = false;
        };

        trigger.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          const isOpen = trigger.getAttribute('aria-expanded') === 'true';
          closeAll(isOpen ? null : popover);
          trigger.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
          menu.classList.toggle('plex-hidden', isOpen);
          if (!isOpen && needsSync) sync({ force: true });
          if (!isOpen) positionMenu();
        });

        sections.forEach((entry) => {
          entry.select?.addEventListener('change', sync);
          entry.select?.addEventListener('arr:options-updated', sync);
        });
        sync();
      });

      document.addEventListener('click', (event) => {
        const target = event.target;
        if (target && target.closest && target.closest('.arr-filter-popover')) return;
        closeAll();
      });

      document.addEventListener('keydown', (event) => {
        if (event.key !== 'Escape') return;
        closeAll();
      });
    }

    initArrFilterPopovers();

    document.querySelectorAll('.plex-collapse-btn').forEach((button) => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();
        const section = button.closest('.plex-module');
        if (!section) return;
        section.classList.toggle('plex-collapsed');
      });
    });
  </script>
  <% if (dashboardModules.some((item) => item.app.id === 'plex' && !item.mediaCombined)) { %>
    <% const plexApp = dashboardModules.find((item) => item.app.id === 'plex' && !item.mediaCombined)?.app; %>
    <% if (plexApp) { %>
      <script>
        window.PLEX_OVERVIEW_CONFIG = <%- JSON.stringify({
          baseUrl: (appBaseUrls && appBaseUrls[plexApp.id]) || plexApp.localUrl || plexApp.remoteUrl || '',
          host: plexApp.plexHost || '',
          token: plexApp.plexToken || '',
          displaySettings: dashboardModules
            .filter((item) => item.app.id === 'plex' && !item.mediaCombined)
            .reduce((acc, item) => {
              if (!item?.element?.id) return acc;
              acc[item.element.id] = {
                showSubtitle: item.element.showSubtitle !== false,
                showMeta: item.element.showMeta !== false,
                showPill: item.element.showPill !== false,
                showTypeIcon: item.element.showTypeIcon !== false,
                showViewIcon: item.element.showViewIcon !== false,
                showUsername: item.element.showUsername !== false,
              };
              return acc;
            }, {})
        }) %>;
      </script>
      <script src="/plex-overview.js?v=<%= assetVersion %>"></script>
    <% } %>
  <% } %>
  <% ['jellyfin', 'emby'].forEach((mediaServerId) => { %>
    <% if (dashboardModules.some((item) => item.app.id === mediaServerId && !item.mediaCombined && ['active', 'recent'].includes(item.element.id))) { %>
      <% const mediaServerApp = dashboardModules.find((item) => item.app.id === mediaServerId && !item.mediaCombined)?.app; %>
      <% if (mediaServerApp) { %>
        <script>
          window.<%= mediaServerId === 'emby' ? 'EMBY_OVERVIEW_CONFIG' : 'JELLYFIN_OVERVIEW_CONFIG' %> = <%- JSON.stringify({
            baseUrl: (appBaseUrls && appBaseUrls[mediaServerApp.id]) || mediaServerApp.localUrl || mediaServerApp.remoteUrl || mediaServerApp.url || '',
            apiKey: mediaServerApp.apiKey || '',
            displaySettings: dashboardModules
              .filter((item) => item.app.id === mediaServerId && !item.mediaCombined)
              .reduce((acc, item) => {
                if (!item?.element?.id) return acc;
                acc[item.element.id] = {
                  showSubtitle: item.element.showSubtitle !== false,
                  showMeta: item.element.showMeta !== false,
                  showPill: item.element.showPill !== false,
                  showTypeIcon: item.element.showTypeIcon !== false,
                  showViewIcon: item.element.showViewIcon !== false,
                  showUsername: item.element.showUsername !== false,
                };
                return acc;
              }, {})
          }) %>;
        </script>
        <script src="/<%= mediaServerId %>-overview.js?v=<%= assetVersion %>"></script>
      <% } %>
    <% } %>
  <% }) %>
  <% if (dashboardModules.some((item) => item.app.id === 'tautulli')) { %>
    <% const tautulliApp = dashboardModules.find((item) => item.app.id === 'tautulli')?.app; %>
    <% const plexAppForTautulli = dashboardModules.find((item) => item.app.id === 'plex')?.app || apps.find((appItem) => appItem.id === 'plex'); %>
    <% const activeTautulliCards = (Array.isArray(tautulliCards) ? tautulliCards : []).filter((item) => item.enable).sort((a, b) => (a.order || 0) - (b.order || 0)).map((item) => item.id); %>
    <% if (tautulliApp) { %>
      <script>
        window.TAUTULLI_OVERVIEW_CONFIG = <%- JSON.stringify({
          baseUrl: (appBaseUrls && appBaseUrls[tautulliApp.id]) || tautulliApp.localUrl || tautulliApp.remoteUrl || tautulliApp.url || '',
          apiKey: tautulliApp.apiKey || '',
          plexBaseUrl: (plexAppForTautulli && ((appBaseUrls && appBaseUrls[plexAppForTautulli.id]) || plexAppForTautulli.localUrl || plexAppForTautulli.remoteUrl || plexAppForTautulli.url)) || '',
          statsCards: activeTautulliCards
        }) %>;
      </script>
      <script src="/tautulli-overview.js?v=<%= assetVersion %>"></script>
    <% } %>
  <% } %>
  <% if (dashboardModules.some((item) => isArrAppId(item.app.id) && (item.element.id === 'downloading-soon' || item.element.id === 'recently-downloaded' || item.element.id === 'activity-queue' || item.element.id === 'calendar'))) { %>
    <%
      const arrOverviewApps = [];
      const arrSourceApps = [];
      const addArrSourceApp = (candidate) => {
        if (!candidate || !isArrAppId(candidate.id)) return;
        if (arrSourceApps.some((appItem) => appItem.id === candidate.id)) return;
        arrSourceApps.push(candidate);
      };
      (Array.isArray(apps) ? apps : []).forEach(addArrSourceApp);
      const arrCombinedConfigs = [];
      dashboardModules
        .filter((item) => isArrAppId(item.app.id))
        .forEach((item) => {
          if (!arrOverviewApps.some((appItem) => appItem.id === item.app.id)) arrOverviewApps.push(item.app);
          addArrSourceApp(item.app);
          if (item.arrCombined) {
            const includeSoon = item.arrCombined.elementId === 'downloading-soon';
            const includeRecent = item.arrCombined.elementId === 'recently-downloaded';
            const includeQueue = item.arrCombined.elementId === 'activity-queue';
            const includeCalendar = item.arrCombined.elementId === 'calendar';
            const moduleKey = String(item.arrCombined.moduleKey || '').trim();
            if (!moduleKey) return;
            arrCombinedConfigs.push({
              appId: moduleKey,
              appName: item.arrCombined.displayName || item.arrCombined.appNames.join(' + '),
              appIds: item.arrCombined.appIds,
              includeSoon,
              includeRecent,
              includeQueue,
              includeCalendar,
              displaySettings: {
                [item.arrCombined.elementId]: {
                  showSubtitle: item.element.showSubtitle !== false,
                  showMeta: item.element.showMeta !== false,
                  showPill: item.element.showPill !== false,
                  showTypeIcon: item.element.showTypeIcon !== false,
                  showViewIcon: item.element.showViewIcon !== false,
                  showUsername: item.element.showUsername !== false,
                },
              },
              sources: item.arrCombined.appIds
                .map((appId) => arrSourceApps.find((appItem) => appItem.id === appId))
                .filter(Boolean)
                .map((arrApp) => ({
                  appId: arrApp.id,
                  appName: arrApp.name,
                  baseUrl: (appBaseUrls && appBaseUrls[arrApp.id]) || arrApp.localUrl || arrApp.remoteUrl || arrApp.url || '',
                  baseUrls: [
                    (appBaseUrls && appBaseUrls[arrApp.id]) || '',
                    arrApp.localUrl || '',
                    arrApp.remoteUrl || '',
                    arrApp.url || '',
                  ],
                  apiKey: arrApp.apiKey || '',
                })),
            });
          }
        });
    %>
    <% if (arrOverviewApps.length) { %>
      <script>
        window.ARR_OVERVIEW_CONFIGS = <%- JSON.stringify(
          arrOverviewApps.map((arrApp) => ({
            appId: arrApp.id,
            appName: arrApp.name,
            baseUrl: (appBaseUrls && appBaseUrls[arrApp.id]) || arrApp.localUrl || arrApp.remoteUrl || arrApp.url || '',
            apiKey: arrApp.apiKey || '',
            displaySettings: dashboardModules
              .filter((item) => item.app.id === arrApp.id)
              .reduce((acc, item) => {
                if (!item?.element?.id) return acc;
                acc[item.element.id] = {
                  showSubtitle: item.element.showSubtitle !== false,
                  showMeta: item.element.showMeta !== false,
                  showPill: item.element.showPill !== false,
                  showTypeIcon: item.element.showTypeIcon !== false,
                  showViewIcon: item.element.showViewIcon !== false,
                  showUsername: item.element.showUsername !== false,
                };
                return acc;
              }, {})
          }))
        ) %>;
        window.ARR_OVERVIEW_COMBINED_CONFIGS = <%- JSON.stringify(arrCombinedConfigs) %>;
      </script>
      <script src="/arr-overview.js?v=<%= assetVersion %>"></script>
    <% } %>
  <% } %>
  <% if (dashboardModules.some((item) => ['transmission', 'nzbget', 'qbittorrent', 'sabnzbd'].includes(resolveAppBaseId(item.app.id)) && item.element.id === 'activity-queue')) { %>
    <%
      const downloaderQueueApps = [];
      dashboardModules
        .filter((item) => ['transmission', 'nzbget', 'qbittorrent', 'sabnzbd'].includes(resolveAppBaseId(item.app.id)) && item.element.id === 'activity-queue')
        .forEach((item) => {
          if (downloaderQueueApps.some((entry) => entry.appId === item.app.id)) return;
          downloaderQueueApps.push({
            appId: item.app.id,
            appName: item.app.name,
            prefix: item.app.id,
          });
        });
    %>
    <% dashboardModules.forEach((item) => { %>
      <% if (item.downloaderCombined && item.element.id === 'activity-queue') { %>
        <% const sources = (item.downloaderCombined.appIds || []).map((id) => apps.find((appItem) => appItem.id === id)).filter(Boolean); %>
        <% if (sources.length > 1) { %>
          <% downloaderQueueApps.push({
            appId: 'downloaderscombined',
            appName: item.downloaderCombined.appNames.join(' + '),
            prefix: 'downloaderscombined',
            sources: sources.map((appItem) => ({ appId: appItem.id, appName: appItem.name })),
          }); %>
        <% } %>
      <% } %>
    <% }) %>
    <% if (downloaderQueueApps.length) { %>
      <script>
        window.DOWNLOADER_QUEUE_CONFIGS = <%- JSON.stringify(downloaderQueueApps) %>;
      </script>
      <script src="/downloaders-queue.js?v=<%= assetVersion %>"></script>
    <% } %>
  <% } %>
  <% if (dashboardModules.some((item) => item.mediaCombined && ['active', 'recent'].includes(item.element.id))) { %>
    <% const mediaCombinedModules = dashboardModules.filter((item) => item.mediaCombined && ['active', 'recent'].includes(item.element.id)); %>
    <% if (mediaCombinedModules.length) { %>
      <script>
        window.MEDIA_OVERVIEW_COMBINED_CONFIGS = <%- JSON.stringify(
          mediaCombinedModules.map((item) => {
            const isActive = item.element.id === 'active';
            const controlPrefix = isActive ? 'mediacombinedActive' : 'mediacombinedRecent';
            const moduleId = isActive ? 'mediacombined-active' : 'mediacombined-recent';
            return {
              section: isActive ? 'active' : 'recent',
              moduleId,
              controlPrefix,
              displaySettings: {
                showSubtitle: item.element.showSubtitle !== false,
                showMeta: item.element.showMeta !== false,
                showPill: item.element.showPill !== false,
                showTypeIcon: item.element.showTypeIcon !== false,
                showViewIcon: item.element.showViewIcon !== false,
                showUsername: item.element.showUsername !== false,
              },
              sources: (Array.isArray(item.mediaCombined?.appIds) ? item.mediaCombined.appIds : [])
                .map((appId) => apps.find((appItem) => appItem.id === appId))
                .filter(Boolean)
                .map((appItem) => ({
                  appId: appItem.id,
                  appName: appItem.name,
                  type: appItem.id === 'plex'
                    ? 'plex'
                    : (appItem.id === 'jellyfin'
                      ? 'jellyfin'
                      : (appItem.id === 'emby' ? 'emby' : appItem.id)),
                  baseUrl: (appBaseUrls && appBaseUrls[appItem.id]) || appItem.localUrl || appItem.remoteUrl || appItem.url || '',
                  token: appItem.plexToken || '',
                })),
            };
          })
        ) %>;
      </script>
      <script src="/media-overview.js?v=<%= assetVersion %>"></script>
    <% } %>
  <% } %>
  <% if (dashboardModules.some((item) => ['pulsarr', 'seerr'].includes(item.app.id) && (item.element.id === 'recent-requests' || item.element.id === 'most-watchlisted'))) { %>
    <% const requestOverviewApps = Array.from(new Set(
      dashboardModules
        .filter((item) => ['pulsarr', 'seerr'].includes(item.app.id) && (item.element.id === 'recent-requests' || item.element.id === 'most-watchlisted'))
        .map((item) => item.app.id)
    )).map((id) => dashboardModules.find((entry) => entry.app.id === id)?.app).filter(Boolean); %>
    <% requestOverviewApps.forEach((requestApp) => { %>
      <script>
        window.PULSARR_OVERVIEW_CONFIG = <%- JSON.stringify({
          appId: requestApp.id,
          domPrefix: requestApp.id,
          appName: requestApp.name,
          baseUrl: (appBaseUrls && appBaseUrls[requestApp.id]) || requestApp.localUrl || requestApp.remoteUrl || requestApp.url || '',
          apiKey: requestApp.apiKey || '',
          displaySettings: dashboardModules
            .filter((item) => item.app.id === requestApp.id)
            .reduce((acc, item) => {
              if (!item?.element?.id) return acc;
              acc[item.element.id] = {
                showSubtitle: item.element.showSubtitle !== false,
                showMeta: item.element.showMeta !== false,
                showPill: item.element.showPill !== false,
                showTypeIcon: item.element.showTypeIcon !== false,
                showViewIcon: item.element.showViewIcon !== false,
                showUsername: item.element.showUsername !== false,
              };
              return acc;
            }, {})
        }) %>;
      </script>
      <script src="/pulsarr-overview.js?v=<%= assetVersion %>"></script>
    <% }) %>
  <% } %>
  <% if (dashboardModules.some((item) => ['prowlarr', 'jackett'].includes(resolveAppBaseId(item.app.id)) && item.element.id === 'search')) { %>
    <%
      const indexerSearchApps = Array.from(new Set(
        dashboardModules
          .filter((item) => ['prowlarr', 'jackett'].includes(resolveAppBaseId(item.app.id)) && item.element.id === 'search')
          .map((item) => item.app.id)
      )).map((id) => dashboardModules.find((entry) => entry.app.id === id)?.app).filter(Boolean);
      const indexerSearchConfigs = indexerSearchApps.map((searchApp) => {
        const baseId = resolveAppBaseId(searchApp.id);
        const isJackett = baseId === 'jackett';
        return {
          appId: searchApp.id,
          appName: searchApp.name,
          prefix: isJackett ? 'jackett' : 'prowlarr',
          endpoint: isJackett ? '/api/jackett/search' : '/api/prowlarr/search',
          filtersEndpoint: isJackett ? '/api/jackett/search/filters' : '/api/prowlarr/search/filters',
          canDownload: !isJackett,
          downloadEndpoint: '/api/prowlarr/download',
        };
      });
    %>
    <% if (indexerSearchConfigs.length) { %>
      <script>
        window.INDEXER_SEARCH_CONFIGS = <%- JSON.stringify(indexerSearchConfigs) %>;
      </script>
      <script src="/indexer-search.js?v=<%= assetVersion %>"></script>
    <% } %>
  <% } %>
  <% if (dashboardModules.some((item) => (item.app.id === 'bazarr' && item.element.id === 'subtitle-queue') || (item.app.id === 'autobrr' && ['recent-matches', 'delivery-queue'].includes(item.element.id)))) { %>
    <%
      const queueCardConfigs = dashboardModules
        .filter((item) => (item.app.id === 'bazarr' && item.element.id === 'subtitle-queue') || (item.app.id === 'autobrr' && ['recent-matches', 'delivery-queue'].includes(item.element.id)))
        .map((item) => {
          if (item.app.id === 'bazarr') {
            const controlPrefix = `${item.app.id}SubtitleQueue`;
            return {
              moduleId: `${item.app.id}-subtitle-queue`,
              bodyId: `${controlPrefix}Body`,
              typeFilterId: `${controlPrefix}TypeFilter`,
              statusFilterId: `${controlPrefix}StatusFilter`,
              endpoint: '/api/bazarr/subtitle-queue',
              appName: item.app.name || 'Bazarr',
            };
          }
          const isRecentMatches = item.element.id === 'recent-matches';
          const controlPrefix = `${item.app.id}${isRecentMatches ? 'RecentMatches' : 'DeliveryQueue'}`;
          return {
            moduleId: `${item.app.id}-${item.element.id}`,
            bodyId: `${controlPrefix}Body`,
            typeFilterId: `${controlPrefix}TypeFilter`,
            statusFilterId: `${controlPrefix}StatusFilter`,
            endpoint: `/api/autobrr/${item.element.id}`,
            appName: item.app.name || 'Autobrr',
          };
        });
    %>
    <% if (queueCardConfigs.length) { %>
      <script>
        window.QUEUE_CARD_CONFIGS = <%- JSON.stringify(queueCardConfigs) %>;
      </script>
      <script src="/queue-cards.js?v=<%= assetVersion %>"></script>
    <% } %>
  <% } %>
  <% if (dashboardModules.some((item) => ['prowlarr', 'jackett'].includes(item.app.id) && item.element.id === 'search')) { %>
    <script src="/indexer-table-sort.js?v=<%= assetVersion %>"></script>
  <% } %>
  <script src="/table-pagination.js?v=<%= assetVersion %>"></script>
  <script src="/version-badge.js?v=<%= assetVersion %>"></script>
  <script src="/brand-menu.js?v=<%= assetVersion %>"></script>
  <script src="/starfield-3d.js"></script>
  <script src="/pwa.js?v=<%= assetVersion %>"></script>
</body>
</html>
