<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Launcharr Â· User Profile</title>
  <script>
    (function() {
      try {
        var stored = localStorage.getItem("launcharr-theme");
        var prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
        var themeDefaults = <%- JSON.stringify(themeDefaults || {}) %>;
        var modeFromDefaults = (themeDefaults && (themeDefaults.mode === "day" || themeDefaults.mode === "night")) ? themeDefaults.mode : "";
        var mode = stored || modeFromDefaults || (prefersLight ? "day" : "night");
        var defaultBrandTheme = String(themeDefaults && themeDefaults.brandTheme || "").trim().toLowerCase();
        var isAllowedBrandTheme = /^(custom|launcharr|rocketship|pulsarr|plex|radarr|sonarr|lidarr|readarr)$/.test(defaultBrandTheme);
        var brandTheme = localStorage.getItem("launcharr-brand-theme") || (isAllowedBrandTheme ? defaultBrandTheme : "pulsarr");
        document.documentElement.dataset.theme = mode;
        document.documentElement.dataset.brandTheme = brandTheme;
        var parseStoredBool = function(key, fallback) {
          var raw = localStorage.getItem(key);
          if (raw === null || raw === undefined) return Boolean(fallback);
          return raw === "1" || raw === "true";
        };
        var sidebarInvert = parseStoredBool("launcharr-sidebar-invert", themeDefaults && themeDefaults.sidebarInvert === true);
        var squareCorners = parseStoredBool("launcharr-square-corners", themeDefaults && themeDefaults.squareCorners === true);
        var bgMotionStored = localStorage.getItem("launcharr-bg-motion");
        var bgMotionDefault = themeDefaults && themeDefaults.bgMotion === undefined ? true : (themeDefaults && themeDefaults.bgMotion === true);
        var bgMotion = bgMotionStored === null ? bgMotionDefault : (bgMotionStored === "1" || bgMotionStored === "true");
        var carouselFreeScroll = parseStoredBool("launcharr-carousel-free-scroll", themeDefaults && themeDefaults.carouselFreeScroll === true);
        var maximizedWindow = localStorage.getItem("launcharr-maximized-window") === "1";
        document.documentElement.dataset.sidebarInvert = sidebarInvert ? "1" : "0";
        document.documentElement.dataset.squareCorners = squareCorners ? "1" : "0";
        document.documentElement.dataset.bgMotion = bgMotion ? "1" : "0";
        document.documentElement.dataset.carouselFreeScroll = carouselFreeScroll ? "1" : "0";
        document.documentElement.dataset.maximized = maximizedWindow ? "1" : "0";
        var starDensity = 165;
        var starSpeed = 45;
        var starSize = 1.2;
        document.documentElement.style.setProperty("--star-density", String(starDensity));
        document.documentElement.style.setProperty("--star-speed", String(starSpeed) + "s");
        document.documentElement.style.setProperty("--star-size", String(starSize));
        var embedded = false;
        try {
          embedded = window.self !== window.top;
        } catch (err) {
          embedded = true;
        }
        document.documentElement.dataset.embedded = embedded ? "1" : "0";
        if (brandTheme === "custom") {
          var customHex = localStorage.getItem("launcharr-custom-color") || String(themeDefaults && themeDefaults.customColor || "#1cc6c2");
          var normalizedHex = /^#?[0-9a-fA-F]{6}$/.test(customHex) ? (customHex.charAt(0) === "#" ? customHex : "#" + customHex) : "#1cc6c2";
          var r = parseInt(normalizedHex.slice(1, 3), 16);
          var g = parseInt(normalizedHex.slice(3, 5), 16);
          var b = parseInt(normalizedHex.slice(5, 7), 16);
          var mix = function(base, target, amount) {
            return Math.round(base + (target - base) * amount);
          };
          var toHex = function(value) {
            var clamped = Math.max(0, Math.min(255, value));
            return clamped.toString(16).padStart(2, "0");
          };
          var dark = "#" + toHex(mix(r, 0, 0.4)) + toHex(mix(g, 0, 0.4)) + toHex(mix(b, 0, 0.4));
          var start = "#" + toHex(mix(r, 255, 0.35)) + toHex(mix(g, 255, 0.35)) + toHex(mix(b, 255, 0.35));
          var end = "#" + toHex(mix(r, 0, 0.2)) + toHex(mix(g, 0, 0.2)) + toHex(mix(b, 0, 0.2));
          var shadowR = mix(r, 0, 0.28);
          var shadowG = mix(g, 0, 0.28);
          var shadowB = mix(b, 0, 0.28);
          var linear = function(channel) {
            var value = channel / 255;
            return value <= 0.03928 ? value / 12.92 : Math.pow((value + 0.055) / 1.055, 2.4);
          };
          var luminance = 0.2126 * linear(r) + 0.7152 * linear(g) + 0.0722 * linear(b);
          var contrastWhite = 1.05 / (luminance + 0.05);
          var contrastBlack = (luminance + 0.05) / 0.05;
          var onBrand = contrastWhite >= contrastBlack ? "#ffffff" : "#081013";
          var onBrandMuted = contrastWhite >= contrastBlack ? "rgba(255,255,255,.78)" : "rgba(8,16,19,.72)";
          var onBrandIconFilter = contrastWhite >= contrastBlack ? "brightness(0) saturate(100%) invert(1)" : "brightness(0) saturate(100%)";
          document.documentElement.style.setProperty("--teal", normalizedHex.toLowerCase());
          document.documentElement.style.setProperty("--teal-dark", dark);
          document.documentElement.style.setProperty("--brand-rgb", r + "," + g + "," + b);
          document.documentElement.style.setProperty("--brand-btn-start", start);
          document.documentElement.style.setProperty("--brand-btn-mid", normalizedHex.toLowerCase());
          document.documentElement.style.setProperty("--brand-btn-end", end);
          document.documentElement.style.setProperty("--brand-btn-shadow", shadowR + "," + shadowG + "," + shadowB);
          document.documentElement.style.setProperty("--on-brand", onBrand);
          document.documentElement.style.setProperty("--on-brand-muted", onBrandMuted);
          document.documentElement.style.setProperty("--on-brand-icon-filter", onBrandIconFilter);
        }
      } catch (e) {}
    })();
  </script>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" type="image/png" href="/icons/launcharr-icon.png" />
  <meta name="theme-color" content="#1cc6c2" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/icons/launcharr-icon.png" />
</head>
<body class="dash-body">
  <div class="dash-frame">
    <aside class="dash-sidebar">
      <div class="dash-brand">
        <span class="dash-logo">
          <img class="nav-icon app-icon" src="/icons/launcharr-icon.png" alt="Launcharr" />
        </span>
        <div>
          <div class="dash-title">Launcharr</div>
        </div>
      </div>

      <div class="dash-nav">
        <a class="nav-item" href="/dashboard">
          <img class="nav-icon" src="/icons/dashboard.svg" alt="" />
          <span class="nav-label">Dashboard</span>
        </a>
        <% if (navCategories && navCategories.length) { %>
          <div class="nav-divider"></div>
          <div class="nav-accordion">
            <% navCategories.forEach((category) => { %>
              <% if (category.sidebarMenu) { %>
                <div class="nav-accordion-item nav-accordion-item--category">
                  <button class="nav-accordion-trigger nav-accordion-trigger--category" type="button">
                    <img class="nav-icon" src="<%= category.icon || '/icons/category.svg' %>" alt="" onerror="this.src='/icons/category.svg'" />
                    <span class="nav-label"><%= category.name %></span>
                  </button>
                  <div class="nav-accordion-panel nav-accordion-panel--category">
                    <div class="nav-accordion nav-accordion--nested">
                      <% category.apps.forEach((appItem) => { %>
                        <div class="nav-accordion-item">
                          <button class="nav-accordion-trigger" type="button">
                            <img class="nav-icon app-icon" src="<%= appItem.icon || (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'seerr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission', 'jellyfin', 'emby'].includes(appItem.id) ? '/icons/' + appItem.id + '.png' : '/icons/' + appItem.id + '.svg') %>" alt="" onerror="this.src='/icons/app.svg'" />
                            <span class="nav-label"><%= appItem.name %></span>
                          </button>
                          <div class="nav-accordion-panel">
                            <% if (appItem.menuAccess.overview) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>">
                                <img class="nav-subicon" src="/icons/overview.svg" alt="" />
                                <span>Overview</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.launch) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>/launch" <%= appItem.effectiveLaunchMode === 'new-tab' ? 'target="_blank" rel="noreferrer"' : '' %>>
                                <img class="nav-subicon" src="/icons/launch.svg" alt="" />
                                <span>Launch</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.settings) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>/settings">
                                <img class="nav-subicon" src="/icons/settings.svg" alt="" />
                                <span>App settings</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.activity) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>/activity">
                                <img class="nav-subicon" src="/icons/activity-queue.svg" alt="" />
                                <span>Activity</span>
                              </a>
                            <% } %>
                          </div>
                        </div>
                      <% }) %>
                    </div>
                  </div>
                </div>
              <% } else { %>
                <% category.apps.forEach((appItem) => { %>
                  <div class="nav-accordion-item">
                    <button class="nav-accordion-trigger" type="button">
                      <img class="nav-icon app-icon" src="<%= appItem.icon || (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'seerr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission', 'jellyfin', 'emby'].includes(appItem.id) ? '/icons/' + appItem.id + '.png' : '/icons/' + appItem.id + '.svg') %>" alt="" onerror="this.src='/icons/app.svg'" />
                      <span class="nav-label"><%= appItem.name %></span>
                    </button>
                    <div class="nav-accordion-panel">
                      <% if (appItem.menuAccess.overview) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>">
                          <img class="nav-subicon" src="/icons/overview.svg" alt="" />
                          <span>Overview</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.launch) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>/launch" <%= appItem.effectiveLaunchMode === 'new-tab' ? 'target="_blank" rel="noreferrer"' : '' %>>
                          <img class="nav-subicon" src="/icons/launch.svg" alt="" />
                          <span>Launch</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.settings) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>/settings">
                          <img class="nav-subicon" src="/icons/settings.svg" alt="" />
                          <span>App settings</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.activity) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>/activity">
                          <img class="nav-subicon" src="/icons/activity-queue.svg" alt="" />
                          <span>Activity</span>
                        </a>
                      <% } %>
                    </div>
                  </div>
                <% }) %>
              <% } %>
            <% }) %>
          </div>
        <% } %>
      </div>

      <div class="dash-user">
        <div class="user-pill user-pill--menu" data-user-menu role="button" tabindex="0" aria-haspopup="true" aria-expanded="false">
          <img class="user-avatar" src="<%= user.avatar || user.avatarFallback || '/icons/user-profile.svg' %>" alt="" onerror="this.onerror=null;this.src='<%= user.avatarFallback || '/icons/user-profile.svg' %>';" />
          <div class="user-meta">
            <span class="role"><%= role %></span>
            <div class="username"><%= user.username %></div>
            <% if (user.email) { %>
              <div class="email"><%= user.email %></div>
            <% } %>
          </div>
          <span class="user-pill-caret" aria-hidden="true"></span>
          <div class="user-menu" role="menu">
            <% if (actualRole === 'admin') { %>
              <a class="user-menu-item" href="/settings">
                <img class="user-menu-icon" src="/icons/settings.svg" alt="" />
                <span class="user-menu-text">Settings</span>
              </a>
            <% } %>
            <% if (actualRole === 'admin') { %>
              <a class="user-menu-item" href="/switch-view?role=<%= role === 'admin' ? 'user' : 'admin' %>">
                <img class="user-menu-icon" src="/icons/window.svg" alt="" />
                <span class="user-menu-text"><%= role === 'admin' ? 'User view' : 'Admin view' %></span>
              </a>
            <% } %>
            <a class="user-menu-item" href="/user-settings">
              <img class="user-menu-icon" src="/icons/user-profile.svg" alt="" />
              <span class="user-menu-text">User profile</span>
            </a>
            <div class="user-menu-divider"></div>
            <a class="user-menu-item" href="/logout">
              <img class="user-menu-icon" src="/icons/logout.svg" alt="" />
              <span class="user-menu-text">Sign out</span>
            </a>
          </div>
        </div>
      </div>
    </aside>

    <section class="dash-main">
      <div class="main-window-bar">
        <button class="sidebar-toggle main-toggle left-toggle" type="button" aria-label="Toggle sidebar">
          <img class="toggle-icon" src="/icons/sidebar-toggle.svg" alt="" />
        </button>
        <div class="main-window-title">
          <img class="main-window-icon" src="/icons/user-profile.svg" alt="" />
          <span class="main-window-app">User Profile</span>
        </div>
        <div class="main-window-spacer"></div>
        <div class="main-window-status">
          <span class="status-dot"></span>
        </div>
      </div>

      <div class="dash-panel">
        <div class="panel-header">
          <h2>User Profile</h2>
          <span class="panel-sub">Profile and view mode</span>
        </div>
        <%
          const profileResultMap = {
            saved: 'Profile details updated.',
          };
          const profileNote = profileError
            ? profileError
            : (profileResultMap[profileResult] || (isLocalUser
              ? 'Update your Launcharr account details.'
              : 'This profile is managed by your Plex account.'));
          const profileRole = isLocalUser
            ? (localProfile?.role || actualRole)
            : role;
        %>
        <div class="settings-form">
          <div class="settings-card">
            <div class="settings-profile-head">
              <div class="settings-profile-head-copy">
                <div class="settings-card-title">Profile</div>
                <div class="settings-card-sub"><%= isLocalUser ? 'Launcharr account details' : 'Plex account details' %></div>
              </div>
              <strong class="settings-role-pill settings-role-pill--profile">
                <img class="settings-role-pill-icon" src="/icons/role.svg" alt="" />
                <%= profileRole %>
              </strong>
            </div>
            <%
              const profileAvatarFallback = user.avatarFallback || '/icons/user-profile.svg';
              const profileAvatarSrc = (localProfile?.avatar || user.avatar || profileAvatarFallback);
            %>
            <div class="settings-profile-avatar">
              <img
                class="settings-profile-avatar-image"
                id="profileAvatarPreview"
                src="<%= profileAvatarSrc %>"
                alt="Current avatar"
                onerror="this.onerror=null;this.src='<%= profileAvatarFallback %>';"
              />
              <div class="settings-profile-avatar-meta">
                <strong class="settings-profile-avatar-label">Current avatar</strong>
                <span class="settings-profile-avatar-help">PNG, JPG, or WEBP up to 2 MB.</span>
              </div>
            </div>
            <span class="settings-users-note<%= profileError ? ' settings-users-note--error' : '' %>"><%= profileNote %></span>
            <% if (isLocalUser) { %>
              <form method="post" action="/user-settings/profile" class="settings-form" id="profileDetailsForm">
                <input type="hidden" name="avatarDataUrl" id="avatarDataUrl" value="" />
                <label class="field">
                  <span>Username</span>
                  <input type="text" name="username" value="<%= localProfile?.username || user.username || '' %>" required />
                </label>
                <label class="field">
                  <span>Email (optional)</span>
                  <input type="email" name="email" value="<%= localProfile?.email || user.email || '' %>" />
                </label>
                <label class="field">
                  <span>New password (optional)</span>
                  <input type="password" name="newPassword" placeholder="Leave blank to keep current password" />
                </label>
                <label class="field">
                  <span>Confirm new password</span>
                  <input type="password" name="confirmPassword" placeholder="Repeat new password" />
                </label>
                <label class="field">
                  <span>Avatar image (optional)</span>
                  <input class="settings-icon-file" type="file" id="avatarUploadInput" accept="image/png,image/jpeg,image/webp" />
                </label>
                <span class="settings-users-note settings-users-note--error" id="avatarUploadError" hidden></span>
                <button class="primary-button" type="submit">Save profile details</button>
              </form>
            <% } else { %>
              <div class="settings-card-lines">
                <div class="settings-card-line"><span>Username</span><strong><%= user.username %></strong></div>
                <% if (user.email) { %>
                  <div class="settings-card-line"><span>Email</span><strong><%= user.email %></strong></div>
                <% } %>
              </div>
            <% } %>
          </div>

          <%
            const themeResultMap = {
              saved: 'Theme preference saved.',
            };
            const themeNote = themeError
              ? themeError
              : (themeResultMap[themeResult] || '');
          %>
          <div class="settings-card settings-card--themes">
            <div class="settings-card-title">Theme</div>
            <div class="settings-card-sub">Customize your personal Launcharr appearance.</div>
            <div class="theme-presets" id="profileThemePresets">
              <button class="theme-preset-card" type="button" data-brand-theme="launcharr">
                <span class="theme-preset-chip" style="--theme-color:#6d7a86;"></span>
                <span class="theme-preset-name">Launcharr</span>
                <span class="theme-preset-meta">Gunmetal</span>
              </button>
              <button class="theme-preset-card" type="button" data-brand-theme="rocketship">
                <span class="theme-preset-chip" style="--theme-color:#b8c1ca;"></span>
                <span class="theme-preset-name">Rocketship</span>
                <span class="theme-preset-meta">Silver</span>
              </button>
              <button class="theme-preset-card" type="button" data-brand-theme="pulsarr">
                <span class="theme-preset-chip" style="--theme-color:#1cc6c2;"></span>
                <span class="theme-preset-name">Pulsarr</span>
                <span class="theme-preset-meta">Pulsarr teal</span>
              </button>
              <button class="theme-preset-card" type="button" data-brand-theme="plex">
                <span class="theme-preset-chip" style="--theme-color:#f9ad2f;"></span>
                <span class="theme-preset-name">Plex</span>
                <span class="theme-preset-meta">Plex orange</span>
              </button>
              <button class="theme-preset-card" type="button" data-brand-theme="radarr">
                <span class="theme-preset-chip" style="--theme-color:#f4c542;"></span>
                <span class="theme-preset-name">Radarr</span>
                <span class="theme-preset-meta">Radarr yellow</span>
              </button>
              <button class="theme-preset-card" type="button" data-brand-theme="sonarr">
                <span class="theme-preset-chip" style="--theme-color:#3d7bfd;"></span>
                <span class="theme-preset-name">Sonarr</span>
                <span class="theme-preset-meta">Sonarr blue</span>
              </button>
              <button class="theme-preset-card" type="button" data-brand-theme="lidarr">
                <span class="theme-preset-chip" style="--theme-color:#53b86a;"></span>
                <span class="theme-preset-name">Lidarr</span>
                <span class="theme-preset-meta">Lidarr green</span>
              </button>
              <button class="theme-preset-card" type="button" data-brand-theme="readarr">
                <span class="theme-preset-chip" style="--theme-color:#d84a4a;"></span>
                <span class="theme-preset-name">Readarr</span>
                <span class="theme-preset-meta">Readarr red</span>
              </button>
              <button class="theme-preset-card" type="button" data-brand-theme="custom">
                <span class="theme-preset-chip theme-preset-chip--custom" data-custom-chip style="--theme-color:#1cc6c2;">
                  <input class="theme-chip-picker" id="profileCustomThemeColor" type="color" value="#1cc6c2" aria-label="Choose custom theme color" />
                </span>
                <span class="theme-preset-name">Custom</span>
                <span class="theme-preset-meta">Color wheel</span>
              </button>
            </div>
            <div class="theme-options" id="profileThemeOptions">
              <label class="settings-toggle theme-option">
                <input id="profileThemeSidebarInvert" type="checkbox" />
                <span class="settings-toggle-slider" aria-hidden="true"></span>
                <span class="theme-option-copy">
                  <strong>Invert sidebar colors</strong>
                  <small>Swap sidebar dark/theme emphasis.</small>
                </span>
              </label>
              <label class="settings-toggle theme-option">
                <input id="profileThemeSquareCorners" type="checkbox" />
                <span class="settings-toggle-slider" aria-hidden="true"></span>
                <span class="theme-option-copy">
                  <strong>Square corners</strong>
                  <small>Remove rounded corners across the UI.</small>
                </span>
              </label>
              <label class="settings-toggle theme-option">
                <input id="profileThemeBgMotion" type="checkbox" checked />
                <span class="settings-toggle-slider" aria-hidden="true"></span>
                <span class="theme-option-copy">
                  <strong>Animated space background</strong>
                  <small>Theme-linked moving star field.</small>
                </span>
              </label>
              <label class="settings-toggle theme-option">
                <input id="profileThemeCarouselFreeScroll" type="checkbox" />
                <span class="settings-toggle-slider" aria-hidden="true"></span>
                <span class="theme-option-copy">
                  <strong>Free carousel scroll</strong>
                  <small>Disable index snapping and allow fast horizontal swipe scrolling.</small>
                </span>
              </label>
            </div>
            <form method="post" action="/user-settings/theme" class="settings-card-actions" id="profileThemeSaveForm">
              <input type="hidden" name="theme_mode" id="profileThemeMode" />
              <input type="hidden" name="theme_brand_theme" id="profileThemeBrandTheme" />
              <input type="hidden" name="theme_custom_color" id="profileThemeCustomColor" />
              <input type="hidden" name="theme_sidebar_invert" id="profileThemeSidebarInvertValue" />
              <input type="hidden" name="theme_square_corners" id="profileThemeSquareCornersValue" />
              <input type="hidden" name="theme_bg_motion" id="profileThemeBgMotionValue" />
              <input type="hidden" name="theme_carousel_free_scroll" id="profileThemeCarouselFreeScrollValue" />
              <button class="primary-button" type="submit">Save my theme</button>
            </form>
            <% if (themeNote) { %>
              <span class="settings-users-note<%= themeError ? ' settings-users-note--error' : '' %>"><%= themeNote %></span>
            <% } %>
          </div>

          <% if (actualRole === 'admin') { %>
            <div class="settings-card">
              <div class="settings-card-title">View mode</div>
              <div class="settings-card-sub">Preview user access without leaving your account</div>
              <form method="get" action="/switch-view" class="settings-access-form" id="viewModeForm">
                <input type="hidden" name="role" value="<%= role === 'admin' ? 'user' : 'admin' %>" />
                <div class="settings-access-row">
                  <label class="settings-toggle">
                    <input type="checkbox" id="viewModeToggle" <%= role === 'admin' ? 'checked' : '' %> />
                    <span class="settings-toggle-slider" aria-hidden="true"></span>
                    <span class="settings-toggle-text"><%= role === 'admin' ? 'Admin view' : 'User view' %></span>
                  </label>
                  <button class="primary-button" type="submit"><%= role === 'admin' ? 'Switch to user view' : 'Switch to admin view' %></button>
                </div>
              </form>
            </div>
          <% } %>
        </div>
      </div>
    </section>
  </div>
  <script>
    const dashFrame = document.querySelector('.dash-frame');
    const toggle = document.querySelector('.sidebar-toggle');
    const toggleIcon = toggle?.querySelector('img');
    const mobileQuery = window.matchMedia('(max-width: 980px)');
    const isMobile = () => mobileQuery.matches;
    const mainContent = document.querySelector('.dash-main');
    const sidebar = document.querySelector('.dash-sidebar');
    const dashNav = document.querySelector('.dash-nav');
    const safeStorage = {
      get(key) {
        try {
          return localStorage.getItem(key);
        } catch (err) {
          return null;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (err) {
          return;
        }
      },
    };
    const userMenus = document.querySelectorAll('[data-user-menu]');
    const serverThemeDefaults = <%- JSON.stringify(themeDefaults || {}) %>;
    const profileThemePresetButtons = Array.from(document.querySelectorAll('#profileThemePresets .theme-preset-card'));
    const profileCustomThemeColorInput = document.getElementById('profileCustomThemeColor');
    const profileCustomThemeChip = document.querySelector('#profileThemePresets [data-custom-chip]');
    const profileThemeSidebarInvertToggle = document.getElementById('profileThemeSidebarInvert');
    const profileThemeSquareCornersToggle = document.getElementById('profileThemeSquareCorners');
    const profileThemeBgMotionToggle = document.getElementById('profileThemeBgMotion');
    const profileThemeCarouselFreeScrollToggle = document.getElementById('profileThemeCarouselFreeScroll');
    const profileThemeSaveForm = document.getElementById('profileThemeSaveForm');
    const profileThemeModeInput = document.getElementById('profileThemeMode');
    const profileThemeBrandThemeInput = document.getElementById('profileThemeBrandTheme');
    const profileThemeCustomColorInput = document.getElementById('profileThemeCustomColor');
    const profileThemeSidebarInvertValueInput = document.getElementById('profileThemeSidebarInvertValue');
    const profileThemeSquareCornersValueInput = document.getElementById('profileThemeSquareCornersValue');
    const profileThemeBgMotionValueInput = document.getElementById('profileThemeBgMotionValue');
    const profileThemeCarouselFreeScrollValueInput = document.getElementById('profileThemeCarouselFreeScrollValue');
    const allowedBrandThemes = new Set(['custom', 'launcharr', 'rocketship', 'pulsarr', 'plex', 'radarr', 'sonarr', 'lidarr', 'readarr']);
    const customColorStorageKey = 'launcharr-custom-color';
    const themeOptionStorageKeys = {
      sidebarInvert: 'launcharr-sidebar-invert',
      squareCorners: 'launcharr-square-corners',
      bgMotion: 'launcharr-bg-motion',
      carouselFreeScroll: 'launcharr-carousel-free-scroll',
    };
    const parseStoredBool = (key, defaultValue = false) => {
      const raw = safeStorage.get(key);
      if (raw === null || raw === undefined) return defaultValue;
      return raw === '1' || raw === 'true';
    };
    const resolveBrandTheme = (value) => {
      const raw = String(value || '').trim().toLowerCase();
      return allowedBrandThemes.has(raw) ? raw : 'pulsarr';
    };
    const parseHexColor = (value) => {
      const raw = String(value || '').trim();
      const normalized = raw.startsWith('#') ? raw : `#${raw}`;
      return /^#[0-9a-fA-F]{6}$/.test(normalized) ? normalized.toLowerCase() : '#1cc6c2';
    };
    const hexToRgb = (hex) => ({
      r: Number.parseInt(hex.slice(1, 3), 16),
      g: Number.parseInt(hex.slice(3, 5), 16),
      b: Number.parseInt(hex.slice(5, 7), 16),
    });
    const rgbToHex = (r, g, b) => `#${[r, g, b].map((value) => Math.max(0, Math.min(255, Math.round(value))).toString(16).padStart(2, '0')).join('')}`;
    const mixRgb = (base, target, amount) => ({
      r: base.r + (target.r - base.r) * amount,
      g: base.g + (target.g - base.g) * amount,
      b: base.b + (target.b - base.b) * amount,
    });
    const clearCustomThemeVars = () => {
      const rootStyle = document.documentElement.style;
      ['--teal', '--teal-dark', '--brand-rgb', '--brand-btn-start', '--brand-btn-mid', '--brand-btn-end', '--brand-btn-shadow', '--on-brand', '--on-brand-muted', '--on-brand-icon-filter'].forEach((name) => {
        rootStyle.removeProperty(name);
      });
    };
    const applyCustomColor = (inputHex) => {
      const hex = parseHexColor(inputHex);
      const base = hexToRgb(hex);
      const dark = mixRgb(base, { r: 0, g: 0, b: 0 }, 0.4);
      const start = mixRgb(base, { r: 255, g: 255, b: 255 }, 0.35);
      const end = mixRgb(base, { r: 0, g: 0, b: 0 }, 0.2);
      const shadow = mixRgb(base, { r: 0, g: 0, b: 0 }, 0.28);
      const toLinear = (channel) => {
        const value = channel / 255;
        return value <= 0.03928 ? value / 12.92 : Math.pow((value + 0.055) / 1.055, 2.4);
      };
      const luminance = 0.2126 * toLinear(base.r) + 0.7152 * toLinear(base.g) + 0.0722 * toLinear(base.b);
      const contrastWhite = 1.05 / (luminance + 0.05);
      const contrastBlack = (luminance + 0.05) / 0.05;
      const onBrand = contrastWhite >= contrastBlack ? '#ffffff' : '#081013';
      const onBrandMuted = contrastWhite >= contrastBlack ? 'rgba(255,255,255,.78)' : 'rgba(8,16,19,.72)';
      const onBrandIconFilter = contrastWhite >= contrastBlack ? 'brightness(0) saturate(100%) invert(1)' : 'brightness(0) saturate(100%)';
      const rootStyle = document.documentElement.style;
      rootStyle.setProperty('--teal', hex);
      rootStyle.setProperty('--teal-dark', rgbToHex(dark.r, dark.g, dark.b));
      rootStyle.setProperty('--brand-rgb', `${Math.round(base.r)},${Math.round(base.g)},${Math.round(base.b)}`);
      rootStyle.setProperty('--brand-btn-start', rgbToHex(start.r, start.g, start.b));
      rootStyle.setProperty('--brand-btn-mid', hex);
      rootStyle.setProperty('--brand-btn-end', rgbToHex(end.r, end.g, end.b));
      rootStyle.setProperty('--brand-btn-shadow', `${Math.round(shadow.r)},${Math.round(shadow.g)},${Math.round(shadow.b)}`);
      rootStyle.setProperty('--on-brand', onBrand);
      rootStyle.setProperty('--on-brand-muted', onBrandMuted);
      rootStyle.setProperty('--on-brand-icon-filter', onBrandIconFilter);
      if (profileCustomThemeChip) profileCustomThemeChip.style.setProperty('--theme-color', hex);
      return hex;
    };
    const syncProfileThemeSaveForm = () => {
      if (!profileThemeSaveForm) return;
      if (profileThemeModeInput) {
        profileThemeModeInput.value = document.documentElement.dataset.theme === 'day' ? 'day' : 'night';
      }
      if (profileThemeBrandThemeInput) {
        profileThemeBrandThemeInput.value = resolveBrandTheme(document.documentElement.dataset.brandTheme || serverThemeDefaults.brandTheme);
      }
      if (profileThemeCustomColorInput) {
        profileThemeCustomColorInput.value = parseHexColor(safeStorage.get(customColorStorageKey) || serverThemeDefaults.customColor || '#1cc6c2');
      }
      if (profileThemeSidebarInvertValueInput) {
        profileThemeSidebarInvertValueInput.value = profileThemeSidebarInvertToggle?.checked ? '1' : '0';
      }
      if (profileThemeSquareCornersValueInput) {
        profileThemeSquareCornersValueInput.value = profileThemeSquareCornersToggle?.checked ? '1' : '0';
      }
      if (profileThemeBgMotionValueInput) {
        profileThemeBgMotionValueInput.value = profileThemeBgMotionToggle?.checked ? '1' : '0';
      }
      if (profileThemeCarouselFreeScrollValueInput) {
        profileThemeCarouselFreeScrollValueInput.value = profileThemeCarouselFreeScrollToggle?.checked ? '1' : '0';
      }
    };
    const applyThemeOptions = (options = {}) => {
      const sidebarInvert = Boolean(options.sidebarInvert);
      const squareCorners = Boolean(options.squareCorners);
      const bgMotion = options.bgMotion !== false;
      const starDensity = 165;
      const starSpeed = 45;
      const starSize = 1.2;
      const carouselFreeScroll = Boolean(options.carouselFreeScroll);
      document.documentElement.dataset.sidebarInvert = sidebarInvert ? '1' : '0';
      document.documentElement.dataset.squareCorners = squareCorners ? '1' : '0';
      document.documentElement.dataset.bgMotion = bgMotion ? '1' : '0';
      document.documentElement.style.setProperty('--star-density', String(starDensity));
      document.documentElement.style.setProperty('--star-speed', `${starSpeed}s`);
      document.documentElement.style.setProperty('--star-size', String(starSize));
      document.documentElement.dataset.carouselFreeScroll = carouselFreeScroll ? '1' : '0';
      safeStorage.set(themeOptionStorageKeys.sidebarInvert, sidebarInvert ? '1' : '0');
      safeStorage.set(themeOptionStorageKeys.squareCorners, squareCorners ? '1' : '0');
      safeStorage.set(themeOptionStorageKeys.bgMotion, bgMotion ? '1' : '0');
      safeStorage.set(themeOptionStorageKeys.carouselFreeScroll, carouselFreeScroll ? '1' : '0');
      if (profileThemeSidebarInvertToggle) profileThemeSidebarInvertToggle.checked = sidebarInvert;
      if (profileThemeSquareCornersToggle) profileThemeSquareCornersToggle.checked = squareCorners;
      if (profileThemeBgMotionToggle) profileThemeBgMotionToggle.checked = bgMotion;
      if (profileThemeCarouselFreeScrollToggle) profileThemeCarouselFreeScrollToggle.checked = carouselFreeScroll;
      syncProfileThemeSaveForm();
    };
    const syncThemeOptionsFromInputs = () => {
      applyThemeOptions({
        sidebarInvert: Boolean(profileThemeSidebarInvertToggle?.checked),
        squareCorners: Boolean(profileThemeSquareCornersToggle?.checked),
        bgMotion: Boolean(profileThemeBgMotionToggle?.checked),
        carouselFreeScroll: Boolean(profileThemeCarouselFreeScrollToggle?.checked),
      });
    };
    const applyBrandTheme = (theme) => {
      const normalized = allowedBrandThemes.has(theme) ? theme : 'pulsarr';
      document.documentElement.dataset.brandTheme = normalized;
      safeStorage.set('launcharr-brand-theme', normalized);
      if (normalized === 'custom') {
        const savedCustomHex = parseHexColor(safeStorage.get(customColorStorageKey) || serverThemeDefaults.customColor || '#1cc6c2');
        const appliedHex = applyCustomColor(savedCustomHex);
        if (profileCustomThemeColorInput) profileCustomThemeColorInput.value = appliedHex;
      } else {
        clearCustomThemeVars();
      }
      profileThemePresetButtons.forEach((btn) => {
        const isActive = btn.dataset.brandTheme === normalized;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
      syncProfileThemeSaveForm();
    };
    const initialThemeOptions = {
      sidebarInvert: parseStoredBool(themeOptionStorageKeys.sidebarInvert, serverThemeDefaults.sidebarInvert === true),
      squareCorners: parseStoredBool(themeOptionStorageKeys.squareCorners, serverThemeDefaults.squareCorners === true),
      bgMotion: parseStoredBool(themeOptionStorageKeys.bgMotion, serverThemeDefaults.bgMotion === undefined ? true : serverThemeDefaults.bgMotion === true),
      carouselFreeScroll: parseStoredBool(themeOptionStorageKeys.carouselFreeScroll, serverThemeDefaults.carouselFreeScroll === true),
    };
    applyThemeOptions(initialThemeOptions);
    profileThemeSidebarInvertToggle?.addEventListener('change', syncThemeOptionsFromInputs);
    profileThemeSquareCornersToggle?.addEventListener('change', syncThemeOptionsFromInputs);
    profileThemeBgMotionToggle?.addEventListener('change', syncThemeOptionsFromInputs);
    profileThemeCarouselFreeScrollToggle?.addEventListener('change', syncThemeOptionsFromInputs);
    if (profileThemePresetButtons.length) {
      const initialCustomHex = parseHexColor(safeStorage.get(customColorStorageKey) || serverThemeDefaults.customColor || '#1cc6c2');
      if (profileCustomThemeColorInput) profileCustomThemeColorInput.value = initialCustomHex;
      if (profileCustomThemeChip) profileCustomThemeChip.style.setProperty('--theme-color', initialCustomHex);
      const storedBrandTheme = safeStorage.get('launcharr-brand-theme');
      const fallbackBrandTheme = resolveBrandTheme(serverThemeDefaults.brandTheme);
      applyBrandTheme(allowedBrandThemes.has(storedBrandTheme) ? storedBrandTheme : fallbackBrandTheme);
      profileThemePresetButtons.forEach((btn) => {
        btn.addEventListener('click', () => applyBrandTheme(btn.dataset.brandTheme));
      });
      profileCustomThemeColorInput?.addEventListener('input', () => {
        const hex = parseHexColor(profileCustomThemeColorInput.value);
        safeStorage.set(customColorStorageKey, hex);
        applyBrandTheme('custom');
      });
    }
    syncProfileThemeSaveForm();
    profileThemeSaveForm?.addEventListener('submit', () => {
      syncProfileThemeSaveForm();
    });

    function setToggleIcon() {
      if (!toggleIcon) return;
      toggleIcon.src = '/icons/sidebar-toggle.svg';
    }

    function applySidebarState() {
      if (!dashFrame) return;
      if (isMobile()) {
        dashFrame.classList.remove('sidebar-collapsed');
        dashFrame.classList.remove('mobile-nav-open');
        document.body.classList.remove('mobile-nav-open');
        if (dashNav) dashNav.scrollTop = 0;
        setToggleIcon(false);
      } else {
        const collapsed = safeStorage.get('sidebarCollapsed') === 'true';
        dashFrame.classList.toggle('sidebar-collapsed', collapsed);
        dashFrame.classList.remove('mobile-nav-open');
        document.body.classList.remove('mobile-nav-open');
        if (dashNav) dashNav.scrollTop = 0;
        setToggleIcon(!collapsed);
      }
    }

    function closeMobileNav() {
      if (!dashFrame || !isMobile()) return;
      if (!dashFrame.classList.contains('mobile-nav-open')) return;
      dashFrame.classList.remove('mobile-nav-open');
      document.body.classList.remove('mobile-nav-open');
      setToggleIcon(false);
    }

    applySidebarState();
    mobileQuery.addEventListener('change', applySidebarState);
    const autoOpenSingleAppMenuItem = <%= autoOpenSingleAppMenuItem ? 'true' : 'false' %>;
    const accordion = document.querySelectorAll('.nav-accordion-item');
    accordion.forEach((item) => {
      const trigger = item.querySelector('.nav-accordion-trigger');
      if (!trigger) return;
      trigger.addEventListener('click', (event) => {
        event.stopPropagation();
        const isCategoryTrigger = trigger.classList.contains('nav-accordion-trigger--category');
        if (autoOpenSingleAppMenuItem && !isCategoryTrigger) {
          const panel = Array.from(item.children).find((child) => child.classList && child.classList.contains('nav-accordion-panel'));
          const directLinks = panel
            ? Array.from(panel.children).filter((child) => typeof child.matches === 'function' && child.matches('a.nav-subitem[href]'))
            : [];
          if (directLinks.length === 1) {
            const [onlyLink] = directLinks;
            if (onlyLink.target === '_blank') {
              window.open(onlyLink.href, '_blank', 'noopener,noreferrer');
            } else {
              window.location.href = onlyLink.href;
            }
            return;
          }
        }
        const parentAccordion = item.closest('.nav-accordion');
        const siblings = parentAccordion
          ? Array.from(parentAccordion.children).filter((child) => child.classList.contains('nav-accordion-item'))
          : [];
        siblings.forEach((other) => {
          if (other !== item) other.classList.remove('open');
        });
        item.classList.toggle('open');
      });
    });

    function handleSidebarToggle() {
      if (!dashFrame) return;
      if (isMobile()) {
        dashFrame.classList.remove('sidebar-collapsed');
        const isOpen = dashFrame.classList.toggle('mobile-nav-open');
        document.body.classList.toggle('mobile-nav-open', isOpen);
        if (dashNav) dashNav.scrollTop = 0;
        setToggleIcon(isOpen);
        return;
      }
      const isCollapsed = dashFrame.classList.toggle('sidebar-collapsed');
      safeStorage.set('sidebarCollapsed', isCollapsed ? 'true' : 'false');
      if (dashNav) dashNav.scrollTop = 0;
      setToggleIcon(!isCollapsed);
    }

    toggle?.addEventListener('click', handleSidebarToggle);

    mainContent?.addEventListener('click', (event) => {
      if (event.target.closest('.sidebar-toggle')) return;
      if (event.target.closest('.main-window-bar')) return;
      closeMobileNav();
    });

    sidebar?.addEventListener('click', (event) => {
      if (!isMobile() || !dashFrame?.classList.contains('mobile-nav-open')) return;
      const link = event.target.closest('a');
      if (!link || !link.classList.contains('active')) return;
      event.preventDefault();
      closeMobileNav();
    });

    function closeUserMenus(except) {
      userMenus.forEach((menu) => {
        if (menu === except) return;
        menu.classList.remove('user-pill--open');
        menu.setAttribute('aria-expanded', 'false');
      });
    }

    userMenus.forEach((menu) => {
      menu.setAttribute('aria-expanded', 'false');
      menu.addEventListener('click', (event) => {
        if (event.target.closest('.user-menu')) return;
        event.preventDefault();
        const isOpen = menu.classList.contains('user-pill--open');
        closeUserMenus(menu);
        menu.classList.toggle('user-pill--open', !isOpen);
        menu.setAttribute('aria-expanded', !isOpen ? 'true' : 'false');
      });
      menu.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        event.preventDefault();
        menu.click();
      });
    });

    document.addEventListener('click', (event) => {
      if (event.target.closest('[data-user-menu]')) return;
      closeUserMenus();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      closeUserMenus();
    });

    const viewModeForm = document.getElementById('viewModeForm');
    const viewModeToggle = document.getElementById('viewModeToggle');
    if (viewModeForm && viewModeToggle) {
      viewModeToggle.addEventListener('change', () => {
        viewModeForm.submit();
      });
    }

    const avatarUploadInput = document.getElementById('avatarUploadInput');
    const avatarDataUrlField = document.getElementById('avatarDataUrl');
    const avatarPreview = document.getElementById('profileAvatarPreview');
    const avatarUploadError = document.getElementById('avatarUploadError');
    const MAX_AVATAR_BYTES = 2 * 1024 * 1024;
    const MIN_AVATAR_DIMENSION = 64;
    const MAX_AVATAR_DIMENSION = 1024;
    const ALLOWED_AVATAR_TYPES = new Set(['image/png', 'image/jpeg', 'image/webp']);

    function setAvatarError(message) {
      if (!avatarUploadError) return;
      const text = String(message || '').trim();
      avatarUploadError.hidden = !text;
      avatarUploadError.textContent = text;
    }

    function resetAvatarUploadInput() {
      if (!avatarUploadInput) return;
      avatarUploadInput.value = '';
      if (avatarDataUrlField) avatarDataUrlField.value = '';
    }

    if (avatarUploadInput && avatarDataUrlField && avatarPreview) {
      avatarUploadInput.addEventListener('change', () => {
        setAvatarError('');
        avatarDataUrlField.value = '';
        const file = avatarUploadInput.files && avatarUploadInput.files[0];
        if (!file) return;

        const mime = String(file.type || '').trim().toLowerCase();
        if (!ALLOWED_AVATAR_TYPES.has(mime)) {
          setAvatarError('Avatar must be PNG, JPG, or WEBP.');
          resetAvatarUploadInput();
          return;
        }
        if (file.size > MAX_AVATAR_BYTES) {
          setAvatarError('Avatar image is too large. Maximum size is 2 MB.');
          resetAvatarUploadInput();
          return;
        }

        const reader = new FileReader();
        reader.onerror = () => {
          setAvatarError('Avatar file could not be read.');
          resetAvatarUploadInput();
        };
        reader.onload = () => {
          const dataUrl = String(reader.result || '');
          if (!dataUrl) {
            setAvatarError('Avatar file is empty.');
            resetAvatarUploadInput();
            return;
          }
          const probe = new Image();
          probe.onerror = () => {
            setAvatarError('Avatar file is not a valid image.');
            resetAvatarUploadInput();
          };
          probe.onload = () => {
            const width = Number(probe.naturalWidth || 0);
            const height = Number(probe.naturalHeight || 0);
            if (
              width < MIN_AVATAR_DIMENSION
              || height < MIN_AVATAR_DIMENSION
              || width > MAX_AVATAR_DIMENSION
              || height > MAX_AVATAR_DIMENSION
            ) {
              setAvatarError('Avatar dimensions must be between 64x64 and 1024x1024 pixels.');
              resetAvatarUploadInput();
              return;
            }
            avatarDataUrlField.value = dataUrl;
            avatarPreview.src = dataUrl;
          };
          probe.src = dataUrl;
        };
        reader.readAsDataURL(file);
      });
    }
  </script>
  <script src="/version-badge.js"></script>
  <script src="/brand-menu.js?v=<%= assetVersion %>"></script>
  <script src="/starfield-3d.js"></script>
  <script src="/pwa.js"></script>
</body>
</html>
