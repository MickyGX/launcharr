<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Launcharr - Settings</title>
  <script>
    (function() {
      try {
        var stored = localStorage.getItem("launcharr-theme");
        var prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
        var mode = stored || (prefersLight ? "day" : "night");
        var brandTheme = localStorage.getItem("launcharr-brand-theme") || "pulsarr";
        document.documentElement.dataset.theme = mode;
        document.documentElement.dataset.brandTheme = brandTheme;
        var sidebarInvert = localStorage.getItem("launcharr-sidebar-invert") === "1";
        var squareCorners = localStorage.getItem("launcharr-square-corners") === "1";
        var bgMotionStored = localStorage.getItem("launcharr-bg-motion");
        var bgMotion = bgMotionStored === null ? true : bgMotionStored === "1";
        var maximizedWindow = localStorage.getItem("launcharr-maximized-window") === "1";
        document.documentElement.dataset.sidebarInvert = sidebarInvert ? "1" : "0";
        document.documentElement.dataset.squareCorners = squareCorners ? "1" : "0";
        document.documentElement.dataset.bgMotion = bgMotion ? "1" : "0";
        document.documentElement.dataset.maximized = maximizedWindow ? "1" : "0";
        var starDensity = 165;
        var starSpeed = 45;
        var starSize = 1.2;
        document.documentElement.style.setProperty("--star-density", String(starDensity));
        document.documentElement.style.setProperty("--star-speed", String(starSpeed) + "s");
        document.documentElement.style.setProperty("--star-size", String(starSize));
        var embedded = false;
        try {
          embedded = window.self !== window.top;
        } catch (err) {
          embedded = true;
        }
        document.documentElement.dataset.embedded = embedded ? "1" : "0";
        if (brandTheme === "custom") {
          var customHex = localStorage.getItem("launcharr-custom-color") || "#1cc6c2";
          var normalizedHex = /^#?[0-9a-fA-F]{6}$/.test(customHex) ? (customHex.charAt(0) === "#" ? customHex : "#" + customHex) : "#1cc6c2";
          var r = parseInt(normalizedHex.slice(1, 3), 16);
          var g = parseInt(normalizedHex.slice(3, 5), 16);
          var b = parseInt(normalizedHex.slice(5, 7), 16);
          var mix = function(base, target, amount) {
            return Math.round(base + (target - base) * amount);
          };
          var toHex = function(value) {
            var clamped = Math.max(0, Math.min(255, value));
            return clamped.toString(16).padStart(2, "0");
          };
          var dark = "#" + toHex(mix(r, 0, 0.4)) + toHex(mix(g, 0, 0.4)) + toHex(mix(b, 0, 0.4));
          var start = "#" + toHex(mix(r, 255, 0.35)) + toHex(mix(g, 255, 0.35)) + toHex(mix(b, 255, 0.35));
          var end = "#" + toHex(mix(r, 0, 0.2)) + toHex(mix(g, 0, 0.2)) + toHex(mix(b, 0, 0.2));
          var shadowR = mix(r, 0, 0.28);
          var shadowG = mix(g, 0, 0.28);
          var shadowB = mix(b, 0, 0.28);
          var linear = function(channel) {
            var value = channel / 255;
            return value <= 0.03928 ? value / 12.92 : Math.pow((value + 0.055) / 1.055, 2.4);
          };
          var luminance = 0.2126 * linear(r) + 0.7152 * linear(g) + 0.0722 * linear(b);
          var contrastWhite = 1.05 / (luminance + 0.05);
          var contrastBlack = (luminance + 0.05) / 0.05;
          var onBrand = contrastWhite >= contrastBlack ? "#ffffff" : "#081013";
          var onBrandMuted = contrastWhite >= contrastBlack ? "rgba(255,255,255,.78)" : "rgba(8,16,19,.72)";
          var onBrandIconFilter = contrastWhite >= contrastBlack ? "brightness(0) saturate(100%) invert(1)" : "brightness(0) saturate(100%)";
          document.documentElement.style.setProperty("--teal", normalizedHex.toLowerCase());
          document.documentElement.style.setProperty("--teal-dark", dark);
          document.documentElement.style.setProperty("--brand-rgb", r + "," + g + "," + b);
          document.documentElement.style.setProperty("--brand-btn-start", start);
          document.documentElement.style.setProperty("--brand-btn-mid", normalizedHex.toLowerCase());
          document.documentElement.style.setProperty("--brand-btn-end", end);
          document.documentElement.style.setProperty("--brand-btn-shadow", shadowR + "," + shadowG + "," + shadowB);
          document.documentElement.style.setProperty("--on-brand", onBrand);
          document.documentElement.style.setProperty("--on-brand-muted", onBrandMuted);
          document.documentElement.style.setProperty("--on-brand-icon-filter", onBrandIconFilter);
        }
      } catch (e) {}
    })();
  </script>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" type="image/png" href="/icons/launcharr-icon.png" />
  <meta name="theme-color" content="#1cc6c2" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/icons/launcharr-icon.png" />
</head>
<body class="dash-body">
  <div class="dash-frame">
    <aside class="dash-sidebar">
      <div class="dash-brand">
        <span class="dash-logo">
          <img class="nav-icon app-icon" src="/icons/launcharr-icon.png" alt="Launcharr" />
        </span>
        <div>
          <div class="dash-title">Launcharr</div>
        </div>
      </div>

      <div class="dash-nav">
        <a class="nav-item" href="/dashboard">
          <img class="nav-icon" src="/icons/dashboard.svg" alt="" />
          <span class="nav-label">Dashboard</span>
        </a>
        <% if (navCategories && navCategories.length) { %>
          <div class="nav-divider"></div>
          <div class="nav-accordion">
            <% navCategories.forEach((category) => { %>
              <% if (category.sidebarMenu) { %>
                <div class="nav-accordion-item nav-accordion-item--category">
                  <button class="nav-accordion-trigger nav-accordion-trigger--category" type="button">
                    <img class="nav-icon" src="<%= category.icon || '/icons/category.svg' %>" alt="" onerror="this.src='/icons/category.svg'" />
                    <span class="nav-label"><%= category.name %></span>
                  </button>
                  <div class="nav-accordion-panel nav-accordion-panel--category">
                    <div class="nav-accordion nav-accordion--nested">
                      <% category.apps.forEach((appItem) => { %>
                        <div class="nav-accordion-item">
                          <button class="nav-accordion-trigger" type="button">
                            <img class="nav-icon app-icon" src="<%= appItem.icon || (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'seerr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission', 'jellyfin', 'emby'].includes(appItem.id) ? '/icons/' + appItem.id + '.png' : '/icons/' + appItem.id + '.svg') %>" alt="" onerror="this.src='/icons/app.svg'" />
                            <span class="nav-label"><%= appItem.name %></span>
                          </button>
                          <div class="nav-accordion-panel">
                            <% if (appItem.menuAccess.overview) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>">
                                <img class="nav-subicon" src="/icons/overview.svg" alt="" />
                                <span>Overview</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.launch) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>/launch" <%= appItem.effectiveLaunchMode === 'new-tab' ? 'target="_blank" rel="noreferrer"' : '' %>>
                                <img class="nav-subicon" src="/icons/launch.svg" alt="" />
                                <span>Launch</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.settings) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>/settings">
                                <img class="nav-subicon" src="/icons/settings.svg" alt="" />
                                <span>App settings</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.activity) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>/activity">
                                <img class="nav-subicon" src="/icons/activity-queue.svg" alt="" />
                                <span>Activity</span>
                              </a>
                            <% } %>
                          </div>
                        </div>
                      <% }) %>
                    </div>
                  </div>
                </div>
              <% } else { %>
                <% category.apps.forEach((appItem) => { %>
                  <div class="nav-accordion-item">
                    <button class="nav-accordion-trigger" type="button">
                      <img class="nav-icon app-icon" src="<%= appItem.icon || (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'seerr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission', 'jellyfin', 'emby'].includes(appItem.id) ? '/icons/' + appItem.id + '.png' : '/icons/' + appItem.id + '.svg') %>" alt="" onerror="this.src='/icons/app.svg'" />
                      <span class="nav-label"><%= appItem.name %></span>
                    </button>
                    <div class="nav-accordion-panel">
                      <% if (appItem.menuAccess.overview) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>">
                          <img class="nav-subicon" src="/icons/overview.svg" alt="" />
                          <span>Overview</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.launch) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>/launch" <%= appItem.effectiveLaunchMode === 'new-tab' ? 'target="_blank" rel="noreferrer"' : '' %>>
                          <img class="nav-subicon" src="/icons/launch.svg" alt="" />
                          <span>Launch</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.settings) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>/settings">
                          <img class="nav-subicon" src="/icons/settings.svg" alt="" />
                          <span>App settings</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.activity) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>/activity">
                          <img class="nav-subicon" src="/icons/activity-queue.svg" alt="" />
                          <span>Activity</span>
                        </a>
                      <% } %>
                    </div>
                  </div>
                <% }) %>
              <% } %>
            <% }) %>
          </div>
        <% } %>
      </div>

      <div class="dash-user">
        <div class="user-pill user-pill--menu" data-user-menu role="button" tabindex="0" aria-haspopup="true" aria-expanded="false">
          <% if (user.avatar) { %>
            <img class="user-avatar" src="<%= user.avatar %>" alt="" />
          <% } %>
          <div class="user-meta">
            <span class="role"><%= role %></span>
            <div class="username"><%= user.username %></div>
            <% if (user.email) { %>
              <div class="email"><%= user.email %></div>
            <% } %>
          </div>
          <span class="user-pill-caret" aria-hidden="true"></span>
          <div class="user-menu" role="menu">
            <% if (actualRole === 'admin') { %>
              <a class="user-menu-item" href="/settings">
                <img class="user-menu-icon" src="/icons/settings.svg" alt="" />
                <span class="user-menu-text">Settings</span>
              </a>
            <% } %>
            <% if (actualRole === 'admin') { %>
              <a class="user-menu-item" href="/switch-view?role=<%= role === 'admin' ? 'user' : 'admin' %>">
                <img class="user-menu-icon" src="/icons/window.svg" alt="" />
                <span class="user-menu-text"><%= role === 'admin' ? 'User view' : 'Admin view' %></span>
              </a>
            <% } %>
            <a class="user-menu-item" href="/user-settings">
              <img class="user-menu-icon" src="/icons/user-profile.svg" alt="" />
              <span class="user-menu-text">User profile</span>
            </a>
            <div class="user-menu-divider"></div>
            <a class="user-menu-item" href="/logout">
              <img class="user-menu-icon" src="/icons/logout.svg" alt="" />
              <span class="user-menu-text">Sign out</span>
            </a>
          </div>
        </div>
      </div>
    </aside>

    <section class="dash-main">
      <div class="main-window-bar">
        <button class="sidebar-toggle main-toggle left-toggle" type="button" aria-label="Toggle sidebar">
          <img class="toggle-icon" src="/icons/sidebar-toggle.svg" alt="" />
        </button>
        <div class="main-window-title">
          <img class="main-window-icon" src="/icons/settings.svg" alt="" />
          <span class="main-window-app">Settings</span>
        </div>
      <div class="main-window-spacer"></div>
      <div class="main-window-status">
        <span class="status-dot"></span>
      </div>
    </div>
    <div class="settings-debug" id="settingsDebug" style="display:none;"></div>

      <% const safeJson = (value) => JSON.stringify(value)
        .replace(/</g, '\\u003c')
        .replace(/\u2028/g, '\\u2028')
        .replace(/\u2029/g, '\\u2029'); %>
      <%
        const resolveAppBaseId = (value) => {
          const id = String(value || '').trim().toLowerCase();
          if (!id) return '';
          if (id === 'radarr' || id.startsWith('radarr-')) return 'radarr';
          if (id === 'sonarr' || id.startsWith('sonarr-')) return 'sonarr';
          if (id === 'bazarr' || id.startsWith('bazarr-')) return 'bazarr';
          return id;
        };
        const appInstanceBaseTitles = {
          radarr: 'Radarr',
          sonarr: 'Sonarr',
          bazarr: 'Bazarr',
        };
        const resolveAppBaseTitle = (value) => {
          const key = resolveAppBaseId(value);
          if (!key) return 'App';
          if (appInstanceBaseTitles[key]) return appInstanceBaseTitles[key];
          return key.charAt(0).toUpperCase() + key.slice(1);
        };
        const resolveAppInstanceSuffix = (value, baseHint = '') => {
          const id = String(value || '').trim().toLowerCase();
          const baseId = resolveAppBaseId(baseHint || id);
          if (!id || !baseId) return NaN;
          const match = id.match(new RegExp(`^${baseId}-(\\d+)$`));
          if (!match) return id === baseId ? 1 : NaN;
          return Number(match[1]);
        };
        const resolveInstanceTabLabel = (appItem) => {
          const baseId = resolveAppBaseId(appItem?.id);
          const baseTitle = resolveAppBaseTitle(baseId);
          const instanceName = String(appItem?.instanceName || '').trim();
          if (instanceName && instanceName.toLowerCase() !== baseTitle.toLowerCase()) {
            return instanceName;
          }
          const suffix = resolveAppInstanceSuffix(appItem?.id, baseId);
          if (Number.isFinite(suffix) && suffix > 1) return `${baseTitle} ${suffix}`;
          return baseTitle;
        };
        const resolveAppIconPath = (appItem) => {
          const customIcon = String(appItem?.icon || '').trim();
          if (customIcon) return customIcon;
          const baseId = resolveAppBaseId(appItem?.id);
          if (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'seerr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission', 'nzbget', 'qbittorrent', 'sabnzbd', 'jellyfin', 'emby', 'bazarr'].includes(baseId)) {
            return `/icons/${baseId}.png`;
          }
          return `/icons/${baseId || 'app'}.svg`;
        };
      %>
      <div class="settings-tabs" role="tablist" aria-label="Settings tabs">
        <button class="settings-tab-btn is-active" type="button" data-tab="general">
          <img class="settings-tab-icon" src="/icons/settings.svg" alt="" />
          <span class="settings-tab-text">General</span>
        </button>
        <button class="settings-tab-btn" type="button" data-tab="custom">
          <img class="settings-tab-icon" src="/icons/tools.svg" alt="" />
          <span class="settings-tab-text">Custom</span>
        </button>
        <button class="settings-tab-btn" type="button" data-tab="app">
          <img class="settings-tab-icon" src="/icons/app.svg" alt="" />
          <span class="settings-tab-text">Apps</span>
        </button>
        <button class="settings-tab-btn" type="button" data-tab="user">
          <img class="settings-tab-icon" src="/icons/user-profile.svg" alt="" />
          <span class="settings-tab-text">User</span>
        </button>
        <button class="settings-tab-btn" type="button" data-tab="notifications">
          <img class="settings-tab-icon" src="/icons/status.svg" alt="" />
          <span class="settings-tab-text">Notifications</span>
        </button>
        <button class="settings-tab-btn" type="button" data-tab="log">
          <img class="settings-tab-icon" src="/icons/activity-queue.svg" alt="" />
          <span class="settings-tab-text">Log</span>
        </button>
      </div>

      <div class="settings-tab-panel is-active" data-tab="general">
        <div class="dash-panel">
          <form method="post" action="/settings/general" class="settings-form">
            <div class="settings-card">
              <div class="settings-card-title">Server Identity</div>
              <div class="settings-card-sub">Remote URL is used for external links and sharing. Local URL is preferred for LAN Plex SSO.</div>
              <label class="field">
                <span>Server Name</span>
                <input
                  type="text"
                  name="server_name"
                  value="<%= generalSettings?.serverName || 'Launcharr' %>"
                  placeholder="Launcharr"
                />
              </label>
              <label class="field">
                <span>Remote URL</span>
                <input
                  type="text"
                  name="remote_url"
                  value="<%= generalSettings?.remoteUrl || '' %>"
                  placeholder="https://example.com"
                />
              </label>
              <label class="field">
                <span>Local URL</span>
                <input
                  type="text"
                  name="local_url"
                  value="<%= generalSettings?.localUrl || '' %>"
                  placeholder="http://192.168.0.2:3333"
                />
              </label>
              <label class="settings-toggle">
                <input type="checkbox" name="restrictGuests" <%= generalSettings?.restrictGuests ? 'checked' : '' %> />
                <span class="settings-toggle-slider" aria-hidden="true"></span>
                <span class="settings-toggle-text">Restrict guest users</span>
              </label>
              <label class="settings-toggle">
                <input type="checkbox" name="autoOpenSingleAppMenuItem" <%= generalSettings?.autoOpenSingleAppMenuItem ? 'checked' : '' %> />
                <span class="settings-toggle-slider" aria-hidden="true"></span>
                <span class="settings-toggle-text">Auto-open single app submenu item</span>
              </label>
              <label class="settings-toggle">
                <input type="checkbox" name="hideSidebarAppSettingsLink" <%= generalSettings?.hideSidebarAppSettingsLink ? 'checked' : '' %> />
                <span class="settings-toggle-slider" aria-hidden="true"></span>
                <span class="settings-toggle-text">Hide App settings link in sidebar</span>
              </label>
              <label class="settings-toggle">
                <input type="checkbox" name="hideSidebarActivityLink" <%= generalSettings?.hideSidebarActivityLink ? 'checked' : '' %> />
                <span class="settings-toggle-slider" aria-hidden="true"></span>
                <span class="settings-toggle-text">Hide Activity link in sidebar</span>
              </label>
            </div>
            <button class="primary-button" type="submit">Save general settings</button>
          </form>
        </div>
      </div>

      <div class="settings-tab-panel" data-tab="custom">
        <div class="dash-panel">
          <div class="settings-subtabs" role="tablist" aria-label="Custom settings pages">
            <button class="settings-subtab-btn is-active" type="button" data-subtab="categories">
              <img class="settings-subtab-icon" src="/icons/category.svg" alt="" />
              <span class="settings-subtab-text">Categories</span>
            </button>
            <button class="settings-subtab-btn" type="button" data-subtab="apps">
              <img class="settings-subtab-icon" src="/icons/sidebar-toggle.svg" alt="" />
              <span class="settings-subtab-text">Sidebar</span>
            </button>
            <button class="settings-subtab-btn" type="button" data-subtab="dashboard">
              <img class="settings-subtab-icon" src="/icons/dashboard.svg" alt="" />
              <span class="settings-subtab-text">Dashboard</span>
            </button>
            <button class="settings-subtab-btn" type="button" data-subtab="images">
              <img class="settings-subtab-icon" src="/icons/view.svg" alt="" />
              <span class="settings-subtab-text">Images</span>
            </button>
            <button class="settings-subtab-btn" type="button" data-subtab="themes">
              <img class="settings-subtab-icon" src="/icons/sun.svg" alt="" />
              <span class="settings-subtab-text">Themes</span>
            </button>
          </div>
          <div class="settings-subtab-panel is-active" data-subtab="categories">
            <form method="post" action="/settings/categories" class="settings-form" id="categoryManagerForm">
              <input type="hidden" id="categoryManagerJson" name="categories_json" />
              <div class="settings-table settings-table--categories">
                <div class="settings-row settings-row--categories settings-head">
                  <div>
                    <img class="settings-head-icon" src="/icons/category.svg" alt="" />
                    <span class="settings-head-label">Category</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/app.svg" alt="" />
                    <span class="settings-head-label">Icon</span>
                  </div>
                  <div class="settings-col-visibility">
                    <img class="settings-head-icon" src="/icons/view.svg" alt="" />
                    <span class="settings-head-label">Visibility</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/edit.svg" alt="" />
                    <span class="settings-head-label">Edit</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/delete.svg" alt="" />
                    <span class="settings-head-label">Delete</span>
                  </div>
                </div>
                <div id="categoryRows">
                  <% const categoryManagerEntries = Array.isArray(categoryEntries) && categoryEntries.length
                    ? categoryEntries
                    : ['Tools'].map((name) => ({ name, sidebarMenu: false, sidebarMinRole: 'disabled', icon: '/icons/category.svg' })); %>
                  <% const defaultCategoryCatalogList = Array.isArray(defaultCategoryCatalog) ? defaultCategoryCatalog : []; %>
                  <% const defaultCategoryNameSet = new Set(defaultCategoryCatalogList.map((entry) => String(entry?.name || '').trim().toLowerCase()).filter(Boolean)); %>
                  <% const existingCategoryNameSet = new Set(categoryManagerEntries.map((entry) => String(entry?.name || '').trim().toLowerCase()).filter(Boolean)); %>
                  <% const categoryVisibilityRoles = [
                    { value: 'disabled', label: 'Disabled' },
                    { value: 'guest', label: 'Guest' },
                    { value: 'user', label: 'User' },
                    { value: 'co-admin', label: 'Co-admin' },
                    { value: 'admin', label: 'Admin' },
                  ]; %>
                  <% const missingDefaultCategories = defaultCategoryCatalogList
                    .filter((entry) => !existingCategoryNameSet.has(String(entry?.name || '').trim().toLowerCase()))
                    .sort((a, b) => String(a?.name || '').localeCompare(String(b?.name || ''))); %>
                  <% categoryManagerEntries.forEach((entry, index) => { %>
                    <% const iconValue = entry.icon || '/icons/category.svg'; %>
                    <% const isDefaultCategory = defaultCategoryNameSet.has(String(entry.name || '').trim().toLowerCase()); %>
                    <% const entrySidebarMinRole = String(entry?.sidebarMinRole || (entry?.sidebarMenu ? 'user' : 'disabled')).trim().toLowerCase() || 'disabled'; %>
                    <div class="settings-row settings-row--categories category-row" draggable="true" data-category="<%= entry.name %>" data-sidebar-min-role="<%= entrySidebarMinRole %>" data-icon="<%= iconValue %>" data-default="<%= isDefaultCategory ? 'true' : 'false' %>">
                      <div class="settings-app settings-app--category">
                        <button class="order-button category-drag-handle" type="button" title="Drag to reorder" aria-label="Drag to reorder">&#x2630;</button>
                        <img class="nav-icon category-icon-preview" src="<%= iconValue %>" alt="" onerror="this.src='/icons/category.svg'" />
                        <span class="settings-app-name settings-app-name--category"><%= entry.name %></span>
                      </div>
                      <div class="settings-cell">
                        <div class="category-icon-display" aria-label="Category icon in use">
                          <img class="category-icon-display-img" src="<%= iconValue %>" alt="" onerror="this.src='/icons/category.svg'" />
                          <span class="category-icon-display-text"><%= String(iconValue || '').replace('/icons/', '') %></span>
                        </div>
                      </div>
                      <div class="settings-cell settings-cell--visibility settings-col-visibility">
                        <div class="settings-visibility-popover" data-category-visibility-popover>
                          <button class="settings-visibility-trigger" type="button" aria-label="Configure category visibility role" aria-expanded="false" aria-haspopup="true"></button>
                          <div class="settings-visibility-menu" hidden>
                            <label class="settings-visibility-group">
                              <span class="settings-visibility-label">Sidebar</span>
                              <select class="settings-select settings-visibility-select category-visibility-select" data-category-visibility-role>
                                <% categoryVisibilityRoles.forEach((option) => { %>
                                  <option value="<%= option.value %>" <%= option.value === entrySidebarMinRole ? 'selected' : '' %>><%= option.label %></option>
                                <% }) %>
                              </select>
                            </label>
                          </div>
                        </div>
                      </div>
                      <div class="settings-cell">
                        <button class="order-button category-edit-button" type="button" title="<%= isDefaultCategory ? 'Default categories cannot be edited.' : 'Edit category' %>" aria-label="Edit category" <%= isDefaultCategory ? 'disabled' : '' %>>Edit</button>
                      </div>
                      <div class="settings-cell">
                        <button class="order-button category-delete-button" type="button" title="Delete category" aria-label="Delete category">&times;</button>
                      </div>
                    </div>
                  <% }) %>
                </div>
              </div>
              <div class="category-manager-add">
                <input type="text" id="categoryManagerInput" class="category-manager-input" placeholder="New category name" autocomplete="off" />
                <div class="icon-picker" data-icon-picker>
                  <button class="settings-select icon-picker-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                    <span class="icon-picker-preview" aria-hidden="true"></span>
                    <span class="icon-picker-label">Select icon</span>
                  </button>
                  <div class="icon-picker-menu" role="listbox" aria-label="Category icon">
                    <% (Array.isArray(categoryIcons) ? categoryIcons : []).forEach((iconPath) => { %>
                      <button class="icon-picker-option" type="button" data-value="<%= iconPath %>" data-label="<%= iconPath.replace('/icons/', '') %>" role="option">
                        <img class="icon-picker-icon" src="<%= iconPath %>" alt="" />
                        <span class="icon-picker-option-label"><%= iconPath.replace('/icons/', '') %></span>
                      </button>
                    <% }) %>
                  </div>
                  <input type="hidden" id="categoryManagerIconSelect" value="" />
                </div>
                <button class="primary-button" type="button" id="categoryManagerAddBtn">Add category</button>
              </div>
              <div class="category-manager-add app-manager-add default-category-add-row" id="defaultCategoryForm">
                <div class="icon-picker default-category-picker" data-default-category-picker>
                  <button class="settings-select icon-picker-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                    <span class="icon-picker-preview" aria-hidden="true"></span>
                    <span class="icon-picker-label">Select default category</span>
                  </button>
                  <div class="icon-picker-menu" role="listbox" aria-label="Default category">
                    <% if (missingDefaultCategories.length) { %>
                      <% missingDefaultCategories.forEach((entry) => { %>
                        <% const defaultIcon = String(entry?.icon || '/icons/category.svg').trim() || '/icons/category.svg'; %>
                        <button
                          class="icon-picker-option"
                          type="button"
                          role="option"
                          data-default-category-option
                          data-value="<%= entry.name %>"
                          data-label="<%= entry.name %>"
                          data-default-icon="<%= defaultIcon %>"
                          data-default-min-role="<%= String(entry?.sidebarMinRole || (entry?.sidebarMenu ? 'user' : 'disabled')).trim().toLowerCase() || 'disabled' %>"
                          data-preview="<%= defaultIcon %>"
                        >
                          <img class="icon-picker-icon" src="<%= defaultIcon %>" alt="" onerror="this.src='/icons/category.svg'" />
                          <span class="icon-picker-option-label"><%= entry.name %></span>
                        </button>
                      <% }) %>
                    <% } else { %>
                      <div class="icon-picker-empty">No default categories available</div>
                    <% } %>
                  </div>
                  <input type="hidden" id="defaultCategorySelect" value="" />
                </div>
                <button class="primary-button default-category-add-btn" type="button" id="defaultCategoryAddBtn" <%= missingDefaultCategories.length ? '' : 'disabled' %>>Add default category</button>
              </div>
              <span class="settings-users-note" id="categoryManagerNote">Manage categories, including removing and re-adding defaults.</span>
              <button class="primary-button" type="submit">Save category settings</button>
            </form>
          </div>
          <div class="settings-subtab-panel" data-subtab="apps">
            <form method="post" action="/settings/apps" class="settings-form">
              <div class="settings-table settings-table--display" id="displayAppsTable">
                <div class="settings-row settings-row--display settings-head">
                  <div>
                    <img class="settings-head-icon" src="/icons/app.svg" alt="" />
                    <span class="settings-head-label">Application</span>
                  </div>
                  <div class="settings-col-visibility">
                    <img class="settings-head-icon" src="/icons/view.svg" alt="" />
                    <span class="settings-head-label">Visibility</span>
                  </div>
                  <div class="settings-col-launch">
                    <img class="settings-head-icon" src="/icons/launch.svg" alt="" />
                    <span class="settings-head-label">Launch</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/favourite.svg" alt="" />
                    <span class="settings-head-label">Favourite</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/category.svg" alt="" />
                    <span class="settings-head-label">Category</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/edit.svg" alt="" />
                    <span class="settings-head-label">Edit</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/delete.svg" alt="" />
                    <span class="settings-head-label">Delete</span>
                  </div>
                </div>
                <% const availableCategories = Array.isArray(categories) && categories.length ? categories : ['Tools']; %>
                <% const defaultCatalog = Array.isArray(defaultAppCatalog) ? defaultAppCatalog : []; %>
                <% const defaultAppIdSet = new Set(defaultCatalog.map((entry) => String(entry?.id || '').trim().toLowerCase()).filter(Boolean)); %>
                <% const displayApps = (Array.isArray(apps) ? apps : []).filter((appItem) => !appItem?.removed); %>
                <% const missingDefaultApps = defaultCatalog
                  .filter((entry) => {
                    const targetId = String(entry?.id || '').trim().toLowerCase();
                    if (!targetId) return false;
                    const existing = (Array.isArray(apps) ? apps : []).find((appItem) => String(appItem?.id || '').trim().toLowerCase() === targetId);
                    return !existing || Boolean(existing?.removed);
                  })
                  .sort((a, b) => String(a?.name || '').localeCompare(String(b?.name || ''))); %>
                <% const missingDefaultAppGroups = missingDefaultApps.reduce((acc, entry) => {
                  const group = String(entry?.category || 'Tools').trim() || 'Tools';
                  if (!acc[group]) acc[group] = [];
                  acc[group].push(entry);
                  return acc;
                }, {}); %>
                <% const categoryOptions = availableCategories.map((value) => {
                  const label = String(value || '').trim();
                  const initials = label
                    .split(/\s+/)
                    .map((part) => part.charAt(0))
                    .join('')
                    .toUpperCase();
                  const short = initials || label.slice(0, 3).toUpperCase();
                  return { value: label, label, short };
                }); %>
                <% const visibilityRoles = [
                  { value: 'disabled', label: 'Disabled' },
                  { value: 'guest', label: 'Guest' },
                  { value: 'user', label: 'User' },
                  { value: 'co-admin', label: 'Co-admin' },
                  { value: 'admin', label: 'Admin' },
                ]; %>
                <% const visibilityRoleRank = { disabled: -1, guest: 0, user: 1, 'co-admin': 2, admin: 3 }; %>
                <% const parseVisibilityRole = (value) => {
                  const raw = String(value || '').trim().toLowerCase();
                  if (!raw) return '';
                  if (raw === 'coadmin' || raw === 'co_admin') return 'co-admin';
                  return Object.prototype.hasOwnProperty.call(visibilityRoleRank, raw) ? raw : '';
                }; %>
                <% const normalizeVisibilityRole = (value, fallback = 'disabled') => {
                  const parsed = parseVisibilityRole(value);
                  if (parsed) return parsed;
                  const fallbackParsed = parseVisibilityRole(fallback);
                  return fallbackParsed || 'disabled';
                }; %>
                <% const deriveSectionMinRoleFromLegacy = (sectionName, section) => {
                  const userAllowed = Boolean(section?.user);
                  const adminAllowed = Boolean(section?.admin);
                  if (userAllowed) return 'user';
                  if (adminAllowed) return sectionName === 'settings' ? 'admin' : 'co-admin';
                  return 'disabled';
                }; %>
                <% const resolveSectionMinRole = (sectionName, section, fallback = 'disabled') => {
                  const explicit = parseVisibilityRole(section?.minRole);
                  if (explicit) return explicit;
                  const legacy = deriveSectionMinRoleFromLegacy(sectionName, section);
                  return normalizeVisibilityRole(legacy, fallback);
                }; %>
                <% const deriveSidebarMinRole = (sidebar, sectionRoles) => {
                  const explicit = parseVisibilityRole(sidebar?.minRole);
                  if (explicit) return explicit;
                  const enabled = (Array.isArray(sectionRoles) ? sectionRoles : [])
                    .map((entry) => normalizeVisibilityRole(entry, 'disabled'))
                    .filter((entry) => entry !== 'disabled');
                  if (!enabled.length) return 'disabled';
                  return enabled.reduce((lowest, nextRole) => {
                    const lowestRank = Number(visibilityRoleRank[normalizeVisibilityRole(lowest, 'disabled')]);
                    const nextRank = Number(visibilityRoleRank[normalizeVisibilityRole(nextRole, 'disabled')]);
                    return nextRank < lowestRank ? nextRole : lowest;
                  }, enabled[0]);
                }; %>
                <% const launchOptions = [
                  { value: 'new-tab', label: 'New Tab', short: 'Tab' },
                  { value: 'iframe', label: 'iFrame', short: 'Frame' },
                ]; %>
                <% displayApps.forEach((app, index) => { %>
                  <% const menu = app.menu || {}; %>
                  <% const sidebarOverview = menu.sidebarOverview || {}; %>
                  <% const sidebarSettings = menu.sidebarSettings || {}; %>
                  <% const sidebarActivity = menu.sidebarActivity || {}; %>
                  <% const overview = menu.overview || {}; %>
                  <% const launch = menu.launch || {}; %>
                  <% const settings = menu.settings || {}; %>
                  <% const overviewMinRole = resolveSectionMinRole('overview', overview, 'disabled'); %>
                  <% const launchMinRole = resolveSectionMinRole('launch', launch, 'disabled'); %>
                  <% const settingsMinRole = resolveSectionMinRole('settings', settings, 'admin'); %>
                  <% const overviewSidebarMinRole = normalizeVisibilityRole(parseVisibilityRole(sidebarOverview?.minRole) || overviewMinRole, 'disabled'); %>
                  <% const appSettingsSidebarMinRole = normalizeVisibilityRole(parseVisibilityRole(sidebarSettings?.minRole) || settingsMinRole, 'disabled'); %>
                  <% const activitySidebarMinRole = normalizeVisibilityRole(parseVisibilityRole(sidebarActivity?.minRole) || 'admin', 'disabled'); %>
                  <% const isCustomApp = Boolean(app.custom); %>
                  <% const overviewVisibilityMinRole = isCustomApp ? 'disabled' : overviewSidebarMinRole; %>
                  <% const sidebarMinRole = normalizeVisibilityRole(deriveSidebarMinRole(menu.sidebar || {}, [overviewMinRole, launchMinRole, settingsMinRole]), 'disabled'); %>
                  <% const sidebarEnabled = sidebarMinRole !== 'disabled'; %>
                  <% const appLaunchOptions = launchOptions; %>
                  <% const modeValues = appLaunchOptions.map((option) => option.value); %>
                  <% const currentLaunchMode = modeValues.includes(app.launchMode) ? app.launchMode : 'new-tab'; %>
                  <% const categoryValues = categoryOptions.map((option) => option.value); %>
                  <% const currentCategory = categoryValues.includes(app.category) ? app.category : categoryOptions[0].value; %>
                  <% const orderValue = Number.isFinite(app.order) ? app.order : index + 1; %>
                  <% const favouriteValue = Boolean(app.favourite || app.favorite); %>
                  <% const isDefaultApp = defaultAppIdSet.has(String(app.id || '').trim().toLowerCase()); %>
                  <% const categoryRank = Math.max(0, categoryOptions.findIndex((option) => option.value === currentCategory)); %>
                  <div class="settings-row settings-row--display settings-row--draggable <%= sidebarEnabled ? '' : 'is-disabled' %>" data-category="<%= currentCategory %>" data-category-rank="<%= categoryRank %>" draggable="true">
                    <div class="settings-app settings-app--draggable">
                      <button class="order-button settings-drag-handle settings-drag-handle--app" type="button" title="Drag to reorder within category" aria-label="Drag to reorder within category">&#x2630;</button>
                      <img class="nav-icon app-icon" src="<%= resolveAppIconPath(app) %>" alt="" onerror="this.src='/icons/app.svg'" />
                      <span class="settings-app-name"><%= app.name %></span>
                    </div>
                    <div class="settings-cell settings-cell--visibility settings-col-visibility">
                      <div class="settings-visibility-popover" data-visibility-popover>
                        <button class="settings-visibility-trigger" type="button" aria-label="Configure visibility roles" aria-expanded="false" aria-haspopup="true"></button>
                        <div class="settings-visibility-menu" hidden>
                          <label class="settings-visibility-group">
                            <span class="settings-visibility-label">Sidebar</span>
                            <select class="settings-select settings-visibility-select" name="display_sidebar_min_role_<%= app.id %>" data-visibility-section="sidebar">
                              <% visibilityRoles.forEach((option) => { %>
                                <option value="<%= option.value %>" <%= option.value === sidebarMinRole ? 'selected' : '' %>><%= option.label %></option>
                              <% }) %>
                            </select>
                          </label>
                          <label class="settings-visibility-group">
                            <span class="settings-visibility-label">Overview</span>
                            <select class="settings-select settings-visibility-select" name="display_overview_min_role_<%= app.id %>" data-visibility-section="overview" <%= isCustomApp ? 'disabled title="Overview is disabled for custom apps."' : '' %>>
                              <% visibilityRoles.forEach((option) => { %>
                                <option value="<%= option.value %>" <%= option.value === overviewVisibilityMinRole ? 'selected' : '' %>><%= option.label %></option>
                              <% }) %>
                            </select>
                            <% if (isCustomApp) { %>
                              <input type="hidden" name="display_overview_min_role_<%= app.id %>" value="disabled" />
                            <% } %>
                          </label>
                          <label class="settings-visibility-group">
                            <span class="settings-visibility-label">Launch</span>
                            <select class="settings-select settings-visibility-select" name="display_launch_min_role_<%= app.id %>" data-visibility-section="launch">
                              <% visibilityRoles.forEach((option) => { %>
                                <option value="<%= option.value %>" <%= option.value === launchMinRole ? 'selected' : '' %>><%= option.label %></option>
                              <% }) %>
                            </select>
                          </label>
                          <label class="settings-visibility-group">
                            <span class="settings-visibility-label">App Settings</span>
                            <select class="settings-select settings-visibility-select" name="display_app_settings_min_role_<%= app.id %>" data-visibility-section="app-settings">
                              <% visibilityRoles.forEach((option) => { %>
                                <option value="<%= option.value %>" <%= option.value === appSettingsSidebarMinRole ? 'selected' : '' %>><%= option.label %></option>
                              <% }) %>
                            </select>
                          </label>
                          <label class="settings-visibility-group">
                            <span class="settings-visibility-label">Activity</span>
                            <select class="settings-select settings-visibility-select" name="display_activity_min_role_<%= app.id %>" data-visibility-section="activity">
                              <% visibilityRoles.forEach((option) => { %>
                                <option value="<%= option.value %>" <%= option.value === activitySidebarMinRole ? 'selected' : '' %>><%= option.label %></option>
                              <% }) %>
                            </select>
                          </label>
                        </div>
                      </div>
                    </div>
                    <div class="settings-cell settings-cell--launch settings-col-launch">
                      <select class="settings-select settings-launch-mode" name="display_launch_mode_<%= app.id %>" title="<%= app.id === 'tautulli' ? 'Tautulli iFrame mode is overridden to New Tab on local/private host access.' : 'Choose how launch opens.' %>">
                        <% appLaunchOptions.forEach((option) => { %>
                          <option value="<%= option.value %>" <%= option.value === currentLaunchMode ? 'selected' : '' %> data-full="<%= option.label %>" data-short="<%= option.short %>" title="<%= option.label %>"><%= option.label %></option>
                        <% }) %>
                      </select>
                    </div>
                    <div class="settings-cell">
                      <button class="settings-favourite-toggle <%= favouriteValue ? 'is-active' : '' %>" type="button" aria-pressed="<%= favouriteValue ? 'true' : 'false' %>" aria-label="Toggle favourite">
                        <img class="settings-favourite-icon" src="<%= favouriteValue ? '/icons/favourite-solid.svg' : '/icons/favourite.svg' %>" alt="" />
                      </button>
                      <input class="settings-favourite-input" type="checkbox" name="display_favourite_<%= app.id %>" <%= favouriteValue ? 'checked' : '' %> />
                    </div>
                    <div class="settings-cell">
                      <select class="settings-select settings-category" name="display_category_<%= app.id %>">
                        <% categoryOptions.forEach((option) => { %>
                          <option value="<%= option.value %>" <%= option.value === currentCategory ? 'selected' : '' %> data-full="<%= option.label %>" data-short="<%= option.short %>" title="<%= option.value %>"><%= option.label %></option>
                        <% }) %>
                      </select>
                    </div>
                    <div class="settings-cell">
                <button class="order-button custom-app-edit" type="button" title="<%= isCustomApp ? 'Edit custom app' : 'Only custom apps can be edited' %>" aria-label="Edit app" <%= isCustomApp ? 'data-app-id="' + app.id + '" data-app-name="' + app.name + '" data-app-category="' + (app.category || 'Tools') + '" data-app-icon="' + (app.icon || '') + '"' : 'disabled' %>>Edit</button>
                    </div>
                    <div class="settings-cell">
                      <% if (isCustomApp) { %>
                        <button class="order-button custom-app-delete" type="button" title="Delete custom app" aria-label="Delete app" data-app-id="<%= app.id %>">&times;</button>
                      <% } else if (isDefaultApp) { %>
                        <button
                          class="order-button default-app-delete"
                          type="submit"
                          name="id"
                          value="<%= app.id %>"
                          formaction="/settings/default-apps/remove"
                          formmethod="post"
                          title="Remove default app"
                          aria-label="Remove default app"
                          onclick="return window.confirm('Remove this default app? You can re-add it later.');"
                        >&times;</button>
                      <% } else { %>
                        <button class="order-button default-app-delete" type="button" title="Only custom/default apps can be deleted here" aria-label="Delete app" disabled>&times;</button>
                      <% } %>
                    </div>
                    <input type="hidden" class="settings-order-input" name="display_order_<%= app.id %>" value="<%= orderValue %>" />
                  </div>
                <% }) %>
              </div>
              <div class="category-manager-add app-manager-add default-app-add-row" id="defaultAppForm">
                <div class="icon-picker default-app-picker" data-default-app-picker>
                  <button class="settings-select icon-picker-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                    <span class="icon-picker-preview" aria-hidden="true"></span>
                    <span class="icon-picker-label">Select default app</span>
                  </button>
                  <div class="icon-picker-menu" role="listbox" aria-label="Default app">
                    <% if (missingDefaultApps.length) { %>
                      <% Object.keys(missingDefaultAppGroups).sort((a, b) => String(a || '').localeCompare(String(b || ''))).forEach((groupName) => { %>
                        <div class="icon-picker-group-label"><%= groupName %></div>
                        <% missingDefaultAppGroups[groupName].forEach((entry) => { %>
                          <button
                            class="icon-picker-option"
                            type="button"
                            role="option"
                            data-default-app-option
                            data-value="<%= entry.id %>"
                            data-label="<%= entry.name %>"
                            data-default-category="<%= String(entry.category || 'Tools') %>"
                            data-preview="<%= entry.icon || '/icons/app.svg' %>"
                          >
                            <img class="icon-picker-icon" src="<%= entry.icon || '/icons/app.svg' %>" alt="" onerror="this.src='/icons/app.svg'" />
                            <span class="icon-picker-option-label"><%= entry.name %></span>
                          </button>
                        <% }) %>
                      <% }) %>
                    <% } else { %>
                      <div class="icon-picker-empty">No default apps available</div>
                    <% } %>
                  </div>
                  <input type="hidden" name="default_app_id" id="defaultAppSelect" value="" />
                </div>
                <select class="settings-select app-manager-select default-app-category-select" name="default_app_category" id="defaultAppCategory">
                  <% categoryOptions.forEach((option) => { %>
                    <option value="<%= option.value %>"><%= option.label %></option>
                  <% }) %>
                </select>
                <button class="primary-button default-app-add-btn" type="submit" formaction="/settings/default-apps/add" formmethod="post" <%= missingDefaultApps.length ? '' : 'disabled' %>>Add default app</button>
              </div>
              <%
                const defaultAppResultMap = {
                  added: 'Default app added. It is disabled for sidebar, overview, and dashboard by default.',
                  removed: 'Default app removed from sidebar manager. Re-add it anytime from the dropdown.',
                };
                const defaultAppNotice = defaultAppError
                  ? defaultAppError
                  : (defaultAppResultMap[defaultAppResult] || 'Add or remove default apps from sidebar manager.');
              %>
              <span class="settings-users-note<%= defaultAppError ? ' settings-users-note--error' : '' %>" id="defaultAppNote"><%= defaultAppNotice %></span>
              <div class="category-manager-add app-manager-add" id="customAppForm">
                <input type="text" id="customAppName" class="category-manager-input" placeholder="Custom app name" />
                <select id="customAppCategory" class="settings-select app-manager-select">
                  <% (Array.isArray(categories) && categories.length ? categories : ['Tools']).forEach((category) => { %>
                    <option value="<%= category %>"><%= category %></option>
                  <% }) %>
                </select>
                <div class="icon-picker" data-app-icon-picker>
                  <button class="settings-select icon-picker-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                    <span class="icon-picker-preview" aria-hidden="true"></span>
                    <span class="icon-picker-label">Select icon</span>
                  </button>
                  <div class="icon-picker-menu" role="listbox" aria-label="App icon">
                    <% (Array.isArray(appIcons) ? appIcons : []).forEach((iconPath) => { %>
                      <button class="icon-picker-option" type="button" data-value="<%= iconPath %>" data-label="<%= iconPath.replace('/icons/', '') %>" role="option">
                        <img class="icon-picker-icon" src="<%= iconPath %>" alt="" />
                        <span class="icon-picker-option-label"><%= iconPath.replace('/icons/', '') %></span>
                      </button>
                    <% }) %>
                  </div>
                  <input type="hidden" id="customAppIconSelect" value="" />
                </div>
                <button class="primary-button" type="button" id="customAppSubmit">Add custom app</button>
                <button class="order-button" type="button" id="customAppCancel" style="display:none;">Cancel edit</button>
              </div>
              <span class="settings-users-note" id="customAppNote">Overview is disabled for custom apps.</span>
              <button class="primary-button" type="submit">Save display settings</button>
            </form>
          </div>
          <div class="settings-subtab-panel" data-subtab="dashboard">
            <form method="post" action="/settings/dashboard-elements" class="settings-form" id="dashboardElementsForm">
              <%
                const dashboardVisibilityRoles = [
                  { value: 'disabled', label: 'Disabled' },
                  { value: 'guest', label: 'Guest' },
                  { value: 'user', label: 'User' },
                  { value: 'co-admin', label: 'Co-admin' },
                  { value: 'admin', label: 'Admin' },
                ];
                const parseDashboardVisibilityRole = (value) => {
                  const raw = String(value || '').trim().toLowerCase();
                  if (!raw) return '';
                  if (raw === 'coadmin' || raw === 'co_admin') return 'co-admin';
                  return ['disabled', 'guest', 'user', 'co-admin', 'admin'].includes(raw) ? raw : '';
                };
                const normalizeDashboardVisibilityRole = (value, fallback = 'user') => {
                  const parsed = parseDashboardVisibilityRole(value);
                  if (parsed) return parsed;
                  const fallbackParsed = parseDashboardVisibilityRole(fallback);
                  return fallbackParsed || 'user';
                };
                const resolveCombinedDashboardVisibilityRoleView = (settings, fallback = 'user') => {
                  const source = settings && typeof settings === 'object' ? settings : {};
                  const explicit = parseDashboardVisibilityRole(source.visibilityRole);
                  if (explicit) return explicit;
                  const enabled = source.enable === undefined ? true : Boolean(source.enable);
                  const dashboard = source.dashboard === undefined ? true : Boolean(source.dashboard);
                  if (!enabled || !dashboard) return 'disabled';
                  return normalizeDashboardVisibilityRole(fallback, 'user');
                };
              %>
              <% const tautulliItems = Array.isArray(tautulliCards) ? tautulliCards : []; %>
              <% if (tautulliItems.length) { %>
                <input type="hidden" name="tautulliCardsForm" value="1" />
              <% } %>
              <div class="settings-table settings-table--elements" id="dashboardElementsTable">
                <div class="settings-row settings-head settings-row--elements settings-row--with-expand">
                  <div>
                    <img class="settings-head-icon" src="/icons/overview.svg" alt="" />
                    <span class="settings-head-label">Name</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/view.svg" alt="" />
                    <span class="settings-head-label">Visibility</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/expand.svg" alt="" />
                    <span class="settings-head-label">Options</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/delete.svg" alt="" />
                    <span class="settings-head-label">Delete</span>
                  </div>
                </div>
                <% (Array.isArray(dashboardElements) ? dashboardElements : []).forEach((item, index) => { %>
                  <% const element = item.element || {}; %>
                  <% const combinedRowToken = item.combined
                    ? `${String(item.combinedType || 'combined')}-${String(item.combinedSection || element.id || index)}`
                    : `single-${index}`; %>
                  <% const rowKey = `${String(item.appId)}-${String(element.id || index)}-${combinedRowToken}`; %>
                  <% const categoryRank = Math.max(0, (categories || []).indexOf(item.category || 'Tools')); %>
                  <% const displayName = item.displayName || element.name; %>
                  <% const elementIcon = item.iconPath || resolveAppIconPath({ id: item.appId }); %>
                  <% const isArrCombined = item.combined && (item.combinedType === 'arr' || item.combinedType === 'arrcustom'); %>
                  <% const isCustomArrCombined = item.combinedType === 'arrcustom'; %>
                  <% const canRemoveDashboardItem = Boolean(item.dashboardElementKey); %>
                  <% const showWatchCardsPanel = item.appId === 'tautulli' && (element.id === 'watch-stats' || element.id === 'watch-stats-wheel') && tautulliItems.length; %>
                  <% const combinedOrderKey = item.combined ? `combined:${item.combinedType || 'mixed'}:${item.combinedSection || element.id || 'unknown'}` : ''; %>
                  <% const combinedOrderValue = combinedOrderKey && dashboardCombinedOrder ? Number(dashboardCombinedOrder[combinedOrderKey]) : NaN; %>
                  <% const orderValue = Number.isFinite(combinedOrderValue) ? combinedOrderValue : (Number.isFinite(element.order) ? element.order : index + 1); %>
                  <% const isQueue = element.id === 'activity-queue'; %>
                  <% const isDisabled = Boolean(item.appAccess === false); %>
                  <% const combinedKey = item.combined ? `combined:${item.combinedType || 'mixed'}:${item.combinedSection || element.id || 'unknown'}` : ''; %>
                  <% const combinedSettings = combinedKey && dashboardCombinedSettings ? dashboardCombinedSettings[combinedKey] : null; %>
                  <% const baseVisibilityRole = item.combined
                    ? resolveCombinedDashboardVisibilityRoleView(combinedSettings, 'user')
                    : normalizeDashboardVisibilityRole(
                      element.dashboardVisibilityRole,
                      (element.enable === false || element.dashboard === false) ? 'disabled' : 'user'
                    ); %>
                  <% const effectiveVisibilityRole = isDisabled ? 'disabled' : baseVisibilityRole; %>
                  <% const combinedPrefix = item.combined ? `dashboard_combined_${item.combinedType || 'mixed'}_${item.combinedSection || element.id}` : `dashboard_${item.appId}_${element.id}`; %>
                  <div class="settings-row settings-row--elements settings-row--with-expand settings-row--draggable <%= effectiveVisibilityRole === 'disabled' ? 'is-disabled' : '' %>" data-app-id="<%= item.appId %>" data-category="<%= item.category || 'Tools' %>" data-category-rank="<%= categoryRank %>" draggable="true">
                    <div class="settings-element">
                      <button class="order-button settings-drag-handle" type="button" title="Drag to reorder" aria-label="Drag to reorder">&#x2630;</button>
                      <img class="settings-element-icon" src="<%= elementIcon %>" alt="" onerror="this.src='/icons/app.svg'" />
                      <span class="settings-element-name"><%= displayName %></span>
                    </div>
                    <div class="settings-cell settings-cell--visibility settings-col-visibility">
                      <div class="settings-visibility-popover" data-dashboard-visibility-popover>
                        <button class="settings-visibility-trigger" type="button" aria-label="Configure dashboard visibility role" aria-expanded="false" aria-haspopup="true" <%= isDisabled ? 'disabled' : '' %>></button>
                        <div class="settings-visibility-menu" hidden>
                          <label class="settings-visibility-group">
                            <span class="settings-visibility-label">Dashboard</span>
                            <select class="settings-select settings-visibility-select dashboard-visibility-select" name="<%= combinedPrefix %>_visibility_role" data-dashboard-visibility-role <%= isDisabled ? 'disabled' : '' %>>
                              <% dashboardVisibilityRoles.forEach((option) => { %>
                                <option value="<%= option.value %>" <%= option.value === effectiveVisibilityRole ? 'selected' : '' %>><%= option.label %></option>
                              <% }) %>
                            </select>
                          </label>
                        </div>
                      </div>
                    </div>
                    <% const orderName = item.combined ? `dashboard_combined_${item.combinedType || 'mixed'}_${item.combinedSection || element.id}_order` : `dashboard_${item.appId}_${element.id}_order`; %>
                    <input type="hidden" class="settings-order-input" name="<%= orderName %>" value="<%= orderValue %>" />
                    <% if (item.combined) { %>
                      <input type="hidden" name="<%= combinedPrefix %>_present" value="1" />
                    <% } else { %>
                      <input type="hidden" name="dashboard_<%= item.appId %>_<%= element.id %>_present" value="1" />
                    <% } %>
                    <div class="settings-cell settings-expand-cell">
                      <button class="settings-expand-toggle settings-inline-toggle settings-element-options-toggle" type="button" data-target="dashboardOptions-<%= rowKey %>" aria-label="Toggle carousel display options" aria-expanded="false" <%= isDisabled ? 'disabled' : '' %>>
                        <img class="settings-expand-icon" src="/icons/expand.svg" alt="" />
                      </button>
                    </div>
                    <div class="settings-cell settings-delete-cell">
                      <button
                        class="order-button default-app-delete settings-dashboard-delete"
                        type="button"
                        data-dashboard-element-key="<%= item.dashboardElementKey || '' %>"
                        title="Remove dashboard item"
                        aria-label="Remove dashboard item"
                        <%= canRemoveDashboardItem ? '' : 'disabled' %>
                      >&times;</button>
                    </div>
                  </div>
                  <div class="settings-collapsible is-collapsed settings-inline-collapsible" id="dashboardOptions-<%= rowKey %>">
                    <div class="settings-card">
                      <fieldset class="settings-card-fields" <%= isDisabled ? 'disabled' : '' %>>
                      <% if (showWatchCardsPanel) { %>
                        <div class="settings-card-title">Watch Statistics Cards</div>
                        <div class="settings-table settings-table--tautulli-cards">
                          <% tautulliItems.forEach((item, cardIndex) => { %>
                            <% const orderValue = Number.isFinite(item.order) ? item.order : cardIndex + 1; %>
                            <div class="settings-row settings-row--tautulli-cards settings-row--draggable">
                              <div class="settings-element">
                                <button class="order-button settings-drag-handle" type="button" title="Drag to reorder" aria-label="Drag to reorder">&#x2630;</button>
                                <span class="settings-element-name"><%= item.name %></span>
                              </div>
                              <div class="settings-cell">
                                <input type="checkbox" name="dashboard_tautulli_card_enable_<%= element.id %>_<%= item.id %>" <%= item.enable ? 'checked' : '' %> />
                              </div>
                              <div class="settings-cell settings-cell--blank" aria-hidden="true"></div>
                              <div class="settings-cell settings-cell--blank" aria-hidden="true"></div>
                              <input type="hidden" class="settings-order-input" name="dashboard_tautulli_card_order_<%= element.id %>_<%= item.id %>" value="<%= orderValue %>" />
                              <div class="settings-cell settings-cell--blank" aria-hidden="true"></div>
                            </div>
                          <% }) %>
                        </div>
                      <% } %>
                      <% if (isArrCombined) { %>
                        <% const arrSectionKey = isCustomArrCombined ? (item.arrCombined?.sectionKey || 'activityQueue') : (item.combinedSection || 'activityQueue'); %>
                        <% const arrSectionLabel = arrSectionKey === 'downloadingSoon'
                          ? 'Downloading Soon'
                          : (arrSectionKey === 'recentlyDownloaded'
                            ? 'Recently Downloaded'
                            : (arrSectionKey === 'calendar' ? 'Calendar' : 'Activity Queue')); %>
                        <div class="settings-card-title">Combined <%= arrSectionLabel %> Sources</div>
                        <div class="settings-combined-grid settings-combined-grid--arr" data-section="<%= arrSectionKey %>">
                          <% arrApps.forEach((app) => { %>
                            <% const arrIconPath = resolveAppIconPath(app); %>
                            <% const isChecked = isCustomArrCombined
                              ? (Array.isArray(item.arrCombined?.appIds) && item.arrCombined.appIds.includes(app.id))
                              : Boolean(arrDashboardCombine?.[arrSectionKey]?.[app.id]); %>
                            <% const arrSourceName = isCustomArrCombined
                              ? `arrcustom_combine_${item.arrCombined?.cardId}_${app.id}`
                              : `arr_combine_${arrSectionKey}_${app.id}`; %>
                            <label class="settings-combined-item">
                              <img class="settings-combined-icon" src="<%= arrIconPath %>" alt="" onerror="this.src='/icons/app.svg'" />
                              <span class="settings-combined-name"><%= app.name %></span>
                              <input
                                type="checkbox"
                                name="<%= arrSourceName %>"
                                <%= isChecked ? 'checked' : '' %>
                              />
                            </label>
                          <% }) %>
                        </div>
                        <% if (arrSectionKey === 'activityQueue') { %>
                          <div class="settings-card-title" style="margin-top:12px;">Combined Queue Display Options</div>
                          <div class="settings-grid">
                            <label class="radio-pill">
                              <input type="checkbox" name="arr_combined_queue_col_detail" <%= arrCombinedQueueDisplay?.queueShowDetail !== false ? 'checked' : '' %> />
                              <span>Detail</span>
                            </label>
                            <label class="radio-pill">
                              <input type="checkbox" name="arr_combined_queue_col_subdetail" <%= arrCombinedQueueDisplay?.queueShowSubDetail !== false ? 'checked' : '' %> />
                              <span>Sub-detail</span>
                            </label>
                            <label class="radio-pill">
                              <input type="checkbox" name="arr_combined_queue_col_size" <%= arrCombinedQueueDisplay?.queueShowSize !== false ? 'checked' : '' %> />
                              <span>Quality</span>
                            </label>
                            <label class="radio-pill">
                              <input type="checkbox" name="arr_combined_queue_col_protocol" <%= arrCombinedQueueDisplay?.queueShowProtocol !== false ? 'checked' : '' %> />
                              <span>Protocol</span>
                            </label>
                            <label class="radio-pill">
                              <input type="checkbox" name="arr_combined_queue_col_timeleft" <%= arrCombinedQueueDisplay?.queueShowTimeLeft !== false ? 'checked' : '' %> />
                              <span>Time Left</span>
                            </label>
                            <label class="radio-pill">
                              <input type="checkbox" name="arr_combined_queue_col_progress" <%= arrCombinedQueueDisplay?.queueShowProgress !== false ? 'checked' : '' %> />
                              <span>Progress</span>
                            </label>
                          </div>
                          <div class="settings-grid" style="margin-top:12px;">
                            <label class="field">
                              <span>Visible items in queue</span>
                              <input
                                type="number"
                                min="5"
                                max="50"
                                step="1"
                                name="arr_combined_queue_visible_rows"
                                value="<%= arrCombinedQueueDisplay?.queueVisibleRows || 10 %>"
                              />
                            </label>
                          </div>
                        <% } %>
                      <% } %>
                      <% if (item.combined && item.combinedType === 'media') { %>
                        <% const mediaSectionKey = item.combinedSection || 'active'; %>
                        <% const mediaSectionLabel = mediaSectionKey === 'recent' ? 'Recently Added' : 'Active Streams'; %>
                        <% const combinedMediaApps = (Array.isArray(mediaApps) && mediaApps.length)
                          ? mediaApps
                          : (Array.isArray(apps) ? apps.filter((appItem) => ['plex', 'jellyfin', 'emby'].includes(appItem.id)) : []); %>
                        <div class="settings-card-title">Combined <%= mediaSectionLabel %> Sources</div>
                        <div class="settings-combined-grid settings-combined-grid--arr" data-section="<%= mediaSectionKey %>">
                          <% combinedMediaApps.forEach((app) => { %>
                            <% const iconPath = app.icon || (app.id === 'jellyfin'
                              ? '/icons/jellyfin.png'
                              : (app.id === 'emby' ? '/icons/emby.png' : '/icons/plex.png')); %>
                            <label class="settings-combined-item">
                              <img class="settings-combined-icon" src="<%= iconPath %>" alt="" onerror="this.src='/icons/app.svg'" />
                              <span class="settings-combined-name"><%= app.name %></span>
                              <input
                                type="checkbox"
                                name="media_combine_<%= mediaSectionKey %>_<%= app.id %>"
                                <%= mediaDashboardCombine?.[mediaSectionKey]?.[app.id] ? 'checked' : '' %>
                              />
                            </label>
                          <% }) %>
                        </div>
                      <% } %>
                      <% if (item.combined && item.combinedType === 'downloader' && element.id === 'activity-queue') { %>
                        <% const combinedDownloaderApps = (Array.isArray(downloaderApps) && downloaderApps.length)
                          ? downloaderApps
                          : (Array.isArray(apps) ? apps.filter((appItem) => ['transmission', 'nzbget', 'qbittorrent', 'sabnzbd'].includes(appItem.id)) : []); %>
                        <div class="settings-card-title">Combined Download Queue Sources</div>
                        <div class="settings-combined-grid settings-combined-grid--arr" data-section="activityQueue">
                          <% combinedDownloaderApps.forEach((app) => { %>
                            <label class="settings-combined-item">
                              <img class="settings-combined-icon" src="<%= resolveAppIconPath(app) %>" alt="" onerror="this.src='/icons/app.svg'" />
                              <span class="settings-combined-name"><%= app.name %></span>
                              <input
                                type="checkbox"
                                name="downloader_combine_activityQueue_<%= app.id %>"
                                <%= downloaderDashboardCombine?.activityQueue?.[app.id] ? 'checked' : '' %>
                              />
                            </label>
                          <% }) %>
                        </div>
                        <div class="settings-card-title" style="margin-top:12px;">Combined Download Queue Display Options</div>
                        <div class="settings-grid">
                          <label class="radio-pill">
                            <input type="checkbox" name="downloader_combined_queue_col_detail" <%= downloaderCombinedQueueDisplay?.queueShowDetail !== false ? 'checked' : '' %> />
                            <span>Source</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="downloader_combined_queue_col_subdetail" <%= downloaderCombinedQueueDisplay?.queueShowSubDetail !== false ? 'checked' : '' %> />
                            <span>Detail</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="downloader_combined_queue_col_size" <%= downloaderCombinedQueueDisplay?.queueShowSize !== false ? 'checked' : '' %> />
                            <span>Size</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="downloader_combined_queue_col_protocol" <%= downloaderCombinedQueueDisplay?.queueShowProtocol !== false ? 'checked' : '' %> />
                            <span>Protocol</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="downloader_combined_queue_col_timeleft" <%= downloaderCombinedQueueDisplay?.queueShowTimeLeft !== false ? 'checked' : '' %> />
                            <span>Time Left</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="downloader_combined_queue_col_progress" <%= downloaderCombinedQueueDisplay?.queueShowProgress !== false ? 'checked' : '' %> />
                            <span>Progress</span>
                          </label>
                        </div>
                        <div class="settings-grid" style="margin-top:12px;">
                          <label class="field">
                            <span>Visible items in queue</span>
                            <input
                              type="number"
                              min="5"
                              max="50"
                              step="1"
                              name="downloader_combined_queue_visible_rows"
                              value="<%= downloaderCombinedQueueDisplay?.queueVisibleRows || 10 %>"
                            />
                          </label>
                        </div>
                      <% } %>
                      <% if (isQueue && !item.combined) { %>
                        <div class="settings-card-title">Queue Display Options</div>
                        <div class="settings-grid">
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_queue_col_detail" <%= element.queueShowDetail !== false ? 'checked' : '' %> />
                            <span><%= element.queueDetailLabel || 'Detail' %></span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_queue_col_subdetail" <%= element.queueShowSubDetail !== false ? 'checked' : '' %> />
                            <span><%= element.queueSubDetailLabel || 'Sub-detail' %></span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_queue_col_size" <%= element.queueShowSize !== false ? 'checked' : '' %> />
                            <span><%= ['transmission', 'nzbget', 'qbittorrent', 'sabnzbd'].includes(item.appId) ? 'Size' : 'Quality' %></span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_queue_col_protocol" <%= element.queueShowProtocol !== false ? 'checked' : '' %> />
                            <span>Protocol</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_queue_col_timeLeft" <%= element.queueShowTimeLeft !== false ? 'checked' : '' %> />
                            <span>Time Left</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_queue_col_progress" <%= element.queueShowProgress !== false ? 'checked' : '' %> />
                            <span>Progress</span>
                          </label>
                        </div>
                        <div class="settings-grid" style="margin-top:12px;">
                          <label class="field">
                            <span>Visible items in queue</span>
                            <input
                              type="number"
                              min="5"
                              max="50"
                              step="1"
                              name="dashboard_<%= item.appId %>_<%= element.id %>_queue_visible_rows"
                              value="<%= element.queueVisibleRows || 10 %>"
                            />
                          </label>
                        </div>
                      <% } else if (!item.combined || (element.id !== 'activity-queue')) { %>
                        <div class="settings-card-title">Carousel Display Options</div>
                        <div class="settings-grid">
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_showSubtitle" <%= element.showSubtitle !== false ? 'checked' : '' %> />
                            <span>Subtitle</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_showMeta" <%= element.showMeta !== false ? 'checked' : '' %> />
                            <span>Meta</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_showPill" <%= element.showPill !== false ? 'checked' : '' %> />
                            <span>Pill</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_showTypeIcon" <%= element.showTypeIcon !== false ? 'checked' : '' %> />
                            <span>Type Icon</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_showViewIcon" <%= element.showViewIcon !== false ? 'checked' : '' %> />
                            <span>View Icon</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_showUsername" <%= element.showUsername !== false ? 'checked' : '' %> />
                            <span>Username</span>
                          </label>
                        </div>
                      <% } %>
                      </fieldset>
                    </div>
                  </div>
                <% }) %>
              </div>
              <%
                const dashboardElementResultMap = {
                  added: 'Dashboard item added back.',
                  removed: 'Dashboard item removed. Re-add it from the list below.',
                };
                const dashboardElementNotice = dashboardElementError
                  ? dashboardElementError
                  : (dashboardElementResultMap[dashboardElementResult] || 'Remove dashboard rows and re-add them as needed.');
                const dashboardAddOptions = Array.isArray(dashboardRemovedAddOptions) ? dashboardRemovedAddOptions : [];
                const dashboardAddGroups = dashboardAddOptions.reduce((acc, entry) => {
                  const groupName = String(entry?.group || 'Apps').trim() || 'Apps';
                  if (!acc[groupName]) acc[groupName] = [];
                  acc[groupName].push(entry);
                  return acc;
                }, {});
              %>
              <div class="category-manager-add app-manager-add dashboard-element-add-row" id="dashboardElementAddForm">
                <div class="icon-picker dashboard-element-picker" data-dashboard-element-picker>
                  <button class="settings-select icon-picker-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                    <span class="icon-picker-preview" aria-hidden="true"></span>
                    <span class="icon-picker-label">Select dashboard item</span>
                  </button>
                  <div class="icon-picker-menu" role="listbox" aria-label="Dashboard item">
                    <% if (dashboardAddOptions.length) { %>
                      <% Object.keys(dashboardAddGroups).sort((a, b) => String(a || '').localeCompare(String(b || ''))).forEach((groupName) => { %>
                        <div class="icon-picker-group-label"><%= groupName %></div>
                        <% dashboardAddGroups[groupName].forEach((entry) => { %>
                          <button
                            class="icon-picker-option"
                            type="button"
                            role="option"
                            data-dashboard-element-option
                            data-value="<%= entry.key %>"
                            data-label="<%= entry.name %>"
                            data-preview="<%= entry.icon || '/icons/app.svg' %>"
                          >
                            <img class="icon-picker-icon" src="<%= entry.icon || '/icons/app.svg' %>" alt="" onerror="this.src='/icons/app.svg'" />
                            <span class="icon-picker-option-label"><%= entry.name %></span>
                          </button>
                        <% }) %>
                      <% }) %>
                    <% } else { %>
                      <div class="icon-picker-empty">No removed dashboard items</div>
                    <% } %>
                  </div>
                  <input type="hidden" name="dashboard_element_key" id="dashboardElementSelect" value="" />
                </div>
                <button class="primary-button dashboard-element-add-btn" type="submit" formaction="/settings/dashboard-elements/add" formmethod="post" <%= dashboardAddOptions.length ? '' : 'disabled' %>>Add Dashboard Card</button>
              </div>
              <span class="settings-users-note<%= dashboardElementError ? ' settings-users-note--error' : '' %>"><%= dashboardElementNotice %></span>
              <%
                const arrCombinedCardResultMap = {
                  added: 'Combined card added.',
                  removed: 'Combined card removed.',
                };
                const arrCombinedCardNotice = arrCombinedCardError
                  ? arrCombinedCardError
                  : (arrCombinedCardResultMap[arrCombinedCardResult] || 'Add combined cards here, then set sources inside each card options.');
              %>
              <% const arrCombinedOptions = Array.isArray(dashboardCombinedAddOptions) ? dashboardCombinedAddOptions : []; %>
              <div class="category-manager-add app-manager-add dashboard-combined-add-row" id="dashboardCombinedAddForm">
                <div class="icon-picker dashboard-combined-picker" data-dashboard-combined-picker>
                  <button class="settings-select icon-picker-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                    <span class="icon-picker-preview" aria-hidden="true"></span>
                    <span class="icon-picker-label">Select combined card</span>
                  </button>
                  <div class="icon-picker-menu" role="listbox" aria-label="Combined card section">
                    <% if (arrCombinedOptions.length) { %>
                      <%
                        const combinedOptionGroups = arrCombinedOptions.reduce((acc, entry) => {
                          const groupName = String(entry?.group || 'Combined Cards').trim() || 'Combined Cards';
                          if (!acc[groupName]) acc[groupName] = [];
                          acc[groupName].push(entry);
                          return acc;
                        }, {});
                      %>
                      <% Object.keys(combinedOptionGroups).sort((a, b) => String(a || '').localeCompare(String(b || ''))).forEach((groupName) => { %>
                        <div class="icon-picker-group-label"><%= groupName %></div>
                        <% combinedOptionGroups[groupName].forEach((option) => { %>
                          <button
                            class="icon-picker-option"
                            type="button"
                            role="option"
                            data-dashboard-combined-option
                            data-value="<%= option.key %>"
                            data-label="<%= option.name %>"
                            data-preview="<%= option.icon || '/icons/arr-suite.svg' %>"
                          >
                            <img class="icon-picker-icon" src="<%= option.icon || '/icons/arr-suite.svg' %>" alt="" onerror="this.src='/icons/arr-suite.svg'" />
                            <span class="icon-picker-option-label"><%= option.name %></span>
                          </button>
                        <% }) %>
                      <% }) %>
                    <% } else { %>
                      <div class="icon-picker-empty">No combined sections available</div>
                    <% } %>
                  </div>
                  <input type="hidden" name="dashboard_combined_key" id="dashboardCombinedKeySelect" value="" />
                </div>
                <button class="primary-button dashboard-combined-add-btn" type="submit" formaction="/settings/dashboard-combined/add" formmethod="post" <%= arrCombinedOptions.length ? '' : 'disabled' %>>Add Combined Card</button>
              </div>
              <span class="settings-users-note<%= arrCombinedCardError ? ' settings-users-note--error' : '' %>"><%= arrCombinedCardNotice %></span>
              <button class="primary-button" type="submit">Save dashboard settings</button>
            </form>
          </div>
          <div class="settings-subtab-panel" data-subtab="images">
            <div class="settings-card">
              <div class="settings-card-title">System Icons</div>
              <form method="post" action="/settings/icons/upload" class="settings-form settings-images-form" data-icon-form>
                <input type="hidden" name="icon_type" value="system" />
                <input type="hidden" name="icon_data" class="settings-icon-data" />
                <div class="settings-row settings-row--images-upload">
                  <input class="settings-input settings-icon-file" type="file" accept="image/*,.svg" />
                  <input class="settings-input settings-icon-name category-manager-input" type="text" name="icon_name" placeholder="Icon name (required)" required />
                  <button class="primary-button" type="submit">Upload</button>
                </div>
              </form>
              <div class="settings-icon-grid">
                <% (Array.isArray(systemIconDefaults) ? systemIconDefaults : []).forEach((iconPath) => { %>
                  <div class="settings-icon-card">
                    <img src="<%= iconPath %>" alt="" />
                    <span><%= iconPath.split('/').pop() %></span>
                  </div>
                <% }) %>
                <% (Array.isArray(systemIconCustom) ? systemIconCustom : []).forEach((iconPath) => { %>
                  <div class="settings-icon-card settings-icon-card--custom">
                    <img src="<%= iconPath %>" alt="" />
                    <span><%= iconPath.split('/').pop() %></span>
                    <form method="post" action="/settings/icons/delete" class="settings-icon-delete">
                      <input type="hidden" name="icon_type" value="system" />
                      <input type="hidden" name="icon_path" value="<%= iconPath %>" />
                      <button class="order-button" type="submit" title="Delete icon" aria-label="Delete icon">&times;</button>
                    </form>
                  </div>
                <% }) %>
              </div>
            </div>

            <div class="settings-card">
              <div class="settings-card-title">App Icons</div>
              <form method="post" action="/settings/icons/upload" class="settings-form settings-images-form" data-icon-form>
                <input type="hidden" name="icon_type" value="app" />
                <input type="hidden" name="icon_data" class="settings-icon-data" />
                <div class="settings-row settings-row--images-upload">
                  <input class="settings-input settings-icon-file" type="file" accept="image/*,.svg" />
                  <input class="settings-input settings-icon-name category-manager-input" type="text" name="icon_name" placeholder="Icon name (required)" required />
                  <button class="primary-button" type="submit">Upload</button>
                </div>
              </form>
              <div class="settings-icon-grid">
                <% (Array.isArray(appIconDefaults) ? appIconDefaults : []).forEach((iconPath) => { %>
                  <div class="settings-icon-card">
                    <img src="<%= iconPath %>" alt="" />
                    <span><%= iconPath.split('/').pop() %></span>
                  </div>
                <% }) %>
                <% (Array.isArray(appIconCustom) ? appIconCustom : []).forEach((iconPath) => { %>
                  <div class="settings-icon-card settings-icon-card--custom">
                    <img src="<%= iconPath %>" alt="" />
                    <span><%= iconPath.split('/').pop() %></span>
                    <form method="post" action="/settings/icons/delete" class="settings-icon-delete">
                      <input type="hidden" name="icon_type" value="app" />
                      <input type="hidden" name="icon_path" value="<%= iconPath %>" />
                      <button class="order-button" type="submit" title="Delete icon" aria-label="Delete icon">&times;</button>
                    </form>
                  </div>
                <% }) %>
              </div>
            </div>
          </div>
          <div class="settings-subtab-panel" data-subtab="themes">
            <div class="settings-card settings-card--themes">
              <div class="settings-card-title">Themes</div>
              <div class="settings-card-sub">Choose a preset theme for Launcharr.</div>
              <div class="theme-presets" id="themePresets">
                <button class="theme-preset-card" type="button" data-brand-theme="launcharr">
                  <span class="theme-preset-chip" style="--theme-color:#6d7a86;"></span>
                  <span class="theme-preset-name">Launcharr</span>
                  <span class="theme-preset-meta">Gunmetal</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="rocketship">
                  <span class="theme-preset-chip" style="--theme-color:#b8c1ca;"></span>
                  <span class="theme-preset-name">Rocketship</span>
                  <span class="theme-preset-meta">Silver</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="pulsarr">
                  <span class="theme-preset-chip" style="--theme-color:#1cc6c2;"></span>
                  <span class="theme-preset-name">Pulsarr</span>
                  <span class="theme-preset-meta">Pulsarr teal</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="plex">
                  <span class="theme-preset-chip" style="--theme-color:#f9ad2f;"></span>
                  <span class="theme-preset-name">Plex</span>
                  <span class="theme-preset-meta">Plex orange</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="radarr">
                  <span class="theme-preset-chip" style="--theme-color:#f4c542;"></span>
                  <span class="theme-preset-name">Radarr</span>
                  <span class="theme-preset-meta">Radarr yellow</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="sonarr">
                  <span class="theme-preset-chip" style="--theme-color:#3d7bfd;"></span>
                  <span class="theme-preset-name">Sonarr</span>
                  <span class="theme-preset-meta">Sonarr blue</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="lidarr">
                  <span class="theme-preset-chip" style="--theme-color:#53b86a;"></span>
                  <span class="theme-preset-name">Lidarr</span>
                  <span class="theme-preset-meta">Lidarr green</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="readarr">
                  <span class="theme-preset-chip" style="--theme-color:#d84a4a;"></span>
                  <span class="theme-preset-name">Readarr</span>
                  <span class="theme-preset-meta">Readarr red</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="custom">
                  <span class="theme-preset-chip theme-preset-chip--custom" data-custom-chip style="--theme-color:#1cc6c2;">
                    <input class="theme-chip-picker" id="customThemeColor" type="color" value="#1cc6c2" aria-label="Choose custom theme color" />
                  </span>
                  <span class="theme-preset-name">Custom</span>
                  <span class="theme-preset-meta">Color wheel</span>
                </button>
              </div>
              <div class="theme-options" id="themeOptions">
                <label class="settings-toggle theme-option">
                  <input id="themeSidebarInvert" type="checkbox" />
                  <span class="settings-toggle-slider" aria-hidden="true"></span>
                  <span class="theme-option-copy">
                    <strong>Invert sidebar colors</strong>
                    <small>Swap sidebar dark/theme emphasis.</small>
                  </span>
                </label>
                <label class="settings-toggle theme-option">
                  <input id="themeSquareCorners" type="checkbox" />
                  <span class="settings-toggle-slider" aria-hidden="true"></span>
                  <span class="theme-option-copy">
                    <strong>Square corners</strong>
                    <small>Remove rounded corners across the UI.</small>
                  </span>
                </label>
                <label class="settings-toggle theme-option">
                  <input id="themeBgMotion" type="checkbox" checked />
                  <span class="settings-toggle-slider" aria-hidden="true"></span>
                  <span class="theme-option-copy">
                    <strong>Animated space background</strong>
                    <small>Theme-linked moving star field.</small>
                  </span>
                </label>
                <label class="settings-toggle theme-option">
                  <input id="themeCarouselFreeScroll" type="checkbox" />
                  <span class="settings-toggle-slider" aria-hidden="true"></span>
                  <span class="theme-option-copy">
                    <strong>Free carousel scroll</strong>
                    <small>Disable index snapping and allow fast horizontal swipe scrolling.</small>
                  </span>
                </label>
              </div>
            </div>
          </div>
      </div>
      </div>

      <div class="settings-tab-panel" data-tab="notifications">
      <div class="dash-panel">
        <form method="post" action="/settings/notifications" class="settings-form">
          <div class="settings-card">
            <div class="settings-card-title">Apprise Notifications</div>
            <div class="settings-card-sub">Configure global notifications through Apprise API.</div>
            <label class="settings-toggle">
              <input type="checkbox" name="apprise_enabled" <%= notificationSettings?.appriseEnabled ? 'checked' : '' %> />
              <span class="settings-toggle-slider" aria-hidden="true"></span>
              <span class="settings-toggle-text">Enable Apprise notifications</span>
            </label>
            <label class="field">
              <span>Apprise API URL</span>
              <input
                type="text"
                name="apprise_api_url"
                value="<%= notificationSettings?.appriseApiUrl || '' %>"
                placeholder="http://apprise:8000"
              />
            </label>
            <label class="field">
              <span>Delivery Mode</span>
              <select name="apprise_mode">
                <option value="targets" <%= (notificationSettings?.appriseMode || 'targets') === 'targets' ? 'selected' : '' %>>Target URLs</option>
                <option value="config-key" <%= notificationSettings?.appriseMode === 'config-key' ? 'selected' : '' %>>Config Key</option>
              </select>
            </label>
            <label class="field">
              <span>Apprise Config Key (Config Key mode)</span>
              <input
                type="text"
                name="apprise_config_key"
                value="<%= notificationSettings?.appriseConfigKey || '' %>"
                placeholder="launcharr"
              />
            </label>
            <label class="field">
              <span>Apprise Target URLs (Target URLs mode)</span>
              <textarea
                name="apprise_targets"
                rows="4"
                placeholder="discord://...&#10;mailto://..."
              ><%= notificationSettings?.appriseTargets || '' %></textarea>
            </label>
            <label class="field">
              <span>Tag (optional)</span>
              <input
                type="text"
                name="apprise_tag"
                value="<%= notificationSettings?.appriseTag || '' %>"
                placeholder="launcharr"
              />
            </label>
            <%
              const notifyResult = String(notificationResult || '').trim();
              const notifyErrorText = String(notificationError || '').trim();
              const notifyMessage = notifyResult === 'saved'
                ? 'Notification settings saved.'
                : (notifyResult === 'test-ok'
                  ? 'Apprise test notification sent successfully.'
                  : (notifyResult === 'test-error'
                    ? `Apprise test failed: ${notifyErrorText || 'Unknown error.'}`
                    : ''));
              const notifyIsError = notifyResult === 'test-error';
            %>
            <% if (notifyMessage) { %>
              <span class="settings-users-note<%= notifyIsError ? ' settings-users-note--error' : '' %>"><%= notifyMessage %></span>
            <% } %>
            <div class="settings-card-actions">
              <button class="primary-button" type="submit">Save notification settings</button>
              <button class="primary-button" type="submit" formaction="/settings/notifications/test" formmethod="post">Send test notification</button>
            </div>
          </div>
        </form>
      </div>
      </div>

      <div class="settings-tab-panel" data-tab="log">
      <div class="dash-panel">
        <form method="post" action="/settings/logs" class="settings-form">
          <div class="settings-card">
            <div class="settings-card-title">Retention</div>
            <div class="settings-card-sub">Logs are stored on disk and pruned by these limits.</div>
            <div class="settings-log-row">
              <label class="field">
                <span>Max Entries</span>
                <input
                  type="number"
                  min="50"
                  max="5000"
                  step="50"
                  name="log_max_entries"
                  value="<%= logSettings?.maxEntries || 250 %>"
                />
              </label>
              <label class="field">
                <span>Max Days</span>
                <input
                  type="number"
                  min="1"
                  max="365"
                  step="1"
                  name="log_max_days"
                  value="<%= logSettings?.maxDays || 7 %>"
                />
              </label>
              <label class="field">
                <span>Visible Rows</span>
                <input
                  type="number"
                  min="3"
                  max="100"
                  step="1"
                  name="log_visible_rows"
                  value="<%= logSettings?.visibleRows || 10 %>"
                />
              </label>
              <button class="primary-button" type="submit">Save log settings</button>
            </div>
          </div>
        </form>
      </div>

      <div class="dash-panel">
        <div class="panel-card log-body log-body--combined">
          <div class="log-toolbar">
            <div class="log-filter">
              <span class="log-filter-label">App</span>
              <select class="settings-select" id="settingsLogApp">
                <option value="">All</option>
                <option value="system">System</option>
                <% apps.forEach((app) => { %>
                  <option value="<%= app.id %>"><%= app.name %></option>
                <% }) %>
              </select>
            </div>
            <div class="log-filter">
              <span class="log-filter-label">Level</span>
              <select class="settings-select" id="settingsLogLevel">
                <option value="">All</option>
                <option value="info">Info</option>
                <option value="error">Error</option>
              </select>
            </div>
            <button class="primary-button log-refresh" type="button" id="settingsLogRefresh">Refresh</button>
            <span class="log-status" id="settingsLogStatus">Loading...</span>
          </div>
          <div class="log-list" id="settingsLogList" style="--log-visible-rows:<%= logSettings?.visibleRows || 10 %>"></div>
        </div>
      </div>
      </div>

      <div class="settings-tab-panel" data-tab="app">
      <div class="dash-panel">
        <div class="panel-header">
          <h2>Application Settings</h2>
          <span class="panel-sub">Switch apps below to edit settings on this page.</span>
        </div>
        <%
          const appInstanceResultMap = {
            added: 'New instance created.',
            deleted: 'Instance deleted.',
          };
          const appInstanceNotice = appInstanceError
            ? appInstanceError
            : (appInstanceResultMap[appInstanceResult] || '');
        %>
        <% if (appInstanceNotice) { %>
          <span class="settings-users-note<%= appInstanceError ? ' settings-users-note--error' : '' %>"><%= appInstanceNotice %></span>
        <% } %>
        <%
          const appSettingsNav = [];
          const appSettingsSeen = new Set();
          (Array.isArray(navCategories) ? navCategories : []).forEach((category) => {
            (Array.isArray(category?.apps) ? category.apps : []).forEach((appItem) => {
              const id = String(appItem?.id || '').trim();
              if (!id || appSettingsSeen.has(id)) return;
              appSettingsSeen.add(id);
              appSettingsNav.push(appItem);
            });
          });
          const appSettingsPanels = [];
          const appSettingsPanelSeen = new Set();
          appSettingsNav.forEach((appItem) => {
            const id = String(appItem?.id || '').trim();
            const baseId = resolveAppBaseId(id);
            const isMultiInstanceApp = ['radarr', 'sonarr', 'bazarr'].includes(baseId);
            const panelKey = isMultiInstanceApp ? `base:${baseId}` : `app:${id}`;
            if (!id || appSettingsPanelSeen.has(panelKey)) return;
            appSettingsPanelSeen.add(panelKey);
            appSettingsPanels.push(appItem);
          });
        %>
        <% if (appSettingsPanels.length) { %>
          <div class="app-settings-switcher" role="navigation" aria-label="Application settings pages">
            <% appSettingsPanels.forEach((appItem, appIndex) => { %>
              <%
                const switcherBaseId = resolveAppBaseId(appItem.id);
                const switcherLabel = ['radarr', 'sonarr', 'bazarr'].includes(switcherBaseId)
                  ? resolveAppBaseTitle(switcherBaseId)
                  : appItem.name;
              %>
              <button
                class="app-settings-switcher-btn<%= appIndex === 0 ? ' is-active' : '' %>"
                type="button"
                data-settings-app-button
                data-app-id="<%= appItem.id %>"
                title="<%= switcherLabel %> settings"
                aria-label="<%= switcherLabel %> settings"
              >
                <img
                  class="app-settings-switcher-icon nav-icon app-icon"
                  src="<%= resolveAppIconPath(appItem) %>"
                  alt=""
                  onerror="this.src='/icons/app.svg'"
                />
                <span class="app-settings-switcher-text"><%= switcherLabel %></span>
              </button>
            <% }) %>
          </div>
          <% appSettingsPanels.forEach((appItem, appIndex) => { %>
            <%
              const appBaseId = resolveAppBaseId(appItem.id);
              const requestedAppId = String(selectedSettingsAppId || '').trim().toLowerCase();
              const supportsInstances = ['radarr', 'sonarr', 'bazarr'].includes(appBaseId);
              const instanceItems = supportsInstances
                ? appSettingsNav
                  .filter((entry) => resolveAppBaseId(entry.id) === appBaseId)
                  .slice()
                  .sort((a, b) => {
                    const aSuffix = resolveAppInstanceSuffix(a?.id, appBaseId);
                    const bSuffix = resolveAppInstanceSuffix(b?.id, appBaseId);
                    const aOrder = Number.isFinite(aSuffix) ? aSuffix : Number.MAX_SAFE_INTEGER;
                    const bOrder = Number.isFinite(bSuffix) ? bSuffix : Number.MAX_SAFE_INTEGER;
                    if (aOrder !== bOrder) return aOrder - bOrder;
                    return String(a?.id || '').localeCompare(String(b?.id || ''));
                  })
                : [appItem];
              const activeInstanceItem = supportsInstances
                ? (instanceItems.find((entry) => String(entry?.id || '').trim().toLowerCase() === requestedAppId) || instanceItems[0] || appItem)
                : appItem;
              const panelAppItem = activeInstanceItem || appItem;
              const appMenu = panelAppItem.menu || {};
              const appOverview = appMenu.overview || {};
              const appLaunch = appMenu.launch || {};
              const appSettingsMenu = appMenu.settings || {};
              const appRoleKey = role === 'admin' || role === 'co-admin' ? 'admin' : 'user';
              const appHasMenu = Boolean(appMenu.overview || appMenu.launch || appMenu.settings);
              const appEnabled = appHasMenu ? Boolean(appOverview[appRoleKey] || appLaunch[appRoleKey] || appSettingsMenu[appRoleKey]) : true;
              const appHasUrl = Boolean(panelAppItem.localUrl || panelAppItem.remoteUrl);
              const appIsArrSuite = String(panelAppItem.category || '').toLowerCase() === 'arr suite';
              const appRequiresApiKey = appIsArrSuite || ['tautulli', 'jellyfin', 'emby', 'prowlarr', 'sabnzbd'].includes(appBaseId);
              const appHasToken = appBaseId === 'plex'
                ? Boolean(panelAppItem.plexToken)
                : (appRequiresApiKey ? Boolean(panelAppItem.apiKey) : true);
              const appStatusOk = appEnabled && appHasUrl && appHasToken;
              const baseInstanceCount = instanceItems.length;
              const canAddInstance = supportsInstances && baseInstanceCount < 5;
              const firstInstanceItem = supportsInstances && instanceItems.length ? instanceItems[0] : null;
              const remainingInstanceItems = supportsInstances && instanceItems.length > 1 ? instanceItems.slice(1) : [];
              const activeAppId = String(panelAppItem?.id || '').trim();
              const instancePlaceholder = appBaseId === 'radarr'
                ? 'Movies (e.g. 4K)'
                : (appBaseId === 'sonarr' ? 'TV (e.g. Anime)' : 'Subtitles (e.g. Foreign)');
            %>
            <div class="app-settings-panel<%= appIndex === 0 ? ' is-active' : '' %>" data-settings-app-panel data-app-id="<%= appItem.id %>">
              <div class="settings-card">
                <div class="settings-card-title"><%= supportsInstances ? resolveAppBaseTitle(appBaseId) : panelAppItem.name %> connection</div>
                <div class="settings-card-sub"><%= appStatusOk ? 'Configured and enabled.' : 'Needs attention: check URL or credentials.' %></div>
                <% if (supportsInstances) { %>
                  <div class="settings-subtabs app-instance-tabs" role="tablist" aria-label="<%= resolveAppBaseTitle(appBaseId) %> instance tabs">
                    <% if (firstInstanceItem) { %>
                      <a
                        class="settings-subtab-btn<%= String(firstInstanceItem.id || '').trim() === activeAppId ? ' is-active' : '' %>"
                        data-instance-id="<%= String(firstInstanceItem.id || '').trim().toLowerCase() %>"
                        href="/settings?tab=app&app=<%= encodeURIComponent(String(firstInstanceItem.id || '').trim()) %>"
                      >
                        <span class="settings-subtab-text"><%= resolveInstanceTabLabel(firstInstanceItem) %></span>
                      </a>
                    <% } %>
                    <% remainingInstanceItems.forEach((instanceEntry) => { %>
                      <div class="app-instance-tab-entry">
                        <a
                          class="settings-subtab-btn<%= String(instanceEntry.id || '').trim() === activeAppId ? ' is-active' : '' %>"
                          data-instance-id="<%= String(instanceEntry.id || '').trim().toLowerCase() %>"
                          href="/settings?tab=app&app=<%= encodeURIComponent(String(instanceEntry.id || '').trim()) %>"
                        >
                          <span class="settings-subtab-text"><%= resolveInstanceTabLabel(instanceEntry) %></span>
                        </a>
                        <form
                          method="post"
                          action="/settings/apps/instances/delete"
                          class="app-instance-tab-delete-form"
                          onsubmit="return confirm('Delete this instance? This cannot be undone.');"
                        >
                          <input type="hidden" name="appId" value="<%= String(instanceEntry.id || '').trim() %>" />
                          <button
                            class="app-instance-tab-delete"
                            type="submit"
                            title="Delete <%= resolveInstanceTabLabel(instanceEntry) %>"
                            aria-label="Delete <%= resolveInstanceTabLabel(instanceEntry) %>"
                          >
                            <img src="/icons/delete.svg" alt="" />
                          </button>
                        </form>
                      </div>
                    <% }) %>
                    <% if (canAddInstance) { %>
                      <form method="post" action="/settings/apps/instances/add" class="app-instance-tab-add-form">
                        <input type="hidden" name="baseId" value="<%= appBaseId %>" />
                        <input type="hidden" name="sourceId" value="<%= panelAppItem.id %>" />
                        <button
                          class="settings-subtab-btn app-instance-tab-add"
                          type="submit"
                          title="Add <%= resolveAppBaseTitle(appBaseId) %> instance"
                          aria-label="Add <%= resolveAppBaseTitle(appBaseId) %> instance"
                        >
                          +
                        </button>
                      </form>
                    <% } %>
                  </div>
                  <div class="settings-users-actions">
                    <span class="settings-users-note">Instances: <%= baseInstanceCount %>/5</span>
                  </div>
                <% } %>
                <form method="post" action="/apps/<%= panelAppItem.id %>/settings?from=settings" class="settings-form">
                  <% if (supportsInstances) { %>
                    <label class="field">
                      <span>Instance Name</span>
                      <input type="text" name="instanceName" value="<%= panelAppItem.instanceName || '' %>" placeholder="<%= instancePlaceholder %>" />
                    </label>
                  <% } %>
                  <label class="field">
                    <span>Local URL</span>
                    <input type="text" name="localUrl" value="<%= panelAppItem.localUrl || '' %>" placeholder="http://192.168.x.x:port" />
                  </label>
                  <label class="field">
                    <span>Remote URL</span>
                    <input type="text" name="remoteUrl" value="<%= panelAppItem.remoteUrl || '' %>" placeholder="https://app.example.com" />
                  </label>
                  <% if (panelAppItem.id === 'plex') { %>
                    <% const appAdminOwner = (Array.isArray(admins) && admins.length) ? admins[0] : ''; %>
                    <label class="field">
                      <span>Plex Token</span>
                      <input type="password" name="plexToken" value="<%= panelAppItem.plexToken || '' %>" placeholder="Plex token" />
                    </label>
                    <label class="field">
                      <span>Plex Machine</span>
                      <input type="password" name="plexMachine" value="<%= panelAppItem.plexMachine || '' %>" placeholder="Machine identifier" />
                    </label>
                    <label class="field">
                      <span>Plex Admin User</span>
                      <input type="text" name="plexAdminUser" value="<%= appAdminOwner %>" placeholder="admin@plex.tv" />
                    </label>
                  <% } %>
                  <% if (appRequiresApiKey) { %>
                    <label class="field">
                      <span>API Key</span>
                      <input type="password" name="apiKey" value="<%= panelAppItem.apiKey || '' %>" placeholder="<%= panelAppItem.name %> API key" />
                    </label>
                  <% } %>
                  <% if (['nzbget', 'transmission', 'qbittorrent', 'sabnzbd'].includes(panelAppItem.id)) { %>
                    <label class="field">
                      <span>Username</span>
                      <input type="text" name="username" value="<%= panelAppItem.username || '' %>" placeholder="<%= panelAppItem.name %> username" />
                    </label>
                    <label class="field">
                      <span>Password</span>
                      <input type="password" name="password" value="<%= panelAppItem.password || '' %>" placeholder="<%= panelAppItem.name %> password" />
                    </label>
                  <% } %>
                  <button class="primary-button" type="submit">Save <%= panelAppItem.name %> settings</button>
                </form>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <span class="settings-users-note">No apps available for settings.</span>
        <% } %>
      </div>
      </div>

      <div class="settings-tab-panel" data-tab="user">
      <div class="dash-panel">
        <div class="settings-form settings-users">
          <%
            const localUsersResultMap = {
              added: 'Launcharr user added.',
              'role-saved': 'Launcharr user role updated.',
            };
            const localUsersNote = localUsersError
              ? localUsersError
              : (localUsersResultMap[localUsersResult] || 'Create non-Plex Launcharr users and set access roles.');
          %>
          <div class="settings-card">
            <div class="settings-card-title">Launcharr Users</div>
            <div class="settings-card-sub">Local accounts can sign in without Plex and use role-based access.</div>
            <div class="settings-users-actions">
              <span class="settings-users-note<%= localUsersError ? ' settings-users-note--error' : '' %>"><%= localUsersNote %></span>
            </div>
            <form method="post" action="/settings/local-users" class="settings-form">
              <label class="field">
                <span>Username</span>
                <input type="text" name="username" placeholder="localuser" required />
              </label>
              <label class="field">
                <span>Email (optional)</span>
                <input type="email" name="email" placeholder="user@example.com" />
              </label>
              <label class="field">
                <span>Password</span>
                <input type="password" name="password" placeholder="At least 6 characters" minlength="6" required />
              </label>
              <label class="field">
                <span>Role</span>
                <select class="settings-select" name="role">
                  <option value="user">User</option>
                  <option value="co-admin">Co-admin</option>
                  <option value="admin">Admin</option>
                </select>
              </label>
              <button class="primary-button" type="submit">Add Launcharr user</button>
            </form>
            <div class="settings-users-table">
              <div class="settings-users-row settings-users-head">
                <div class="settings-users-head-cell">
                  <img class="settings-head-icon" src="/icons/name.svg" alt="" />
                  <span>User</span>
                </div>
                <div class="settings-users-head-cell">
                  <span>Email</span>
                </div>
                <div class="settings-users-head-cell">
                  <span>Last Launcharr login</span>
                </div>
                <div class="settings-users-head-cell">
                  <img class="settings-head-icon" src="/icons/role.svg" alt="" />
                  <span>Role</span>
                </div>
              </div>
              <% if (Array.isArray(localUsers) && localUsers.length) { %>
                <% localUsers.forEach((localUser) => { %>
                  <%
                    const localLogin = localUser.lastLauncharrLogin && !Number.isNaN(Date.parse(localUser.lastLauncharrLogin))
                      ? new Date(localUser.lastLauncharrLogin).toLocaleString()
                      : '';
                  %>
                  <div class="settings-users-row">
                    <div class="settings-users-name">
                      <%= localUser.username %>
                      <% if (localUser.isCurrentSessionUser) { %>
                        <span class="settings-users-locked">Current session</span>
                      <% } %>
                    </div>
                    <div class="settings-users-login"><%= localUser.email || '' %></div>
                    <div class="settings-users-login" title="<%= localUser.lastLauncharrLogin || '' %>"><%= localLogin %></div>
                    <div class="settings-users-role">
                      <form method="post" action="/settings/local-users/role" class="settings-role-inline-form">
                        <input type="hidden" name="username" value="<%= localUser.username %>" />
                        <select name="role">
                          <option value="user" <%= localUser.role === 'user' ? 'selected' : '' %>>User</option>
                          <option value="co-admin" <%= localUser.role === 'co-admin' ? 'selected' : '' %>>Co-admin</option>
                          <option value="admin" <%= localUser.role === 'admin' ? 'selected' : '' %>>Admin</option>
                        </select>
                        <button class="primary-button" type="submit">Save</button>
                      </form>
                    </div>
                  </div>
                <% }) %>
              <% } else { %>
                <div class="settings-users-row">
                  <div class="settings-users-login">No local Launcharr users found.</div>
                  <div class="settings-users-login"></div>
                  <div class="settings-users-login"></div>
                  <div class="settings-users-login"></div>
                </div>
              <% } %>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-card-title">Plex Users</div>
            <div class="settings-card-sub">Pull users from Plex and assign Launcharr roles.</div>
            <div class="settings-users-actions">
              <button class="primary-button" type="button" id="fetchPlexUsersBtn">Fetch users</button>
              <button class="primary-button" type="button" id="savePlexRolesBtn" disabled>Save roles</button>
              <span class="settings-users-note" id="plexUsersNote">Pull the user list from Plex to assign roles.</span>
            </div>
            <div class="settings-users-table">
              <div class="settings-users-row settings-users-head">
                <div class="settings-users-head-cell settings-users-sort" data-sort-key="name" role="button" tabindex="0">
                  <img class="settings-head-icon" src="/icons/name.svg" alt="" />
                  <span>Name</span>
                </div>
                <div class="settings-users-head-cell settings-users-sort" data-sort-key="plex" role="button" tabindex="0">
                  <span>Last seen (Plex)</span>
                </div>
                <div class="settings-users-head-cell settings-users-sort" data-sort-key="launcharr" role="button" tabindex="0">
                  <span>Last Launcharr login</span>
                </div>
                <div class="settings-users-head-cell settings-users-sort" data-sort-key="role" role="button" tabindex="0">
                  <img class="settings-head-icon" src="/icons/role.svg" alt="" />
                  <span>Role</span>
                </div>
              </div>
              <div id="plexUsersBody"></div>
            </div>
          </div>
        </div>
      </div>
      </div>
    </section>
  </div>
  <script>
    const dashFrame = document.querySelector('.dash-frame');
    const toggle = document.querySelector('.sidebar-toggle');
    const toggleIcon = toggle?.querySelector('img');
    const mobileQuery = window.matchMedia('(max-width: 980px)');
    const isMobile = () => mobileQuery.matches;
    const mainContent = document.querySelector('.dash-main');
    const sidebar = document.querySelector('.dash-sidebar');
    const dashNav = document.querySelector('.dash-nav');
    const tabButtons = Array.from(document.querySelectorAll('.settings-tab-btn'));
    const tabPanels = Array.from(document.querySelectorAll('.settings-tab-panel'));
    const customTabButtons = Array.from(document.querySelectorAll('.settings-subtab-btn'));
    const customTabPanels = Array.from(document.querySelectorAll('.settings-subtab-panel'));
    const debugBanner = document.getElementById('settingsDebug');
    const showDebug = (message) => {
      if (!debugBanner) return;
      debugBanner.textContent = message;
      debugBanner.style.display = 'block';
    };
    window.addEventListener('error', (event) => {
      const location = event?.filename
        ? ` (${event.filename}:${event.lineno || 0}:${event.colno || 0})`
        : '';
      showDebug('Settings error: ' + (event?.message || 'Unknown error') + location);
    });
    window.addEventListener('unhandledrejection', (event) => {
      const message = event?.reason?.message || String(event?.reason || 'Unknown rejection');
      showDebug('Settings error: ' + message);
    });
    const safeStorage = {
      get(key) {
        try {
          return localStorage.getItem(key);
        } catch (err) {
          return null;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (err) {
          return;
        }
      },
    };

      const formatIconLabel = (value) => String(value || '').replace('/icons/', '');
      const initIconPicker = (root, hiddenInput, options = {}) => {
        if (!root || !hiddenInput) {
          return { setSelection: () => {} };
        }
        const onChange = typeof options.onChange === 'function' ? options.onChange : null;
        const trigger = root.querySelector('.icon-picker-trigger');
        const label = root.querySelector('.icon-picker-label');
        const preview = root.querySelector('.icon-picker-preview');
        const menu = root.querySelector('.icon-picker-menu');
        const setSelection = (value, labelText, optionEl = null) => {
          hiddenInput.value = value || '';
          const explicitPreview = optionEl ? String(optionEl.dataset.preview || '').trim() : '';
          const valuePreview = String(value || '').trim();
          const previewSrc = explicitPreview || (valuePreview.startsWith('/icons/') ? valuePreview : '');
          if (preview) {
            preview.innerHTML = previewSrc
              ? '<img src="' + previewSrc + '" alt=\"\" />'
              : '';
          }
          if (label) {
            label.textContent = labelText || 'Select icon';
          }
          if (onChange) onChange(hiddenInput.value, optionEl);
        };
        const close = () => {
          if (!menu || !trigger) return;
          menu.classList.remove('is-open');
          trigger.setAttribute('aria-expanded', 'false');
        };
        if (trigger && menu) {
          trigger.addEventListener('click', () => {
            const isOpen = menu.classList.toggle('is-open');
            trigger.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          });
          menu.addEventListener('click', (event) => {
            const option = event.target.closest('.icon-picker-option');
            if (!option) return;
            const value = String(option.dataset.value || '').trim();
            const labelText = String(option.dataset.label || option.textContent || '').trim();
            setSelection(value, labelText, option);
            close();
          });
          document.addEventListener('click', (event) => {
            if (root.contains(event.target)) return;
            close();
          });
          document.addEventListener('keydown', (event) => {
            if (event.key !== 'Escape') return;
            close();
          });
        }
        return { setSelection, close };
      };

      const initIconUploadForms = () => {
        document.querySelectorAll('.settings-images-form').forEach((form) => {
          const fileInput = form.querySelector('.settings-icon-file');
          const dataInput = form.querySelector('.settings-icon-data');
          const nameInput = form.querySelector('.settings-icon-name');
          if (!fileInput || !dataInput) return;
          fileInput.addEventListener('change', () => {
            dataInput.value = '';
          });
          form.addEventListener('submit', (event) => {
            const file = fileInput.files && fileInput.files[0];
            const iconName = String(nameInput?.value || '').trim().replace(/\.[^/.]+$/, '');
            if (!iconName) {
              event.preventDefault();
              showDebug('Enter an icon name before uploading.');
              return;
            }
            if (!file) {
              event.preventDefault();
              showDebug('Choose an image before uploading.');
              return;
            }
            if (dataInput.value) return;
            event.preventDefault();
            const resolveMime = (name, fallback) => {
              if (fallback) return fallback;
              const ext = String(name || '').toLowerCase().split('.').pop();
              if (ext === 'svg') return 'image/svg+xml';
              if (ext === 'png') return 'image/png';
              if (ext === 'jpg' || ext === 'jpeg') return 'image/jpeg';
              if (ext === 'webp') return 'image/webp';
              return 'application/octet-stream';
            };
            const toBase64 = (buffer) => {
              const bytes = new Uint8Array(buffer);
              let binary = '';
              const chunkSize = 0x8000;
              for (let i = 0; i < bytes.length; i += chunkSize) {
                const chunk = bytes.subarray(i, i + chunkSize);
                binary += String.fromCharCode(...chunk);
              }
              return btoa(binary);
            };
            const submitDataUrl = (buffer) => {
              const mime = resolveMime(file.name, file.type);
              const base64 = toBase64(buffer);
              dataInput.value = `data:${mime};base64,${base64}`;
              form.submit();
            };
            if (typeof file.arrayBuffer === 'function') {
              file.arrayBuffer()
                .then(submitDataUrl)
                .catch(() => {
                  showDebug('Unable to read the selected image.');
                });
              return;
            }
            const reader = new FileReader();
            reader.onload = () => {
              dataInput.value = String(reader.result || '');
              form.submit();
            };
            reader.onerror = () => {
              showDebug('Unable to read the selected image.');
            };
            reader.readAsDataURL(file);
          });
        });
      };

      const setActiveTab = (tabId, persist = true) => {
      if (!tabId) return;
      tabButtons.forEach((btn) => {
        const isActive = btn.dataset.tab === tabId;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      tabPanels.forEach((panel) => {
        panel.classList.toggle('is-active', panel.dataset.tab === tabId);
      });
      if (persist) safeStorage.set('settingsTab', tabId);
    };
    window.setActiveTab = setActiveTab;

    const queryParams = new URLSearchParams(window.location.search);
    const requestedTab = String(queryParams.get('tab') || '').trim();
    const storedTab = safeStorage.get('settingsTab');
    const hasStored = storedTab && tabPanels.some((panel) => panel.dataset.tab === storedTab);
    const initialTab = requestedTab && tabPanels.some((panel) => panel.dataset.tab === requestedTab)
      ? requestedTab
      : (hasStored ? storedTab : 'general');
    setActiveTab(initialTab, false);
    if (queryParams.get('iconError') === '1') {
      showDebug('Icon name is required for uploads.');
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        setActiveTab(btn.dataset.tab);
        if (btn.dataset.tab === 'custom') {
          const storedCustomTab = safeStorage.get('settingsCustomTab');
          const hasStoredCustom = storedCustomTab && customTabPanels.some((panel) => panel.dataset.subtab === storedCustomTab);
          setCustomTab(hasStoredCustom ? storedCustomTab : customTabButtons[0]?.dataset.subtab, false);
        }
      });
    });

    const setCustomTab = (tabId, persist = true) => {
      if (!tabId) return;
      customTabButtons.forEach((btn) => {
        const isActive = btn.dataset.subtab === tabId;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      customTabPanels.forEach((panel) => {
        panel.classList.toggle('is-active', panel.dataset.subtab === tabId);
      });
      if (persist) safeStorage.set('settingsCustomTab', tabId);
    };

    if (customTabButtons.length) {
      const requestedCustomTab = String(queryParams.get('settingsCustomTab') || queryParams.get('subtab') || '').trim();
      const hasRequestedCustom = requestedCustomTab && customTabPanels.some((panel) => panel.dataset.subtab === requestedCustomTab);
      const storedCustomTab = safeStorage.get('settingsCustomTab');
      const hasStoredCustom = storedCustomTab && customTabPanels.some((panel) => panel.dataset.subtab === storedCustomTab);
      setCustomTab(hasRequestedCustom ? requestedCustomTab : (hasStoredCustom ? storedCustomTab : customTabButtons[0].dataset.subtab), false);
      customTabButtons.forEach((btn) => {
        btn.addEventListener('click', () => setCustomTab(btn.dataset.subtab));
      });
    }

    const appSettingsButtons = Array.from(document.querySelectorAll('[data-settings-app-button]'));
    const appSettingsPanels = Array.from(document.querySelectorAll('[data-settings-app-panel]'));
    const resolveAppBaseId = (value) => {
      const id = String(value || '').trim().toLowerCase();
      if (!id) return '';
      if (id === 'radarr' || id.startsWith('radarr-')) return 'radarr';
      if (id === 'sonarr' || id.startsWith('sonarr-')) return 'sonarr';
      if (id === 'bazarr' || id.startsWith('bazarr-')) return 'bazarr';
      return id;
    };
    const setAppSettingsPanel = (appId, persist = true) => {
      if (!appId) return;
      appSettingsButtons.forEach((button) => {
        const isActive = button.dataset.appId === appId;
        button.classList.toggle('is-active', isActive);
      });
      appSettingsPanels.forEach((panel) => {
        const isActive = panel.dataset.appId === appId;
        panel.classList.toggle('is-active', isActive);
        if (!isActive) return;
        const instanceTabs = Array.from(panel.querySelectorAll('.app-instance-tabs .settings-subtab-btn[data-instance-id]'));
        if (!instanceTabs.length) return;
        const requestedInstanceId = String(queryParams.get('app') || queryParams.get('instance') || '').trim().toLowerCase();
        let activeInstanceId = requestedInstanceId && instanceTabs.some((tab) => tab.dataset.instanceId === requestedInstanceId)
          ? requestedInstanceId
          : (instanceTabs.find((tab) => tab.classList.contains('is-active'))?.dataset.instanceId || String(instanceTabs[0]?.dataset.instanceId || ''));
        if (!instanceTabs.some((tab) => tab.dataset.instanceId === activeInstanceId)) {
          activeInstanceId = String(instanceTabs[0]?.dataset.instanceId || '');
        }
        instanceTabs.forEach((tab) => {
          tab.classList.toggle('is-active', tab.dataset.instanceId === activeInstanceId);
        });
      });
      if (persist) safeStorage.set('settingsAppPanel', appId);
    };
    if (appSettingsButtons.length && appSettingsPanels.length) {
      const hasAppPanel = (appId) => appSettingsPanels.some((panel) => panel.dataset.appId === appId);
      const resolveAppPanelId = (value) => {
        const requested = String(value || '').trim();
        if (!requested) return '';
        if (hasAppPanel(requested)) return requested;
        const baseId = resolveAppBaseId(requested);
        if (!baseId) return '';
        const matchedPanel = appSettingsPanels.find((panel) => resolveAppBaseId(panel.dataset.appId) === baseId);
        return matchedPanel ? String(matchedPanel.dataset.appId || '').trim() : '';
      };
      const requestedAppPanel = String(queryParams.get('app') || '').trim();
      const storedAppPanel = String(safeStorage.get('settingsAppPanel') || '').trim();
      const resolvedRequestedAppPanel = resolveAppPanelId(requestedAppPanel);
      const resolvedStoredAppPanel = resolveAppPanelId(storedAppPanel);
      const initialAppPanel = resolvedRequestedAppPanel
        || resolvedStoredAppPanel
        || appSettingsButtons[0].dataset.appId;
      setAppSettingsPanel(initialAppPanel, false);
      appSettingsButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const appId = String(button.dataset.appId || '').trim();
          if (!appId) return;
          setAppSettingsPanel(appId);
        });
      });
    }

    const themePresetButtons = Array.from(document.querySelectorAll('.theme-preset-card'));
    const customThemeColorInput = document.getElementById('customThemeColor');
    const customThemeChip = document.querySelector('[data-custom-chip]');
    const themeSidebarInvertToggle = document.getElementById('themeSidebarInvert');
    const themeSquareCornersToggle = document.getElementById('themeSquareCorners');
    const themeBgMotionToggle = document.getElementById('themeBgMotion');
    const themeCarouselFreeScrollToggle = document.getElementById('themeCarouselFreeScroll');
    const allowedBrandThemes = new Set(['custom', 'launcharr', 'rocketship', 'pulsarr', 'plex', 'radarr', 'sonarr', 'lidarr', 'readarr']);
    const customColorStorageKey = 'launcharr-custom-color';
    const themeOptionStorageKeys = {
      sidebarInvert: 'launcharr-sidebar-invert',
      squareCorners: 'launcharr-square-corners',
      bgMotion: 'launcharr-bg-motion',
      carouselFreeScroll: 'launcharr-carousel-free-scroll',
    };
    const parseStoredBool = (key, defaultValue = false) => {
      const raw = safeStorage.get(key);
      if (raw === null || raw === undefined) return defaultValue;
      return raw === '1' || raw === 'true';
    };
    const applyThemeOptions = (options = {}) => {
      const sidebarInvert = Boolean(options.sidebarInvert);
      const squareCorners = Boolean(options.squareCorners);
      const bgMotion = options.bgMotion !== false;
      const starDensity = 165;
      const starSpeed = 45;
      const starSize = 1.2;
      const carouselFreeScroll = Boolean(options.carouselFreeScroll);
      document.documentElement.dataset.sidebarInvert = sidebarInvert ? '1' : '0';
      document.documentElement.dataset.squareCorners = squareCorners ? '1' : '0';
      document.documentElement.dataset.bgMotion = bgMotion ? '1' : '0';
      document.documentElement.style.setProperty('--star-density', String(starDensity));
      document.documentElement.style.setProperty('--star-speed', `${starSpeed}s`);
      document.documentElement.style.setProperty('--star-size', String(starSize));
      document.documentElement.dataset.carouselFreeScroll = carouselFreeScroll ? '1' : '0';
      safeStorage.set(themeOptionStorageKeys.sidebarInvert, sidebarInvert ? '1' : '0');
      safeStorage.set(themeOptionStorageKeys.squareCorners, squareCorners ? '1' : '0');
      safeStorage.set(themeOptionStorageKeys.bgMotion, bgMotion ? '1' : '0');
      safeStorage.set(themeOptionStorageKeys.carouselFreeScroll, carouselFreeScroll ? '1' : '0');
      if (themeSidebarInvertToggle) themeSidebarInvertToggle.checked = sidebarInvert;
      if (themeSquareCornersToggle) themeSquareCornersToggle.checked = squareCorners;
      if (themeBgMotionToggle) themeBgMotionToggle.checked = bgMotion;
      if (themeCarouselFreeScrollToggle) themeCarouselFreeScrollToggle.checked = carouselFreeScroll;
    };
    const syncThemeOptionsFromInputs = () => {
      applyThemeOptions({
        sidebarInvert: Boolean(themeSidebarInvertToggle?.checked),
        squareCorners: Boolean(themeSquareCornersToggle?.checked),
        bgMotion: Boolean(themeBgMotionToggle?.checked),
        carouselFreeScroll: Boolean(themeCarouselFreeScrollToggle?.checked),
      });
    };
    const parseHexColor = (value) => {
      const raw = String(value || '').trim();
      const normalized = raw.startsWith('#') ? raw : `#${raw}`;
      return /^#[0-9a-fA-F]{6}$/.test(normalized) ? normalized.toLowerCase() : '#1cc6c2';
    };
    const hexToRgb = (hex) => ({
      r: Number.parseInt(hex.slice(1, 3), 16),
      g: Number.parseInt(hex.slice(3, 5), 16),
      b: Number.parseInt(hex.slice(5, 7), 16),
    });
    const rgbToHex = (r, g, b) => `#${[r, g, b].map((value) => Math.max(0, Math.min(255, Math.round(value))).toString(16).padStart(2, '0')).join('')}`;
    const mixRgb = (base, target, amount) => ({
      r: base.r + (target.r - base.r) * amount,
      g: base.g + (target.g - base.g) * amount,
      b: base.b + (target.b - base.b) * amount,
    });
    const clearCustomThemeVars = () => {
      const rootStyle = document.documentElement.style;
      ['--teal', '--teal-dark', '--brand-rgb', '--brand-btn-start', '--brand-btn-mid', '--brand-btn-end', '--brand-btn-shadow', '--on-brand', '--on-brand-muted', '--on-brand-icon-filter'].forEach((name) => {
        rootStyle.removeProperty(name);
      });
    };
    const applyCustomColor = (inputHex) => {
      const hex = parseHexColor(inputHex);
      const base = hexToRgb(hex);
      const dark = mixRgb(base, { r: 0, g: 0, b: 0 }, 0.4);
      const start = mixRgb(base, { r: 255, g: 255, b: 255 }, 0.35);
      const end = mixRgb(base, { r: 0, g: 0, b: 0 }, 0.2);
      const shadow = mixRgb(base, { r: 0, g: 0, b: 0 }, 0.28);
      const toLinear = (channel) => {
        const value = channel / 255;
        return value <= 0.03928 ? value / 12.92 : Math.pow((value + 0.055) / 1.055, 2.4);
      };
      const luminance = 0.2126 * toLinear(base.r) + 0.7152 * toLinear(base.g) + 0.0722 * toLinear(base.b);
      const contrastWhite = 1.05 / (luminance + 0.05);
      const contrastBlack = (luminance + 0.05) / 0.05;
      const onBrand = contrastWhite >= contrastBlack ? '#ffffff' : '#081013';
      const onBrandMuted = contrastWhite >= contrastBlack ? 'rgba(255,255,255,.78)' : 'rgba(8,16,19,.72)';
      const onBrandIconFilter = contrastWhite >= contrastBlack ? 'brightness(0) saturate(100%) invert(1)' : 'brightness(0) saturate(100%)';
      const rootStyle = document.documentElement.style;
      rootStyle.setProperty('--teal', hex);
      rootStyle.setProperty('--teal-dark', rgbToHex(dark.r, dark.g, dark.b));
      rootStyle.setProperty('--brand-rgb', `${Math.round(base.r)},${Math.round(base.g)},${Math.round(base.b)}`);
      rootStyle.setProperty('--brand-btn-start', rgbToHex(start.r, start.g, start.b));
      rootStyle.setProperty('--brand-btn-mid', hex);
      rootStyle.setProperty('--brand-btn-end', rgbToHex(end.r, end.g, end.b));
      rootStyle.setProperty('--brand-btn-shadow', `${Math.round(shadow.r)},${Math.round(shadow.g)},${Math.round(shadow.b)}`);
      rootStyle.setProperty('--on-brand', onBrand);
      rootStyle.setProperty('--on-brand-muted', onBrandMuted);
      rootStyle.setProperty('--on-brand-icon-filter', onBrandIconFilter);
      if (customThemeChip) customThemeChip.style.setProperty('--theme-color', hex);
      return hex;
    };
    const applyBrandTheme = (theme) => {
      const normalized = allowedBrandThemes.has(theme) ? theme : 'pulsarr';
      document.documentElement.dataset.brandTheme = normalized;
      safeStorage.set('launcharr-brand-theme', normalized);
      if (normalized === 'custom') {
        const savedCustomHex = parseHexColor(safeStorage.get(customColorStorageKey));
        const appliedHex = applyCustomColor(savedCustomHex);
        if (customThemeColorInput) customThemeColorInput.value = appliedHex;
      } else {
        clearCustomThemeVars();
      }
      themePresetButtons.forEach((btn) => {
        const isActive = btn.dataset.brandTheme === normalized;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    };
    const initialThemeOptions = {
      sidebarInvert: parseStoredBool(themeOptionStorageKeys.sidebarInvert, false),
      squareCorners: parseStoredBool(themeOptionStorageKeys.squareCorners, false),
      bgMotion: parseStoredBool(themeOptionStorageKeys.bgMotion, true),
      carouselFreeScroll: parseStoredBool(themeOptionStorageKeys.carouselFreeScroll, false),
    };
    applyThemeOptions(initialThemeOptions);
    themeSidebarInvertToggle?.addEventListener('change', syncThemeOptionsFromInputs);
    themeSquareCornersToggle?.addEventListener('change', syncThemeOptionsFromInputs);
    themeBgMotionToggle?.addEventListener('change', syncThemeOptionsFromInputs);
    themeCarouselFreeScrollToggle?.addEventListener('change', syncThemeOptionsFromInputs);
    if (themePresetButtons.length) {
      const initialCustomHex = parseHexColor(safeStorage.get(customColorStorageKey));
      if (customThemeColorInput) customThemeColorInput.value = initialCustomHex;
      if (customThemeChip) customThemeChip.style.setProperty('--theme-color', initialCustomHex);
      const storedBrandTheme = safeStorage.get('launcharr-brand-theme');
      applyBrandTheme(allowedBrandThemes.has(storedBrandTheme) ? storedBrandTheme : 'pulsarr');
      themePresetButtons.forEach((btn) => {
        btn.addEventListener('click', () => applyBrandTheme(btn.dataset.brandTheme));
      });
      customThemeColorInput?.addEventListener('input', () => {
        const hex = parseHexColor(customThemeColorInput.value);
        safeStorage.set(customColorStorageKey, hex);
        applyBrandTheme('custom');
      });
    }

    initIconUploadForms();

    document.querySelectorAll('.settings-icon-delete').forEach((form) => {
      form.addEventListener('submit', (event) => {
        if (!window.confirm('Delete this custom icon?')) {
          event.preventDefault();
        }
      });
    });

    function setToggleIcon() {
      if (!toggleIcon) return;
      toggleIcon.src = '/icons/sidebar-toggle.svg';
    }

    function applySidebarState() {
      if (!dashFrame) return;
      if (isMobile()) {
        dashFrame.classList.remove('sidebar-collapsed');
        dashFrame.classList.remove('mobile-nav-open');
        document.body.classList.remove('mobile-nav-open');
        if (dashNav) dashNav.scrollTop = 0;
        setToggleIcon(false);
      } else {
        const collapsed = safeStorage.get('sidebarCollapsed') === 'true';
        dashFrame.classList.toggle('sidebar-collapsed', collapsed);
        dashFrame.classList.remove('mobile-nav-open');
        document.body.classList.remove('mobile-nav-open');
        if (dashNav) dashNav.scrollTop = 0;
        setToggleIcon(!collapsed);
      }
    }

    function closeMobileNav() {
      if (!dashFrame || !isMobile()) return;
      if (!dashFrame.classList.contains('mobile-nav-open')) return;
      dashFrame.classList.remove('mobile-nav-open');
      document.body.classList.remove('mobile-nav-open');
      setToggleIcon(false);
    }

    applySidebarState();
    mobileQuery.addEventListener('change', applySidebarState);
    const autoOpenSingleAppMenuItem = <%= autoOpenSingleAppMenuItem ? 'true' : 'false' %>;
    const accordion = document.querySelectorAll('.nav-accordion-item');
    accordion.forEach((item) => {
      const trigger = item.querySelector('.nav-accordion-trigger');
      if (!trigger) return;
      trigger.addEventListener('click', (event) => {
        event.stopPropagation();
        const isCategoryTrigger = trigger.classList.contains('nav-accordion-trigger--category');
        if (autoOpenSingleAppMenuItem && !isCategoryTrigger) {
          const panel = Array.from(item.children).find((child) => child.classList && child.classList.contains('nav-accordion-panel'));
          const directLinks = panel
            ? Array.from(panel.children).filter((child) => typeof child.matches === 'function' && child.matches('a.nav-subitem[href]'))
            : [];
          if (directLinks.length === 1) {
            const [onlyLink] = directLinks;
            if (onlyLink.target === '_blank') {
              window.open(onlyLink.href, '_blank', 'noopener,noreferrer');
            } else {
              window.location.href = onlyLink.href;
            }
            return;
          }
        }
        const parentAccordion = item.closest('.nav-accordion');
        const siblings = parentAccordion
          ? Array.from(parentAccordion.children).filter((child) => child.classList.contains('nav-accordion-item'))
          : [];
        siblings.forEach((other) => {
          if (other !== item) other.classList.remove('open');
        });
        item.classList.toggle('open');
      });
    });
    function handleSidebarToggle() {
      if (!dashFrame) return;
      if (isMobile()) {
        dashFrame.classList.remove('sidebar-collapsed');
        const isOpen = dashFrame.classList.toggle('mobile-nav-open');
        document.body.classList.toggle('mobile-nav-open', isOpen);
        if (dashNav) dashNav.scrollTop = 0;
        setToggleIcon(isOpen);
        return;
      }
      const isCollapsed = dashFrame.classList.toggle('sidebar-collapsed');
      safeStorage.set('sidebarCollapsed', isCollapsed ? 'true' : 'false');
      if (dashNav) dashNav.scrollTop = 0;
      setToggleIcon(!isCollapsed);
    }

    toggle?.addEventListener('click', handleSidebarToggle);

    mainContent?.addEventListener('click', (event) => {
      if (event.target.closest('.sidebar-toggle')) return;
      if (event.target.closest('.main-window-bar')) return;
      closeMobileNav();
    });

    sidebar?.addEventListener('click', (event) => {
      if (!isMobile() || !dashFrame?.classList.contains('mobile-nav-open')) return;
      const link = event.target.closest('a');
      if (!link || !link.classList.contains('active')) return;
      event.preventDefault();
      closeMobileNav();
    });

    const userMenus = document.querySelectorAll('[data-user-menu]');

    function closeUserMenus(except) {
      userMenus.forEach((menu) => {
        if (menu === except) return;
        menu.classList.remove('user-pill--open');
        menu.setAttribute('aria-expanded', 'false');
      });
    }

    userMenus.forEach((menu) => {
      menu.setAttribute('aria-expanded', 'false');
      menu.addEventListener('click', (event) => {
        if (event.target.closest('.user-menu')) return;
        event.preventDefault();
        const isOpen = menu.classList.contains('user-pill--open');
        closeUserMenus(menu);
        menu.classList.toggle('user-pill--open', !isOpen);
        menu.setAttribute('aria-expanded', !isOpen ? 'true' : 'false');
      });
      menu.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        event.preventDefault();
        menu.click();
      });
    });

    document.addEventListener('click', (event) => {
      if (event.target.closest('[data-user-menu]')) return;
      closeUserMenus();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      closeUserMenus();
    });
  </script>
  <script>
    try {
      const settingsLogList = document.getElementById('settingsLogList');
      const settingsLogStatus = document.getElementById('settingsLogStatus');
      const settingsLogRefresh = document.getElementById('settingsLogRefresh');
      const settingsLogApp = document.getElementById('settingsLogApp');
      const settingsLogLevel = document.getElementById('settingsLogLevel');
      const logAppNames = <%- safeJson((apps || []).reduce((acc, app) => {
        acc[String(app.id || '').toLowerCase()] = app.name || app.id;
        return acc;
      }, {})) %>;
      let settingsLogs = [];

    const escapeLogHtml = (value) => String(value || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');

    const formatLogTime = (value) => {
      const date = value ? new Date(value) : null;
      if (!date || Number.isNaN(date.getTime())) return '';
      return date.toLocaleString();
    };

    const renderSettingsLogs = () => {
      if (!settingsLogList) return;
      const appFilter = String(settingsLogApp?.value || '').trim().toLowerCase();
      const levelFilter = String(settingsLogLevel?.value || '').trim().toLowerCase();
      const filtered = settingsLogs.filter((entry) => {
        if (appFilter && String(entry.app || '').toLowerCase() !== appFilter) return false;
        if (levelFilter && String(entry.level || '').toLowerCase() !== levelFilter) return false;
        return true;
      });
      if (!filtered.length) {
        settingsLogList.innerHTML = '<div class="log-empty">No logs yet.</div>';
        return;
      }
      settingsLogList.innerHTML = filtered
        .map((entry) => {
          const appId = String(entry.app || 'system').toLowerCase();
          const appName = logAppNames[appId] || (appId === 'system' ? 'System' : appId);
          const level = String(entry.level || 'info').toLowerCase();
          const action = String(entry.action || 'event');
          const message = String(entry.message || '');
          const time = formatLogTime(entry.ts);
          return `
            <div class="log-row log-row--${escapeLogHtml(level)}" data-app="${escapeLogHtml(appId)}">
              <div class="log-time">${escapeLogHtml(time)}</div>
              <div class="log-message">
                <div class="log-title">
                  <span class="log-app-pill" data-app="${escapeLogHtml(appId)}">${escapeLogHtml(appName)}</span>
                  ${escapeLogHtml(action)}
                </div>
                <div class="log-text">${escapeLogHtml(message)}</div>
              </div>
            </div>
          `;
        })
        .join('');
    };

    const loadSettingsLogs = async () => {
      if (!settingsLogList || !settingsLogStatus) return;
      settingsLogStatus.textContent = 'Loading...';
      try {
        const response = await fetch('/api/logs?limit=250');
        const payload = response.ok ? await response.json() : { items: [] };
        settingsLogs = Array.isArray(payload.items) ? payload.items : [];
        renderSettingsLogs();
        settingsLogStatus.textContent = new Date().toLocaleTimeString();
      } catch (err) {
        settingsLogStatus.textContent = 'Failed to load logs';
      }
    };

    settingsLogRefresh?.addEventListener('click', loadSettingsLogs);
    settingsLogApp?.addEventListener('change', renderSettingsLogs);
    settingsLogLevel?.addEventListener('change', renderSettingsLogs);
    loadSettingsLogs();
    } catch (err) {
      console.error('[Launcharr] Settings logs init failed', err);
    }

    try {
      const fetchBtn = document.getElementById('fetchPlexUsersBtn');
      const saveBtn = document.getElementById('savePlexRolesBtn');
      const usersBody = document.getElementById('plexUsersBody');
      const note = document.getElementById('plexUsersNote');

      try {
        const customAppForm = document.getElementById('customAppForm');
        const defaultAppForm = document.getElementById('defaultAppForm');
        const defaultAppPicker = defaultAppForm?.querySelector('[data-default-app-picker]');
        const defaultAppSelect = document.getElementById('defaultAppSelect');
        const defaultAppCategory = document.getElementById('defaultAppCategory');
        const defaultAppNote = document.getElementById('defaultAppNote');
        const dashboardElementAddForm = document.getElementById('dashboardElementAddForm');
        const dashboardElementPicker = dashboardElementAddForm?.querySelector('[data-dashboard-element-picker]');
        const dashboardElementSelect = document.getElementById('dashboardElementSelect');
        const dashboardCombinedAddForm = document.getElementById('dashboardCombinedAddForm');
        const dashboardCombinedPicker = dashboardCombinedAddForm?.querySelector('[data-dashboard-combined-picker]');
        const dashboardCombinedSelect = document.getElementById('dashboardCombinedKeySelect');
        const customAppName = document.getElementById('customAppName');
        const customAppCategory = document.getElementById('customAppCategory');
        const customAppIconSelect = document.getElementById('customAppIconSelect');
        const appIconPicker = customAppForm?.querySelector('[data-app-icon-picker]');
        const customAppNote = document.getElementById('customAppNote');
        const displayAppsTable = document.getElementById('displayAppsTable');
        const customAppSubmit = document.getElementById('customAppSubmit');
        const customAppCancel = document.getElementById('customAppCancel');
        let customAppIconPath = '';
        let customAppEditId = '';
        const appsSettingsForm = document.querySelector('.settings-subtab-panel[data-subtab="apps"] form');
        const dashboardSettingsForm = document.getElementById('dashboardElementsForm');

        const setCustomAppNote = (text, error = false) => {
          if (!customAppNote) return;
          customAppNote.textContent = text;
          customAppNote.classList.toggle('settings-users-note--error', Boolean(error));
        };
        const setDefaultAppNote = (text, error = false) => {
          if (!defaultAppNote) return;
          defaultAppNote.textContent = text;
          defaultAppNote.classList.toggle('settings-users-note--error', Boolean(error));
        };

        const appIconPickerApi = initIconPicker(appIconPicker, customAppIconSelect);
        const getDefaultAppOptions = () => Array.from(defaultAppPicker?.querySelectorAll('.icon-picker-option[data-default-app-option]') || []);
        const syncDefaultAppCategory = (selectedOption = null) => {
          if (!defaultAppSelect || !defaultAppCategory) return;
          const option = selectedOption || getDefaultAppOptions().find((entry) => String(entry.dataset.value || '').trim() === String(defaultAppSelect.value || '').trim());
          const suggested = option ? String(option.dataset.defaultCategory || '').trim() : '';
          if (!suggested) return;
          const exists = Array.from(defaultAppCategory.options || []).some((entry) => String(entry.value || '').trim() === suggested);
          if (exists) defaultAppCategory.value = suggested;
        };
        const defaultAppPickerApi = initIconPicker(defaultAppPicker, defaultAppSelect, {
          onChange: (_value, option) => syncDefaultAppCategory(option),
        });
        const defaultAppOptions = getDefaultAppOptions();
        if (defaultAppOptions.length) {
          const firstDefault = defaultAppOptions[0];
          const firstValue = String(firstDefault.dataset.value || '').trim();
          const firstLabel = String(firstDefault.dataset.label || firstDefault.textContent || '').trim();
          defaultAppPickerApi.setSelection(firstValue, firstLabel, firstDefault);
        } else {
          defaultAppPickerApi.setSelection('', 'No default apps available');
        }
        const dashboardElementPickerApi = initIconPicker(dashboardElementPicker, dashboardElementSelect);
        const dashboardElementOptions = Array.from(dashboardElementPicker?.querySelectorAll('.icon-picker-option[data-dashboard-element-option]') || []);
        if (dashboardElementOptions.length) {
          const firstDashboardOption = dashboardElementOptions[0];
          dashboardElementPickerApi.setSelection(
            String(firstDashboardOption.dataset.value || '').trim(),
            String(firstDashboardOption.dataset.label || firstDashboardOption.textContent || '').trim(),
            firstDashboardOption
          );
        } else {
          dashboardElementPickerApi.setSelection('', 'No removed dashboard items');
        }
        const dashboardCombinedPickerApi = initIconPicker(dashboardCombinedPicker, dashboardCombinedSelect);
        const dashboardCombinedOptions = Array.from(dashboardCombinedPicker?.querySelectorAll('.icon-picker-option[data-dashboard-combined-option]') || []);
        if (dashboardCombinedOptions.length) {
          const firstCombinedOption = dashboardCombinedOptions[0];
          dashboardCombinedPickerApi.setSelection(
            String(firstCombinedOption.dataset.value || '').trim(),
            String(firstCombinedOption.dataset.label || firstCombinedOption.textContent || '').trim(),
            firstCombinedOption
          );
        } else {
          dashboardCombinedPickerApi.setSelection('', 'No combined sections available');
        }

        customAppSubmit?.addEventListener('click', async () => {
          const name = String(customAppName?.value || '').trim();
          const category = String(customAppCategory?.value || '').trim();
          customAppIconPath = String(customAppIconSelect?.value || '').trim();
          if (!name) {
            setCustomAppNote('Custom app name is required.', true);
            return;
          }
          setCustomAppNote('Saving custom app...');
          try {
            const endpoint = customAppEditId ? '/settings/custom-apps/update' : '/settings/custom-apps';
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: customAppEditId, name, category, iconPath: customAppIconPath }),
            });
            const payload = await response.json();
            if (!response.ok) throw new Error(payload?.error || 'Failed to add custom app.');
            setCustomAppNote('Custom app added.');
            window.location.reload();
          } catch (err) {
            setCustomAppNote(err?.message || 'Failed to add custom app.', true);
          }
        });

        appsSettingsForm?.addEventListener('submit', () => {
          safeStorage.set('settingsTab', 'custom');
          safeStorage.set('settingsCustomTab', 'apps');
        });
        dashboardSettingsForm?.addEventListener('submit', () => {
          safeStorage.set('settingsTab', 'custom');
          safeStorage.set('settingsCustomTab', 'dashboard');
        });

        const handleCustomAppActions = async (event) => {
          const editBtn = event.target.closest('.custom-app-edit');
          if (editBtn) {
            event.preventDefault();
            event.stopPropagation();
            customAppEditId = String(editBtn.dataset.appId || '').trim().replace(/^"+|"+$/g, '');
            customAppName.value = String(editBtn.dataset.appName || '');
            if (customAppCategory) customAppCategory.value = String(editBtn.dataset.appCategory || 'Tools');
            customAppIconPath = '';
            if (customAppIconSelect) {
              const iconValue = String(editBtn.dataset.appIcon || '').trim();
              appIconPickerApi.setSelection(iconValue, formatIconLabel(iconValue));
              customAppIconPath = iconValue;
            }
            if (customAppSubmit) customAppSubmit.textContent = 'Save changes';
            if (customAppCancel) customAppCancel.style.display = 'inline-flex';
            setCustomAppNote('Editing custom app. Select a new icon to replace the current one.');
            setActiveTab('custom');
            setCustomTab('apps', false);
            customAppName?.focus();
            return;
          }
          const button = event.target.closest('.custom-app-delete');
          if (!button) return;
          event.preventDefault();
          event.stopPropagation();
          const appId = String(button.dataset.appId || '').trim().replace(/^"+|"+$/g, '');
          if (!appId) return;
          if (!window.confirm('Delete this custom app?')) return;
          setCustomAppNote('Deleting custom app...');
          try {
            const response = await fetch('/settings/custom-apps/delete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: appId }),
            });
            const payload = await response.json().catch(() => ({}));
            if (!response.ok) {
              throw new Error(payload?.error || `Failed to delete custom app (${response.status}).`);
            }
            window.location.reload();
          } catch (err) {
            setCustomAppNote(err?.message || 'Failed to delete custom app.', true);
          }
        };

        displayAppsTable?.addEventListener('click', handleCustomAppActions);
        document.addEventListener('click', handleCustomAppActions);

        customAppCancel?.addEventListener('click', () => {
          customAppEditId = '';
          if (customAppName) customAppName.value = '';
          if (customAppCategory) customAppCategory.value = customAppCategory.options[0]?.value || 'Tools';
          appIconPickerApi.setSelection('', '');
          customAppIconPath = '';
          if (customAppSubmit) customAppSubmit.textContent = 'Add custom app';
          if (customAppCancel) customAppCancel.style.display = 'none';
          setCustomAppNote('Overview is disabled for custom apps.');
        });
      } catch (err) {
        console.error('[Launcharr] Custom app init failed', err);
      }

      try {
        const settingsTable = document.querySelector('.settings-subtab-panel[data-subtab="apps"] .settings-table--display');
        if (settingsTable) {
          let draggedSettingsRow = null;
          let openVisibilityPopover = null;
          settingsTable.querySelectorAll('.settings-category option, .settings-launch-mode option').forEach((option) => {
            const full = option.dataset.full || option.textContent;
            option.textContent = full;
          });

          const dataRows = () => Array.from(settingsTable.querySelectorAll('.settings-row')).filter((row) => !row.classList.contains('settings-head'));
          const getCategory = (row) => row.querySelector('.settings-category')?.value || 'Tools';
          const getSidebarVisibilityRole = (row) => {
            const sidebarSelect = row?.querySelector('select[name^="display_sidebar_min_role_"]');
            if (sidebarSelect) return String(sidebarSelect.value || '').trim().toLowerCase();
            const sidebarInput = row?.querySelector('input[type="hidden"][name^="display_sidebar_min_role_"]');
            return String(sidebarInput?.value || '').trim().toLowerCase();
          };
          const updateVisibilityRowState = (row) => {
            if (!row) return;
            const sidebarRole = getSidebarVisibilityRole(row);
            row.classList.toggle('is-disabled', sidebarRole === 'disabled');
          };
          const closeVisibilityPopover = (popover) => {
            if (!popover) return;
            const trigger = popover.querySelector('.settings-visibility-trigger');
            const menu = popover.querySelector('.settings-visibility-menu');
            if (!trigger || !menu) return;
            trigger.setAttribute('aria-expanded', 'false');
            menu.hidden = true;
            const row = popover.closest('.settings-row');
            if (row) row.classList.remove('has-open-visibility');
            if (openVisibilityPopover === popover) openVisibilityPopover = null;
          };
          const openVisibilityMenu = (popover) => {
            if (!popover) return;
            if (openVisibilityPopover && openVisibilityPopover !== popover) {
              closeVisibilityPopover(openVisibilityPopover);
            }
            const trigger = popover.querySelector('.settings-visibility-trigger');
            const menu = popover.querySelector('.settings-visibility-menu');
            if (!trigger || !menu) return;
            trigger.setAttribute('aria-expanded', 'true');
            menu.hidden = false;
            const row = popover.closest('.settings-row');
            if (row) row.classList.add('has-open-visibility');
            openVisibilityPopover = popover;
          };
          const updateCategoryOrders = (category) => {
            const rows = dataRows().filter((row) => getCategory(row) === category);
            rows.forEach((row, index) => {
              const input = row.querySelector('.settings-order-input');
              if (input) input.value = index + 1;
              const rank = row.querySelector('.settings-order-rank');
              if (rank) rank.textContent = String(index + 1);
            });
          };

          dataRows().forEach((row) => {
            row.dataset.category = getCategory(row);
            updateVisibilityRowState(row);
          });

          settingsTable.querySelectorAll('[data-visibility-popover]').forEach((popover) => {
            const trigger = popover.querySelector('.settings-visibility-trigger');
            if (!trigger) return;
            const menu = popover.querySelector('.settings-visibility-menu');
            if (!menu) return;
            menu.hidden = true;
            trigger.setAttribute('aria-expanded', 'false');
            trigger.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
              const isOpen = trigger.getAttribute('aria-expanded') === 'true';
              if (isOpen) closeVisibilityPopover(popover);
              else openVisibilityMenu(popover);
            });
          });

          Array.from(new Set(dataRows().map((row) => getCategory(row)))).forEach(updateCategoryOrders);

          const attachSettingsRowDragEvents = (row) => {
            row.addEventListener('dragstart', (event) => {
              if (event.dataTransfer) {
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('text/plain', String(row.dataset.category || ''));
              }
              draggedSettingsRow = row;
              row.classList.add('settings-row--dragging');
            });
            row.addEventListener('dragend', () => {
              const category = getCategory(row);
              row.classList.remove('settings-row--dragging');
              draggedSettingsRow = null;
              updateCategoryOrders(category);
            });
            row.addEventListener('dragover', (event) => {
              event.preventDefault();
              if (!draggedSettingsRow || draggedSettingsRow === row) return;
              if (getCategory(draggedSettingsRow) !== getCategory(row)) return;
              const bounds = row.getBoundingClientRect();
              const insertBefore = (event.clientY - bounds.top) < (bounds.height / 2);
              const parent = row.parentElement;
              if (!parent) return;
              parent.insertBefore(draggedSettingsRow, insertBefore ? row : row.nextSibling);
            });
          };

          dataRows().forEach(attachSettingsRowDragEvents);

          settingsTable.addEventListener('change', (event) => {
            const visibilitySelect = event.target.closest('.settings-visibility-select');
            if (visibilitySelect) {
              const row = visibilitySelect.closest('.settings-row');
              if (row) updateVisibilityRowState(row);
              return;
            }
            const select = event.target.closest('.settings-category');
            if (!select) return;
            const row = select.closest('.settings-row');
            if (!row) return;
            const previousCategory = row.dataset.category || select.value;
            row.dataset.category = select.value;
            updateCategoryOrders(previousCategory);
            updateCategoryOrders(select.value);
          });
          document.addEventListener('click', (event) => {
            if (!openVisibilityPopover) return;
            if (openVisibilityPopover.contains(event.target)) return;
            closeVisibilityPopover(openVisibilityPopover);
          });
          document.addEventListener('keydown', (event) => {
            if (event.key !== 'Escape') return;
            closeVisibilityPopover(openVisibilityPopover);
          });
        }
      } catch (err) {
        console.error('[Launcharr] Display settings init failed', err);
      }

      try {
        const dashboardTable = document.querySelector('.settings-subtab-panel[data-subtab="dashboard"] .settings-table--elements');
        if (dashboardTable) {
          let draggedElementRow = null;
          let openDashboardVisibilityPopover = null;
          const getDashboardVisibilityRole = (row) => {
            const select = row?.querySelector('select[data-dashboard-visibility-role]');
            if (select) return String(select.value || '').trim().toLowerCase();
            const hidden = row?.querySelector('input[type="hidden"][name$="_visibility_role"]');
            return String(hidden?.value || '').trim().toLowerCase();
          };
          const updateRowState = (row) => {
            if (!row) return;
            const visibilityRole = getDashboardVisibilityRole(row);
            row.classList.toggle('is-disabled', visibilityRole === 'disabled');
            row.classList.remove('is-muted');
          };
          const closeDashboardVisibilityPopover = (popover) => {
            if (!popover) return;
            const trigger = popover.querySelector('.settings-visibility-trigger');
            const menu = popover.querySelector('.settings-visibility-menu');
            if (!trigger || !menu) return;
            trigger.setAttribute('aria-expanded', 'false');
            menu.hidden = true;
            const row = popover.closest('.settings-row');
            if (row) row.classList.remove('has-open-visibility');
            if (openDashboardVisibilityPopover === popover) openDashboardVisibilityPopover = null;
          };
          const openDashboardVisibilityMenu = (popover) => {
            if (!popover) return;
            if (openDashboardVisibilityPopover && openDashboardVisibilityPopover !== popover) {
              closeDashboardVisibilityPopover(openDashboardVisibilityPopover);
            }
            const trigger = popover.querySelector('.settings-visibility-trigger');
            const menu = popover.querySelector('.settings-visibility-menu');
            if (!trigger || !menu) return;
            trigger.setAttribute('aria-expanded', 'true');
            menu.hidden = false;
            const row = popover.closest('.settings-row');
            if (row) row.classList.add('has-open-visibility');
            openDashboardVisibilityPopover = popover;
          };
          const initDragOrderTable = (table) => {
            if (!table) return;
            let draggedRow = null;
            const dataRows = () => Array.from(table.querySelectorAll('.settings-row')).filter((row) => !row.classList.contains('settings-head'));
            const updateOrders = () => {
              dataRows().forEach((row, index) => {
                const input = row.querySelector('.settings-order-input');
                if (input) input.value = index + 1;
              });
            };

            dataRows().forEach((row) => {
              row.setAttribute('draggable', 'true');
              row.addEventListener('dragstart', (event) => {
                if (event.dataTransfer) {
                  event.dataTransfer.effectAllowed = 'move';
                }
                draggedRow = row;
                row.classList.add('settings-row--dragging');
              });
              row.addEventListener('dragend', () => {
                row.classList.remove('settings-row--dragging');
                draggedRow = null;
                updateOrders();
              });
              row.addEventListener('dragover', (event) => {
                event.preventDefault();
                if (!draggedRow || draggedRow === row) return;
                const bounds = row.getBoundingClientRect();
                const insertBefore = (event.clientY - bounds.top) < (bounds.height / 2);
                const parent = row.parentElement;
                if (!parent) return;
                parent.insertBefore(draggedRow, insertBefore ? row : row.nextSibling);
              });
            });
          };

          const getRowPanel = (row) => {
            const toggle = row?.querySelector('.settings-expand-toggle');
            const targetId = toggle?.dataset?.target;
            if (!targetId) return null;
            const panel = document.getElementById(targetId);
            if (panel && panel.classList.contains('settings-collapsible')) {
              return panel;
            }
            return null;
          };
          const getRowBlock = (row) => {
            const panel = getRowPanel(row);
            if (panel) {
              return [row, panel];
            }
            return [row];
          };

          const dataRows = () => Array.from(dashboardTable.children)
            .filter((node) => node.classList && node.classList.contains('settings-row--draggable'));
          const getRowOrder = (row) => {
            const input = row?.querySelector('.settings-order-input');
            const value = Number(input?.value);
            return Number.isFinite(value) ? value : 0;
          };
          const updateOrders = () => {
            const rows = dataRows();
            rows.forEach((row, index) => {
              const input = row.querySelector('.settings-order-input');
              if (input) input.value = index + 1;
            });
          };

          dataRows().forEach((row) => {
            updateRowState(row);
            row.addEventListener('dragstart', (event) => {
              if (event.dataTransfer) {
                event.dataTransfer.effectAllowed = 'move';
              }
              draggedElementRow = row;
              row.classList.add('settings-row--dragging');
            });
            row.addEventListener('dragend', () => {
              row.classList.remove('settings-row--dragging');
              draggedElementRow = null;
              updateOrders();
            });
            row.addEventListener('dragover', (event) => {
              event.preventDefault();
              if (!draggedElementRow || draggedElementRow === row) return;
              const bounds = row.getBoundingClientRect();
              const insertBefore = (event.clientY - bounds.top) < (bounds.height / 2);
              const parent = row.parentElement;
              if (!parent) return;
              const draggedBlock = getRowBlock(draggedElementRow);
              draggedBlock.forEach((el) => el.remove());
              if (insertBefore) {
                parent.insertBefore(draggedBlock[0], row);
                if (draggedBlock[1]) parent.insertBefore(draggedBlock[1], row);
              } else {
                const targetBlock = getRowBlock(row);
                const afterNode = targetBlock[targetBlock.length - 1].nextSibling;
                parent.insertBefore(draggedBlock[0], afterNode);
                if (draggedBlock[1]) parent.insertBefore(draggedBlock[1], afterNode);
              }
            });
          });

          dashboardTable.querySelectorAll('[data-dashboard-visibility-popover]').forEach((popover) => {
            const trigger = popover.querySelector('.settings-visibility-trigger');
            const menu = popover.querySelector('.settings-visibility-menu');
            if (!trigger || !menu) return;
            menu.hidden = true;
            trigger.setAttribute('aria-expanded', 'false');
            trigger.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
              const isOpen = trigger.getAttribute('aria-expanded') === 'true';
              if (isOpen) closeDashboardVisibilityPopover(popover);
              else openDashboardVisibilityMenu(popover);
            });
          });

          dashboardTable.querySelectorAll('.settings-table--tautulli-cards').forEach((table) => {
            initDragOrderTable(table);
          });

          dashboardTable.addEventListener('change', (event) => {
            if (!(event.target instanceof Element)) return;
            const visibilitySelect = event.target.closest('select[data-dashboard-visibility-role]');
            if (!visibilitySelect) return;
            const row = visibilitySelect.closest('.settings-row--draggable');
            if (!row) return;
            updateRowState(row);
          });

          dashboardTable.addEventListener('click', (event) => {
            const deleteButton = event.target.closest('.settings-dashboard-delete');
            if (deleteButton) {
              event.preventDefault();
              event.stopPropagation();
              if (deleteButton.disabled) return;
              const key = String(deleteButton.dataset.dashboardElementKey || '').trim();
              if (!key) return;
              if (!window.confirm('Remove this dashboard item? You can re-add it below.')) return;
              const removeForm = document.createElement('form');
              removeForm.method = 'post';
              removeForm.action = '/settings/dashboard-elements/remove';
              removeForm.style.display = 'none';
              const keyInput = document.createElement('input');
              keyInput.type = 'hidden';
              keyInput.name = 'dashboard_element_key';
              keyInput.value = key;
              removeForm.appendChild(keyInput);
              document.body.appendChild(removeForm);
              removeForm.submit();
              return;
            }
            const toggle = event.target.closest('.settings-expand-toggle');
            if (!toggle) return;
            const targetId = toggle.dataset.target;
            if (!targetId) return;
            const panel = document.getElementById(targetId);
            if (!panel) return;
            const isCollapsed = panel.classList.toggle('is-collapsed');
            toggle.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
          });
          document.addEventListener('click', (event) => {
            if (!openDashboardVisibilityPopover) return;
            if (openDashboardVisibilityPopover.contains(event.target)) return;
            closeDashboardVisibilityPopover(openDashboardVisibilityPopover);
          });
          document.addEventListener('keydown', (event) => {
            if (event.key !== 'Escape') return;
            closeDashboardVisibilityPopover(openDashboardVisibilityPopover);
          });
        }
      } catch (err) {
        console.error('[Launcharr] Dashboard settings init failed', err);
      }

      try {
        const appsTable = document.getElementById('displayAppsTable');
        if (appsTable) {
          const sortRows = () => {
            const rows = Array.from(appsTable.querySelectorAll('.settings-row--display.settings-row--draggable'));
            rows.sort((a, b) => {
              const aFav = Boolean(a.querySelector('.settings-favourite-input')?.checked);
              const bFav = Boolean(b.querySelector('.settings-favourite-input')?.checked);
              const favouriteDelta = (bFav ? 1 : 0) - (aFav ? 1 : 0);
              if (favouriteDelta !== 0) return favouriteDelta;
              const aCategoryRank = Number(a.dataset.categoryRank || 0);
              const bCategoryRank = Number(b.dataset.categoryRank || 0);
              const categoryDelta = aCategoryRank - bCategoryRank;
              if (categoryDelta !== 0) return categoryDelta;
              const aOrder = Number(a.querySelector('.settings-order-input')?.value || 0);
              const bOrder = Number(b.querySelector('.settings-order-input')?.value || 0);
              const orderDelta = aOrder - bOrder;
              if (orderDelta !== 0) return orderDelta;
              const aName = a.querySelector('.settings-app-name')?.textContent || '';
              const bName = b.querySelector('.settings-app-name')?.textContent || '';
              return aName.localeCompare(bName);
            });
            const headRow = appsTable.querySelector('.settings-head');
            rows.forEach((row) => appsTable.appendChild(row));
            if (headRow) {
              appsTable.prepend(headRow);
            }
          };

          appsTable.addEventListener('click', (event) => {
            const favToggle = event.target.closest('.settings-favourite-toggle');
            if (!favToggle) return;
            const row = favToggle.closest('.settings-row--display');
            if (!row) return;
            const input = row.querySelector('.settings-favourite-input');
            if (!input) return;
            input.checked = !input.checked;
            favToggle.classList.toggle('is-active', input.checked);
            favToggle.setAttribute('aria-pressed', input.checked ? 'true' : 'false');
            const icon = favToggle.querySelector('.settings-favourite-icon');
            if (icon) {
              icon.src = input.checked ? '/icons/favourite-solid.svg' : '/icons/favourite.svg';
            }
            sortRows();
          });
          appsTable.addEventListener('change', (event) => {
            const select = event.target.closest('.settings-category');
            if (!select) return;
            const row = select.closest('.settings-row--display');
            if (!row) return;
            row.dataset.category = select.value;
            row.dataset.categoryRank = String(select.selectedIndex);
            sortRows();
          });
        }
      } catch (err) {
        console.error('[Launcharr] App settings init failed', err);
      }

      try {
        const categoryManagerForm = document.getElementById('categoryManagerForm');
        if (categoryManagerForm) {
          const categoryRows = document.getElementById('categoryRows');
          const categoryInput = document.getElementById('categoryManagerInput');
          const categoryAddBtn = document.getElementById('categoryManagerAddBtn');
          const categoryIconSelect = document.getElementById('categoryManagerIconSelect');
          const iconPicker = categoryManagerForm.querySelector('[data-icon-picker]');
          const defaultCategoryForm = document.getElementById('defaultCategoryForm');
          const defaultCategoryPicker = defaultCategoryForm?.querySelector('[data-default-category-picker]');
          const defaultCategorySelect = document.getElementById('defaultCategorySelect');
          const defaultCategoryAddBtn = document.getElementById('defaultCategoryAddBtn');
          const categoryJsonInput = document.getElementById('categoryManagerJson');
          const categoryNote = document.getElementById('categoryManagerNote');
          let draggedCategoryRow = null;
          let editingCategoryRow = null;

      const setCategoryNote = (text, error = false) => {
        if (!categoryNote) return;
        categoryNote.textContent = text;
        categoryNote.classList.toggle('settings-users-note--error', Boolean(error));
      };

      const getCategoryRows = () => Array.from(categoryRows?.querySelectorAll('.category-row') || []);
      const getDefaultCategoryOptions = () => Array.from(defaultCategoryPicker?.querySelectorAll('.icon-picker-option[data-default-category-option]') || []);
      const escapeHtml = (value) => String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
      const normalizeCategory = (value) => String(value || '').trim().toLowerCase();
      const parseCategoryVisibilityRole = (value) => {
        const raw = String(value || '').trim().toLowerCase();
        if (!raw) return '';
        if (raw === 'coadmin' || raw === 'co_admin') return 'co-admin';
        return ['disabled', 'guest', 'user', 'co-admin', 'admin'].includes(raw) ? raw : '';
      };
      const normalizeCategoryVisibilityRole = (value, fallback = 'disabled') => {
        const parsed = parseCategoryVisibilityRole(value);
        if (parsed) return parsed;
        const fallbackParsed = parseCategoryVisibilityRole(fallback);
        return fallbackParsed || 'disabled';
      };
      const categoryVisibilityRoleOptions = [
        { value: 'disabled', label: 'Disabled' },
        { value: 'guest', label: 'Guest' },
        { value: 'user', label: 'User' },
        { value: 'co-admin', label: 'Co-admin' },
        { value: 'admin', label: 'Admin' },
      ];
      const buildCategoryVisibilityOptions = (selectedRole) => {
        const selected = normalizeCategoryVisibilityRole(selectedRole, 'disabled');
        return categoryVisibilityRoleOptions
          .map((option) => (
            '<option value="' + escapeHtml(option.value) + '"' + (option.value === selected ? ' selected' : '') + '>'
            + escapeHtml(option.label)
            + '</option>'
          ))
          .join('');
      };
      let categoryFormSubmitting = false;
      let openCategoryVisibilityPopover = null;

      const syncCategoryPayload = () => {
        if (!categoryJsonInput) return;
        const categories = getCategoryRows()
          .map((row) => ({
            name: String(row.dataset.category || '').trim(),
            sidebarMinRole: normalizeCategoryVisibilityRole(row.dataset.sidebarMinRole, 'disabled'),
            sidebarMenu: normalizeCategoryVisibilityRole(row.dataset.sidebarMinRole, 'disabled') !== 'disabled',
            icon: String(row.dataset.icon || '').trim(),
          }))
          .filter((entry) => entry.name);
        categoryJsonInput.value = JSON.stringify(categories);
      };

      const categoryPicker = initIconPicker(iconPicker, categoryIconSelect);
      const setIconSelection = categoryPicker.setSelection;
      const defaultCategoryPickerApi = initIconPicker(defaultCategoryPicker, defaultCategorySelect);

      const buildDefaultCategoryOption = ({ name, icon, sidebarMinRole = 'disabled' }) => {
        const value = String(name || '').trim();
        if (!value) return null;
        const option = document.createElement('button');
        option.className = 'icon-picker-option';
        option.type = 'button';
        option.setAttribute('role', 'option');
        option.dataset.defaultCategoryOption = '';
        option.dataset.value = value;
        option.dataset.label = value;
        option.dataset.defaultIcon = String(icon || '/icons/category.svg').trim() || '/icons/category.svg';
        option.dataset.defaultMinRole = normalizeCategoryVisibilityRole(sidebarMinRole, 'disabled');
        option.dataset.preview = option.dataset.defaultIcon;
        option.innerHTML =
          '<img class="icon-picker-icon" src="' + escapeHtml(option.dataset.defaultIcon) + '" alt="" onerror="this.src=\'/icons/category.svg\'" />' +
          '<span class="icon-picker-option-label">' + escapeHtml(value) + '</span>';
        return option;
      };

      const ensureDefaultCategoryOption = ({ name, icon, sidebarMinRole = 'disabled' }) => {
        const optionName = String(name || '').trim();
        if (!optionName) return null;
        const existing = getDefaultCategoryOptions().find((entry) => normalizeCategory(entry.dataset.value) === normalizeCategory(optionName));
        if (existing) return existing;
        const menu = defaultCategoryPicker?.querySelector('.icon-picker-menu');
        if (!menu) return null;
        const empty = menu.querySelector('.icon-picker-empty');
        if (empty) empty.remove();
        const option = buildDefaultCategoryOption({ name: optionName, icon, sidebarMinRole });
        if (!option) return null;
        const options = getDefaultCategoryOptions();
        const insertBefore = options.find((entry) => String(entry.dataset.label || '').localeCompare(optionName, undefined, { sensitivity: 'base' }) > 0);
        if (insertBefore) menu.insertBefore(option, insertBefore);
        else menu.appendChild(option);
        return option;
      };

      const syncDefaultCategoryPicker = () => {
        const options = getDefaultCategoryOptions();
        const hasOptions = options.length > 0;
        if (defaultCategoryAddBtn) defaultCategoryAddBtn.disabled = !hasOptions;
        if (!hasOptions) {
          defaultCategoryPickerApi.setSelection('', 'No default categories available');
          return;
        }
        const currentValue = String(defaultCategorySelect?.value || '').trim();
        const currentOption = options.find((entry) => String(entry.dataset.value || '').trim() === currentValue);
        const nextOption = currentOption || options[0];
        defaultCategoryPickerApi.setSelection(
          String(nextOption.dataset.value || '').trim(),
          String(nextOption.dataset.label || nextOption.textContent || '').trim(),
          nextOption
        );
      };

      const refreshCategoryRows = () => {
        const rows = getCategoryRows();
        const disableDelete = rows.length <= 1;
        rows.forEach((row) => {
          const deleteButton = row.querySelector('.category-delete-button');
          if (deleteButton) deleteButton.disabled = disableDelete;
          row.classList.toggle('is-disabled', normalizeCategoryVisibilityRole(row.dataset.sidebarMinRole, 'disabled') === 'disabled');
        });
        syncCategoryPayload();
      };

      const submitCategoryChanges = () => {
        if (categoryFormSubmitting) return;
        categoryFormSubmitting = true;
        syncCategoryPayload();
        categoryManagerForm.requestSubmit();
      };

      const createCategoryRow = ({ label, icon, sidebarMinRole = 'disabled', isDefault = false }) => {
        const nameValue = String(label || '').trim();
        if (!nameValue) return null;
        const iconValue = String(icon || '/icons/category.svg').trim() || '/icons/category.svg';
        const resolvedSidebarMinRole = normalizeCategoryVisibilityRole(sidebarMinRole, 'disabled');
        const row = document.createElement('div');
        row.className = 'settings-row settings-row--categories category-row';
        row.draggable = true;
        row.dataset.category = nameValue;
        row.dataset.sidebarMinRole = resolvedSidebarMinRole;
        row.dataset.icon = iconValue;
        row.dataset.default = isDefault ? 'true' : 'false';
        row.innerHTML =
          '<div class="settings-app settings-app--category">' +
            '<button class="order-button category-drag-handle" type="button" title="Drag to reorder" aria-label="Drag to reorder">&#x2630;</button>' +
            '<img class="nav-icon category-icon-preview" src="' + escapeHtml(iconValue) + '" alt="" onerror="this.src=\'/icons/category.svg\'" />' +
            '<span class="settings-app-name settings-app-name--category">' + escapeHtml(nameValue) + '</span>' +
          '</div>' +
          '<div class="settings-cell">' +
            '<div class="category-icon-display" aria-label="Category icon in use">' +
              '<img class="category-icon-display-img" src="' + escapeHtml(iconValue) + '" alt="" onerror="this.src=\'/icons/category.svg\'" />' +
              '<span class="category-icon-display-text">' + escapeHtml(formatIconLabel(iconValue)) + '</span>' +
            '</div>' +
          '</div>' +
          '<div class="settings-cell settings-cell--visibility settings-col-visibility">' +
            '<div class="settings-visibility-popover" data-category-visibility-popover>' +
              '<button class="settings-visibility-trigger" type="button" aria-label="Configure category visibility role" aria-expanded="false" aria-haspopup="true"></button>' +
              '<div class="settings-visibility-menu" hidden>' +
                '<label class="settings-visibility-group">' +
                  '<span class="settings-visibility-label">Sidebar</span>' +
                  '<select class="settings-select settings-visibility-select category-visibility-select" data-category-visibility-role>' +
                    buildCategoryVisibilityOptions(resolvedSidebarMinRole) +
                  '</select>' +
                '</label>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="settings-cell">' +
            '<button class="order-button category-edit-button" type="button" title="' + (isDefault ? 'Default categories cannot be edited.' : 'Edit category') + '" aria-label="Edit category" ' + (isDefault ? 'disabled' : '') + '>Edit</button>' +
          '</div>' +
          '<div class="settings-cell">' +
            '<button class="order-button category-delete-button" type="button" title="Delete category" aria-label="Delete category">&times;</button>' +
          '</div>';
        return row;
      };

      const attachCategoryRowEvents = (row) => {
        const visibilitySelect = row.querySelector('select[data-category-visibility-role]');
        if (visibilitySelect) {
          const currentRole = normalizeCategoryVisibilityRole(row.dataset.sidebarMinRole, visibilitySelect.value || 'disabled');
          visibilitySelect.value = currentRole;
          row.dataset.sidebarMinRole = currentRole;
          row.classList.toggle('is-disabled', currentRole === 'disabled');
          visibilitySelect.addEventListener('change', () => {
            row.dataset.sidebarMinRole = normalizeCategoryVisibilityRole(visibilitySelect.value, 'disabled');
            row.classList.toggle('is-disabled', normalizeCategoryVisibilityRole(row.dataset.sidebarMinRole, 'disabled') === 'disabled');
            syncCategoryPayload();
          });
        }
        row.addEventListener('dragstart', (event) => {
          if (event.dataTransfer) {
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', String(row.dataset.category || ''));
          }
          draggedCategoryRow = row;
          row.classList.add('category-row--dragging');
        });
        row.addEventListener('dragend', () => {
          row.classList.remove('category-row--dragging');
          draggedCategoryRow = null;
          refreshCategoryRows();
        });
        row.addEventListener('dragover', (event) => {
          event.preventDefault();
          if (!draggedCategoryRow || draggedCategoryRow === row || !categoryRows) return;
          const bounds = row.getBoundingClientRect();
          const insertBefore = (event.clientY - bounds.top) < (bounds.height / 2);
          categoryRows.insertBefore(draggedCategoryRow, insertBefore ? row : row.nextSibling);
        });
      };

      getCategoryRows().forEach(attachCategoryRowEvents);
      syncDefaultCategoryPicker();

      const closeCategoryVisibilityPopover = (popover) => {
        if (!popover) return;
        const trigger = popover.querySelector('.settings-visibility-trigger');
        const menu = popover.querySelector('.settings-visibility-menu');
        if (!trigger || !menu) return;
        trigger.setAttribute('aria-expanded', 'false');
        menu.hidden = true;
        const row = popover.closest('.settings-row');
        if (row) row.classList.remove('has-open-visibility');
        if (openCategoryVisibilityPopover === popover) openCategoryVisibilityPopover = null;
      };
      const openCategoryVisibilityMenu = (popover) => {
        if (!popover) return;
        if (openCategoryVisibilityPopover && openCategoryVisibilityPopover !== popover) {
          closeCategoryVisibilityPopover(openCategoryVisibilityPopover);
        }
        const trigger = popover.querySelector('.settings-visibility-trigger');
        const menu = popover.querySelector('.settings-visibility-menu');
        if (!trigger || !menu) return;
        trigger.setAttribute('aria-expanded', 'true');
        menu.hidden = false;
        const row = popover.closest('.settings-row');
        if (row) row.classList.add('has-open-visibility');
        openCategoryVisibilityPopover = popover;
      };
      const bindCategoryVisibilityPopover = (popover) => {
        if (!popover) return;
        const trigger = popover.querySelector('.settings-visibility-trigger');
        const menu = popover.querySelector('.settings-visibility-menu');
        if (!trigger || !menu) return;
        menu.hidden = true;
        trigger.setAttribute('aria-expanded', 'false');
        trigger.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          const isOpen = trigger.getAttribute('aria-expanded') === 'true';
          if (isOpen) closeCategoryVisibilityPopover(popover);
          else openCategoryVisibilityMenu(popover);
        });
      };
      categoryRows?.querySelectorAll('[data-category-visibility-popover]').forEach(bindCategoryVisibilityPopover);
      document.addEventListener('click', (event) => {
        if (!openCategoryVisibilityPopover) return;
        if (openCategoryVisibilityPopover.contains(event.target)) return;
        closeCategoryVisibilityPopover(openCategoryVisibilityPopover);
      });
      document.addEventListener('keydown', (event) => {
        if (event.key !== 'Escape') return;
        closeCategoryVisibilityPopover(openCategoryVisibilityPopover);
      });

      categoryRows?.addEventListener('click', (event) => {
        const editButton = event.target.closest('.category-edit-button');
        if (editButton) {
          const row = editButton.closest('.category-row');
          if (!row) return;
          const label = String(row.dataset.category || '').trim();
          const iconValue = String(row.dataset.icon || '/icons/category.svg').trim() || '/icons/category.svg';
          editingCategoryRow = row;
          if (categoryInput) categoryInput.value = label;
          setIconSelection(iconValue, formatIconLabel(iconValue));
          if (categoryAddBtn) categoryAddBtn.textContent = 'Save changes';
          setCategoryNote('Editing category. Update the fields and save changes.');
          categoryInput?.focus();
          return;
        }
        const deleteButton = event.target.closest('.category-delete-button');
        if (!deleteButton) return;
        const row = deleteButton.closest('.category-row');
        if (!row) return;
        if (deleteButton.disabled) return;
        const label = String(row.dataset.category || '').trim() || 'this category';
        if (!window.confirm('Delete "' + label + '"?')) return;
        const isDefault = row.dataset.default === 'true';
        if (isDefault) {
          ensureDefaultCategoryOption({
            name: label,
            icon: String(row.dataset.icon || '/icons/category.svg').trim() || '/icons/category.svg',
            sidebarMinRole: normalizeCategoryVisibilityRole(row.dataset.sidebarMinRole, 'disabled'),
          });
          syncDefaultCategoryPicker();
        }
        row.remove();
        setCategoryNote((isDefault ? 'Default category removed. You can re-add it from the dropdown. ' : 'Category removed. ') + 'Applying changes...');
        refreshCategoryRows();
        submitCategoryChanges();
      });

      categoryAddBtn?.addEventListener('click', () => {
        const label = String(categoryInput?.value || '').trim();
        if (!label) {
          setCategoryNote('Enter a category name before adding.', true);
          return;
        }
        const isDuplicate = getCategoryRows().some((row) => {
          if (editingCategoryRow && row === editingCategoryRow) return false;
          return normalizeCategory(row.dataset.category) === normalizeCategory(label);
        });
        if (isDuplicate) {
          setCategoryNote('That category already exists.', true);
          return;
        }
        const selectedIcon = String(categoryIconSelect?.value || '').trim() || '/icons/category.svg';

        if (editingCategoryRow) {
          editingCategoryRow.dataset.category = label;
          editingCategoryRow.dataset.icon = selectedIcon;
          const nameEl = editingCategoryRow.querySelector('.settings-app-name--category');
          if (nameEl) nameEl.textContent = label;
          const iconPreview = editingCategoryRow.querySelector('.category-icon-preview');
          if (iconPreview) iconPreview.src = selectedIcon;
          const displayImg = editingCategoryRow.querySelector('.category-icon-display-img');
          if (displayImg) displayImg.src = selectedIcon;
          const displayText = editingCategoryRow.querySelector('.category-icon-display-text');
          if (displayText) displayText.textContent = formatIconLabel(selectedIcon);
          editingCategoryRow = null;
          if (categoryAddBtn) categoryAddBtn.textContent = 'Add category';
          if (categoryInput) categoryInput.value = '';
          setIconSelection('', '');
          setCategoryNote('Category updated. Applying changes...');
          refreshCategoryRows();
          submitCategoryChanges();
          return;
        }

        if (!window.confirm('Add "' + label + '" as a new category?')) return;
        const row = createCategoryRow({
          label,
          icon: selectedIcon,
          sidebarMinRole: 'disabled',
          isDefault: false,
        });
        if (!row) return;
        categoryRows?.appendChild(row);
        attachCategoryRowEvents(row);
        bindCategoryVisibilityPopover(row.querySelector('[data-category-visibility-popover]'));
        if (categoryInput) categoryInput.value = '';
        setIconSelection('', '');
        setCategoryNote('Category added. Applying changes...');
        refreshCategoryRows();
        submitCategoryChanges();
      });

      defaultCategoryAddBtn?.addEventListener('click', () => {
        const selectedName = String(defaultCategorySelect?.value || '').trim();
        if (!selectedName) {
          setCategoryNote('Select a default category to add.', true);
          return;
        }
        const selectedOption = getDefaultCategoryOptions().find((entry) => String(entry.dataset.value || '').trim() === selectedName);
        if (!selectedOption) {
          setCategoryNote('Select a default category to add.', true);
          return;
        }
        const isDuplicate = getCategoryRows().some((row) => normalizeCategory(row.dataset.category) === normalizeCategory(selectedName));
        if (isDuplicate) {
          selectedOption.remove();
          syncDefaultCategoryPicker();
          setCategoryNote('That category already exists.', true);
          return;
        }
        const defaultIcon = String(selectedOption.dataset.defaultIcon || '/icons/category.svg').trim() || '/icons/category.svg';
        const defaultMinRole = normalizeCategoryVisibilityRole(selectedOption.dataset.defaultMinRole, 'disabled');
        const row = createCategoryRow({
          label: selectedName,
          icon: defaultIcon,
          sidebarMinRole: defaultMinRole,
          isDefault: true,
        });
        if (!row) return;
        if (!window.confirm('Re-add default category "' + selectedName + '"?')) return;
        categoryRows?.appendChild(row);
        attachCategoryRowEvents(row);
        bindCategoryVisibilityPopover(row.querySelector('[data-category-visibility-popover]'));
        selectedOption.remove();
        syncDefaultCategoryPicker();
        setCategoryNote('Default category re-added. Applying changes...');
        refreshCategoryRows();
        submitCategoryChanges();
      });

      categoryInput?.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter') return;
        event.preventDefault();
        categoryAddBtn?.click();
      });

      categoryManagerForm.addEventListener('submit', () => {
        syncCategoryPayload();
      });

          refreshCategoryRows();
        }
      } catch (err) {
        console.error('[Launcharr] Category manager init failed', err);
      }

    function roleOptions(selected) {
      return [
        { value: 'user', label: 'User' },
        { value: 'co-admin', label: 'Co-admin' },
        { value: 'admin', label: 'Admin' },
      ]
        .map((opt) => '<option value="' + opt.value + '"' + (opt.value === selected ? ' selected' : '') + '>' + opt.label + '</option>')
        .join('');
    }

    function formatLoginTimestamp(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      try {
        return date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
      } catch (err) {
        return date.toLocaleString();
      }
    }

    const userSort = { key: 'name', dir: 'asc' };
    const sortHeaders = Array.from(document.querySelectorAll('.settings-users-head-cell[data-sort-key]'));
    const updateUserSortIndicators = () => {
      sortHeaders.forEach((header) => {
        const key = header.dataset.sortKey;
        const isActive = key === userSort.key;
        if (isActive) {
          header.dataset.sortDir = userSort.dir;
          header.setAttribute('aria-sort', userSort.dir === 'asc' ? 'ascending' : 'descending');
        } else {
          header.dataset.sortDir = '';
          header.setAttribute('aria-sort', 'none');
        }
      });
    };

    const sortUserRows = () => {
      if (!usersBody) return;
      const rows = Array.from(usersBody.querySelectorAll('.settings-users-row'));
      const key = userSort.key;
      const isNumeric = key === 'plex' || key === 'launcharr';
      rows.sort((a, b) => {
        if (isNumeric) {
          const av = Number(a.dataset[key] || 0);
          const bv = Number(b.dataset[key] || 0);
          if (av === bv) return 0;
          return userSort.dir === 'asc' ? av - bv : bv - av;
        }
        const av = String(a.dataset[key] || '');
        const bv = String(b.dataset[key] || '');
        return userSort.dir === 'asc'
          ? av.localeCompare(bv, undefined, { numeric: true, sensitivity: 'base' })
          : bv.localeCompare(av, undefined, { numeric: true, sensitivity: 'base' });
      });
      rows.forEach((row) => usersBody.appendChild(row));
      updateUserSortIndicators();
    };

    sortHeaders.forEach((header) => {
      const key = header.dataset.sortKey;
      if (!key) return;
      header.addEventListener('click', () => {
        if (userSort.key === key) {
          userSort.dir = userSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
          userSort.key = key;
          userSort.dir = key === 'plex' || key === 'launcharr' ? 'desc' : 'asc';
        }
        sortUserRows();
      });
      header.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        event.preventDefault();
        header.click();
      });
    });
    updateUserSortIndicators();

    function renderUsers(users) {
      usersBody.innerHTML = '';
      users.forEach((user) => {
        const row = document.createElement('div');
        row.className = 'settings-users-row';
        row.dataset.identifier = user.identifier;
        const nameKey = String(user.name || user.username || 'Plex User').toLowerCase();
        const roleKey = String(user.role || 'user').toLowerCase();
        const plexStamp = user.lastPlexSeen && !Number.isNaN(Date.parse(user.lastPlexSeen))
          ? Date.parse(user.lastPlexSeen)
          : 0;
        const launcharrStamp = user.lastLauncharrLogin && !Number.isNaN(Date.parse(user.lastLauncharrLogin))
          ? Date.parse(user.lastLauncharrLogin)
          : 0;
        const plexLogin = formatLoginTimestamp(user.lastPlexSeen);
        const launcharrLogin = formatLoginTimestamp(user.lastLauncharrLogin);
        row.dataset.name = nameKey;
        row.dataset.role = roleKey;
        row.dataset.plex = String(plexStamp);
        row.dataset.launcharr = String(launcharrStamp);
        row.innerHTML =
          '<div class="settings-users-name">' + (user.name || 'Plex User') + '</div>' +
          '<div class="settings-users-login" title="' + (user.lastPlexSeen || '') + '">' + plexLogin + '</div>' +
          '<div class="settings-users-login" title="' + (user.lastLauncharrLogin || '') + '">' + launcharrLogin + '</div>' +
          '<div class="settings-users-role">' +
            '<select ' + (user.locked ? 'disabled' : '') + '>' +
              roleOptions(user.role || 'user') +
            '</select>' +
            (user.locked ? '<span class="settings-users-locked">Owner</span>' : '') +
          '</div>';
        usersBody.appendChild(row);
      });
      sortUserRows();
    }

    async function fetchUsers() {
      if (!fetchBtn || !usersBody || !note) return;
      fetchBtn.disabled = true;
      note.textContent = 'Fetching Plex users...';
      try {
        console.info('[Launcharr] Plex users request');
        const res = await fetch('/settings/plex-users');
        console.info('[Launcharr] Plex users response', { status: res.status, ok: res.ok });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to fetch users.');
        renderUsers(data.users || []);
        saveBtn.disabled = false;
        note.textContent = 'Update roles and hit save.';
      } catch (err) {
        console.error('[Launcharr] Plex users failed', { error: err?.message || String(err) });
        note.textContent = err.message || 'Failed to fetch users.';
      } finally {
        fetchBtn.disabled = false;
      }
    }

    async function saveRoles() {
      if (!saveBtn || !usersBody || !note) return;
      const rows = Array.from(usersBody.querySelectorAll('.settings-users-row'));
      const roles = rows.map((row) => {
        const identifier = row.dataset.identifier || '';
        const select = row.querySelector('select');
        return { identifier, role: select ? select.value : 'user' };
      });
      saveBtn.disabled = true;
      note.textContent = 'Saving roles...';
      try {
        console.info('[Launcharr] Roles save request', { count: roles.length });
        const res = await fetch('/settings/roles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ roles }),
        });
        console.info('[Launcharr] Roles save response', { status: res.status, ok: res.ok });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to save roles.');
        note.textContent = 'Roles saved.';
      } catch (err) {
        console.error('[Launcharr] Roles save failed', { error: err?.message || String(err) });
        note.textContent = err.message || 'Failed to save roles.';
      } finally {
        saveBtn.disabled = false;
      }
    }

    fetchBtn?.addEventListener('click', fetchUsers);
    saveBtn?.addEventListener('click', saveRoles);

      if (fetchBtn) {
        fetchUsers();
      }
    } catch (err) {
      console.error('[Launcharr] Settings form init failed', err);
    }
  </script>
  <script src="/version-badge.js"></script>
  <script src="/brand-menu.js?v=<%= assetVersion %>"></script>
  <script src="/starfield-3d.js"></script>
  <script src="/pwa.js"></script>
</body>
</html>
