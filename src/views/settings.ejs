<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Launcharr - Settings</title>
  <script>
    (function() {
      try {
        var stored = localStorage.getItem("launcharr-theme");
        var prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
        var mode = stored || (prefersLight ? "day" : "night");
        var brandTheme = localStorage.getItem("launcharr-brand-theme") || "pulsarr";
        document.documentElement.dataset.theme = mode;
        document.documentElement.dataset.brandTheme = brandTheme;
        if (brandTheme === "custom") {
          var customHex = localStorage.getItem("launcharr-custom-color") || "#1cc6c2";
          var normalizedHex = /^#?[0-9a-fA-F]{6}$/.test(customHex) ? (customHex.charAt(0) === "#" ? customHex : "#" + customHex) : "#1cc6c2";
          var r = parseInt(normalizedHex.slice(1, 3), 16);
          var g = parseInt(normalizedHex.slice(3, 5), 16);
          var b = parseInt(normalizedHex.slice(5, 7), 16);
          var mix = function(base, target, amount) {
            return Math.round(base + (target - base) * amount);
          };
          var toHex = function(value) {
            var clamped = Math.max(0, Math.min(255, value));
            return clamped.toString(16).padStart(2, "0");
          };
          var dark = "#" + toHex(mix(r, 0, 0.4)) + toHex(mix(g, 0, 0.4)) + toHex(mix(b, 0, 0.4));
          var start = "#" + toHex(mix(r, 255, 0.35)) + toHex(mix(g, 255, 0.35)) + toHex(mix(b, 255, 0.35));
          var end = "#" + toHex(mix(r, 0, 0.2)) + toHex(mix(g, 0, 0.2)) + toHex(mix(b, 0, 0.2));
          var shadowR = mix(r, 0, 0.28);
          var shadowG = mix(g, 0, 0.28);
          var shadowB = mix(b, 0, 0.28);
          var linear = function(channel) {
            var value = channel / 255;
            return value <= 0.03928 ? value / 12.92 : Math.pow((value + 0.055) / 1.055, 2.4);
          };
          var luminance = 0.2126 * linear(r) + 0.7152 * linear(g) + 0.0722 * linear(b);
          var contrastWhite = 1.05 / (luminance + 0.05);
          var contrastBlack = (luminance + 0.05) / 0.05;
          var onBrand = contrastWhite >= contrastBlack ? "#ffffff" : "#081013";
          var onBrandMuted = contrastWhite >= contrastBlack ? "rgba(255,255,255,.78)" : "rgba(8,16,19,.72)";
          var onBrandIconFilter = contrastWhite >= contrastBlack ? "brightness(0) saturate(100%) invert(1)" : "brightness(0) saturate(100%)";
          document.documentElement.style.setProperty("--teal", normalizedHex.toLowerCase());
          document.documentElement.style.setProperty("--teal-dark", dark);
          document.documentElement.style.setProperty("--brand-rgb", r + "," + g + "," + b);
          document.documentElement.style.setProperty("--brand-btn-start", start);
          document.documentElement.style.setProperty("--brand-btn-mid", normalizedHex.toLowerCase());
          document.documentElement.style.setProperty("--brand-btn-end", end);
          document.documentElement.style.setProperty("--brand-btn-shadow", shadowR + "," + shadowG + "," + shadowB);
          document.documentElement.style.setProperty("--on-brand", onBrand);
          document.documentElement.style.setProperty("--on-brand-muted", onBrandMuted);
          document.documentElement.style.setProperty("--on-brand-icon-filter", onBrandIconFilter);
        }
      } catch (e) {}
    })();
  </script>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" type="image/png" href="/icons/launcharr-icon.png" />
  <meta name="theme-color" content="#1cc6c2" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/icons/launcharr-icon.png" />
</head>
<body class="dash-body">
  <div class="dash-frame">
    <aside class="dash-sidebar">
      <div class="dash-brand">
        <span class="dash-logo">
          <img class="nav-icon app-icon" src="/icons/launcharr-icon.png" alt="Launcharr" />
        </span>
        <div>
          <div class="dash-title">Launcharr</div>
        </div>
      </div>

      <div class="dash-nav">
        <a class="nav-item" href="/dashboard">
          <img class="nav-icon" src="/icons/dashboard.svg" alt="" />
          <span class="nav-label">Dashboard</span>
        </a>
        <% if (navCategories && navCategories.length) { %>
          <div class="nav-divider"></div>
          <div class="nav-accordion">
            <% navCategories.forEach((category) => { %>
              <% if (category.sidebarMenu) { %>
                <div class="nav-accordion-item nav-accordion-item--category">
                  <button class="nav-accordion-trigger nav-accordion-trigger--category" type="button">
                    <img class="nav-icon" src="<%= category.icon || '/icons/category.svg' %>" alt="" onerror="this.src='/icons/category.svg'" />
                    <span class="nav-label"><%= category.name %></span>
                  </button>
                  <div class="nav-accordion-panel nav-accordion-panel--category">
                    <div class="nav-accordion nav-accordion--nested">
                      <% category.apps.forEach((appItem) => { %>
                        <div class="nav-accordion-item">
                          <button class="nav-accordion-trigger" type="button">
                            <img class="nav-icon app-icon" src="<%= appItem.icon || (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission'].includes(appItem.id) ? '/icons/' + appItem.id + '.png' : '/icons/' + appItem.id + '.svg') %>" alt="" onerror="this.src='/icons/app.svg'" />
                            <span class="nav-label"><%= appItem.name %></span>
                          </button>
                          <div class="nav-accordion-panel">
                            <% if (appItem.menuAccess.overview) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>">
                                <img class="nav-subicon" src="/icons/overview.svg" alt="" />
                                <span>Overview</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.launch) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>/launch" <%= appItem.effectiveLaunchMode === 'new-tab' ? 'target="_blank" rel="noreferrer"' : '' %>>
                                <img class="nav-subicon" src="/icons/launch.svg" alt="" />
                                <span>Launch</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.settings) { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>/settings">
                                <img class="nav-subicon" src="/icons/settings.svg" alt="" />
                                <span>App settings</span>
                              </a>
                            <% } %>
                            <% if (appItem.menuAccess.overview && role === 'admin') { %>
                              <a class="nav-subitem" href="/apps/<%= appItem.id %>/activity">
                                <img class="nav-subicon" src="/icons/activity-queue.svg" alt="" />
                                <span>Activity</span>
                              </a>
                            <% } %>
                          </div>
                        </div>
                      <% }) %>
                    </div>
                  </div>
                </div>
              <% } else { %>
                <% category.apps.forEach((appItem) => { %>
                  <div class="nav-accordion-item">
                    <button class="nav-accordion-trigger" type="button">
                      <img class="nav-icon app-icon" src="<%= appItem.icon || (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission'].includes(appItem.id) ? '/icons/' + appItem.id + '.png' : '/icons/' + appItem.id + '.svg') %>" alt="" onerror="this.src='/icons/app.svg'" />
                      <span class="nav-label"><%= appItem.name %></span>
                    </button>
                    <div class="nav-accordion-panel">
                      <% if (appItem.menuAccess.overview) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>">
                          <img class="nav-subicon" src="/icons/overview.svg" alt="" />
                          <span>Overview</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.launch) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>/launch" <%= appItem.effectiveLaunchMode === 'new-tab' ? 'target="_blank" rel="noreferrer"' : '' %>>
                          <img class="nav-subicon" src="/icons/launch.svg" alt="" />
                          <span>Launch</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.settings) { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>/settings">
                          <img class="nav-subicon" src="/icons/settings.svg" alt="" />
                          <span>App settings</span>
                        </a>
                      <% } %>
                      <% if (appItem.menuAccess.overview && role === 'admin') { %>
                        <a class="nav-subitem" href="/apps/<%= appItem.id %>/activity">
                          <img class="nav-subicon" src="/icons/activity-queue.svg" alt="" />
                          <span>Activity</span>
                        </a>
                      <% } %>
                    </div>
                  </div>
                <% }) %>
              <% } %>
            <% }) %>
          </div>
        <% } %>
      </div>

      <div class="dash-user">
        <div class="user-pill user-pill--menu" data-user-menu role="button" tabindex="0" aria-haspopup="true" aria-expanded="false">
          <% if (user.avatar) { %>
            <img class="user-avatar" src="<%= user.avatar %>" alt="" />
          <% } %>
          <div class="user-meta">
            <span class="role"><%= role %></span>
            <div class="username"><%= user.username %></div>
            <% if (user.email) { %>
              <div class="email"><%= user.email %></div>
            <% } %>
          </div>
          <span class="user-pill-caret" aria-hidden="true"></span>
          <div class="user-menu" role="menu">
            <% if (actualRole === 'admin') { %>
              <a class="user-menu-item" href="/settings">
                <img class="user-menu-icon" src="/icons/settings.svg" alt="" />
                <span class="user-menu-text">Settings</span>
              </a>
            <% } %>
            <% if (actualRole === 'admin') { %>
              <a class="user-menu-item" href="/switch-view?role=<%= role === 'admin' ? 'user' : 'admin' %>">
                <img class="user-menu-icon" src="/icons/window.svg" alt="" />
                <span class="user-menu-text"><%= role === 'admin' ? 'Switch to user view' : 'Switch to admin view' %></span>
              </a>
            <% } %>
            <a class="user-menu-item" href="/user-settings">
              <img class="user-menu-icon" src="/icons/user-profile.svg" alt="" />
              <span class="user-menu-text">User profile</span>
            </a>
            <div class="user-menu-divider"></div>
            <a class="user-menu-item" href="/logout">
              <img class="user-menu-icon" src="/icons/logout.svg" alt="" />
              <span class="user-menu-text">Sign out</span>
            </a>
          </div>
        </div>
      </div>
    </aside>

    <section class="dash-main">
      <div class="main-window-bar">
        <button class="sidebar-toggle main-toggle left-toggle" type="button" aria-label="Toggle sidebar">
          <img class="toggle-icon" src="/icons/sidebar-toggle.svg" alt="" />
        </button>
        <div class="main-window-title">
          <img class="main-window-icon" src="/icons/settings.svg" alt="" />
          <span class="main-window-app">Settings</span>
        </div>
      <div class="main-window-spacer"></div>
      <div class="main-window-status">
        <span class="status-dot"></span>
      </div>
    </div>
    <div class="settings-debug" id="settingsDebug" style="display:none;"></div>

      <% const safeJson = (value) => JSON.stringify(value)
        .replace(/</g, '\\u003c')
        .replace(/\u2028/g, '\\u2028')
        .replace(/\u2029/g, '\\u2029'); %>
      <div class="settings-tabs" role="tablist" aria-label="Settings tabs">
        <button class="settings-tab-btn is-active" type="button" data-tab="general">
          <img class="settings-tab-icon" src="/icons/settings.svg" alt="" />
          <span class="settings-tab-text">General</span>
        </button>
        <button class="settings-tab-btn" type="button" data-tab="custom">
          <img class="settings-tab-icon" src="/icons/tools.svg" alt="" />
          <span class="settings-tab-text">Custom</span>
        </button>
        <button class="settings-tab-btn" type="button" data-tab="app">
          <img class="settings-tab-icon" src="/icons/app.svg" alt="" />
          <span class="settings-tab-text">Apps</span>
        </button>
        <button class="settings-tab-btn" type="button" data-tab="user">
          <img class="settings-tab-icon" src="/icons/user-profile.svg" alt="" />
          <span class="settings-tab-text">User</span>
        </button>
        <button class="settings-tab-btn" type="button" data-tab="log">
          <img class="settings-tab-icon" src="/icons/activity-queue.svg" alt="" />
          <span class="settings-tab-text">Log</span>
        </button>
      </div>

      <div class="settings-tab-panel is-active" data-tab="general">
        <div class="dash-panel">
          <form method="post" action="/settings/general" class="settings-form">
            <div class="settings-card">
              <div class="settings-card-title">Server Identity</div>
              <div class="settings-card-sub">Remote URL is used for external links and sharing. Local URL is preferred for LAN Plex SSO.</div>
              <label class="field">
                <span>Server Name</span>
                <input
                  type="text"
                  name="server_name"
                  value="<%= generalSettings?.serverName || 'Launcharr' %>"
                  placeholder="Launcharr"
                />
              </label>
              <label class="field">
                <span>Remote URL</span>
                <input
                  type="text"
                  name="remote_url"
                  value="<%= generalSettings?.remoteUrl || '' %>"
                  placeholder="https://example.com"
                />
              </label>
              <label class="field">
                <span>Local URL</span>
                <input
                  type="text"
                  name="local_url"
                  value="<%= generalSettings?.localUrl || '' %>"
                  placeholder="http://192.168.0.2:3333"
                />
              </label>
            </div>
            <button class="primary-button" type="submit">Save general settings</button>
          </form>
        </div>
      </div>

      <div class="settings-tab-panel" data-tab="custom">
        <div class="dash-panel">
          <div class="settings-subtabs" role="tablist" aria-label="Custom settings pages">
            <button class="settings-subtab-btn is-active" type="button" data-subtab="categories">
              <img class="settings-subtab-icon" src="/icons/category.svg" alt="" />
              <span class="settings-subtab-text">Categories</span>
            </button>
            <button class="settings-subtab-btn" type="button" data-subtab="apps">
              <img class="settings-subtab-icon" src="/icons/sidebar-toggle.svg" alt="" />
              <span class="settings-subtab-text">Sidebar</span>
            </button>
            <button class="settings-subtab-btn" type="button" data-subtab="dashboard">
              <img class="settings-subtab-icon" src="/icons/dashboard.svg" alt="" />
              <span class="settings-subtab-text">Dashboard</span>
            </button>
            <button class="settings-subtab-btn" type="button" data-subtab="images">
              <img class="settings-subtab-icon" src="/icons/view.svg" alt="" />
              <span class="settings-subtab-text">Images</span>
            </button>
            <button class="settings-subtab-btn" type="button" data-subtab="themes">
              <img class="settings-subtab-icon" src="/icons/sun.svg" alt="" />
              <span class="settings-subtab-text">Themes</span>
            </button>
          </div>
          <div class="settings-subtab-panel is-active" data-subtab="categories">
            <form method="post" action="/settings/categories" class="settings-form" id="categoryManagerForm">
              <input type="hidden" id="categoryManagerJson" name="categories_json" />
              <div class="settings-table settings-table--categories">
                <div class="settings-row settings-row--categories settings-head">
                  <div>
                    <img class="settings-head-icon" src="/icons/category.svg" alt="" />
                    <span class="settings-head-label">Category</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/app.svg" alt="" />
                    <span class="settings-head-label">Icon</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/sidebar-toggle.svg" alt="" />
                    <span class="settings-head-label">Sidebar menu</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/edit.svg" alt="" />
                    <span class="settings-head-label">Edit</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/delete.svg" alt="" />
                    <span class="settings-head-label">Delete</span>
                  </div>
                </div>
                <div id="categoryRows">
                  <% const categoryManagerEntries = Array.isArray(categoryEntries) && categoryEntries.length
                    ? categoryEntries
                    : ['Tools'].map((name) => ({ name, sidebarMenu: false, icon: '/icons/category.svg' })); %>
                  <% const defaultCategoryNames = ['admin', 'media', 'manager', 'arr suite', 'downloaders', 'tools']; %>
                  <% categoryManagerEntries.forEach((entry, index) => { %>
                    <% const iconValue = entry.icon || '/icons/category.svg'; %>
                    <% const isDefaultCategory = defaultCategoryNames.includes(String(entry.name || '').trim().toLowerCase()); %>
                    <div class="settings-row settings-row--categories category-row" draggable="true" data-category="<%= entry.name %>" data-sidebar-menu="<%= entry.sidebarMenu ? 'true' : 'false' %>" data-icon="<%= iconValue %>" data-default="<%= isDefaultCategory ? 'true' : 'false' %>">
                      <div class="settings-app settings-app--category">
                        <button class="order-button category-drag-handle" type="button" title="Drag to reorder" aria-label="Drag to reorder">&#x2630;</button>
                        <img class="nav-icon category-icon-preview" src="<%= iconValue %>" alt="" onerror="this.src='/icons/category.svg'" />
                        <span class="settings-app-name settings-app-name--category"><%= entry.name %></span>
                      </div>
                      <div class="settings-cell">
                        <div class="category-icon-display" aria-label="Category icon in use">
                          <img class="category-icon-display-img" src="<%= iconValue %>" alt="" onerror="this.src='/icons/category.svg'" />
                          <span class="category-icon-display-text"><%= String(iconValue || '').replace('/icons/', '') %></span>
                        </div>
                      </div>
                      <div class="settings-cell">
                        <input class="category-sidebar-toggle" type="checkbox" title="Group apps under this category in the sidebar" aria-label="Group apps in sidebar" <%= entry.sidebarMenu ? 'checked' : '' %> />
                      </div>
                      <div class="settings-cell">
                        <button class="order-button category-edit-button" type="button" title="<%= isDefaultCategory ? 'Default categories cannot be edited.' : 'Edit category' %>" aria-label="Edit category" <%= isDefaultCategory ? 'disabled' : '' %>>Edit</button>
                      </div>
                      <div class="settings-cell">
                        <button class="order-button category-delete-button" type="button" title="<%= isDefaultCategory ? 'Default categories cannot be deleted.' : 'Delete category' %>" aria-label="Delete category" <%= isDefaultCategory ? 'disabled' : '' %>>&times;</button>
                      </div>
                    </div>
                  <% }) %>
                </div>
              </div>
              <div class="category-manager-add">
                <input type="text" id="categoryManagerInput" class="category-manager-input" placeholder="New category name" autocomplete="off" />
                <div class="icon-picker" data-icon-picker>
                  <button class="settings-select icon-picker-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                    <span class="icon-picker-preview" aria-hidden="true"></span>
                    <span class="icon-picker-label">Select icon</span>
                  </button>
                  <div class="icon-picker-menu" role="listbox" aria-label="Category icon">
                    <% (Array.isArray(categoryIcons) ? categoryIcons : []).forEach((iconPath) => { %>
                      <button class="icon-picker-option" type="button" data-value="<%= iconPath %>" role="option">
                        <img class="icon-picker-icon" src="<%= iconPath %>" alt="" />
                        <span><%= iconPath.replace('/icons/', '') %></span>
                      </button>
                    <% }) %>
                  </div>
                  <input type="hidden" id="categoryManagerIconSelect" value="" />
                </div>
                <button class="primary-button" type="button" id="categoryManagerAddBtn">Add category</button>
              </div>
              <button class="primary-button" type="submit">Save category settings</button>
            </form>
          </div>
          <div class="settings-subtab-panel" data-subtab="apps">
            <form method="post" action="/settings/apps" class="settings-form">
              <div class="settings-table settings-table--display" id="displayAppsTable">
                <div class="settings-row settings-row--display settings-head">
                  <div>
                    <img class="settings-head-icon" src="/icons/app.svg" alt="" />
                    <span class="settings-head-label">Application</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/enable.svg" alt="" />
                    <span class="settings-head-label">Enable</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/overview.svg" alt="" />
                    <span class="settings-head-label">Overview</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/launch.svg" alt="" />
                    <span class="settings-head-label">Launch</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/favourite.svg" alt="" />
                    <span class="settings-head-label">Favourite</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/category.svg" alt="" />
                    <span class="settings-head-label">Category</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/edit.svg" alt="" />
                    <span class="settings-head-label">Edit</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/delete.svg" alt="" />
                    <span class="settings-head-label">Delete</span>
                  </div>
                </div>
                <% const availableCategories = Array.isArray(categories) && categories.length ? categories : ['Tools']; %>
                <% const categoryOptions = availableCategories.map((value) => {
                  const label = String(value || '').trim();
                  const initials = label
                    .split(/\s+/)
                    .map((part) => part.charAt(0))
                    .join('')
                    .toUpperCase();
                  const short = initials || label.slice(0, 3).toUpperCase();
                  return { value: label, label, short };
                }); %>
                <% const launchOptions = [
                  { value: 'disabled', label: 'Disabled', short: 'Off' },
                  { value: 'new-tab', label: 'New Tab', short: 'Tab' },
                  { value: 'iframe', label: 'iFrame', short: 'Frame' },
                ]; %>
                <% apps.forEach((app, index) => { %>
                  <% const menu = app.menu || {}; %>
                  <% const overview = menu.overview || {}; %>
                  <% const launch = menu.launch || {}; %>
                  <% const settings = menu.settings || {}; %>
                  <% const roles = Array.isArray(app.roles) ? app.roles.map(r => String(r).toLowerCase()) : (app.role ? [String(app.role).toLowerCase()] : []); %>
                  <% const defaultUser = !roles.length || roles.includes('user') || roles.includes('both'); %>
                  <% const defaultAdmin = !roles.length || roles.includes('admin') || roles.includes('both'); %>
                  <% const overviewUser = overview.user !== undefined ? overview.user : defaultUser; %>
                  <% const overviewAdmin = overview.admin !== undefined ? overview.admin : defaultAdmin; %>
                  <% const launchUser = launch.user !== undefined ? launch.user : defaultUser; %>
                  <% const launchAdmin = launch.admin !== undefined ? launch.admin : defaultAdmin; %>
                  <% const appLaunchOptions = launchOptions; %>
                  <% const modeValues = appLaunchOptions.map((option) => option.value); %>
                  <% const currentLaunchMode = modeValues.includes(app.launchMode) ? app.launchMode : (launchUser || launchAdmin ? 'new-tab' : 'disabled'); %>
                  <% const settingsAdmin = settings.admin !== undefined ? settings.admin : defaultAdmin; %>
                  <% const adminEnabled = overviewAdmin || launchAdmin || settingsAdmin; %>
                  <% const categoryValues = categoryOptions.map((option) => option.value); %>
                  <% const currentCategory = categoryValues.includes(app.category) ? app.category : categoryOptions[0].value; %>
                  <% const orderValue = Number.isFinite(app.order) ? app.order : index + 1; %>
                  <% const favouriteValue = Boolean(app.favourite || app.favorite); %>
                  <% const isCustomApp = Boolean(app.custom); %>
                  <% const categoryRank = Math.max(0, categoryOptions.findIndex((option) => option.value === currentCategory)); %>
                  <div class="settings-row settings-row--display settings-row--draggable <%= adminEnabled ? '' : 'is-disabled' %>" data-category="<%= currentCategory %>" data-category-rank="<%= categoryRank %>" draggable="true">
                    <div class="settings-app settings-app--draggable">
                      <button class="order-button settings-drag-handle settings-drag-handle--app" type="button" title="Drag to reorder within category" aria-label="Drag to reorder within category">&#x2630;</button>
                      <img class="nav-icon app-icon" src="<%= app.icon || (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission'].includes(app.id) ? '/icons/' + app.id + '.png' : '/icons/' + app.id + '.svg') %>" alt="" onerror="this.src='/icons/app.svg'" />
                      <span class="settings-app-name"><%= app.name %></span>
                    </div>
                    <div class="settings-cell">
                      <input type="checkbox" name="display_enable_<%= app.id %>" <%= adminEnabled ? 'checked' : '' %> />
                    </div>
                    <div class="settings-cell">
                      <input type="checkbox" name="display_overview_user_<%= app.id %>" <%= overviewUser ? 'checked' : '' %> <%= app.custom ? 'disabled title="Overview disabled for custom apps"' : '' %> />
                    </div>
                    <div class="settings-cell settings-cell--launch">
                      <input class="settings-radio" type="checkbox" name="display_launch_user_<%= app.id %>" <%= launchUser ? 'checked' : '' %> />
                      <select class="settings-select settings-launch-mode" name="display_launch_mode_<%= app.id %>" title="<%= app.id === 'tautulli' ? 'Tautulli iFrame mode is overridden to New Tab on local/private host access.' : 'Choose how launch opens.' %>">
                        <% appLaunchOptions.forEach((option) => { %>
                          <option value="<%= option.value %>" <%= option.value === currentLaunchMode ? 'selected' : '' %> data-full="<%= option.label %>" data-short="<%= option.short %>" title="<%= option.label %>"><%= option.label %></option>
                        <% }) %>
                      </select>
                    </div>
                    <div class="settings-cell">
                      <button class="settings-favourite-toggle <%= favouriteValue ? 'is-active' : '' %>" type="button" aria-pressed="<%= favouriteValue ? 'true' : 'false' %>" aria-label="Toggle favourite">
                        <img class="settings-favourite-icon" src="<%= favouriteValue ? '/icons/favourite-solid.svg' : '/icons/favourite.svg' %>" alt="" />
                      </button>
                      <input class="settings-favourite-input" type="checkbox" name="display_favourite_<%= app.id %>" <%= favouriteValue ? 'checked' : '' %> />
                    </div>
                    <div class="settings-cell">
                      <select class="settings-select settings-category" name="display_category_<%= app.id %>">
                        <% categoryOptions.forEach((option) => { %>
                          <option value="<%= option.value %>" <%= option.value === currentCategory ? 'selected' : '' %> data-full="<%= option.label %>" data-short="<%= option.short %>" title="<%= option.value %>"><%= option.label %></option>
                        <% }) %>
                      </select>
                    </div>
                    <div class="settings-cell">
                <button class="order-button custom-app-edit" type="button" title="<%= isCustomApp ? 'Edit custom app' : 'Only custom apps can be edited' %>" aria-label="Edit app" <%= isCustomApp ? 'data-app-id="' + app.id + '" data-app-name="' + app.name + '" data-app-category="' + (app.category || 'Tools') + '" data-app-icon="' + (app.icon || '') + '"' : 'disabled' %>>Edit</button>
                    </div>
                    <div class="settings-cell">
                      <button class="order-button custom-app-delete" type="button" title="<%= isCustomApp ? 'Delete custom app' : 'Only custom apps can be deleted' %>" aria-label="Delete app" <%= isCustomApp ? 'data-app-id="' + app.id + '"' : 'disabled' %>>&times;</button>
                    </div>
                    <input type="hidden" class="settings-order-input" name="display_order_<%= app.id %>" value="<%= orderValue %>" />
                  </div>
                <% }) %>
              </div>
              <div class="category-manager-add app-manager-add" id="customAppForm">
                <input type="text" id="customAppName" class="category-manager-input" placeholder="Custom app name" />
                <select id="customAppCategory" class="settings-select app-manager-select">
                  <% (Array.isArray(categories) && categories.length ? categories : ['Tools']).forEach((category) => { %>
                    <option value="<%= category %>"><%= category %></option>
                  <% }) %>
                </select>
                <div class="icon-picker" data-app-icon-picker>
                  <button class="settings-select icon-picker-trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                    <span class="icon-picker-preview" aria-hidden="true"></span>
                    <span class="icon-picker-label">Select icon</span>
                  </button>
                  <div class="icon-picker-menu" role="listbox" aria-label="App icon">
                    <% (Array.isArray(appIcons) ? appIcons : []).forEach((iconPath) => { %>
                      <button class="icon-picker-option" type="button" data-value="<%= iconPath %>" role="option">
                        <img class="icon-picker-icon" src="<%= iconPath %>" alt="" />
                        <span><%= iconPath.replace('/icons/', '') %></span>
                      </button>
                    <% }) %>
                  </div>
                  <input type="hidden" id="customAppIconSelect" value="" />
                </div>
                <button class="primary-button" type="button" id="customAppSubmit">Add custom app</button>
                <button class="order-button" type="button" id="customAppCancel" style="display:none;">Cancel edit</button>
              </div>
              <span class="settings-users-note" id="customAppNote">Overview is disabled for custom apps.</span>
              <button class="primary-button" type="submit">Save display settings</button>
            </form>
          </div>
          <div class="settings-subtab-panel" data-subtab="dashboard">
            <form method="post" action="/settings/dashboard-elements" class="settings-form" id="dashboardElementsForm">
              <% const tautulliItems = Array.isArray(tautulliCards) ? tautulliCards : []; %>
              <% if (tautulliItems.length) { %>
                <input type="hidden" name="tautulliCardsForm" value="1" />
              <% } %>
              <div class="settings-table settings-table--elements" id="dashboardElementsTable">
                <div class="settings-row settings-head settings-row--elements settings-row--with-expand">
                  <div>
                    <img class="settings-head-icon" src="/icons/overview.svg" alt="" />
                    <span class="settings-head-label">Name</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/enable.svg" alt="" />
                    <span class="settings-head-label">Enable</span>
                  </div>
                  <div>
                    <img class="settings-head-icon" src="/icons/dashboard.svg" alt="" />
                    <span class="settings-head-label">Dashboard</span>
                  </div>
                  <div class="settings-cell--blank" aria-hidden="true"></div>
                </div>
                <% (Array.isArray(dashboardElements) ? dashboardElements : []).forEach((item, index) => { %>
                  <% const element = item.element || {}; %>
                  <% const rowKey = `${String(item.appId)}-${String(element.id || index)}-${item.combined ? 'combined' : 'single'}`; %>
                  <% const categoryRank = Math.max(0, (categories || []).indexOf(item.category || 'Tools')); %>
                  <% const displayName = item.displayName || element.name; %>
                  <% const elementIcon = item.iconPath || (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission'].includes(item.appId) ? `/icons/${item.appId}.png` : `/icons/${item.appId}.svg`); %>
                  <% const showWatchCardsPanel = item.appId === 'tautulli' && (element.id === 'watch-stats' || element.id === 'watch-stats-wheel') && tautulliItems.length; %>
                  <% const combinedOrderKey = item.combined ? `combined:${item.combinedType || 'mixed'}:${item.combinedSection || element.id || 'unknown'}` : ''; %>
                  <% const combinedOrderValue = combinedOrderKey && dashboardCombinedOrder ? Number(dashboardCombinedOrder[combinedOrderKey]) : NaN; %>
                  <% const orderValue = Number.isFinite(combinedOrderValue) ? combinedOrderValue : (Number.isFinite(element.order) ? element.order : index + 1); %>
                  <% const isQueue = element.id === 'activity-queue'; %>
                  <% const isDisabled = Boolean(item.appAccess === false); %>
                  <% const combinedKey = item.combined ? `combined:${item.combinedType || 'mixed'}:${item.combinedSection || element.id || 'unknown'}` : ''; %>
                  <% const combinedSettings = combinedKey && dashboardCombinedSettings ? dashboardCombinedSettings[combinedKey] : null; %>
                  <% const baseEnable = item.combined && combinedSettings && typeof combinedSettings.enable === 'boolean' ? combinedSettings.enable : element.enable; %>
                  <% const baseDashboard = item.combined && combinedSettings && typeof combinedSettings.dashboard === 'boolean' ? combinedSettings.dashboard : element.dashboard; %>
                  <% const effectiveEnable = !isDisabled && baseEnable; %>
                  <% const effectiveDashboard = !isDisabled && baseDashboard; %>
                  <% const combinedPrefix = item.combined ? `dashboard_combined_${item.combinedType || 'mixed'}_${item.combinedSection || element.id}` : `dashboard_${item.appId}_${element.id}`; %>
                  <% const enableName = `name="${combinedPrefix}_enable"`; %>
                  <% const dashboardName = `name="${combinedPrefix}_dashboard"`; %>
                  <div class="settings-row settings-row--elements settings-row--with-expand settings-row--draggable <%= effectiveEnable ? '' : 'is-disabled' %> <%= effectiveDashboard ? '' : 'is-muted' %>" data-app-id="<%= item.appId %>" data-category="<%= item.category || 'Tools' %>" data-category-rank="<%= categoryRank %>" draggable="true">
                    <div class="settings-element">
                      <button class="order-button settings-drag-handle" type="button" title="Drag to reorder" aria-label="Drag to reorder">&#x2630;</button>
                      <img class="settings-element-icon" src="<%= elementIcon %>" alt="" onerror="this.src='/icons/app.svg'" />
                      <span class="settings-element-name"><%= displayName %></span>
                    </div>
                    <div class="settings-cell">
                    <input type="checkbox" <%= isDisabled ? 'disabled' : '' %> <%- enableName %> <%= effectiveEnable ? 'checked' : '' %> />
                    </div>
                    <div class="settings-cell">
                    <input type="checkbox" <%= isDisabled ? 'disabled' : '' %> <%- dashboardName %> <%= effectiveDashboard ? 'checked' : '' %> />
                    </div>
                    <% const orderName = item.combined ? `dashboard_combined_${item.combinedType || 'mixed'}_${item.combinedSection || element.id}_order` : `dashboard_${item.appId}_${element.id}_order`; %>
                    <input type="hidden" class="settings-order-input" name="<%= orderName %>" value="<%= orderValue %>" />
                    <% if (item.combined) { %>
                      <input type="hidden" name="<%= combinedPrefix %>_present" value="1" />
                    <% } else { %>
                      <input type="hidden" name="dashboard_<%= item.appId %>_<%= element.id %>_present" value="1" />
                    <% } %>
                    <div class="settings-cell settings-expand-cell">
                      <button class="settings-expand-toggle settings-inline-toggle settings-element-options-toggle" type="button" data-target="dashboardOptions-<%= rowKey %>" aria-label="Toggle carousel display options" aria-expanded="false" <%= isDisabled ? 'disabled' : '' %>>
                        <img class="settings-expand-icon" src="/icons/expand.svg" alt="" />
                      </button>
                    </div>
                  </div>
                  <div class="settings-collapsible is-collapsed settings-inline-collapsible" id="dashboardOptions-<%= rowKey %>">
                    <div class="settings-card">
                      <fieldset class="settings-card-fields" <%= isDisabled ? 'disabled' : '' %>>
                      <% if (showWatchCardsPanel) { %>
                        <div class="settings-card-title">Watch Statistics Cards</div>
                        <div class="settings-table settings-table--tautulli-cards">
                          <% tautulliItems.forEach((item, cardIndex) => { %>
                            <% const orderValue = Number.isFinite(item.order) ? item.order : cardIndex + 1; %>
                            <div class="settings-row settings-row--tautulli-cards settings-row--draggable">
                              <div class="settings-element">
                                <button class="order-button settings-drag-handle" type="button" title="Drag to reorder" aria-label="Drag to reorder">&#x2630;</button>
                                <span class="settings-element-name"><%= item.name %></span>
                              </div>
                              <div class="settings-cell">
                                <input type="checkbox" name="dashboard_tautulli_card_enable_<%= element.id %>_<%= item.id %>" <%= item.enable ? 'checked' : '' %> />
                              </div>
                              <div class="settings-cell settings-cell--blank" aria-hidden="true"></div>
                              <div class="settings-cell settings-cell--blank" aria-hidden="true"></div>
                              <input type="hidden" class="settings-order-input" name="dashboard_tautulli_card_order_<%= element.id %>_<%= item.id %>" value="<%= orderValue %>" />
                              <div class="settings-cell settings-cell--blank" aria-hidden="true"></div>
                            </div>
                          <% }) %>
                        </div>
                      <% } %>
                      <% if (item.combined && item.combinedType === 'arr') { %>
                        <% const arrSectionKey = item.combinedSection || 'activityQueue'; %>
                        <% const arrSectionLabel = arrSectionKey === 'downloadingSoon' ? 'Downloading Soon' : (arrSectionKey === 'recentlyDownloaded' ? 'Recently Downloaded' : 'Activity Queue'); %>
                        <div class="settings-card-title">Combined Queue Display</div>
                        <div class="settings-combined-grid settings-combined-grid--arr" data-section="<%= arrSectionKey %>">
                          <% arrApps.forEach((app) => { %>
                            <label class="settings-combined-item">
                              <img class="settings-combined-icon" src="/icons/<%= app.id %>.png" alt="" onerror="this.src='/icons/app.svg'" />
                              <span class="settings-combined-name"><%= app.name %></span>
                              <input
                                type="checkbox"
                                name="arr_combine_<%= arrSectionKey %>_<%= app.id %>"
                                <%= arrDashboardCombine?.[arrSectionKey]?.[app.id] ? 'checked' : '' %>
                              />
                            </label>
                          <% }) %>
                        </div>
                        <% if (arrSectionKey === 'activityQueue') { %>
                          <div class="settings-card-title" style="margin-top:12px;">Combined Queue Display Options</div>
                          <div class="settings-grid">
                            <label class="radio-pill">
                              <input type="checkbox" name="arr_combined_queue_col_detail" <%= arrCombinedQueueDisplay?.queueShowDetail !== false ? 'checked' : '' %> />
                              <span>Detail</span>
                            </label>
                            <label class="radio-pill">
                              <input type="checkbox" name="arr_combined_queue_col_subdetail" <%= arrCombinedQueueDisplay?.queueShowSubDetail !== false ? 'checked' : '' %> />
                              <span>Sub-detail</span>
                            </label>
                            <label class="radio-pill">
                              <input type="checkbox" name="arr_combined_queue_col_size" <%= arrCombinedQueueDisplay?.queueShowSize !== false ? 'checked' : '' %> />
                              <span>Size</span>
                            </label>
                            <label class="radio-pill">
                              <input type="checkbox" name="arr_combined_queue_col_protocol" <%= arrCombinedQueueDisplay?.queueShowProtocol !== false ? 'checked' : '' %> />
                              <span>Protocol</span>
                            </label>
                            <label class="radio-pill">
                              <input type="checkbox" name="arr_combined_queue_col_timeleft" <%= arrCombinedQueueDisplay?.queueShowTimeLeft !== false ? 'checked' : '' %> />
                              <span>Time Left</span>
                            </label>
                            <label class="radio-pill">
                              <input type="checkbox" name="arr_combined_queue_col_progress" <%= arrCombinedQueueDisplay?.queueShowProgress !== false ? 'checked' : '' %> />
                              <span>Progress</span>
                            </label>
                          </div>
                          <div class="settings-grid" style="margin-top:12px;">
                            <label class="field">
                              <span>Visible items in queue</span>
                              <input
                                type="number"
                                min="5"
                                max="50"
                                step="1"
                                name="arr_combined_queue_visible_rows"
                                value="<%= arrCombinedQueueDisplay?.queueVisibleRows || 10 %>"
                              />
                            </label>
                          </div>
                        <% } %>
                      <% } %>
                      <% if (item.combined && item.combinedType === 'downloader' && element.id === 'activity-queue') { %>
                        <% const combinedDownloaderApps = (Array.isArray(downloaderApps) && downloaderApps.length)
                          ? downloaderApps
                          : (Array.isArray(apps) ? apps.filter((appItem) => ['transmission', 'nzbget'].includes(appItem.id)) : []); %>
                        <div class="settings-card-title">Combined Download Queue Display</div>
                        <div class="settings-table settings-table--arr-combine">
                          <div class="settings-row settings-row--arr-combine settings-head">
                            <div>
                              <img class="settings-head-icon" src="/icons/download.svg" alt="" />
                              <span class="settings-head-label">Downloader</span>
                            </div>
                            <div class="settings-cell settings-cell--blank" aria-hidden="true"></div>
                            <div class="settings-cell settings-cell--blank" aria-hidden="true"></div>
                            <div>
                              <img class="settings-head-icon" src="/icons/activity-queue.svg" alt="" />
                              <span class="settings-head-label">Activity Queue</span>
                            </div>
                          </div>
                          <% combinedDownloaderApps.forEach((app) => { %>
                            <div class="settings-row settings-row--arr-combine">
                              <div class="settings-app">
                                <img class="nav-icon app-icon" src="<%= app.icon || (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission'].includes(app.id) ? '/icons/' + app.id + '.png' : '/icons/' + app.id + '.svg') %>" alt="" onerror="this.src='/icons/app.svg'" />
                                <span class="settings-app-name"><%= app.name %></span>
                              </div>
                              <div class="settings-cell settings-cell--blank" aria-hidden="true"></div>
                              <div class="settings-cell settings-cell--blank" aria-hidden="true"></div>
                              <div class="settings-cell">
                                <input
                                  type="checkbox"
                                  name="downloader_combine_activityQueue_<%= app.id %>"
                                  <%= downloaderDashboardCombine?.activityQueue?.[app.id] ? 'checked' : '' %>
                                />
                              </div>
                            </div>
                          <% }) %>
                        </div>
                        <div class="settings-card-title" style="margin-top:12px;">Combined Download Queue Display Options</div>
                        <div class="settings-grid">
                          <label class="radio-pill">
                            <input type="checkbox" name="downloader_combined_queue_col_detail" <%= downloaderCombinedQueueDisplay?.queueShowDetail !== false ? 'checked' : '' %> />
                            <span>Source</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="downloader_combined_queue_col_subdetail" <%= downloaderCombinedQueueDisplay?.queueShowSubDetail !== false ? 'checked' : '' %> />
                            <span>Detail</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="downloader_combined_queue_col_size" <%= downloaderCombinedQueueDisplay?.queueShowSize !== false ? 'checked' : '' %> />
                            <span>Size</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="downloader_combined_queue_col_protocol" <%= downloaderCombinedQueueDisplay?.queueShowProtocol !== false ? 'checked' : '' %> />
                            <span>Protocol</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="downloader_combined_queue_col_timeleft" <%= downloaderCombinedQueueDisplay?.queueShowTimeLeft !== false ? 'checked' : '' %> />
                            <span>Time Left</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="downloader_combined_queue_col_progress" <%= downloaderCombinedQueueDisplay?.queueShowProgress !== false ? 'checked' : '' %> />
                            <span>Progress</span>
                          </label>
                        </div>
                        <div class="settings-grid" style="margin-top:12px;">
                          <label class="field">
                            <span>Visible items in queue</span>
                            <input
                              type="number"
                              min="5"
                              max="50"
                              step="1"
                              name="downloader_combined_queue_visible_rows"
                              value="<%= downloaderCombinedQueueDisplay?.queueVisibleRows || 10 %>"
                            />
                          </label>
                        </div>
                      <% } %>
                      <% if (isQueue && !item.combined) { %>
                        <div class="settings-card-title">Queue Display Options</div>
                        <div class="settings-grid">
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_queue_col_detail" <%= element.queueShowDetail !== false ? 'checked' : '' %> />
                            <span><%= element.queueDetailLabel || 'Detail' %></span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_queue_col_subdetail" <%= element.queueShowSubDetail !== false ? 'checked' : '' %> />
                            <span><%= element.queueSubDetailLabel || 'Sub-detail' %></span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_queue_col_size" <%= element.queueShowSize !== false ? 'checked' : '' %> />
                            <span>Size</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_queue_col_protocol" <%= element.queueShowProtocol !== false ? 'checked' : '' %> />
                            <span>Protocol</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_queue_col_timeLeft" <%= element.queueShowTimeLeft !== false ? 'checked' : '' %> />
                            <span>Time Left</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_queue_col_progress" <%= element.queueShowProgress !== false ? 'checked' : '' %> />
                            <span>Progress</span>
                          </label>
                        </div>
                        <div class="settings-grid" style="margin-top:12px;">
                          <label class="field">
                            <span>Visible items in queue</span>
                            <input
                              type="number"
                              min="5"
                              max="50"
                              step="1"
                              name="dashboard_<%= item.appId %>_<%= element.id %>_queue_visible_rows"
                              value="<%= element.queueVisibleRows || 10 %>"
                            />
                          </label>
                        </div>
                      <% } else if (!item.combined || (element.id !== 'activity-queue')) { %>
                        <div class="settings-card-title">Carousel Display Options</div>
                        <div class="settings-grid">
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_showSubtitle" <%= element.showSubtitle !== false ? 'checked' : '' %> />
                            <span>Subtitle</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_showMeta" <%= element.showMeta !== false ? 'checked' : '' %> />
                            <span>Meta</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_showPill" <%= element.showPill !== false ? 'checked' : '' %> />
                            <span>Pill</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_showTypeIcon" <%= element.showTypeIcon !== false ? 'checked' : '' %> />
                            <span>Type Icon</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_showViewIcon" <%= element.showViewIcon !== false ? 'checked' : '' %> />
                            <span>View Icon</span>
                          </label>
                          <label class="radio-pill">
                            <input type="checkbox" name="dashboard_<%= item.appId %>_<%= element.id %>_showUsername" <%= element.showUsername !== false ? 'checked' : '' %> />
                            <span>Username</span>
                          </label>
                        </div>
                      <% } %>
                      </fieldset>
                    </div>
                  </div>
                <% }) %>
              </div>
              <button class="primary-button" type="submit">Save dashboard settings</button>
            </form>
          </div>
          <div class="settings-subtab-panel" data-subtab="images">
            <div class="settings-card">
              <div class="settings-card-title">System Icons</div>
              <form method="post" action="/settings/icons/upload" class="settings-form settings-images-form" data-icon-form>
                <input type="hidden" name="icon_type" value="system" />
                <input type="hidden" name="icon_data" class="settings-icon-data" />
                <div class="settings-row settings-row--images-upload">
                  <input class="settings-input settings-icon-file" type="file" accept="image/*,.svg" />
                  <input class="settings-input settings-icon-name category-manager-input" type="text" name="icon_name" placeholder="Icon name (required)" required />
                  <button class="primary-button" type="submit">Upload</button>
                </div>
              </form>
              <div class="settings-icon-grid">
                <% (Array.isArray(systemIconDefaults) ? systemIconDefaults : []).forEach((iconPath) => { %>
                  <div class="settings-icon-card">
                    <img src="<%= iconPath %>" alt="" />
                    <span><%= iconPath.split('/').pop() %></span>
                  </div>
                <% }) %>
                <% (Array.isArray(systemIconCustom) ? systemIconCustom : []).forEach((iconPath) => { %>
                  <div class="settings-icon-card settings-icon-card--custom">
                    <img src="<%= iconPath %>" alt="" />
                    <span><%= iconPath.split('/').pop() %></span>
                    <form method="post" action="/settings/icons/delete" class="settings-icon-delete">
                      <input type="hidden" name="icon_type" value="system" />
                      <input type="hidden" name="icon_path" value="<%= iconPath %>" />
                      <button class="order-button" type="submit" title="Delete icon" aria-label="Delete icon">&times;</button>
                    </form>
                  </div>
                <% }) %>
              </div>
            </div>

            <div class="settings-card">
              <div class="settings-card-title">App Icons</div>
              <form method="post" action="/settings/icons/upload" class="settings-form settings-images-form" data-icon-form>
                <input type="hidden" name="icon_type" value="app" />
                <input type="hidden" name="icon_data" class="settings-icon-data" />
                <div class="settings-row settings-row--images-upload">
                  <input class="settings-input settings-icon-file" type="file" accept="image/*,.svg" />
                  <input class="settings-input settings-icon-name category-manager-input" type="text" name="icon_name" placeholder="Icon name (required)" required />
                  <button class="primary-button" type="submit">Upload</button>
                </div>
              </form>
              <div class="settings-icon-grid">
                <% (Array.isArray(appIconDefaults) ? appIconDefaults : []).forEach((iconPath) => { %>
                  <div class="settings-icon-card">
                    <img src="<%= iconPath %>" alt="" />
                    <span><%= iconPath.split('/').pop() %></span>
                  </div>
                <% }) %>
                <% (Array.isArray(appIconCustom) ? appIconCustom : []).forEach((iconPath) => { %>
                  <div class="settings-icon-card settings-icon-card--custom">
                    <img src="<%= iconPath %>" alt="" />
                    <span><%= iconPath.split('/').pop() %></span>
                    <form method="post" action="/settings/icons/delete" class="settings-icon-delete">
                      <input type="hidden" name="icon_type" value="app" />
                      <input type="hidden" name="icon_path" value="<%= iconPath %>" />
                      <button class="order-button" type="submit" title="Delete icon" aria-label="Delete icon">&times;</button>
                    </form>
                  </div>
                <% }) %>
              </div>
            </div>
          </div>
          <div class="settings-subtab-panel" data-subtab="themes">
            <div class="settings-card settings-card--themes">
              <div class="settings-card-title">Themes</div>
              <div class="settings-card-sub">Choose a preset theme for Launcharr.</div>
              <div class="theme-presets" id="themePresets">
                <button class="theme-preset-card" type="button" data-brand-theme="launcharr">
                  <span class="theme-preset-chip" style="--theme-color:#6d7a86;"></span>
                  <span class="theme-preset-name">Launcharr</span>
                  <span class="theme-preset-meta">Gunmetal</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="rocketship">
                  <span class="theme-preset-chip" style="--theme-color:#b8c1ca;"></span>
                  <span class="theme-preset-name">Rocketship</span>
                  <span class="theme-preset-meta">Silver</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="pulsarr">
                  <span class="theme-preset-chip" style="--theme-color:#1cc6c2;"></span>
                  <span class="theme-preset-name">Pulsarr</span>
                  <span class="theme-preset-meta">Pulsarr teal</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="plex">
                  <span class="theme-preset-chip" style="--theme-color:#f9ad2f;"></span>
                  <span class="theme-preset-name">Plex</span>
                  <span class="theme-preset-meta">Plex orange</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="radarr">
                  <span class="theme-preset-chip" style="--theme-color:#f4c542;"></span>
                  <span class="theme-preset-name">Radarr</span>
                  <span class="theme-preset-meta">Radarr yellow</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="sonarr">
                  <span class="theme-preset-chip" style="--theme-color:#3d7bfd;"></span>
                  <span class="theme-preset-name">Sonarr</span>
                  <span class="theme-preset-meta">Sonarr blue</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="lidarr">
                  <span class="theme-preset-chip" style="--theme-color:#53b86a;"></span>
                  <span class="theme-preset-name">Lidarr</span>
                  <span class="theme-preset-meta">Lidarr green</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="readarr">
                  <span class="theme-preset-chip" style="--theme-color:#d84a4a;"></span>
                  <span class="theme-preset-name">Readarr</span>
                  <span class="theme-preset-meta">Readarr red</span>
                </button>
                <button class="theme-preset-card" type="button" data-brand-theme="custom">
                  <span class="theme-preset-chip theme-preset-chip--custom" data-custom-chip style="--theme-color:#1cc6c2;">
                    <input class="theme-chip-picker" id="customThemeColor" type="color" value="#1cc6c2" aria-label="Choose custom theme color" />
                  </span>
                  <span class="theme-preset-name">Custom</span>
                  <span class="theme-preset-meta">Color wheel</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="settings-tab-panel" data-tab="log">
      <div class="dash-panel">
        <form method="post" action="/settings/logs" class="settings-form">
          <div class="settings-card">
            <div class="settings-card-title">Retention</div>
            <div class="settings-card-sub">Logs are stored on disk and pruned by these limits.</div>
            <div class="settings-log-row">
              <label class="field">
                <span>Max Entries</span>
                <input
                  type="number"
                  min="50"
                  max="5000"
                  step="50"
                  name="log_max_entries"
                  value="<%= logSettings?.maxEntries || 250 %>"
                />
              </label>
              <label class="field">
                <span>Max Days</span>
                <input
                  type="number"
                  min="1"
                  max="365"
                  step="1"
                  name="log_max_days"
                  value="<%= logSettings?.maxDays || 7 %>"
                />
              </label>
              <label class="field">
                <span>Visible Rows</span>
                <input
                  type="number"
                  min="3"
                  max="100"
                  step="1"
                  name="log_visible_rows"
                  value="<%= logSettings?.visibleRows || 10 %>"
                />
              </label>
              <button class="primary-button" type="submit">Save log settings</button>
            </div>
          </div>
        </form>
      </div>

      <div class="dash-panel">
        <div class="panel-card log-body log-body--combined">
          <div class="log-toolbar">
            <div class="log-filter">
              <span class="log-filter-label">App</span>
              <select class="settings-select" id="settingsLogApp">
                <option value="">All</option>
                <option value="system">System</option>
                <% apps.forEach((app) => { %>
                  <option value="<%= app.id %>"><%= app.name %></option>
                <% }) %>
              </select>
            </div>
            <div class="log-filter">
              <span class="log-filter-label">Level</span>
              <select class="settings-select" id="settingsLogLevel">
                <option value="">All</option>
                <option value="info">Info</option>
                <option value="error">Error</option>
              </select>
            </div>
            <button class="primary-button log-refresh" type="button" id="settingsLogRefresh">Refresh</button>
            <span class="log-status" id="settingsLogStatus">Loading...</span>
          </div>
          <div class="log-list" id="settingsLogList" style="--log-visible-rows:<%= logSettings?.visibleRows || 10 %>"></div>
        </div>
      </div>
      </div>

      <div class="settings-tab-panel" data-tab="app">
      <div class="dash-panel">
        <div class="panel-header">
          <h2>Application Settings</h2>
          <span class="panel-sub">Switch apps below to edit settings on this page.</span>
        </div>
        <%
          const appSettingsNav = [];
          const appSettingsSeen = new Set();
          (Array.isArray(navCategories) ? navCategories : []).forEach((category) => {
            (Array.isArray(category?.apps) ? category.apps : []).forEach((appItem) => {
              const id = String(appItem?.id || '').trim();
              if (!id || appSettingsSeen.has(id)) return;
              appSettingsSeen.add(id);
              appSettingsNav.push(appItem);
            });
          });
        %>
        <% if (appSettingsNav.length) { %>
          <div class="app-settings-switcher" role="navigation" aria-label="Application settings pages">
            <% appSettingsNav.forEach((appItem, appIndex) => { %>
              <button
                class="app-settings-switcher-btn<%= appIndex === 0 ? ' is-active' : '' %>"
                type="button"
                data-settings-app-button
                data-app-id="<%= appItem.id %>"
                title="<%= appItem.name %> settings"
                aria-label="<%= appItem.name %> settings"
              >
                <img
                  class="app-settings-switcher-icon nav-icon app-icon"
                  src="<%= appItem.icon || (['plex', 'tautulli', 'radarr', 'sonarr', 'lidarr', 'readarr', 'pulsarr', 'prowlarr', 'cleanuparr', 'huntarr', 'transmission'].includes(appItem.id) ? '/icons/' + appItem.id + '.png' : '/icons/' + appItem.id + '.svg') %>"
                  alt=""
                  onerror="this.src='/icons/app.svg'"
                />
                <span class="app-settings-switcher-text"><%= appItem.name %></span>
              </button>
            <% }) %>
          </div>
          <% appSettingsNav.forEach((appItem, appIndex) => { %>
            <%
              const appMenu = appItem.menu || {};
              const appOverview = appMenu.overview || {};
              const appLaunch = appMenu.launch || {};
              const appSettingsMenu = appMenu.settings || {};
              const appRoleKey = role === 'admin' || role === 'co-admin' ? 'admin' : 'user';
              const appHasMenu = Boolean(appMenu.overview || appMenu.launch || appMenu.settings);
              const appEnabled = appHasMenu ? Boolean(appOverview[appRoleKey] || appLaunch[appRoleKey] || appSettingsMenu[appRoleKey]) : true;
              const appHasUrl = Boolean(appItem.localUrl || appItem.remoteUrl);
              const appHasToken = appItem.id === 'plex' ? Boolean(appItem.plexToken) : true;
              const appStatusOk = appEnabled && appHasUrl && appHasToken;
              const appIsArrSuite = String(appItem.category || '').toLowerCase() === 'arr suite';
            %>
            <div class="app-settings-panel<%= appIndex === 0 ? ' is-active' : '' %>" data-settings-app-panel data-app-id="<%= appItem.id %>">
              <div class="settings-card">
                <div class="settings-card-title"><%= appItem.name %> connection</div>
                <div class="settings-card-sub"><%= appStatusOk ? 'Configured and enabled.' : 'Needs attention: check URL or credentials.' %></div>
                <form method="post" action="/apps/<%= appItem.id %>/settings?from=settings" class="settings-form">
                  <label class="field">
                    <span>Local URL</span>
                    <input type="text" name="localUrl" value="<%= appItem.localUrl || '' %>" placeholder="http://192.168.x.x:port" />
                  </label>
                  <label class="field">
                    <span>Remote URL</span>
                    <input type="text" name="remoteUrl" value="<%= appItem.remoteUrl || '' %>" placeholder="https://app.example.com" />
                  </label>
                  <% if (appItem.id === 'plex') { %>
                    <% const appAdminOwner = (Array.isArray(admins) && admins.length) ? admins[0] : ''; %>
                    <label class="field">
                      <span>Plex Token</span>
                      <input type="password" name="plexToken" value="<%= appItem.plexToken || '' %>" placeholder="Plex token" />
                    </label>
                    <label class="field">
                      <span>Plex Machine</span>
                      <input type="password" name="plexMachine" value="<%= appItem.plexMachine || '' %>" placeholder="Machine identifier" />
                    </label>
                    <label class="field">
                      <span>Plex Admin User</span>
                      <input type="text" name="plexAdminUser" value="<%= appAdminOwner %>" placeholder="admin@plex.tv" />
                    </label>
                  <% } %>
                  <% if (appItem.id === 'tautulli' || appIsArrSuite) { %>
                    <label class="field">
                      <span>API Key</span>
                      <input type="password" name="apiKey" value="<%= appItem.apiKey || '' %>" placeholder="<%= appItem.name %> API key" />
                    </label>
                  <% } %>
                  <% if (appItem.id === 'nzbget' || appItem.id === 'transmission') { %>
                    <label class="field">
                      <span>Username</span>
                      <input type="text" name="username" value="<%= appItem.username || '' %>" placeholder="<%= appItem.name %> username" />
                    </label>
                    <label class="field">
                      <span>Password</span>
                      <input type="password" name="password" value="<%= appItem.password || '' %>" placeholder="<%= appItem.name %> password" />
                    </label>
                  <% } %>
                  <button class="primary-button" type="submit">Save <%= appItem.name %> settings</button>
                </form>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <span class="settings-users-note">No apps available for settings.</span>
        <% } %>
      </div>
      </div>

      <div class="settings-tab-panel" data-tab="user">
      <div class="dash-panel">
        <div class="settings-form settings-users">
          <div class="settings-card">
            <div class="settings-card-title">Access control</div>
            <div class="settings-card-sub">Limit sign-in to Plex server users.</div>
            <form method="post" action="/user-settings/access" class="settings-access-form">
              <div class="settings-access-row">
                <label class="settings-toggle">
                  <input type="checkbox" name="restrictGuests" <%= generalSettings.restrictGuests ? 'checked' : '' %> />
                  <span class="settings-toggle-slider" aria-hidden="true"></span>
                  <span class="settings-toggle-text">Restrict guest users</span>
                </label>
                <button class="primary-button" type="submit">Save access settings</button>
              </div>
            </form>
          </div>
          <div class="settings-users-actions">
            <button class="primary-button" type="button" id="fetchPlexUsersBtn">Fetch users</button>
            <button class="primary-button" type="button" id="savePlexRolesBtn" disabled>Save roles</button>
            <span class="settings-users-note" id="plexUsersNote">Pull the user list from Plex to assign roles.</span>
          </div>
          <div class="settings-users-table">
            <div class="settings-users-row settings-users-head">
              <div class="settings-users-head-cell settings-users-sort" data-sort-key="name" role="button" tabindex="0">
                <img class="settings-head-icon" src="/icons/name.svg" alt="" />
                <span>Name</span>
              </div>
              <div class="settings-users-head-cell settings-users-sort" data-sort-key="plex" role="button" tabindex="0">
                <span>Last seen (Plex)</span>
              </div>
              <div class="settings-users-head-cell settings-users-sort" data-sort-key="launcharr" role="button" tabindex="0">
                <span>Last Launcharr login</span>
              </div>
              <div class="settings-users-head-cell settings-users-sort" data-sort-key="role" role="button" tabindex="0">
                <img class="settings-head-icon" src="/icons/role.svg" alt="" />
                <span>Role</span>
              </div>
            </div>
            <div id="plexUsersBody"></div>
          </div>
        </div>
      </div>
      </div>
    </section>
  </div>
  <script>
    const dashFrame = document.querySelector('.dash-frame');
    const toggle = document.querySelector('.sidebar-toggle');
    const toggleIcon = toggle?.querySelector('img');
    const mobileQuery = window.matchMedia('(max-width: 980px)');
    const isMobile = () => mobileQuery.matches;
    const mainContent = document.querySelector('.dash-main');
    const sidebar = document.querySelector('.dash-sidebar');
    const tabButtons = Array.from(document.querySelectorAll('.settings-tab-btn'));
    const tabPanels = Array.from(document.querySelectorAll('.settings-tab-panel'));
    const customTabButtons = Array.from(document.querySelectorAll('.settings-subtab-btn'));
    const customTabPanels = Array.from(document.querySelectorAll('.settings-subtab-panel'));
    const debugBanner = document.getElementById('settingsDebug');
    const showDebug = (message) => {
      if (!debugBanner) return;
      debugBanner.textContent = message;
      debugBanner.style.display = 'block';
    };
    window.addEventListener('error', (event) => {
      const location = event?.filename
        ? ` (${event.filename}:${event.lineno || 0}:${event.colno || 0})`
        : '';
      showDebug('Settings error: ' + (event?.message || 'Unknown error') + location);
    });
    window.addEventListener('unhandledrejection', (event) => {
      const message = event?.reason?.message || String(event?.reason || 'Unknown rejection');
      showDebug('Settings error: ' + message);
    });
    const safeStorage = {
      get(key) {
        try {
          return localStorage.getItem(key);
        } catch (err) {
          return null;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (err) {
          return;
        }
      },
    };

      const formatIconLabel = (value) => String(value || '').replace('/icons/', '');
      const initIconPicker = (root, hiddenInput) => {
        if (!root || !hiddenInput) {
          return { setSelection: () => {} };
        }
        const trigger = root.querySelector('.icon-picker-trigger');
        const label = root.querySelector('.icon-picker-label');
        const preview = root.querySelector('.icon-picker-preview');
        const menu = root.querySelector('.icon-picker-menu');
        const setSelection = (value, labelText) => {
          hiddenInput.value = value || '';
          if (preview) {
            preview.innerHTML = value
              ? '<img src="' + value + '" alt=\"\" />'
              : '';
          }
          if (label) {
            label.textContent = labelText || 'Select icon';
          }
        };
        const close = () => {
          if (!menu || !trigger) return;
          menu.classList.remove('is-open');
          trigger.setAttribute('aria-expanded', 'false');
        };
        if (trigger && menu) {
          trigger.addEventListener('click', () => {
            const isOpen = menu.classList.toggle('is-open');
            trigger.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          });
          menu.addEventListener('click', (event) => {
            const option = event.target.closest('.icon-picker-option');
            if (!option) return;
            const value = String(option.dataset.value || '').trim();
            const labelText = option.textContent.trim();
            setSelection(value, labelText);
            close();
          });
          document.addEventListener('click', (event) => {
            if (event.target.closest('[data-icon-picker]')) return;
            if (event.target.closest('[data-app-icon-picker]')) return;
            close();
          });
          document.addEventListener('keydown', (event) => {
            if (event.key !== 'Escape') return;
            close();
          });
        }
        return { setSelection };
      };

      const initIconUploadForms = () => {
        document.querySelectorAll('.settings-images-form').forEach((form) => {
          const fileInput = form.querySelector('.settings-icon-file');
          const dataInput = form.querySelector('.settings-icon-data');
          const nameInput = form.querySelector('.settings-icon-name');
          if (!fileInput || !dataInput) return;
          fileInput.addEventListener('change', () => {
            dataInput.value = '';
          });
          form.addEventListener('submit', (event) => {
            const file = fileInput.files && fileInput.files[0];
            const iconName = String(nameInput?.value || '').trim().replace(/\.[^/.]+$/, '');
            if (!iconName) {
              event.preventDefault();
              showDebug('Enter an icon name before uploading.');
              return;
            }
            if (!file) {
              event.preventDefault();
              showDebug('Choose an image before uploading.');
              return;
            }
            if (dataInput.value) return;
            event.preventDefault();
            const resolveMime = (name, fallback) => {
              if (fallback) return fallback;
              const ext = String(name || '').toLowerCase().split('.').pop();
              if (ext === 'svg') return 'image/svg+xml';
              if (ext === 'png') return 'image/png';
              if (ext === 'jpg' || ext === 'jpeg') return 'image/jpeg';
              if (ext === 'webp') return 'image/webp';
              return 'application/octet-stream';
            };
            const toBase64 = (buffer) => {
              const bytes = new Uint8Array(buffer);
              let binary = '';
              const chunkSize = 0x8000;
              for (let i = 0; i < bytes.length; i += chunkSize) {
                const chunk = bytes.subarray(i, i + chunkSize);
                binary += String.fromCharCode(...chunk);
              }
              return btoa(binary);
            };
            const submitDataUrl = (buffer) => {
              const mime = resolveMime(file.name, file.type);
              const base64 = toBase64(buffer);
              dataInput.value = `data:${mime};base64,${base64}`;
              form.submit();
            };
            if (typeof file.arrayBuffer === 'function') {
              file.arrayBuffer()
                .then(submitDataUrl)
                .catch(() => {
                  showDebug('Unable to read the selected image.');
                });
              return;
            }
            const reader = new FileReader();
            reader.onload = () => {
              dataInput.value = String(reader.result || '');
              form.submit();
            };
            reader.onerror = () => {
              showDebug('Unable to read the selected image.');
            };
            reader.readAsDataURL(file);
          });
        });
      };

      const setActiveTab = (tabId, persist = true) => {
      if (!tabId) return;
      tabButtons.forEach((btn) => {
        const isActive = btn.dataset.tab === tabId;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      tabPanels.forEach((panel) => {
        panel.classList.toggle('is-active', panel.dataset.tab === tabId);
      });
      if (persist) safeStorage.set('settingsTab', tabId);
    };
    window.setActiveTab = setActiveTab;

    const queryParams = new URLSearchParams(window.location.search);
    const requestedTab = String(queryParams.get('tab') || '').trim();
    const storedTab = safeStorage.get('settingsTab');
    const hasStored = storedTab && tabPanels.some((panel) => panel.dataset.tab === storedTab);
    const initialTab = requestedTab && tabPanels.some((panel) => panel.dataset.tab === requestedTab)
      ? requestedTab
      : (hasStored ? storedTab : 'general');
    setActiveTab(initialTab, false);
    if (queryParams.get('iconError') === '1') {
      showDebug('Icon name is required for uploads.');
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        setActiveTab(btn.dataset.tab);
        if (btn.dataset.tab === 'custom') {
          const storedCustomTab = safeStorage.get('settingsCustomTab');
          const hasStoredCustom = storedCustomTab && customTabPanels.some((panel) => panel.dataset.subtab === storedCustomTab);
          setCustomTab(hasStoredCustom ? storedCustomTab : customTabButtons[0]?.dataset.subtab, false);
        }
      });
    });

    const setCustomTab = (tabId, persist = true) => {
      if (!tabId) return;
      customTabButtons.forEach((btn) => {
        const isActive = btn.dataset.subtab === tabId;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      customTabPanels.forEach((panel) => {
        panel.classList.toggle('is-active', panel.dataset.subtab === tabId);
      });
      if (persist) safeStorage.set('settingsCustomTab', tabId);
    };

    if (customTabButtons.length) {
      const storedCustomTab = safeStorage.get('settingsCustomTab');
      const hasStoredCustom = storedCustomTab && customTabPanels.some((panel) => panel.dataset.subtab === storedCustomTab);
      setCustomTab(hasStoredCustom ? storedCustomTab : customTabButtons[0].dataset.subtab, false);
      customTabButtons.forEach((btn) => {
        btn.addEventListener('click', () => setCustomTab(btn.dataset.subtab));
      });
    }

    const appSettingsButtons = Array.from(document.querySelectorAll('[data-settings-app-button]'));
    const appSettingsPanels = Array.from(document.querySelectorAll('[data-settings-app-panel]'));
    const setAppSettingsPanel = (appId, persist = true) => {
      if (!appId) return;
      appSettingsButtons.forEach((button) => {
        const isActive = button.dataset.appId === appId;
        button.classList.toggle('is-active', isActive);
      });
      appSettingsPanels.forEach((panel) => {
        panel.classList.toggle('is-active', panel.dataset.appId === appId);
      });
      if (persist) safeStorage.set('settingsAppPanel', appId);
    };
    if (appSettingsButtons.length && appSettingsPanels.length) {
      const hasAppPanel = (appId) => appSettingsPanels.some((panel) => panel.dataset.appId === appId);
      const requestedAppPanel = String(queryParams.get('app') || '').trim();
      const storedAppPanel = String(safeStorage.get('settingsAppPanel') || '').trim();
      const initialAppPanel = hasAppPanel(requestedAppPanel)
        ? requestedAppPanel
        : (hasAppPanel(storedAppPanel) ? storedAppPanel : appSettingsButtons[0].dataset.appId);
      setAppSettingsPanel(initialAppPanel, false);
      appSettingsButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const appId = String(button.dataset.appId || '').trim();
          if (!appId) return;
          setAppSettingsPanel(appId);
        });
      });
    }

    const themePresetButtons = Array.from(document.querySelectorAll('.theme-preset-card'));
    const customThemeColorInput = document.getElementById('customThemeColor');
    const customThemeChip = document.querySelector('[data-custom-chip]');
    const allowedBrandThemes = new Set(['custom', 'launcharr', 'rocketship', 'pulsarr', 'plex', 'radarr', 'sonarr', 'lidarr', 'readarr']);
    const customColorStorageKey = 'launcharr-custom-color';
    const parseHexColor = (value) => {
      const raw = String(value || '').trim();
      const normalized = raw.startsWith('#') ? raw : `#${raw}`;
      return /^#[0-9a-fA-F]{6}$/.test(normalized) ? normalized.toLowerCase() : '#1cc6c2';
    };
    const hexToRgb = (hex) => ({
      r: Number.parseInt(hex.slice(1, 3), 16),
      g: Number.parseInt(hex.slice(3, 5), 16),
      b: Number.parseInt(hex.slice(5, 7), 16),
    });
    const rgbToHex = (r, g, b) => `#${[r, g, b].map((value) => Math.max(0, Math.min(255, Math.round(value))).toString(16).padStart(2, '0')).join('')}`;
    const mixRgb = (base, target, amount) => ({
      r: base.r + (target.r - base.r) * amount,
      g: base.g + (target.g - base.g) * amount,
      b: base.b + (target.b - base.b) * amount,
    });
    const clearCustomThemeVars = () => {
      const rootStyle = document.documentElement.style;
      ['--teal', '--teal-dark', '--brand-rgb', '--brand-btn-start', '--brand-btn-mid', '--brand-btn-end', '--brand-btn-shadow', '--on-brand', '--on-brand-muted', '--on-brand-icon-filter'].forEach((name) => {
        rootStyle.removeProperty(name);
      });
    };
    const applyCustomColor = (inputHex) => {
      const hex = parseHexColor(inputHex);
      const base = hexToRgb(hex);
      const dark = mixRgb(base, { r: 0, g: 0, b: 0 }, 0.4);
      const start = mixRgb(base, { r: 255, g: 255, b: 255 }, 0.35);
      const end = mixRgb(base, { r: 0, g: 0, b: 0 }, 0.2);
      const shadow = mixRgb(base, { r: 0, g: 0, b: 0 }, 0.28);
      const toLinear = (channel) => {
        const value = channel / 255;
        return value <= 0.03928 ? value / 12.92 : Math.pow((value + 0.055) / 1.055, 2.4);
      };
      const luminance = 0.2126 * toLinear(base.r) + 0.7152 * toLinear(base.g) + 0.0722 * toLinear(base.b);
      const contrastWhite = 1.05 / (luminance + 0.05);
      const contrastBlack = (luminance + 0.05) / 0.05;
      const onBrand = contrastWhite >= contrastBlack ? '#ffffff' : '#081013';
      const onBrandMuted = contrastWhite >= contrastBlack ? 'rgba(255,255,255,.78)' : 'rgba(8,16,19,.72)';
      const onBrandIconFilter = contrastWhite >= contrastBlack ? 'brightness(0) saturate(100%) invert(1)' : 'brightness(0) saturate(100%)';
      const rootStyle = document.documentElement.style;
      rootStyle.setProperty('--teal', hex);
      rootStyle.setProperty('--teal-dark', rgbToHex(dark.r, dark.g, dark.b));
      rootStyle.setProperty('--brand-rgb', `${Math.round(base.r)},${Math.round(base.g)},${Math.round(base.b)}`);
      rootStyle.setProperty('--brand-btn-start', rgbToHex(start.r, start.g, start.b));
      rootStyle.setProperty('--brand-btn-mid', hex);
      rootStyle.setProperty('--brand-btn-end', rgbToHex(end.r, end.g, end.b));
      rootStyle.setProperty('--brand-btn-shadow', `${Math.round(shadow.r)},${Math.round(shadow.g)},${Math.round(shadow.b)}`);
      rootStyle.setProperty('--on-brand', onBrand);
      rootStyle.setProperty('--on-brand-muted', onBrandMuted);
      rootStyle.setProperty('--on-brand-icon-filter', onBrandIconFilter);
      if (customThemeChip) customThemeChip.style.setProperty('--theme-color', hex);
      return hex;
    };
    const applyBrandTheme = (theme) => {
      const normalized = allowedBrandThemes.has(theme) ? theme : 'pulsarr';
      document.documentElement.dataset.brandTheme = normalized;
      safeStorage.set('launcharr-brand-theme', normalized);
      if (normalized === 'custom') {
        const savedCustomHex = parseHexColor(safeStorage.get(customColorStorageKey));
        const appliedHex = applyCustomColor(savedCustomHex);
        if (customThemeColorInput) customThemeColorInput.value = appliedHex;
      } else {
        clearCustomThemeVars();
      }
      themePresetButtons.forEach((btn) => {
        const isActive = btn.dataset.brandTheme === normalized;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    };
    if (themePresetButtons.length) {
      const initialCustomHex = parseHexColor(safeStorage.get(customColorStorageKey));
      if (customThemeColorInput) customThemeColorInput.value = initialCustomHex;
      if (customThemeChip) customThemeChip.style.setProperty('--theme-color', initialCustomHex);
      const storedBrandTheme = safeStorage.get('launcharr-brand-theme');
      applyBrandTheme(allowedBrandThemes.has(storedBrandTheme) ? storedBrandTheme : 'pulsarr');
      themePresetButtons.forEach((btn) => {
        btn.addEventListener('click', () => applyBrandTheme(btn.dataset.brandTheme));
      });
      customThemeColorInput?.addEventListener('input', () => {
        const hex = parseHexColor(customThemeColorInput.value);
        safeStorage.set(customColorStorageKey, hex);
        applyBrandTheme('custom');
      });
    }

    initIconUploadForms();

    document.querySelectorAll('.settings-icon-delete').forEach((form) => {
      form.addEventListener('submit', (event) => {
        if (!window.confirm('Delete this custom icon?')) {
          event.preventDefault();
        }
      });
    });

    function setToggleIcon() {
      if (!toggleIcon) return;
      toggleIcon.src = '/icons/sidebar-toggle.svg';
    }

    function applySidebarState() {
      if (!dashFrame) return;
      if (isMobile()) {
        dashFrame.classList.remove('sidebar-collapsed');
        dashFrame.classList.remove('mobile-nav-open');
        document.body.classList.remove('mobile-nav-open');
        setToggleIcon(false);
      } else {
        const collapsed = safeStorage.get('sidebarCollapsed') === 'true';
        dashFrame.classList.toggle('sidebar-collapsed', collapsed);
        dashFrame.classList.remove('mobile-nav-open');
        document.body.classList.remove('mobile-nav-open');
        setToggleIcon(!collapsed);
      }
    }

    function closeMobileNav() {
      if (!dashFrame || !isMobile()) return;
      if (!dashFrame.classList.contains('mobile-nav-open')) return;
      dashFrame.classList.remove('mobile-nav-open');
      document.body.classList.remove('mobile-nav-open');
      setToggleIcon(false);
    }

    applySidebarState();
    mobileQuery.addEventListener('change', applySidebarState);
    const accordion = document.querySelectorAll('.nav-accordion-item');
    accordion.forEach((item) => {
      const trigger = item.querySelector('.nav-accordion-trigger');
      if (!trigger) return;
      trigger.addEventListener('click', (event) => {
        event.stopPropagation();
        const parentAccordion = item.closest('.nav-accordion');
        const siblings = parentAccordion
          ? Array.from(parentAccordion.children).filter((child) => child.classList.contains('nav-accordion-item'))
          : [];
        siblings.forEach((other) => {
          if (other !== item) other.classList.remove('open');
        });
        item.classList.toggle('open');
      });
    });
    function handleSidebarToggle() {
      if (!dashFrame) return;
      if (isMobile()) {
        dashFrame.classList.remove('sidebar-collapsed');
        const isOpen = dashFrame.classList.toggle('mobile-nav-open');
        document.body.classList.toggle('mobile-nav-open', isOpen);
        setToggleIcon(isOpen);
        return;
      }
      const isCollapsed = dashFrame.classList.toggle('sidebar-collapsed');
      safeStorage.set('sidebarCollapsed', isCollapsed ? 'true' : 'false');
      setToggleIcon(!isCollapsed);
    }

    toggle?.addEventListener('click', handleSidebarToggle);

    mainContent?.addEventListener('click', (event) => {
      if (event.target.closest('.sidebar-toggle')) return;
      if (event.target.closest('.main-window-bar')) return;
      closeMobileNav();
    });

    sidebar?.addEventListener('click', (event) => {
      if (!isMobile() || !dashFrame?.classList.contains('mobile-nav-open')) return;
      const link = event.target.closest('a');
      if (!link || !link.classList.contains('active')) return;
      event.preventDefault();
      closeMobileNav();
    });

    const userMenus = document.querySelectorAll('[data-user-menu]');

    function closeUserMenus(except) {
      userMenus.forEach((menu) => {
        if (menu === except) return;
        menu.classList.remove('user-pill--open');
        menu.setAttribute('aria-expanded', 'false');
      });
    }

    userMenus.forEach((menu) => {
      menu.setAttribute('aria-expanded', 'false');
      menu.addEventListener('click', (event) => {
        if (event.target.closest('.user-menu')) return;
        event.preventDefault();
        const isOpen = menu.classList.contains('user-pill--open');
        closeUserMenus(menu);
        menu.classList.toggle('user-pill--open', !isOpen);
        menu.setAttribute('aria-expanded', !isOpen ? 'true' : 'false');
      });
      menu.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        event.preventDefault();
        menu.click();
      });
    });

    document.addEventListener('click', (event) => {
      if (event.target.closest('[data-user-menu]')) return;
      closeUserMenus();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      closeUserMenus();
    });
  </script>
  <script>
    try {
      const settingsLogList = document.getElementById('settingsLogList');
      const settingsLogStatus = document.getElementById('settingsLogStatus');
      const settingsLogRefresh = document.getElementById('settingsLogRefresh');
      const settingsLogApp = document.getElementById('settingsLogApp');
      const settingsLogLevel = document.getElementById('settingsLogLevel');
      const logAppNames = <%- safeJson((apps || []).reduce((acc, app) => {
        acc[String(app.id || '').toLowerCase()] = app.name || app.id;
        return acc;
      }, {})) %>;
      let settingsLogs = [];

    const escapeLogHtml = (value) => String(value || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');

    const formatLogTime = (value) => {
      const date = value ? new Date(value) : null;
      if (!date || Number.isNaN(date.getTime())) return '';
      return date.toLocaleString();
    };

    const renderSettingsLogs = () => {
      if (!settingsLogList) return;
      const appFilter = String(settingsLogApp?.value || '').trim().toLowerCase();
      const levelFilter = String(settingsLogLevel?.value || '').trim().toLowerCase();
      const filtered = settingsLogs.filter((entry) => {
        if (appFilter && String(entry.app || '').toLowerCase() !== appFilter) return false;
        if (levelFilter && String(entry.level || '').toLowerCase() !== levelFilter) return false;
        return true;
      });
      if (!filtered.length) {
        settingsLogList.innerHTML = '<div class="log-empty">No logs yet.</div>';
        return;
      }
      settingsLogList.innerHTML = filtered
        .map((entry) => {
          const appId = String(entry.app || 'system').toLowerCase();
          const appName = logAppNames[appId] || (appId === 'system' ? 'System' : appId);
          const level = String(entry.level || 'info').toLowerCase();
          const action = String(entry.action || 'event');
          const message = String(entry.message || '');
          const time = formatLogTime(entry.ts);
          return `
            <div class="log-row log-row--${escapeLogHtml(level)}" data-app="${escapeLogHtml(appId)}">
              <div class="log-time">${escapeLogHtml(time)}</div>
              <div class="log-message">
                <div class="log-title">
                  <span class="log-app-pill" data-app="${escapeLogHtml(appId)}">${escapeLogHtml(appName)}</span>
                  ${escapeLogHtml(action)}
                </div>
                <div class="log-text">${escapeLogHtml(message)}</div>
              </div>
            </div>
          `;
        })
        .join('');
    };

    const loadSettingsLogs = async () => {
      if (!settingsLogList || !settingsLogStatus) return;
      settingsLogStatus.textContent = 'Loading...';
      try {
        const response = await fetch('/api/logs?limit=250');
        const payload = response.ok ? await response.json() : { items: [] };
        settingsLogs = Array.isArray(payload.items) ? payload.items : [];
        renderSettingsLogs();
        settingsLogStatus.textContent = new Date().toLocaleTimeString();
      } catch (err) {
        settingsLogStatus.textContent = 'Failed to load logs';
      }
    };

    settingsLogRefresh?.addEventListener('click', loadSettingsLogs);
    settingsLogApp?.addEventListener('change', renderSettingsLogs);
    settingsLogLevel?.addEventListener('change', renderSettingsLogs);
    loadSettingsLogs();
    } catch (err) {
      console.error('[Launcharr] Settings logs init failed', err);
    }

    try {
      const fetchBtn = document.getElementById('fetchPlexUsersBtn');
      const saveBtn = document.getElementById('savePlexRolesBtn');
      const usersBody = document.getElementById('plexUsersBody');
      const note = document.getElementById('plexUsersNote');

      try {
        const customAppForm = document.getElementById('customAppForm');
        const customAppName = document.getElementById('customAppName');
        const customAppCategory = document.getElementById('customAppCategory');
        const customAppIconSelect = document.getElementById('customAppIconSelect');
        const appIconPicker = customAppForm?.querySelector('[data-app-icon-picker]');
        const customAppNote = document.getElementById('customAppNote');
        const displayAppsTable = document.getElementById('displayAppsTable');
        const customAppSubmit = document.getElementById('customAppSubmit');
        const customAppCancel = document.getElementById('customAppCancel');
        let customAppIconPath = '';
        let customAppEditId = '';
        const appsSettingsForm = document.querySelector('.settings-subtab-panel[data-subtab="apps"] form');

        const setCustomAppNote = (text, error = false) => {
          if (!customAppNote) return;
          customAppNote.textContent = text;
          customAppNote.classList.toggle('settings-users-note--error', Boolean(error));
        };

        const appIconPickerApi = initIconPicker(appIconPicker, customAppIconSelect);

        customAppSubmit?.addEventListener('click', async () => {
          const name = String(customAppName?.value || '').trim();
          const category = String(customAppCategory?.value || '').trim();
          customAppIconPath = String(customAppIconSelect?.value || '').trim();
          if (!name) {
            setCustomAppNote('Custom app name is required.', true);
            return;
          }
          setCustomAppNote('Saving custom app...');
          try {
            const endpoint = customAppEditId ? '/settings/custom-apps/update' : '/settings/custom-apps';
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: customAppEditId, name, category, iconPath: customAppIconPath }),
            });
            const payload = await response.json();
            if (!response.ok) throw new Error(payload?.error || 'Failed to add custom app.');
            setCustomAppNote('Custom app added.');
            window.location.reload();
          } catch (err) {
            setCustomAppNote(err?.message || 'Failed to add custom app.', true);
          }
        });

        appsSettingsForm?.addEventListener('submit', () => {
          safeStorage.set('settingsTab', 'custom');
          safeStorage.set('settingsCustomTab', 'apps');
        });

        const handleCustomAppActions = async (event) => {
          const editBtn = event.target.closest('.custom-app-edit');
          if (editBtn) {
            event.preventDefault();
            event.stopPropagation();
            customAppEditId = String(editBtn.dataset.appId || '').trim().replace(/^"+|"+$/g, '');
            customAppName.value = String(editBtn.dataset.appName || '');
            if (customAppCategory) customAppCategory.value = String(editBtn.dataset.appCategory || 'Tools');
            customAppIconPath = '';
            if (customAppIconSelect) {
              const iconValue = String(editBtn.dataset.appIcon || '').trim();
              appIconPickerApi.setSelection(iconValue, formatIconLabel(iconValue));
              customAppIconPath = iconValue;
            }
            if (customAppSubmit) customAppSubmit.textContent = 'Save changes';
            if (customAppCancel) customAppCancel.style.display = 'inline-flex';
            setCustomAppNote('Editing custom app. Select a new icon to replace the current one.');
            setActiveTab('custom');
            setCustomTab('apps', false);
            customAppName?.focus();
            return;
          }
          const button = event.target.closest('.custom-app-delete');
          if (!button) return;
          event.preventDefault();
          event.stopPropagation();
          const appId = String(button.dataset.appId || '').trim().replace(/^"+|"+$/g, '');
          if (!appId) return;
          if (!window.confirm('Delete this custom app?')) return;
          setCustomAppNote('Deleting custom app...');
          try {
            const response = await fetch('/settings/custom-apps/delete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: appId }),
            });
            const payload = await response.json().catch(() => ({}));
            if (!response.ok) {
              throw new Error(payload?.error || `Failed to delete custom app (${response.status}).`);
            }
            window.location.reload();
          } catch (err) {
            setCustomAppNote(err?.message || 'Failed to delete custom app.', true);
          }
        };

        displayAppsTable?.addEventListener('click', handleCustomAppActions);
        document.addEventListener('click', handleCustomAppActions);

        customAppCancel?.addEventListener('click', () => {
          customAppEditId = '';
          if (customAppName) customAppName.value = '';
          if (customAppCategory) customAppCategory.value = customAppCategory.options[0]?.value || 'Tools';
          appIconPickerApi.setSelection('', '');
          customAppIconPath = '';
          if (customAppSubmit) customAppSubmit.textContent = 'Add custom app';
          if (customAppCancel) customAppCancel.style.display = 'none';
          setCustomAppNote('Overview is disabled for custom apps.');
        });
      } catch (err) {
        console.error('[Launcharr] Custom app init failed', err);
      }

      try {
        const settingsTable = document.querySelector('.settings-subtab-panel[data-subtab="apps"] .settings-table--display');
        if (settingsTable) {
          let draggedSettingsRow = null;
          settingsTable.querySelectorAll('.settings-category option, .settings-launch-mode option').forEach((option) => {
            const full = option.dataset.full || option.textContent;
            option.textContent = full;
          });

          const dataRows = () => Array.from(settingsTable.querySelectorAll('.settings-row')).filter((row) => !row.classList.contains('settings-head'));
          const getCategory = (row) => row.querySelector('.settings-category')?.value || 'Tools';
          const updateCategoryOrders = (category) => {
            const rows = dataRows().filter((row) => getCategory(row) === category);
            rows.forEach((row, index) => {
              const input = row.querySelector('.settings-order-input');
              if (input) input.value = index + 1;
              const rank = row.querySelector('.settings-order-rank');
              if (rank) rank.textContent = String(index + 1);
            });
          };

          dataRows().forEach((row) => {
            row.dataset.category = getCategory(row);
          });

          Array.from(new Set(dataRows().map((row) => getCategory(row)))).forEach(updateCategoryOrders);

          const attachSettingsRowDragEvents = (row) => {
            row.addEventListener('dragstart', (event) => {
              if (event.dataTransfer) {
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('text/plain', String(row.dataset.category || ''));
              }
              draggedSettingsRow = row;
              row.classList.add('settings-row--dragging');
            });
            row.addEventListener('dragend', () => {
              const category = getCategory(row);
              row.classList.remove('settings-row--dragging');
              draggedSettingsRow = null;
              updateCategoryOrders(category);
            });
            row.addEventListener('dragover', (event) => {
              event.preventDefault();
              if (!draggedSettingsRow || draggedSettingsRow === row) return;
              if (getCategory(draggedSettingsRow) !== getCategory(row)) return;
              const bounds = row.getBoundingClientRect();
              const insertBefore = (event.clientY - bounds.top) < (bounds.height / 2);
              const parent = row.parentElement;
              if (!parent) return;
              parent.insertBefore(draggedSettingsRow, insertBefore ? row : row.nextSibling);
            });
          };

          dataRows().forEach(attachSettingsRowDragEvents);

          settingsTable.addEventListener('change', (event) => {
            const select = event.target.closest('.settings-category');
            if (!select) return;
            const row = select.closest('.settings-row');
            if (!row) return;
            const previousCategory = row.dataset.category || select.value;
            row.dataset.category = select.value;
            updateCategoryOrders(previousCategory);
            updateCategoryOrders(select.value);
          });
        }
      } catch (err) {
        console.error('[Launcharr] Display settings init failed', err);
      }

      try {
        const dashboardTable = document.querySelector('.settings-subtab-panel[data-subtab="dashboard"] .settings-table--elements');
        if (dashboardTable) {
          let draggedElementRow = null;
          const updateRowState = (row) => {
            if (!row) return;
            const enableToggle = row.querySelector('input[name$="_enable"]');
            const dashboardToggle = row.querySelector('input[name$="_dashboard"]');
            const isEnabled = enableToggle ? enableToggle.checked : true;
            const isOnDashboard = dashboardToggle ? dashboardToggle.checked : true;
            row.classList.toggle('is-disabled', !isEnabled);
            row.classList.toggle('is-muted', isEnabled && !isOnDashboard);
          };
          const initDragOrderTable = (table) => {
            if (!table) return;
            let draggedRow = null;
            const dataRows = () => Array.from(table.querySelectorAll('.settings-row')).filter((row) => !row.classList.contains('settings-head'));
            const updateOrders = () => {
              dataRows().forEach((row, index) => {
                const input = row.querySelector('.settings-order-input');
                if (input) input.value = index + 1;
              });
            };

            dataRows().forEach((row) => {
              row.setAttribute('draggable', 'true');
              row.addEventListener('dragstart', (event) => {
                if (event.dataTransfer) {
                  event.dataTransfer.effectAllowed = 'move';
                }
                draggedRow = row;
                row.classList.add('settings-row--dragging');
              });
              row.addEventListener('dragend', () => {
                row.classList.remove('settings-row--dragging');
                draggedRow = null;
                updateOrders();
              });
              row.addEventListener('dragover', (event) => {
                event.preventDefault();
                if (!draggedRow || draggedRow === row) return;
                const bounds = row.getBoundingClientRect();
                const insertBefore = (event.clientY - bounds.top) < (bounds.height / 2);
                const parent = row.parentElement;
                if (!parent) return;
                parent.insertBefore(draggedRow, insertBefore ? row : row.nextSibling);
              });
            });
          };

          const getRowPanel = (row) => {
            const toggle = row?.querySelector('.settings-expand-toggle');
            const targetId = toggle?.dataset?.target;
            if (!targetId) return null;
            const panel = document.getElementById(targetId);
            if (panel && panel.classList.contains('settings-collapsible')) {
              return panel;
            }
            return null;
          };
          const getRowBlock = (row) => {
            const panel = getRowPanel(row);
            if (panel) {
              return [row, panel];
            }
            return [row];
          };

          const dataRows = () => Array.from(dashboardTable.children)
            .filter((node) => node.classList && node.classList.contains('settings-row--draggable'));
          const getRowOrder = (row) => {
            const input = row?.querySelector('.settings-order-input');
            const value = Number(input?.value);
            return Number.isFinite(value) ? value : 0;
          };
          const updateOrders = () => {
            const rows = dataRows();
            rows.forEach((row, index) => {
              const input = row.querySelector('.settings-order-input');
              if (input) input.value = index + 1;
            });
          };

          dataRows().forEach((row) => {
            updateRowState(row);
            row.addEventListener('dragstart', (event) => {
              if (event.dataTransfer) {
                event.dataTransfer.effectAllowed = 'move';
              }
              draggedElementRow = row;
              row.classList.add('settings-row--dragging');
            });
            row.addEventListener('dragend', () => {
              row.classList.remove('settings-row--dragging');
              draggedElementRow = null;
              updateOrders();
            });
            row.addEventListener('dragover', (event) => {
              event.preventDefault();
              if (!draggedElementRow || draggedElementRow === row) return;
              const bounds = row.getBoundingClientRect();
              const insertBefore = (event.clientY - bounds.top) < (bounds.height / 2);
              const parent = row.parentElement;
              if (!parent) return;
              const draggedBlock = getRowBlock(draggedElementRow);
              draggedBlock.forEach((el) => el.remove());
              if (insertBefore) {
                parent.insertBefore(draggedBlock[0], row);
                if (draggedBlock[1]) parent.insertBefore(draggedBlock[1], row);
              } else {
                const targetBlock = getRowBlock(row);
                const afterNode = targetBlock[targetBlock.length - 1].nextSibling;
                parent.insertBefore(draggedBlock[0], afterNode);
                if (draggedBlock[1]) parent.insertBefore(draggedBlock[1], afterNode);
              }
            });
          });

          dashboardTable.querySelectorAll('.settings-table--tautulli-cards').forEach((table) => {
            initDragOrderTable(table);
          });

          dashboardTable.addEventListener('change', (event) => {
            const target = event.target;
            if (!(target instanceof HTMLInputElement)) return;
            if (target.type !== 'checkbox') return;
            const row = target.closest('.settings-row--draggable');
            if (!row) return;
            updateRowState(row);
          });

          dashboardTable.addEventListener('click', (event) => {
            const toggle = event.target.closest('.settings-expand-toggle');
            if (!toggle) return;
            const targetId = toggle.dataset.target;
            if (!targetId) return;
            const panel = document.getElementById(targetId);
            if (!panel) return;
            const isCollapsed = panel.classList.toggle('is-collapsed');
            toggle.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
          });
        }
      } catch (err) {
        console.error('[Launcharr] Dashboard settings init failed', err);
      }

      try {
        const appsTable = document.getElementById('displayAppsTable');
        if (appsTable) {
          const sortRows = () => {
            const rows = Array.from(appsTable.querySelectorAll('.settings-row--display.settings-row--draggable'));
            rows.sort((a, b) => {
              const aFav = Boolean(a.querySelector('.settings-favourite-input')?.checked);
              const bFav = Boolean(b.querySelector('.settings-favourite-input')?.checked);
              const favouriteDelta = (bFav ? 1 : 0) - (aFav ? 1 : 0);
              if (favouriteDelta !== 0) return favouriteDelta;
              const aCategoryRank = Number(a.dataset.categoryRank || 0);
              const bCategoryRank = Number(b.dataset.categoryRank || 0);
              const categoryDelta = aCategoryRank - bCategoryRank;
              if (categoryDelta !== 0) return categoryDelta;
              const aOrder = Number(a.querySelector('.settings-order-input')?.value || 0);
              const bOrder = Number(b.querySelector('.settings-order-input')?.value || 0);
              const orderDelta = aOrder - bOrder;
              if (orderDelta !== 0) return orderDelta;
              const aName = a.querySelector('.settings-app-name')?.textContent || '';
              const bName = b.querySelector('.settings-app-name')?.textContent || '';
              return aName.localeCompare(bName);
            });
            const headRow = appsTable.querySelector('.settings-head');
            rows.forEach((row) => appsTable.appendChild(row));
            if (headRow) {
              appsTable.prepend(headRow);
            }
          };

          appsTable.addEventListener('click', (event) => {
            const favToggle = event.target.closest('.settings-favourite-toggle');
            if (!favToggle) return;
            const row = favToggle.closest('.settings-row--display');
            if (!row) return;
            const input = row.querySelector('.settings-favourite-input');
            if (!input) return;
            input.checked = !input.checked;
            favToggle.classList.toggle('is-active', input.checked);
            favToggle.setAttribute('aria-pressed', input.checked ? 'true' : 'false');
            const icon = favToggle.querySelector('.settings-favourite-icon');
            if (icon) {
              icon.src = input.checked ? '/icons/favourite-solid.svg' : '/icons/favourite.svg';
            }
            sortRows();
          });
          appsTable.addEventListener('change', (event) => {
            const select = event.target.closest('.settings-category');
            if (!select) return;
            const row = select.closest('.settings-row--display');
            if (!row) return;
            row.dataset.category = select.value;
            row.dataset.categoryRank = String(select.selectedIndex);
            sortRows();
          });
        }
      } catch (err) {
        console.error('[Launcharr] App settings init failed', err);
      }

      try {
        const categoryManagerForm = document.getElementById('categoryManagerForm');
        if (categoryManagerForm) {
          const categoryRows = document.getElementById('categoryRows');
          const categoryInput = document.getElementById('categoryManagerInput');
          const categoryAddBtn = document.getElementById('categoryManagerAddBtn');
          const categoryIconSelect = document.getElementById('categoryManagerIconSelect');
          const iconPicker = categoryManagerForm.querySelector('[data-icon-picker]');
          const categoryJsonInput = document.getElementById('categoryManagerJson');
          const categoryNote = document.getElementById('categoryManagerNote');
          let draggedCategoryRow = null;
          let editingCategoryRow = null;

      const setCategoryNote = (text, error = false) => {
        if (!categoryNote) return;
        categoryNote.textContent = text;
        categoryNote.classList.toggle('settings-users-note--error', Boolean(error));
      };

      const getCategoryRows = () => Array.from(categoryRows?.querySelectorAll('.category-row') || []);
      const escapeHtml = (value) => String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
      const normalizeCategory = (value) => String(value || '').trim().toLowerCase();
      let categoryFormSubmitting = false;

      const syncCategoryPayload = () => {
        if (!categoryJsonInput) return;
        const categories = getCategoryRows()
          .map((row) => ({
            name: String(row.dataset.category || '').trim(),
            sidebarMenu: row.dataset.sidebarMenu === 'true',
            icon: String(row.dataset.icon || '').trim(),
          }))
          .filter((entry) => entry.name);
        categoryJsonInput.value = JSON.stringify(categories);
      };

      const refreshCategoryRows = () => {
        const rows = getCategoryRows();
        const disableDelete = rows.length <= 1;
        rows.forEach((row) => {
          const deleteButton = row.querySelector('.category-delete-button');
          if (deleteButton) deleteButton.disabled = disableDelete;
        });
        syncCategoryPayload();
      };

      const submitCategoryChanges = () => {
        if (categoryFormSubmitting) return;
        categoryFormSubmitting = true;
        syncCategoryPayload();
        categoryManagerForm.requestSubmit();
      };

      const categoryPicker = initIconPicker(iconPicker, categoryIconSelect);
      const setIconSelection = categoryPicker.setSelection;

      const attachCategoryRowEvents = (row) => {
        const iconPreview = row.querySelector('.category-icon-preview');
        const sidebarToggle = row.querySelector('.category-sidebar-toggle');
        if (sidebarToggle) {
          sidebarToggle.addEventListener('change', () => {
            row.dataset.sidebarMenu = sidebarToggle.checked ? 'true' : 'false';
            syncCategoryPayload();
          });
        }
        row.addEventListener('dragstart', (event) => {
          if (event.dataTransfer) {
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', String(row.dataset.category || ''));
          }
          draggedCategoryRow = row;
          row.classList.add('category-row--dragging');
        });
        row.addEventListener('dragend', () => {
          row.classList.remove('category-row--dragging');
          draggedCategoryRow = null;
          refreshCategoryRows();
        });
        row.addEventListener('dragover', (event) => {
          event.preventDefault();
          if (!draggedCategoryRow || draggedCategoryRow === row || !categoryRows) return;
          const bounds = row.getBoundingClientRect();
          const insertBefore = (event.clientY - bounds.top) < (bounds.height / 2);
          categoryRows.insertBefore(draggedCategoryRow, insertBefore ? row : row.nextSibling);
        });
      };

      getCategoryRows().forEach(attachCategoryRowEvents);

      categoryRows?.addEventListener('click', (event) => {
        const editButton = event.target.closest('.category-edit-button');
        if (editButton) {
          const row = editButton.closest('.category-row');
          if (!row) return;
          const label = String(row.dataset.category || '').trim();
          const iconValue = String(row.dataset.icon || '/icons/category.svg').trim() || '/icons/category.svg';
          editingCategoryRow = row;
          if (categoryInput) categoryInput.value = label;
          setIconSelection(iconValue, formatIconLabel(iconValue));
          if (categoryAddBtn) categoryAddBtn.textContent = 'Save changes';
          setCategoryNote('Editing category. Update the fields and save changes.');
          categoryInput?.focus();
          return;
        }
        const deleteButton = event.target.closest('.category-delete-button');
        if (!deleteButton) return;
        const row = deleteButton.closest('.category-row');
        if (!row) return;
        if (deleteButton.disabled) return;
        const isDefault = row.dataset.default === 'true';
        if (isDefault) {
          setCategoryNote('Default categories cannot be deleted.', true);
          return;
        }
        const label = String(row.dataset.category || '').trim() || 'this category';
        if (!window.confirm('Delete "' + label + '"?')) return;
        row.remove();
        setCategoryNote('Category removed. Applying changes...');
        refreshCategoryRows();
        submitCategoryChanges();
      });

      categoryAddBtn?.addEventListener('click', () => {
        const label = String(categoryInput?.value || '').trim();
        if (!label) {
          setCategoryNote('Enter a category name before adding.', true);
          return;
        }
        const isDuplicate = getCategoryRows().some((row) => {
          if (editingCategoryRow && row === editingCategoryRow) return false;
          return normalizeCategory(row.dataset.category) === normalizeCategory(label);
        });
        if (isDuplicate) {
          setCategoryNote('That category already exists.', true);
          return;
        }
        const selectedIcon = String(categoryIconSelect?.value || '').trim() || '/icons/category.svg';

        if (editingCategoryRow) {
          editingCategoryRow.dataset.category = label;
          editingCategoryRow.dataset.icon = selectedIcon;
          const nameEl = editingCategoryRow.querySelector('.settings-app-name--category');
          if (nameEl) nameEl.textContent = label;
          const iconPreview = editingCategoryRow.querySelector('.category-icon-preview');
          if (iconPreview) iconPreview.src = selectedIcon;
          const displayImg = editingCategoryRow.querySelector('.category-icon-display-img');
          if (displayImg) displayImg.src = selectedIcon;
          const displayText = editingCategoryRow.querySelector('.category-icon-display-text');
          if (displayText) displayText.textContent = formatIconLabel(selectedIcon);
          editingCategoryRow = null;
          if (categoryAddBtn) categoryAddBtn.textContent = 'Add category';
          if (categoryInput) categoryInput.value = '';
          setIconSelection('', '');
          setCategoryNote('Category updated. Applying changes...');
          refreshCategoryRows();
          submitCategoryChanges();
          return;
        }

        if (!window.confirm('Add "' + label + '" as a new category?')) return;
        const row = document.createElement('div');
        row.className = 'settings-row settings-row--categories category-row';
        row.draggable = true;
        row.dataset.category = label;
        row.dataset.sidebarMenu = 'false';
        row.dataset.icon = selectedIcon;
        row.innerHTML =
          '<div class="settings-app settings-app--category">' +
            '<button class="order-button category-drag-handle" type="button" title="Drag to reorder" aria-label="Drag to reorder">&#x2630;</button>' +
            '<img class="nav-icon category-icon-preview" src="' + escapeHtml(selectedIcon) + '" alt="" />' +
            '<span class="settings-app-name settings-app-name--category">' + escapeHtml(label) + '</span>' +
          '</div>' +
          '<div class="settings-cell">' +
            '<div class="category-icon-display" aria-label="Category icon in use">' +
              '<img class="category-icon-display-img" src="' + escapeHtml(selectedIcon) + '" alt="" />' +
              '<span class="category-icon-display-text">' + escapeHtml(formatIconLabel(selectedIcon)) + '</span>' +
            '</div>' +
          '</div>' +
          '<div class="settings-cell">' +
            '<input class="category-sidebar-toggle" type="checkbox" title="Group apps under this category in the sidebar" aria-label="Group apps in sidebar" />' +
          '</div>' +
          '<div class="settings-cell">' +
            '<button class="order-button category-edit-button" type="button" title="Edit category" aria-label="Edit category">Edit</button>' +
          '</div>' +
          '<div class="settings-cell">' +
            '<button class="order-button category-delete-button" type="button" title="Delete category" aria-label="Delete category">&times;</button>' +
          '</div>';
        categoryRows?.appendChild(row);
        attachCategoryRowEvents(row);
        if (categoryInput) categoryInput.value = '';
        setIconSelection('', '');
        setCategoryNote('Category added. Applying changes...');
        refreshCategoryRows();
        submitCategoryChanges();
      });

      categoryInput?.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter') return;
        event.preventDefault();
        categoryAddBtn?.click();
      });

      categoryManagerForm.addEventListener('submit', () => {
        syncCategoryPayload();
      });

          refreshCategoryRows();
        }
      } catch (err) {
        console.error('[Launcharr] Category manager init failed', err);
      }

    function roleOptions(selected) {
      return [
        { value: 'user', label: 'User' },
        { value: 'co-admin', label: 'Co-admin' },
        { value: 'admin', label: 'Admin' },
      ]
        .map((opt) => '<option value="' + opt.value + '"' + (opt.value === selected ? ' selected' : '') + '>' + opt.label + '</option>')
        .join('');
    }

    function formatLoginTimestamp(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      try {
        return date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
      } catch (err) {
        return date.toLocaleString();
      }
    }

    const userSort = { key: 'name', dir: 'asc' };
    const sortHeaders = Array.from(document.querySelectorAll('.settings-users-head-cell[data-sort-key]'));
    const updateUserSortIndicators = () => {
      sortHeaders.forEach((header) => {
        const key = header.dataset.sortKey;
        const isActive = key === userSort.key;
        if (isActive) {
          header.dataset.sortDir = userSort.dir;
          header.setAttribute('aria-sort', userSort.dir === 'asc' ? 'ascending' : 'descending');
        } else {
          header.dataset.sortDir = '';
          header.setAttribute('aria-sort', 'none');
        }
      });
    };

    const sortUserRows = () => {
      if (!usersBody) return;
      const rows = Array.from(usersBody.querySelectorAll('.settings-users-row'));
      const key = userSort.key;
      const isNumeric = key === 'plex' || key === 'launcharr';
      rows.sort((a, b) => {
        if (isNumeric) {
          const av = Number(a.dataset[key] || 0);
          const bv = Number(b.dataset[key] || 0);
          if (av === bv) return 0;
          return userSort.dir === 'asc' ? av - bv : bv - av;
        }
        const av = String(a.dataset[key] || '');
        const bv = String(b.dataset[key] || '');
        return userSort.dir === 'asc'
          ? av.localeCompare(bv, undefined, { numeric: true, sensitivity: 'base' })
          : bv.localeCompare(av, undefined, { numeric: true, sensitivity: 'base' });
      });
      rows.forEach((row) => usersBody.appendChild(row));
      updateUserSortIndicators();
    };

    sortHeaders.forEach((header) => {
      const key = header.dataset.sortKey;
      if (!key) return;
      header.addEventListener('click', () => {
        if (userSort.key === key) {
          userSort.dir = userSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
          userSort.key = key;
          userSort.dir = key === 'plex' || key === 'launcharr' ? 'desc' : 'asc';
        }
        sortUserRows();
      });
      header.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        event.preventDefault();
        header.click();
      });
    });
    updateUserSortIndicators();

    function renderUsers(users) {
      usersBody.innerHTML = '';
      users.forEach((user) => {
        const row = document.createElement('div');
        row.className = 'settings-users-row';
        row.dataset.identifier = user.identifier;
        const nameKey = String(user.name || user.username || 'Plex User').toLowerCase();
        const roleKey = String(user.role || 'user').toLowerCase();
        const plexStamp = user.lastPlexSeen && !Number.isNaN(Date.parse(user.lastPlexSeen))
          ? Date.parse(user.lastPlexSeen)
          : 0;
        const launcharrStamp = user.lastLauncharrLogin && !Number.isNaN(Date.parse(user.lastLauncharrLogin))
          ? Date.parse(user.lastLauncharrLogin)
          : 0;
        const plexLogin = formatLoginTimestamp(user.lastPlexSeen);
        const launcharrLogin = formatLoginTimestamp(user.lastLauncharrLogin);
        row.dataset.name = nameKey;
        row.dataset.role = roleKey;
        row.dataset.plex = String(plexStamp);
        row.dataset.launcharr = String(launcharrStamp);
        row.innerHTML =
          '<div class="settings-users-name">' + (user.name || 'Plex User') + '</div>' +
          '<div class="settings-users-login" title="' + (user.lastPlexSeen || '') + '">' + plexLogin + '</div>' +
          '<div class="settings-users-login" title="' + (user.lastLauncharrLogin || '') + '">' + launcharrLogin + '</div>' +
          '<div class="settings-users-role">' +
            '<select ' + (user.locked ? 'disabled' : '') + '>' +
              roleOptions(user.role || 'user') +
            '</select>' +
            (user.locked ? '<span class="settings-users-locked">Owner</span>' : '') +
          '</div>';
        usersBody.appendChild(row);
      });
      sortUserRows();
    }

    async function fetchUsers() {
      if (!fetchBtn || !usersBody || !note) return;
      fetchBtn.disabled = true;
      note.textContent = 'Fetching Plex users...';
      try {
        console.info('[Launcharr] Plex users request');
        const res = await fetch('/settings/plex-users');
        console.info('[Launcharr] Plex users response', { status: res.status, ok: res.ok });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to fetch users.');
        renderUsers(data.users || []);
        saveBtn.disabled = false;
        note.textContent = 'Update roles and hit save.';
      } catch (err) {
        console.error('[Launcharr] Plex users failed', { error: err?.message || String(err) });
        note.textContent = err.message || 'Failed to fetch users.';
      } finally {
        fetchBtn.disabled = false;
      }
    }

    async function saveRoles() {
      if (!saveBtn || !usersBody || !note) return;
      const rows = Array.from(usersBody.querySelectorAll('.settings-users-row'));
      const roles = rows.map((row) => {
        const identifier = row.dataset.identifier || '';
        const select = row.querySelector('select');
        return { identifier, role: select ? select.value : 'user' };
      });
      saveBtn.disabled = true;
      note.textContent = 'Saving roles...';
      try {
        console.info('[Launcharr] Roles save request', { count: roles.length });
        const res = await fetch('/settings/roles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ roles }),
        });
        console.info('[Launcharr] Roles save response', { status: res.status, ok: res.ok });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to save roles.');
        note.textContent = 'Roles saved.';
      } catch (err) {
        console.error('[Launcharr] Roles save failed', { error: err?.message || String(err) });
        note.textContent = err.message || 'Failed to save roles.';
      } finally {
        saveBtn.disabled = false;
      }
    }

    fetchBtn?.addEventListener('click', fetchUsers);
    saveBtn?.addEventListener('click', saveRoles);

      if (fetchBtn) {
        fetchUsers();
      }
    } catch (err) {
      console.error('[Launcharr] Settings form init failed', err);
    }
  </script>
  <script src="/version-badge.js"></script>
  <script src="/pwa.js"></script>
</body>
</html>
